<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sleep Wellness</title>
    <link rel="stylesheet" href="../styles.css">
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --deep-navy: #0f1c2e;
            --navy: #1a2a3a;
            --navy-light: #2a3a4a;
            --gold: #C9A962;
            --gold-light: #d4b978;
            --gold-dark: #9a7b3c;
            --cream: #FAF8F5;
            --text-light: #6b7b8a;
            --success: #2e7d32;
            --warning: #ed6c02;
            --danger: #d32f2f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--cream);
            min-height: 100vh;
        }

        /* Admin Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 280px;
            background: var(--deep-navy);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 11px;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            padding: 0 15px;
            margin-bottom: 10px;
        }

        .nav-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            padding: 10px;
            margin-top: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--gold);
            color: var(--deep-navy);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding: 20px 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--deep-navy);
        }

        .admin-name {
            font-size: 14px;
            font-weight: 500;
        }

        .admin-role {
            font-size: 11px;
            color: var(--gold);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            color: var(--navy);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            color: var(--navy);
            font-weight: 600;
        }

        .stat-change {
            font-size: 12px;
            color: var(--success);
            margin-top: 5px;
        }

        /* Data Table */
        .data-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-card-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            color: var(--navy);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 15px 25px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-table td {
            padding: 18px 25px;
            font-size: 14px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(201, 169, 98, 0.05);
        }

        .client-name {
            font-weight: 500;
            color: var(--navy);
        }

        .client-email {
            font-size: 12px;
            color: var(--text-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 20px;
        }

        .badge-athlete { background: rgba(42, 139, 139, 0.1); color: #2A8B8B; }
        .badge-executive { background: rgba(74, 96, 133, 0.1); color: #4A6085; }
        .badge-hotel { background: rgba(139, 77, 92, 0.1); color: #8B4D5C; }
        .badge-pending { background: rgba(237, 108, 2, 0.1); color: var(--warning); }
        .badge-confirmed { background: rgba(46, 125, 50, 0.1); color: var(--success); }
        .badge-cancelled { background: rgba(211, 47, 47, 0.1); color: var(--danger); }
        .badge-unused { background: rgba(46, 125, 50, 0.1); color: var(--success); }
        .badge-used { background: rgba(107, 123, 138, 0.1); color: var(--text-light); }
        .badge-success { background: rgba(46, 125, 50, 0.15); color: var(--success); font-weight: 500; }

        .action-btn {
            padding: 8px 16px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .action-btn-primary {
            background: var(--gold);
            color: var(--deep-navy);
        }

        .action-btn-primary:hover {
            background: var(--gold-light);
        }

        .action-btn-secondary {
            background: var(--navy);
            color: white;
        }

        .action-btn-secondary:hover {
            background: var(--navy-light);
        }

        .action-btn-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .action-btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* Admin Section */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            font-size: 14px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-family: 'Montserrat', sans-serif;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Invite Code Display */
        .invite-code-display {
            background: var(--cream);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
        }

        .invite-code-value {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            font-weight: bold;
            color: var(--navy);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .copy-btn {
            padding: 8px 20px;
            background: var(--navy);
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--navy-light);
        }

        /* Messages Section */
        .conversations-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: rgba(201, 169, 98, 0.05);
        }

        .conversation-avatar {
            width: 45px;
            height: 45px;
            background: var(--navy);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .conversation-preview {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-light);
        }

        .conversation-unread {
            width: 10px;
            height: 10px;
            background: var(--gold);
            border-radius: 50%;
        }

        /* Chat View */
        .chat-container {
            display: none;
            height: 70vh;
            flex-direction: column;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .chat-back {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 14px;
        }

        .message.received .message-content {
            background: rgba(0,0,0,0.05);
            color: var(--navy);
        }

        .message.sent .message-content {
            background: var(--navy);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
            text-align: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            padding: 20px 25px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .chat-input input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .chat-input button {
            padding: 14px 25px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        /* Assessment View */
        .assessment-detail {
            padding: 25px;
        }

        .assessment-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: var(--cream);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .score-card-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .score-card-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 600;
        }

        .score-card-value.good { color: var(--success); }
        .score-card-value.moderate { color: var(--warning); }
        .score-card-value.poor { color: var(--danger); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 10px;
        }

        /* Search & Filter */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .filter-select {
            padding: 12px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            min-width: 150px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 70px;
            }

            .sidebar-header,
            .sidebar-footer,
            .nav-section-title {
                display: none;
            }

            .nav-item span:not(.badge) {
                display: none;
            }

            .nav-item {
                justify-content: center;
                padding: 15px;
            }

            .admin-main {
                margin-left: 70px;
            }
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                display: none;
            }

            .admin-main {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>

<div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">SLEEP WELLNESS</div>
            <div class="sidebar-subtitle">Admin Portal</div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <a class="nav-item active" onclick="showSection('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Clients</div>
                <a class="nav-item" onclick="showSection('clients')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>All Clients</span>
                </a>
                <a class="nav-item" onclick="showSection('invites')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span>Invite Codes</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Communication</div>
                <a class="nav-item" onclick="showSection('messages')" id="nav-messages">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Messages</span>
                </a>
                <a class="nav-item" onclick="showSection('appointments')" id="nav-appointments">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>Appointments</span>
                    <span class="badge" id="pending-badge" style="display: none;">0</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Content</div>
                <a class="nav-item" onclick="showSection('questionnaires')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <span>Questionnaires</span>
                    <span class="badge" id="questionnaires-badge" style="display: none;">0</span>
                </a>
                <a class="nav-item" onclick="showSection('requests')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="12" y1="18" x2="12" y2="12"/>
                        <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                    <span>Module Requests</span>
                    <span class="badge" id="requests-badge" style="display: none;">0</span>
                </a>
                <a class="nav-item" onclick="showSection('unlocks')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
                    </svg>
                    <span>Assign Modules</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div>
                    <div class="admin-name" id="adminName">Admin</div>
                    <div class="admin-role">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Dashboard Section -->
        <section class="admin-section active" id="section-dashboard">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Welcome back, Dr. Alen</p>
                </div>
                <div id="notification-bell" style="position: relative; cursor: pointer;" onclick="toggleNotifications()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span id="notification-count" style="display: none; position: absolute; top: -5px; right: -5px; background: #c62828; color: white; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center;">0</span>
                </div>
            </div>

            <!-- Notifications Dropdown -->
            <div id="notifications-dropdown" style="display: none; position: absolute; top: 120px; right: 40px; width: 380px; background: white; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1000; max-height: 400px; overflow-y: auto;">
                <div style="padding: 15px 20px; border-bottom: 1px solid rgba(201, 169, 98, 0.15); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin: 0;">Notifications</h3>
                    <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: var(--gold); font-size: 12px; cursor: pointer;">Mark all read</button>
                </div>
                <div id="notifications-list" style="padding: 10px 0;">
                    <p style="text-align: center; color: var(--text-light); padding: 20px; font-size: 14px;">No notifications</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('clients')">
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-value" id="stat-clients">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('assessments')">
                    <div class="stat-label">Assessments</div>
                    <div class="stat-value" id="stat-assessments">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('appointments')">
                    <div class="stat-label">Pending Appointments</div>
                    <div class="stat-value" id="stat-pending">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('invites')">
                    <div class="stat-label">Active Invite Codes</div>
                    <div class="stat-value" id="stat-invites">0</div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header">
                    <h2 class="data-card-title">Recent Assessments</h2>
                    <button class="action-btn action-btn-secondary" onclick="showSection('assessments')">View All</button>
                </div>
                <div id="recent-assessments">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header">
                    <h2 class="data-card-title">Pending Appointments</h2>
                    <button class="action-btn action-btn-secondary" onclick="showSection('appointments')">View All</button>
                </div>
                <div id="pending-appointments">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Clients Section -->
        <section class="admin-section" id="section-clients">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Clients</h1>
                    <p class="page-subtitle">Manage your client accounts</p>
                </div>
                <button class="action-btn action-btn-secondary" onclick="loadClients()" style="display: flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Refresh
                </button>
            </div>

            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search clients..." id="client-search" oninput="filterClients()">
                <select class="filter-select" id="client-filter" onchange="filterClients()">
                    <option value="">All Types</option>
                    <option value="athlete">Athletes</option>
                    <option value="executive">Executives</option>
                    <option value="hotel">Travelers</option>
                </select>
            </div>

            <div class="data-card">
                <div id="clients-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Client Detail Section -->
        <section class="admin-section" id="section-client-detail">
            <div class="page-header" style="margin-bottom: 0;">
                <button onclick="showSection('clients')" style="display: flex; align-items: center; gap: 8px; background: none; border: none; color: var(--gold); cursor: pointer; font-size: 14px; padding: 0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    Back to Clients
                </button>
            </div>

            <!-- Client Profile Header -->
            <div class="data-card" style="margin-top: 20px;">
                <div style="display: flex; align-items: center; gap: 20px; padding: 10px 0;">
                    <div id="client-avatar" style="width: 70px; height: 70px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; font-weight: 600;">?</div>
                    <div style="flex: 1;">
                        <h1 id="client-name" style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--navy); margin: 0 0 5px 0;">Client Name</h1>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 13px; color: var(--text-light);">
                            <span id="client-type-badge" style="background: var(--gold); color: var(--deep-navy); padding: 4px 12px; border-radius: 20px; font-weight: 500; text-transform: capitalize;">Type</span>
                            <span id="client-email">email@example.com</span>
                            <span id="client-joined">Joined: --</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openClientChat()" class="action-btn action-btn-secondary" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            Message
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sleep Health Summary -->
            <div class="data-card" style="margin-top: 20px;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 20px 0;">Sleep Health Summary</h2>
                <div id="no-assessment-notice" style="display: none; text-align: center; padding: 30px; color: var(--text-light);">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 15px; opacity: 0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    <p style="margin: 0;">No assessment completed yet</p>
                </div>
                <div id="assessment-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                    <!-- Score cards will be inserted here -->
                </div>
            </div>

            <!-- Key Findings -->
            <div class="data-card" id="findings-card" style="margin-top: 20px; display: none;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 20px 0;">Key Findings</h2>
                <ul id="findings-list" style="margin: 0; padding-left: 20px; color: var(--navy);">
                    <!-- Findings will be inserted here -->
                </ul>
            </div>

            <!-- Next Steps -->
            <div class="data-card" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Next Steps</h2>
                    <button onclick="showAddActionModal()" style="background: var(--gold); color: var(--deep-navy); border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Action
                    </button>
                </div>
                <div id="actions-list">
                    <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No actions yet. Add next steps for this client.</p>
                </div>
            </div>

            <!-- Recent Messages -->
            <div class="data-card" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Recent Messages</h2>
                    <button onclick="openClientChat()" style="background: none; border: 1px solid var(--gold); color: var(--gold); padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer;">Open Full Chat</button>
                </div>
                <div id="recent-messages">
                    <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No messages yet</p>
                </div>
            </div>

            <!-- Unlocked Modules -->
            <div class="data-card" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Unlocked Modules</h2>
                    <button onclick="showUnlockModuleForClient()" style="background: none; border: 1px solid var(--gold); color: var(--gold); padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer;">Manage Modules</button>
                </div>
                <div id="client-modules">
                    <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No modules unlocked yet</p>
                </div>
            </div>
        </section>

        <!-- Invite Codes Section -->
        <section class="admin-section" id="section-invites">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Invite Codes</h1>
                    <p class="page-subtitle">Generate and manage client invitations</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showGenerateInviteModal()">
                    Generate New Code
                </button>
            </div>

            <div class="data-card">
                <div id="invites-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Messages Section -->
        <section class="admin-section" id="section-messages">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Messages</h1>
                    <p class="page-subtitle">Communicate with your clients</p>
                </div>
            </div>

            <div class="data-card">
                <div class="conversations-list" id="conversations-list">
                    <div class="loading">Loading...</div>
                </div>
                <div class="chat-container" id="chat-container">
                    <div class="chat-header">
                        <button class="chat-back" onclick="closeChat()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <div class="conversation-avatar" id="chat-avatar">?</div>
                        <div class="conversation-name" id="chat-name">Client</div>
                    </div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleMessageKeypress(event)">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Appointments Section -->
        <section class="admin-section" id="section-appointments">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Appointments</h1>
                    <p class="page-subtitle">Manage consultation requests</p>
                </div>
            </div>

            <div class="data-card">
                <div id="appointments-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Module Requests Section -->
        <section class="admin-section" id="section-requests">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Module Requests</h1>
                    <p class="page-subtitle">Review and approve client module access requests</p>
                </div>
            </div>

            <div class="data-card">
                <div id="requests-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Questionnaires Section -->
        <section class="admin-section" id="section-questionnaires">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Questionnaires</h1>
                    <p class="page-subtitle">Assign validated clinical questionnaires and view results</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showAssignQuestionnaireModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Assign Questionnaire
                </button>
            </div>

            <!-- Available Questionnaires Grid -->
            <div class="data-card" style="margin-bottom: 25px;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Available Clinical Instruments</h3>
                <div id="questionnaires-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Questionnaire cards will be inserted here -->
                </div>
            </div>

            <!-- Pending Questionnaires -->
            <div class="data-card" style="margin-bottom: 25px;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Pending Assignments</h3>
                <div id="pending-questionnaires-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Completed Questionnaire Results -->
            <div class="data-card">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Recent Results</h3>
                <div id="questionnaire-results-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Assign Modules Section -->
        <section class="admin-section" id="section-unlocks">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Assign Modules</h1>
                    <p class="page-subtitle">View all therapeutic modules and assign to clients</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showUnlockModal()">
                    Assign to Client
                </button>
            </div>

            <!-- All Available Modules -->
            <div class="data-card" style="margin-bottom: 25px;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Available Therapeutic Modules (13)</h3>
                <div id="all-modules-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <div class="loading">Loading modules...</div>
                </div>
            </div>

            <!-- Assignment History -->
            <div class="data-card">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Recent Assignments</h3>
                <div id="unlocks-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Generate Invite Modal -->
<div id="invite-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Generate Invite Code</h2>
            <button onclick="closeModal('invite-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div id="invite-form-view">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Client Email (optional)</label>
                <input type="email" id="invite-email" placeholder="client@email.com" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Notes</label>
                <textarea id="invite-notes" rows="3" placeholder="Any notes about this invite..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal('invite-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button onclick="generateInviteCode()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Generate Code</button>
            </div>
        </div>

        <div id="invite-result-view" style="display: none;">
            <p style="text-align: center; margin-bottom: 10px; color: #666;">Share this code with your client:</p>
            <div style="background: #f5f5f5; padding: 20px; text-align: center; border-radius: 8px; margin: 20px 0;">
                <div id="generated-code" style="font-family: 'Courier New', monospace; font-size: 28px; font-weight: bold; color: #0f1c2e; letter-spacing: 2px; margin-bottom: 15px;">SW-XXXX-XXXX</div>
                <button onclick="copyInviteCode()" style="padding: 10px 20px; background: #0f1c2e; color: white; border: none; cursor: pointer; border-radius: 4px;">Copy Code</button>
            </div>

            <!-- Email Section -->
            <div id="email-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="font-size: 14px; color: #0f1c2e; font-weight: 500; margin-bottom: 15px; text-align: center;">Send Welcome Email to Client</p>
                <div id="email-preview" style="background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 15px; font-size: 13px; line-height: 1.7; color: #333;">
                    <!-- Email preview will be inserted here -->
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="send-email-btn" onclick="sendInviteEmail()" style="padding: 12px 24px; background: #2e7d32; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        Send Email
                    </button>
                </div>
                <p id="email-status" style="text-align: center; margin-top: 10px; font-size: 13px; display: none;"></p>
            </div>

            <p style="font-size: 13px; color: #666; text-align: center; margin-top: 15px;">
                The client will use this code to create their account at:<br>
                <strong id="auth-url"></strong>
            </p>
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button onclick="closeInviteModal()" style="padding: 12px 30px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Action Modal -->
<div id="action-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Add Next Step</h2>
            <button onclick="closeModal('action-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Action Description *</label>
            <input type="text" id="action-text" placeholder="e.g., Schedule follow-up consultation" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Priority</label>
            <select id="action-priority" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="normal">Normal</option>
                <option value="high">High Priority</option>
                <option value="low">Low Priority</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Due Date (optional)</label>
            <input type="date" id="action-due" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('action-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="addClientAction()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Add Action</button>
        </div>
    </div>
</div>

<!-- Assign Questionnaire Modal -->
<div class="modal-overlay" id="assign-questionnaire-modal">
    <div class="modal" style="max-width: 600px; background: white;">
        <div class="modal-header">
            <h2 class="modal-title">Assign Questionnaire</h2>
            <button class="modal-close" onclick="closeModal('assign-questionnaire-modal')">&times;</button>
        </div>

        <div class="form-group">
            <label>Select Questionnaire</label>
            <select id="questionnaire-select" style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 6px; font-size: 14px;">
                <option value="">Choose a questionnaire...</option>
            </select>
            <div id="questionnaire-preview" style="display: none; margin-top: 15px; padding: 15px; background: #f8f6f3; border-radius: 8px;">
                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                    <span id="qp-time" style="font-size: 12px; color: var(--text-light);"></span>
                    <span id="qp-category" style="font-size: 12px; color: var(--gold); font-weight: 500;"></span>
                </div>
                <p id="qp-description" style="font-size: 13px; color: var(--navy); margin: 0;"></p>
            </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label>Select Clients</label>
            <div id="questionnaire-clients-list" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 6px; padding: 10px;">
                <div class="loading">Loading clients...</div>
            </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label>Due Date</label>
            <input type="date" id="questionnaire-due-date" style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 6px; font-size: 14px;">
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <label>Notes (optional)</label>
            <textarea id="questionnaire-notes" rows="2" placeholder="Any instructions for the client..." style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
        </div>

        <div class="form-actions" style="margin-top: 25px;">
            <button class="action-btn action-btn-secondary" onclick="closeModal('assign-questionnaire-modal')">Cancel</button>
            <button class="action-btn action-btn-primary" onclick="assignQuestionnaireToClients()">Assign Questionnaire</button>
        </div>
    </div>
</div>

<!-- Unlock Module Modal -->
<div class="modal-overlay" id="unlock-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Grant Module Access</h2>
            <button class="modal-close" onclick="closeModal('unlock-modal')">&times;</button>
        </div>

        <div class="form-group">
            <label for="unlock-client">Select Client</label>
            <select id="unlock-client">
                <option value="">Loading clients...</option>
            </select>
        </div>

        <div class="form-group">
            <label>Modules to Unlock</label>
            <div style="margin-top: 10px; max-height: 350px; overflow-y: auto;">
                <p style="font-size: 11px; color: var(--text-light); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Relaxation Techniques</p>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="breathing-478"> 4-7-8 Breathing Technique
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="pmr"> Progressive Muscle Relaxation
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="mindfulness-bodyscan"> Mindfulness & Body Scan
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="autogenic-training"> Autogenic Training
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="guided-imagery"> Guided Imagery for Sleep
                </label>

                <p style="font-size: 11px; color: var(--text-light); margin: 15px 0 12px; text-transform: uppercase; letter-spacing: 1px;">CBT-I Components</p>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-restriction"> CBT-I: Sleep Restriction
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-stimulus"> CBT-I: Stimulus Control
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-cognitive"> CBT-I: Cognitive Restructuring
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="paradoxical-intention"> Paradoxical Intention
                </label>

                <p style="font-size: 11px; color: var(--text-light); margin: 15px 0 12px; text-transform: uppercase; letter-spacing: 1px;">Cognitive & Lifestyle</p>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="worry-management"> Worry Time & Constructive Worry
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="circadian-rhythm"> Circadian Rhythm Optimization
                </label>

                <p style="font-size: 11px; color: var(--text-light); margin: 15px 0 12px; text-transform: uppercase; letter-spacing: 1px;">Tools</p>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="sleep-diary"> Interactive Sleep Diary
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="unlock-notes">Notes</label>
            <textarea id="unlock-notes" rows="2" placeholder="Reason for unlocking..."></textarea>
        </div>

        <div class="form-actions">
            <button class="action-btn action-btn-secondary" onclick="closeModal('unlock-modal')">Cancel</button>
            <button class="action-btn action-btn-primary" onclick="grantUnlock()">Grant Access</button>
        </div>
    </div>
</div>

<!-- Module Detail Modal -->
<div class="modal-overlay" id="module-detail-modal">
    <div class="modal" style="max-width: 600px; background: white;">
        <div class="modal-header">
            <h2 class="modal-title" id="module-detail-title">Module Name</h2>
            <button class="modal-close" onclick="closeModal('module-detail-modal')">&times;</button>
        </div>

        <div id="module-detail-content" style="padding: 0 25px;">
            <!-- Module info will be injected here -->
        </div>

        <div style="padding: 20px 25px; border-top: 1px solid rgba(201, 169, 98, 0.2); margin-top: 20px;">
            <h4 style="font-size: 14px; color: var(--navy); margin-bottom: 15px;">Assign to Clients</h4>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="font-size: 13px; color: var(--text-light); margin-bottom: 8px; display: block;">Select clients to assign this module:</label>
                <div id="module-assign-clients" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 6px; padding: 10px;">
                    <div class="loading">Loading clients...</div>
                </div>
            </div>
            <input type="hidden" id="module-assign-id">
            <div style="display: flex; gap: 10px;">
                <button class="action-btn action-btn-secondary" onclick="closeModal('module-detail-modal')" style="flex: 1;">Cancel</button>
                <button class="action-btn action-btn-primary" onclick="assignModuleToSelected()" id="assign-module-btn" style="flex: 1;">Assign Module</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="../firebase-config.js"></script>
<script src="../auth.js"></script>
<script src="../content.js"></script>
<script src="../questionnaires.js"></script>

<script>
    let currentUser = null;
    let allClients = [];
    let allAssessments = [];
    let currentConversation = null;
    let messageListener = null;

    // Check admin access
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = '../auth.html';
            return;
        }

        const profile = await FirebaseDB.getUserProfile(user.uid);
        if (!profile || profile.role !== 'admin') {
            window.location.href = '../account.html';
            return;
        }

        currentUser = user;
        document.getElementById('adminName').textContent = profile.displayName || 'Admin';
        document.getElementById('adminAvatar').textContent = (profile.displayName || 'A')[0].toUpperCase();

        // Load dashboard data
        loadDashboard();

        // Load notifications
        loadNotifications();
    });

    // Navigate to section (from stat cards)
    function navigateToSection(sectionId) {
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

        // Show section
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + sectionId).classList.add('active');

        // Load section data
        loadSectionData(sectionId);
    }

    // Show section
    function showSection(sectionId) {
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

        // Try to highlight the matching nav item (if called from nav click)
        try {
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.closest('.nav-item')?.classList.add('active');
            }
        } catch (e) {
            // Ignore - event might not be available
        }

        // Show section
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        const section = document.getElementById('section-' + sectionId);
        if (section) {
            section.classList.add('active');
        } else {
            console.error('Section not found:', 'section-' + sectionId);
        }

        // Load section data (skip for client-detail as it's loaded separately)
        if (sectionId !== 'client-detail') {
            loadSectionData(sectionId);
        }
    }

    // Load section data
    function loadSectionData(sectionId) {
        switch(sectionId) {
            case 'dashboard': loadDashboard(); break;
            case 'clients': loadClients(); break;
            case 'assessments': loadAssessments(); break;
            case 'invites': loadInvites(); break;
            case 'messages': loadConversations(); break;
            case 'appointments': loadAppointments(); break;
            case 'requests': loadRequests(); break;
            case 'unlocks': loadUnlocks(); break;
            case 'questionnaires': loadQuestionnaires(); break;
        }
    }

    // Load dashboard
    async function loadDashboard() {
        const analytics = await FirebaseDB.getAnalytics();

        document.getElementById('stat-clients').textContent = analytics.totalClients;
        document.getElementById('stat-assessments').textContent = analytics.totalAssessments;
        document.getElementById('stat-pending').textContent = analytics.pendingAppointments;

        // Load invite count
        const invites = await FirebaseDB.getAllInviteCodes();
        const unusedInvites = invites.filter(i => !i.used).length;
        document.getElementById('stat-invites').textContent = unusedInvites;

        // Update pending badge
        const badge = document.getElementById('pending-badge');
        if (analytics.pendingAppointments > 0) {
            badge.textContent = analytics.pendingAppointments;
            badge.style.display = '';
        } else {
            badge.style.display = 'none';
        }

        // Update module requests badge
        updateRequestsBadge();

        // Load recent assessments
        const assessments = await FirebaseDB.getAllAssessments();
        const recentContainer = document.getElementById('recent-assessments');

        if (assessments.length === 0) {
            recentContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Assessments Yet</h3>
                    <p>Assessments will appear here once clients complete them.</p>
                </div>
            `;
        } else {
            const recent = assessments.slice(0, 5);
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Score</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const a of recent) {
                const client = await FirebaseDB.getUserProfile(a.userId);
                const score = a.overallScore || 0;
                const date = a.createdAt?.toDate()?.toLocaleDateString() || 'N/A';

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${client?.displayName || 'Unknown'}</div>
                            <div class="client-email">${client?.email || ''}</div>
                        </td>
                        <td><span class="badge ${score >= 70 ? 'badge-confirmed' : score >= 40 ? 'badge-pending' : 'badge-cancelled'}">${score}/100</span></td>
                        <td>${date}</td>
                        <td><button class="action-btn action-btn-secondary" onclick="viewAssessment('${a.id}')">View</button></td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            recentContainer.innerHTML = html;
        }

        // Load pending appointments
        const appointments = await FirebaseDB.getAllAppointments();
        const pending = appointments.filter(a => a.status === 'pending');
        const appointmentsContainer = document.getElementById('pending-appointments');

        if (pending.length === 0) {
            appointmentsContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Pending Appointments</h3>
                    <p>Appointment requests will appear here.</p>
                </div>
            `;
        } else {
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Type</th>
                        <th>Requested Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const apt of pending.slice(0, 5)) {
                const client = await FirebaseDB.getUserProfile(apt.userId);
                const dateTime = apt.dateTime?.toDate();
                const formattedDate = dateTime ? dateTime.toLocaleString() : 'N/A';

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${client?.displayName || 'Unknown'}</div>
                            <div class="client-email">${client?.email || ''}</div>
                        </td>
                        <td>${apt.type || 'Consultation'}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="action-btn action-btn-primary" onclick="confirmAppointment('${apt.id}')">Confirm</button>
                            <button class="action-btn action-btn-danger" onclick="cancelAppointment('${apt.id}')">Decline</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            appointmentsContainer.innerHTML = html;
        }
    }

    // Load clients
    async function loadClients() {
        const container = document.getElementById('clients-list');
        container.innerHTML = '<div class="loading">Loading clients...</div>';

        try {
            // Force fresh fetch from Firestore
            const snapshot = await db.collection('users')
                .where('role', '==', 'client')
                .get({ source: 'server' });

            allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Sort by createdAt
            allClients.sort((a, b) => {
                const aTime = a.createdAt?.toDate?.() || new Date(0);
                const bTime = b.createdAt?.toDate?.() || new Date(0);
                return bTime - aTime;
            });

            console.log('Loaded clients:', allClients.length, allClients);
            renderClients(allClients);
        } catch (error) {
            console.error('Error loading clients:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <h3>Error Loading Clients</h3>
                    <p>${error.message}</p>
                    <button class="action-btn action-btn-primary" onclick="loadClients()">Retry</button>
                </div>
            `;
        }
    }

    function renderClients(clients) {
        const container = document.getElementById('clients-list');

        if (clients.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Clients Yet</h3>
                    <p>Generate invite codes to onboard new clients.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Joined</th>
                    <th>Last Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const client of clients) {
            const joined = client.createdAt?.toDate()?.toLocaleDateString() || 'N/A';
            const lastActive = client.lastLogin?.toDate()?.toLocaleDateString() || 'N/A';
            const typeClass = client.clientType ? `badge-${client.clientType}` : '';
            const typeLabel = client.clientType ? client.clientType.charAt(0).toUpperCase() + client.clientType.slice(1) : 'Unknown';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client.displayName || 'Unknown'}</div>
                        <div class="client-email">${client.email}</div>
                    </td>
                    <td><span class="badge ${typeClass}">${typeLabel}</span></td>
                    <td>${joined}</td>
                    <td>${lastActive}</td>
                    <td>
                        <button class="action-btn action-btn-secondary" onclick="viewClient('${client.id}')">View</button>
                        <button class="action-btn action-btn-primary" onclick="messageClient('${client.id}')">Message</button>
                    </td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function filterClients() {
        const search = document.getElementById('client-search').value.toLowerCase();
        const type = document.getElementById('client-filter').value;

        let filtered = allClients;

        if (search) {
            filtered = filtered.filter(c =>
                (c.displayName || '').toLowerCase().includes(search) ||
                (c.email || '').toLowerCase().includes(search)
            );
        }

        if (type) {
            filtered = filtered.filter(c => c.clientType === type);
        }

        renderClients(filtered);
    }

    // Load assessments
    async function loadAssessments() {
        const container = document.getElementById('assessments-list');
        allAssessments = await FirebaseDB.getAllAssessments();

        if (allAssessments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Assessments Yet</h3>
                    <p>Assessments will appear here once clients complete them.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Overall Score</th>
                    <th>Key Findings</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const a of allAssessments) {
            const client = await FirebaseDB.getUserProfile(a.userId);
            const score = a.overallScore || 0;
            const date = a.createdAt?.toDate()?.toLocaleDateString() || 'N/A';
            const findings = a.findings?.slice(0, 2).join(', ') || 'N/A';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${client?.email || ''}</div>
                    </td>
                    <td><span class="badge ${score >= 70 ? 'badge-confirmed' : score >= 40 ? 'badge-pending' : 'badge-cancelled'}">${score}/100</span></td>
                    <td style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${findings}</td>
                    <td>${date}</td>
                    <td><button class="action-btn action-btn-secondary" onclick="viewAssessment('${a.id}')">View Details</button></td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Load invite codes
    async function loadInvites() {
        const container = document.getElementById('invites-list');
        const invites = await FirebaseDB.getAllInviteCodes();

        if (invites.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Invite Codes</h3>
                    <p>Generate codes to invite new clients.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Client / Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const invite of invites) {
            const created = invite.createdAt?.toDate()?.toLocaleDateString() || 'N/A';

            let statusClass, statusText, clientInfo;

            if (invite.used) {
                statusClass = 'badge-success';
                statusText = 'Registered';
                // Try to get client name
                if (invite.usedBy) {
                    const client = allClients.find(c => c.id === invite.usedBy);
                    clientInfo = client ? `<strong>${client.displayName || client.email}</strong>` : (invite.clientEmail || 'Client');
                } else {
                    clientInfo = invite.clientEmail || 'Client';
                }
            } else {
                statusClass = 'badge-pending';
                statusText = 'Available';
                clientInfo = invite.notes || invite.clientEmail || '-';
            }

            const registeredDate = invite.usedAt?.toDate()?.toLocaleDateString() || '';

            html += `
                <tr>
                    <td><strong style="font-family: monospace; letter-spacing: 1px;">${invite.code}</strong></td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${created}${invite.used && registeredDate ? `<br><small style="color: var(--text-light);">Registered: ${registeredDate}</small>` : ''}</td>
                    <td>${clientInfo}</td>
                    <td>
                        ${!invite.used ? `
                            <button class="action-btn action-btn-secondary" onclick="copyCode('${invite.code}')">Copy</button>
                            <button class="action-btn action-btn-danger" onclick="deleteInvite('${invite.code}')">Delete</button>
                        ` : `<button class="action-btn action-btn-secondary" onclick="viewClient('${invite.usedBy}')">View Client</button>`}
                    </td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Generate invite code
    function showGenerateInviteModal() {
        document.getElementById('invite-form-view').style.display = 'block';
        document.getElementById('invite-result-view').style.display = 'none';
        document.getElementById('invite-email').value = '';
        document.getElementById('invite-notes').value = '';
        document.getElementById('invite-modal').style.display = 'flex';
    }

    // Store current invite data for email
    let currentInviteData = {};

    async function generateInviteCode() {
        const email = document.getElementById('invite-email').value.trim();
        const notes = document.getElementById('invite-notes').value;

        const code = await FirebaseDB.generateInviteCode(currentUser.uid, email, notes);
        const authUrl = window.location.origin + '/assessment/auth.html';

        // Store for email sending
        currentInviteData = { email, code, authUrl };

        document.getElementById('generated-code').textContent = code;
        document.getElementById('auth-url').textContent = authUrl;
        document.getElementById('invite-form-view').style.display = 'none';
        document.getElementById('invite-result-view').style.display = 'block';

        // Show email section if email was provided
        const emailSection = document.getElementById('email-section');
        const emailStatus = document.getElementById('email-status');
        emailStatus.style.display = 'none';

        if (email) {
            emailSection.style.display = 'block';
            document.getElementById('email-preview').innerHTML = generateEmailPreview(email, code, authUrl);
            document.getElementById('send-email-btn').disabled = false;
            document.getElementById('send-email-btn').innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                Send Email
            `;
        } else {
            emailSection.style.display = 'none';
        }
    }

    function generateEmailPreview(email, code, authUrl) {
        return `
            <div style="font-family: Georgia, serif; color: #0f1c2e;">
                <p style="margin: 0 0 15px 0;">Dear Client,</p>

                <p style="margin: 0 0 15px 0;">I hope this message finds you well. I am delighted to welcome you to my <strong>Sleep Wellness</strong> practice.</p>

                <p style="margin: 0 0 15px 0;">Your personalized client portal is now ready. This secure space will allow us to work together on optimizing your sleep health, track your progress, and communicate directly.</p>

                <p style="margin: 0 0 10px 0;"><strong>Your Personal Invite Code:</strong></p>
                <p style="margin: 0 0 15px 0; font-family: 'Courier New', monospace; font-size: 18px; background: #f0f0f0; padding: 12px; text-align: center; letter-spacing: 2px; font-weight: bold;">${code}</p>

                <p style="margin: 0 0 10px 0;"><strong>To get started:</strong></p>
                <ol style="margin: 0 0 15px 0; padding-left: 20px;">
                    <li style="margin-bottom: 5px;">Visit: <a href="${authUrl}" style="color: #9a7b3c;">${authUrl}</a></li>
                    <li style="margin-bottom: 5px;">Click "Create Account"</li>
                    <li style="margin-bottom: 5px;">Enter your invite code above</li>
                    <li style="margin-bottom: 5px;">Complete your profile</li>
                </ol>

                <p style="margin: 0 0 15px 0;">I look forward to supporting you on your journey to better sleep and improved well-being.</p>

                <p style="margin: 0 0 5px 0;">Warm regards,</p>
                <p style="margin: 0; font-style: italic;">Dr. Alen Juginovic</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Sleep Wellness by Dr. Alen</p>
            </div>
        `;
    }

    async function sendInviteEmail() {
        const { email, code, authUrl } = currentInviteData;
        if (!email) return;

        const btn = document.getElementById('send-email-btn');
        const status = document.getElementById('email-status');

        btn.disabled = true;
        btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 70"/></svg>
            Sending...
        `;

        try {
            // EmailJS configuration - REPLACE THESE WITH YOUR OWN
            const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
            const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
            const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

            // Check if EmailJS is configured
            if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                // Fallback: Open email client
                const subject = encodeURIComponent('Welcome to Sleep Wellness - Your Access Code');
                const body = encodeURIComponent(`Dear Client,

I hope this message finds you well. I am delighted to welcome you to my Sleep Wellness practice.

Your personalized client portal is now ready. This secure space will allow us to work together on optimizing your sleep health, track your progress, and communicate directly.

Your Personal Invite Code: ${code}

To get started:
1. Visit: ${authUrl}
2. Click "Create Account"
3. Enter your invite code above
4. Complete your profile

I look forward to supporting you on your journey to better sleep and improved well-being.

Warm regards,
Dr. Alen Juginovic
Sleep Wellness by Dr. Alen`);

                window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');

                status.style.display = 'block';
                status.style.color = '#ed6c02';
                status.textContent = 'Email client opened. Please send the email manually.';
                btn.innerHTML = `
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    Open Email Again
                `;
                btn.disabled = false;
                return;
            }

            // Send via EmailJS
            emailjs.init(EMAILJS_PUBLIC_KEY);

            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                to_email: email,
                invite_code: code,
                auth_url: authUrl,
                from_name: 'Dr. Alen Juginovic',
                reply_to: 'alen_juginovic@hms.harvard.edu'
            });

            status.style.display = 'block';
            status.style.color = '#2e7d32';
            status.textContent = 'Email sent successfully!';
            btn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>
                Sent!
            `;
        } catch (error) {
            console.error('Email error:', error);
            status.style.display = 'block';
            status.style.color = '#d32f2f';
            status.textContent = 'Failed to send. Opening email client instead...';

            // Fallback to mailto
            setTimeout(() => {
                const subject = encodeURIComponent('Welcome to Sleep Wellness - Your Access Code');
                const body = encodeURIComponent(`Your invite code: ${code}\n\nCreate your account at: ${authUrl}`);
                window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
            }, 1000);

            btn.disabled = false;
            btn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                Try Again
            `;
        }
    }

    function copyInviteCode() {
        const code = document.getElementById('generated-code').textContent;
        navigator.clipboard.writeText(code);
        event.target.textContent = 'Copied!';
        setTimeout(() => event.target.textContent = 'Copy Code', 2000);
    }

    function closeInviteModal() {
        document.getElementById('invite-modal').style.display = 'none';
        loadInvites();
        loadDashboard();
    }

    function copyCode(code) {
        navigator.clipboard.writeText(code);
        event.target.textContent = 'Copied!';
        setTimeout(() => event.target.textContent = 'Copy', 2000);
    }

    async function deleteInvite(code) {
        if (confirm('Are you sure you want to delete this invite code?')) {
            await FirebaseDB.deleteInviteCode(code);
            loadInvites();
        }
    }

    // Load conversations
    async function loadConversations() {
        const container = document.getElementById('conversations-list');
        container.style.display = 'block';
        document.getElementById('chat-container').classList.remove('active');

        try {
            // Get all conversations where admin is a participant
            const snapshot = await db.collection('conversations')
                .where('participants', 'array-contains', currentUser.uid)
                .get();

            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Conversations</h3>
                        <p>Messages from clients will appear here.</p>
                    </div>
                `;
                return;
            }

            // Sort by lastMessageAt client-side
            const conversations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            conversations.sort((a, b) => {
                const aTime = a.lastMessageAt?.toDate?.() || new Date(0);
                const bTime = b.lastMessageAt?.toDate?.() || new Date(0);
                return bTime - aTime;
            });

            let html = '';
            for (const conv of conversations) {
                const clientId = conv.participants.find(p => p !== currentUser.uid);
                const client = await FirebaseDB.getUserProfile(clientId);

                const lastTime = conv.lastMessageAt?.toDate?.();
                const timeStr = lastTime ? formatTime(lastTime) : '';

                html += `
                    <div class="conversation-item" onclick="openChat('${conv.id}', '${clientId}', '${client?.displayName || 'Client'}')">
                        <div class="conversation-avatar">${(client?.displayName || 'C')[0].toUpperCase()}</div>
                        <div class="conversation-info">
                            <div class="conversation-name">${client?.displayName || 'Client'}</div>
                            <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
                        </div>
                        <div class="conversation-time">${timeStr}</div>
                    </div>
                `;
            }

            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading conversations:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <h3>Error Loading Messages</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    function formatTime(date) {
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
        return date.toLocaleDateString();
    }

    async function openChat(conversationId, clientId, clientName) {
        currentConversation = { id: conversationId, clientId, clientName };

        document.getElementById('conversations-list').style.display = 'none';
        document.getElementById('chat-container').classList.add('active');
        document.getElementById('chat-avatar').textContent = clientName[0].toUpperCase();
        document.getElementById('chat-name').textContent = clientName;

        // Listen for messages
        if (messageListener) messageListener();

        messageListener = FirebaseDB.getMessagesListener(conversationId, (messages) => {
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(m => `
                <div class="message ${m.senderId === currentUser.uid ? 'sent' : 'received'}">
                    <div class="message-content">${m.text}</div>
                    <div class="message-time">${m.createdAt?.toDate()?.toLocaleTimeString() || ''}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        });
    }

    function closeChat() {
        if (messageListener) {
            messageListener();
            messageListener = null;
        }
        currentConversation = null;
        document.getElementById('chat-container').classList.remove('active');
        document.getElementById('conversations-list').style.display = 'block';
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();

        if (!text || !currentConversation) return;

        input.value = '';
        await FirebaseDB.sendMessage(currentConversation.id, currentUser.uid, text);
    }

    function handleMessageKeypress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function messageClient(clientId) {
        try {
            console.log('Messaging client:', clientId);
            // Get or create conversation
            const conv = await FirebaseDB.getOrCreateConversation(clientId, currentUser.uid);
            const client = await FirebaseDB.getUserProfile(clientId);

            console.log('Conversation:', conv);
            console.log('Client:', client);

            // Navigate to messages section
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-messages').classList.add('active');

            // Open the chat after a brief delay
            setTimeout(() => {
                openChat(conv.id, clientId, client?.displayName || 'Client');
            }, 200);
        } catch (error) {
            console.error('Error messaging client:', error);
            alert('Error opening conversation: ' + error.message);
        }
    }

    // Load appointments
    async function loadAppointments() {
        const container = document.getElementById('appointments-list');
        const appointments = await FirebaseDB.getAllAppointments();

        if (appointments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Appointments</h3>
                    <p>Client appointment requests will appear here.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Type</th>
                    <th>Date/Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const apt of appointments) {
            const client = await FirebaseDB.getUserProfile(apt.userId);
            const dateTime = apt.dateTime?.toDate();
            const formattedDate = dateTime ? dateTime.toLocaleString() : 'N/A';
            const statusClass = apt.status === 'confirmed' ? 'badge-confirmed' : apt.status === 'cancelled' ? 'badge-cancelled' : 'badge-pending';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${client?.email || ''}</div>
                    </td>
                    <td>${apt.type || 'Consultation'}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge ${statusClass}">${apt.status}</span></td>
                    <td>
                        ${apt.status === 'pending' ? `
                            <button class="action-btn action-btn-primary" onclick="confirmAppointment('${apt.id}')">Confirm</button>
                            <button class="action-btn action-btn-danger" onclick="cancelAppointment('${apt.id}')">Decline</button>
                        ` : `
                            <button class="action-btn action-btn-secondary" onclick="messageClient('${apt.userId}')">Message</button>
                        `}
                    </td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function confirmAppointment(appointmentId) {
        await FirebaseDB.updateAppointmentStatus(appointmentId, 'confirmed');
        loadAppointments();
        loadDashboard();
    }

    async function cancelAppointment(appointmentId) {
        if (confirm('Are you sure you want to decline this appointment?')) {
            await FirebaseDB.updateAppointmentStatus(appointmentId, 'cancelled');
            loadAppointments();
            loadDashboard();
        }
    }

    // Load unlocks
    // Load module requests
    async function loadRequests() {
        const container = document.getElementById('requests-list');

        try {
            const requests = await FirebaseDB.getPendingModuleRequests();

            // Update badge
            const badge = document.getElementById('requests-badge');
            if (requests.length > 0) {
                badge.textContent = requests.length;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Pending Requests</h3>
                        <p>When clients request module access, they'll appear here.</p>
                    </div>
                `;
                return;
            }

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Module Requested</th>
                        <th>Reason</th>
                        <th>Requested</th>
                        <th style="width: 180px;">Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const req of requests) {
                const requested = req.createdAt?.toDate?.()?.toLocaleDateString() || 'N/A';

                html += `
                    <tr id="request-${req.id}">
                        <td>
                            <div class="client-name">${req.userName}</div>
                            <div class="client-email">${req.userEmail}</div>
                        </td>
                        <td><strong>${req.moduleName || req.moduleId}</strong></td>
                        <td style="max-width: 250px; font-size: 13px; color: var(--text-light);">${req.reason || '<em>No reason provided</em>'}</td>
                        <td>${requested}</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="approveRequest('${req.id}')" class="action-btn action-btn-primary" style="padding: 8px 16px; font-size: 12px;">
                                    Approve
                                </button>
                                <button onclick="denyRequest('${req.id}')" class="action-btn action-btn-secondary" style="padding: 8px 16px; font-size: 12px;">
                                    Deny
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading requests:', error);
            container.innerHTML = '<p style="color: red;">Error loading requests</p>';
        }
    }

    // Approve module request
    async function approveRequest(requestId) {
        if (!confirm('Approve this module request?')) return;

        try {
            await FirebaseDB.approveModuleRequest(requestId);
            alert('Request approved! The module has been unlocked.');
            loadRequests(); // Refresh list
        } catch (error) {
            console.error('Error approving request:', error);
            alert('Error approving request. Please try again.');
        }
    }

    // Deny module request
    async function denyRequest(requestId) {
        const reason = prompt('Reason for denial (optional):');
        if (reason === null) return; // User cancelled

        try {
            await FirebaseDB.denyModuleRequest(requestId, reason);
            alert('Request denied.');
            loadRequests(); // Refresh list
        } catch (error) {
            console.error('Error denying request:', error);
            alert('Error denying request. Please try again.');
        }
    }

    // Update requests badge count
    async function updateRequestsBadge() {
        try {
            const count = await FirebaseDB.getPendingRequestsCount();
            const badge = document.getElementById('requests-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        } catch (error) {
            console.error('Error updating requests badge:', error);
        }
    }

    // Render all available modules in a grid for admin view
    function renderAllModulesGrid() {
        const container = document.getElementById('all-modules-grid');
        if (!container || !window.Content) return;

        const modules = Content.modules;
        const moduleCategories = {
            'Relaxation Techniques': ['breathing-478', 'pmr', 'mindfulness-bodyscan', 'autogenic-training', 'guided-imagery'],
            'CBT-I Components': ['cbti-restriction', 'cbti-stimulus', 'cbti-cognitive', 'paradoxical-intention'],
            'Cognitive & Lifestyle': ['worry-management', 'circadian-rhythm'],
            'Foundational': ['sleep-hygiene'],
            'Tools': ['sleep-diary']
        };

        let html = '';

        for (const category in moduleCategories) {
            const moduleIds = moduleCategories[category];
            html += `<div style="grid-column: 1 / -1; margin-top: ${html ? '20px' : '0'};"><h4 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 12px;">${category}</h4></div>`;

            for (const id of moduleIds) {
                const m = modules[id];
                if (!m) continue;

                const isLocked = m.locked;
                html += `
                    <div onclick="openModuleDetail('${id}')" style="background: ${isLocked ? '#fafafa' : '#f0f9f0'}; border: 1px solid ${isLocked ? 'rgba(201, 169, 98, 0.2)' : 'rgba(46, 125, 50, 0.2)'}; border-radius: 8px; padding: 16px; position: relative; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)';">
                        ${!isLocked ? '<span style="position: absolute; top: 10px; right: 10px; background: #2e7d32; color: white; font-size: 9px; padding: 3px 8px; border-radius: 10px; text-transform: uppercase;">Free</span>' : ''}
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <svg style="width: 24px; height: 24px; stroke: var(--gold); flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke-width="1.5">${Content.getModuleIconSVG(m.icon)}</svg>
                            <h5 style="font-size: 14px; font-weight: 600; color: var(--navy); margin: 0;">${m.title}</h5>
                        </div>
                        <p style="font-size: 12px; color: var(--text-light); margin: 0; line-height: 1.5;">${m.description}</p>
                        <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                            <span style="font-size: 10px; background: rgba(201, 169, 98, 0.15); color: var(--gold-dark); padding: 3px 8px; border-radius: 10px;">${m.duration || 'Varies'}</span>
                            <span style="font-size: 10px; background: rgba(15, 28, 46, 0.08); color: var(--navy); padding: 3px 8px; border-radius: 10px;">${m.difficulty || 'Beginner'}</span>
                        </div>
                    </div>
                `;
            }
        }

        container.innerHTML = html;
    }

    // Open module detail modal
    async function openModuleDetail(moduleId) {
        console.log('openModuleDetail called with:', moduleId);

        // Show modal immediately for testing
        document.getElementById('module-detail-modal').classList.add('active');
        console.log('Modal should be visible now');

        try {
            const modules = Content.modules;
            const m = modules[moduleId];
            if (!m) { console.log('Module not found'); return; }

            // Set title
            document.getElementById('module-detail-title').textContent = m.title;
            document.getElementById('module-assign-id').value = moduleId;

            // Build module info HTML
            const infoHtml = `
            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">${m.description}</p>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: #fafafa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 5px;">Duration</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--navy);">${m.duration || 'Varies'}</div>
                </div>
                <div style="background: #fafafa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 5px;">Difficulty</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--navy);">${m.difficulty || 'Beginner'}</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 10px;">Best For</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${(m.indications || ['General use']).map(ind => `
                        <span style="font-size: 12px; background: rgba(46, 125, 50, 0.1); color: #2e7d32; padding: 6px 12px; border-radius: 15px;">${ind}</span>
                    `).join('')}
                </div>
            </div>

            <div style="background: rgba(201, 169, 98, 0.1); padding: 12px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                <svg style="width: 18px; height: 18px; stroke: var(--gold); flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span style="font-size: 13px; color: var(--navy);"><strong>Evidence:</strong> ${m.evidence || 'Clinical guidelines'}</span>
            </div>
        `;

        document.getElementById('module-detail-content').innerHTML = infoHtml;

        // Load clients for assignment
        const clientsContainer = document.getElementById('module-assign-clients');
        const clients = await FirebaseDB.getAllUsers();

        // Get all existing unlocks to show who already has this module
        const unlocksSnapshot = await db.collection('unlocks').get();
        const clientsWithModule = new Set();
        unlocksSnapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.modules && data.modules.includes(moduleId)) {
                clientsWithModule.add(data.userId);
            }
        });

        if (clients.length === 0) {
            clientsContainer.innerHTML = '<p style="color: var(--text-light); font-size: 13px; text-align: center; padding: 10px;">No clients found</p>';
        } else {
            clientsContainer.innerHTML = clients.map(c => {
                const hasModule = clientsWithModule.has(c.id) || !m.locked;
                return `
                    <label style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: ${hasModule ? 'default' : 'pointer'}; border-radius: 6px; ${hasModule ? 'opacity: 0.6;' : ''}" ${hasModule ? '' : `onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''"`}>
                        <input type="checkbox" name="module-assign-client" value="${c.id}" ${hasModule ? 'disabled checked' : ''} style="width: 16px; height: 16px;">
                        <div>
                            <div style="font-size: 13px; font-weight: 500; color: var(--navy);">${c.displayName || c.email}</div>
                            ${hasModule ? '<div style="font-size: 11px; color: #2e7d32;">Already has access</div>' : ''}
                        </div>
                    </label>
                `;
            }).join('');
        }

            // Show modal
            console.log('Showing modal now');
            document.getElementById('module-detail-modal').classList.add('active');
        } catch (error) {
            console.error('Error in openModuleDetail:', error);
        }
    }

    // Assign module to selected clients
    async function assignModuleToSelected() {
        const moduleId = document.getElementById('module-assign-id').value;
        const selectedClients = Array.from(document.querySelectorAll('input[name="module-assign-client"]:checked:not(:disabled)')).map(cb => cb.value);

        if (selectedClients.length === 0) {
            alert('Please select at least one client to assign this module.');
            return;
        }

        const btn = document.getElementById('assign-module-btn');
        btn.disabled = true;
        btn.textContent = 'Assigning...';

        try {
            // Assign to each selected client
            for (const clientId of selectedClients) {
                await FirebaseDB.grantUnlock(clientId, [moduleId], currentUser.uid, 'Assigned from module detail');
            }

            closeModal('module-detail-modal');
            alert(`Module assigned to ${selectedClients.length} client(s) successfully!`);
            loadUnlocks(); // Refresh the unlocks list
        } catch (error) {
            console.error('Error assigning module:', error);
            alert('Error assigning module. Please try again.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Assign Module';
        }
    }

    // Load unlocks / assign modules section
    async function loadUnlocks() {
        // Render all available modules grid
        renderAllModulesGrid();

        // Load assignment history
        const container = document.getElementById('unlocks-list');

        // Get all unlocks
        const snapshot = await db.collection('unlocks')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();

        if (snapshot.empty) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 30px;">
                    <p style="color: var(--text-light);">No modules have been assigned yet.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Modules</th>
                    <th>Granted</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>`;

        for (const doc of snapshot.docs) {
            const unlock = { id: doc.id, ...doc.data() };
            const client = await FirebaseDB.getUserProfile(unlock.userId);
            const granted = unlock.createdAt?.toDate()?.toLocaleDateString() || 'N/A';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${client?.email || ''}</div>
                    </td>
                    <td>${unlock.modules?.join(', ') || '-'}</td>
                    <td>${granted}</td>
                    <td>${unlock.notes || '-'}</td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Unlock modal
    async function showUnlockModal() {
        const select = document.getElementById('unlock-client');
        const clients = await FirebaseDB.getAllUsers();

        select.innerHTML = '<option value="">Select a client</option>' +
            clients.map(c => `<option value="${c.id}">${c.displayName || c.email}</option>`).join('');

        document.querySelectorAll('input[name="unlock-modules"]').forEach(cb => cb.checked = false);
        document.getElementById('unlock-notes').value = '';

        document.getElementById('unlock-modal').classList.add('active');
    }

    async function grantUnlock() {
        const clientId = document.getElementById('unlock-client').value;
        const modules = Array.from(document.querySelectorAll('input[name="unlock-modules"]:checked')).map(cb => cb.value);
        const notes = document.getElementById('unlock-notes').value;

        if (!clientId || modules.length === 0) {
            alert('Please select a client and at least one module.');
            return;
        }

        await FirebaseDB.grantUnlock(clientId, modules, currentUser.uid, notes);

        closeModal('unlock-modal');
        loadUnlocks();
        alert('Access granted successfully!');
    }

    // ========== QUESTIONNAIRE FUNCTIONS ==========

    // Load questionnaires section
    async function loadQuestionnaires() {
        renderQuestionnairesGrid();
        await loadPendingQuestionnaires();
        await loadQuestionnaireResults();
    }

    // Render available questionnaires grid
    function renderQuestionnairesGrid() {
        const container = document.getElementById('questionnaires-grid');
        if (!container || !window.Questionnaires) return;

        const instruments = Questionnaires.getAllInstruments();

        const categoryColors = {
            'Insomnia': '#5c6bc0',
            'Sleepiness': '#26a69a',
            'Sleep Apnea': '#ef5350',
            'Mood': '#ab47bc'
        };

        let html = '';
        for (const inst of instruments) {
            const catColor = categoryColors[inst.category] || 'var(--gold)';
            html += `
                <div onclick="openQuestionnaireDetail('${inst.id}')" style="background: white; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.04);" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 6px 16px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.04)';">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <span style="background: ${catColor}; color: white; font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 500;">${inst.category}</span>
                        <span style="font-size: 11px; color: var(--text-light);">${inst.timeToComplete}</span>
                    </div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--navy); margin: 0 0 6px 0;">${inst.name}</h4>
                    <p style="font-size: 11px; color: var(--gold-dark); margin: 0 0 10px 0;">${inst.shortName}</p>
                    <p style="font-size: 13px; color: var(--text-light); margin: 0; line-height: 1.5;">${inst.description}</p>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(201, 169, 98, 0.1);">
                        <span style="font-size: 11px; color: var(--text-light);">${inst.questions.length} questions</span>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // Open questionnaire detail (for now just show assign modal)
    function openQuestionnaireDetail(instrumentId) {
        console.log('openQuestionnaireDetail called with:', instrumentId);
        showAssignQuestionnaireModal(instrumentId);
    }

    // Load pending questionnaire assignments
    async function loadPendingQuestionnaires() {
        const container = document.getElementById('pending-questionnaires-list');

        try {
            // Get all pending questionnaire assignments
            const snapshot = await db.collection('questionnaireAssignments')
                .where('status', '==', 'pending')
                .orderBy('dueDate', 'asc')
                .get();

            if (snapshot.empty) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-light);">
                        <p>No pending questionnaire assignments.</p>
                    </div>
                `;
                return;
            }

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Questionnaire</th>
                        <th>Due Date</th>
                        <th>Assigned</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>`;

            snapshot.forEach(doc => {
                const data = doc.data();
                const dueDate = data.dueDate?.toDate?.();
                const assignedDate = data.createdAt?.toDate?.();
                const isOverdue = dueDate && dueDate < new Date();

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${data.userName || 'Unknown'}</div>
                            <div class="client-email">${data.userEmail || ''}</div>
                        </td>
                        <td><strong>${data.questionnaireName || data.questionnaireId}</strong></td>
                        <td style="color: ${isOverdue ? '#c62828' : 'inherit'}; font-weight: ${isOverdue ? '600' : 'normal'};">
                            ${dueDate ? dueDate.toLocaleDateString() : 'No due date'}
                            ${isOverdue ? ' <span style="font-size: 10px;">(Overdue)</span>' : ''}
                        </td>
                        <td>${assignedDate ? assignedDate.toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <span style="background: #fff3e0; color: #ef6c00; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">Pending</span>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Update badge
            updateQuestionnairesBadge(snapshot.size);
        } catch (error) {
            console.error('Error loading pending questionnaires:', error);
            container.innerHTML = '<p style="color: red;">Error loading pending questionnaires</p>';
        }
    }

    // Load completed questionnaire results
    async function loadQuestionnaireResults() {
        const container = document.getElementById('questionnaire-results-list');

        try {
            const results = await FirebaseDB.getRecentCompletedQuestionnaires(20);

            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-light);">
                        <p>No completed questionnaires yet.</p>
                    </div>
                `;
                return;
            }

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Questionnaire</th>
                        <th>Score</th>
                        <th>Interpretation</th>
                        <th>Completed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const result of results) {
                const completedDate = result.completedAt?.toDate?.();

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${result.userName || 'Unknown'}</div>
                            <div class="client-email">${result.userEmail || ''}</div>
                        </td>
                        <td><strong>${result.questionnaireName || result.questionnaireId}</strong></td>
                        <td style="font-weight: 600; font-size: 16px;">${result.score}/${result.maxScore}</td>
                        <td>
                            <span style="background: ${result.color || '#666'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                ${result.interpretation || 'N/A'}
                            </span>
                        </td>
                        <td>${completedDate ? completedDate.toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <button onclick="viewQuestionnaireResult('${result.id}')" class="action-btn action-btn-secondary" style="padding: 6px 12px; font-size: 11px;">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading questionnaire results:', error);
            container.innerHTML = '<p style="color: red;">Error loading results</p>';
        }
    }

    // Update questionnaires badge
    function updateQuestionnairesBadge(count) {
        const badge = document.getElementById('questionnaires-badge');
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-flex';
        } else {
            badge.style.display = 'none';
        }
    }

    // Show assign questionnaire modal
    async function showAssignQuestionnaireModal(preselectedId = null) {
        const select = document.getElementById('questionnaire-select');
        const clientsContainer = document.getElementById('questionnaire-clients-list');
        const preview = document.getElementById('questionnaire-preview');

        // Populate questionnaire options
        const instruments = Questionnaires.getAllInstruments();
        select.innerHTML = '<option value="">Choose a questionnaire...</option>' +
            instruments.map(inst => `<option value="${inst.id}">${inst.name} (${inst.shortName})</option>`).join('');

        // Set preselected if provided
        if (preselectedId) {
            select.value = preselectedId;
            updateQuestionnairePreview();
        } else {
            preview.style.display = 'none';
        }

        // Add change listener for preview
        select.onchange = updateQuestionnairePreview;

        // Set default due date to 7 days from now
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 7);
        document.getElementById('questionnaire-due-date').value = dueDate.toISOString().split('T')[0];

        // Clear notes
        document.getElementById('questionnaire-notes').value = '';

        // Load clients
        const clients = await FirebaseDB.getAllUsers();
        clientsContainer.innerHTML = clients.map(c => `
            <label style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                <input type="checkbox" name="questionnaire-clients" value="${c.id}" data-name="${c.displayName || c.email}" data-email="${c.email || ''}">
                <div>
                    <div style="font-size: 13px; font-weight: 500; color: var(--navy);">${c.displayName || 'Unnamed'}</div>
                    <div style="font-size: 11px; color: var(--text-light);">${c.email || ''}</div>
                </div>
            </label>
        `).join('');

        document.getElementById('assign-questionnaire-modal').classList.add('active');
    }

    // Update questionnaire preview in modal
    function updateQuestionnairePreview() {
        const select = document.getElementById('questionnaire-select');
        const preview = document.getElementById('questionnaire-preview');
        const inst = Questionnaires.getInstrument(select.value);

        if (inst) {
            document.getElementById('qp-time').textContent = inst.timeToComplete;
            document.getElementById('qp-category').textContent = inst.category;
            document.getElementById('qp-description').textContent = inst.description;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    // Assign questionnaire to selected clients
    async function assignQuestionnaireToClients() {
        const questionnaireId = document.getElementById('questionnaire-select').value;
        const selectedCheckboxes = document.querySelectorAll('input[name="questionnaire-clients"]:checked');
        const dueDate = document.getElementById('questionnaire-due-date').value;
        const notes = document.getElementById('questionnaire-notes').value;

        if (!questionnaireId) {
            alert('Please select a questionnaire.');
            return;
        }

        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one client.');
            return;
        }

        const instrument = Questionnaires.getInstrument(questionnaireId);

        try {
            for (const cb of selectedCheckboxes) {
                await FirebaseDB.assignQuestionnaire(
                    cb.value,
                    cb.dataset.name,
                    cb.dataset.email,
                    questionnaireId,
                    instrument.name,
                    dueDate ? new Date(dueDate) : null,
                    notes
                );
            }

            closeModal('assign-questionnaire-modal');
            alert(`Questionnaire assigned to ${selectedCheckboxes.length} client(s) successfully!`);
            loadQuestionnaires();
        } catch (error) {
            console.error('Error assigning questionnaire:', error);
            alert('Error assigning questionnaire. Please try again.');
        }
    }

    // View questionnaire result details
    async function viewQuestionnaireResult(resultId) {
        try {
            const doc = await db.collection('questionnaireResults').doc(resultId).get();
            if (!doc.exists) {
                alert('Result not found');
                return;
            }

            const result = doc.data();
            const answers = result.answers || [];

            // Build details string
            let details = `Client: ${result.userName || 'Unknown'}\n`;
            details += `Questionnaire: ${result.questionnaireName || result.questionnaireId}\n`;
            details += `Completed: ${result.completedAt?.toDate?.().toLocaleString() || 'N/A'}\n\n`;
            details += `SCORE: ${result.score}/${result.maxScore}\n`;
            details += `Interpretation: ${result.interpretation || 'N/A'}\n`;
            details += `Severity: ${result.severity || 'N/A'}\n\n`;
            details += `Individual Responses:\n`;

            const instrument = Questionnaires.getInstrument(result.questionnaireId);
            if (instrument) {
                answers.forEach((ans, i) => {
                    const q = instrument.questions[i];
                    const option = q?.options?.find(o => o.value === ans.value);
                    details += `Q${i + 1}: ${option?.label || ans.value} (${ans.value})\n`;
                });
            }

            alert(details);
        } catch (error) {
            console.error('Error loading result:', error);
            alert('Error loading result details.');
        }
    }

    // ========== END QUESTIONNAIRE FUNCTIONS ==========

    // ========== NOTIFICATION FUNCTIONS ==========

    let notificationsVisible = false;

    async function loadNotifications() {
        try {
            const notifications = await FirebaseDB.getUnreadNotifications(currentUser.uid);

            // Update count badge
            const countEl = document.getElementById('notification-count');
            if (notifications.length > 0) {
                countEl.textContent = notifications.length;
                countEl.style.display = 'inline-flex';
            } else {
                countEl.style.display = 'none';
            }

            // Update dropdown
            const container = document.getElementById('notifications-list');
            if (notifications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px; font-size: 14px;">No new notifications</p>';
                return;
            }

            container.innerHTML = notifications.map(n => {
                const time = n.createdAt?.toDate?.();
                const timeAgo = time ? formatTimeAgo(time) : '';
                const iconColor = n.type === 'questionnaire_completed' ? '#2e7d32' : 'var(--gold)';

                return `
                    <div style="padding: 12px 20px; border-bottom: 1px solid rgba(201, 169, 98, 0.1); display: flex; gap: 12px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8f6f3'" onmouseout="this.style.background=''" onclick="handleNotificationClick('${n.id}', '${n.type}')">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: ${iconColor}15; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2">
                                ${n.type === 'questionnaire_completed' ?
                                    '<path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>' :
                                    '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>'}
                            </svg>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 500; color: var(--navy); margin-bottom: 3px;">${n.title}</div>
                            <div style="font-size: 12px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${n.message}</div>
                            <div style="font-size: 11px; color: var(--gold-dark); margin-top: 4px;">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    function toggleNotifications() {
        const dropdown = document.getElementById('notifications-dropdown');
        notificationsVisible = !notificationsVisible;
        dropdown.style.display = notificationsVisible ? 'block' : 'none';

        if (notificationsVisible) {
            loadNotifications();
        }
    }

    async function handleNotificationClick(notificationId, type) {
        // Mark as read
        await FirebaseDB.markNotificationRead(notificationId);

        // Navigate based on type
        if (type === 'questionnaire_completed') {
            toggleNotifications();
            showSection('questionnaires');
        }

        loadNotifications();
    }

    async function markAllNotificationsRead() {
        try {
            const notifications = await FirebaseDB.getUnreadNotifications(currentUser.uid);
            for (const n of notifications) {
                await FirebaseDB.markNotificationRead(n.id);
            }
            loadNotifications();
        } catch (error) {
            console.error('Error marking notifications as read:', error);
        }
    }

    // Close notifications when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('notifications-dropdown');
        const bell = document.getElementById('notification-bell');
        if (notificationsVisible && !dropdown?.contains(e.target) && !bell?.contains(e.target)) {
            notificationsVisible = false;
            dropdown.style.display = 'none';
        }
    });

    // ========== END NOTIFICATION FUNCTIONS ==========

    // View assessment details
    function viewAssessment(assessmentId) {
        const assessment = allAssessments.find(a => a.id === assessmentId);
        if (!assessment) return;

        alert('Assessment Details:\n\n' +
            'Overall Score: ' + (assessment.overallScore || 'N/A') + '/100\n' +
            'ESS Score: ' + (assessment.scores?.ess || 'N/A') + '\n' +
            'ISI Score: ' + (assessment.scores?.isi || 'N/A') + '\n' +
            'STOP-BANG Score: ' + (assessment.scores?.stopbang || 'N/A') + '\n\n' +
            'Key Findings:\n' + (assessment.findings?.join('\n') || 'None'));
    }

    // Current client being viewed
    let currentViewedClient = null;

    async function viewClient(clientId) {
        console.log('viewClient called with:', clientId);
        console.log('allClients:', allClients);

        let client = allClients.find(c => c.id === clientId);

        // If not in cache, fetch directly
        if (!client) {
            console.log('Client not in cache, fetching from database...');
            try {
                const profile = await FirebaseDB.getUserProfile(clientId);
                if (profile) {
                    client = { id: clientId, ...profile };
                }
            } catch (error) {
                console.error('Error fetching client:', error);
            }
        }

        if (!client) {
            console.error('Client not found:', clientId);
            alert('Error: Client not found');
            return;
        }

        currentViewedClient = client;

        // Update profile header
        const initials = (client.displayName || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        document.getElementById('client-avatar').textContent = initials;
        document.getElementById('client-name').textContent = client.displayName || 'Unknown';
        document.getElementById('client-type-badge').textContent = client.clientType || 'Client';
        document.getElementById('client-email').textContent = client.email || '';
        document.getElementById('client-joined').textContent = 'Joined: ' + (client.createdAt?.toDate?.() ? client.createdAt.toDate().toLocaleDateString() : 'Unknown');

        // Show client detail section first so user sees immediate feedback
        showSection('client-detail');

        // Load all client data
        try {
            await Promise.all([
                loadClientAssessment(clientId),
                loadClientActions(clientId),
                loadClientMessages(clientId),
                loadClientModules(clientId)
            ]);
        } catch (error) {
            console.error('Error loading client data:', error);
        }
    }

    async function loadClientAssessment(clientId) {
        const summaryContainer = document.getElementById('assessment-summary');
        const noAssessmentNotice = document.getElementById('no-assessment-notice');
        const findingsCard = document.getElementById('findings-card');
        const findingsList = document.getElementById('findings-list');

        // Find assessment for this client
        const assessment = allAssessments.find(a => a.userId === clientId);

        if (!assessment) {
            summaryContainer.innerHTML = '';
            noAssessmentNotice.style.display = 'block';
            findingsCard.style.display = 'none';
            return;
        }

        noAssessmentNotice.style.display = 'none';

        // Build score cards
        const scores = assessment.scores || {};
        const overallScore = assessment.overallScore || 0;

        const getScoreColor = (score, type) => {
            if (type === 'ess') {
                if (score <= 10) return '#2e7d32';
                if (score <= 15) return '#ed6c02';
                return '#d32f2f';
            }
            if (type === 'isi') {
                if (score <= 7) return '#2e7d32';
                if (score <= 14) return '#ed6c02';
                if (score <= 21) return '#ed6c02';
                return '#d32f2f';
            }
            if (type === 'stopbang') {
                if (score <= 2) return '#2e7d32';
                if (score <= 4) return '#ed6c02';
                return '#d32f2f';
            }
            if (type === 'overall') {
                if (score >= 70) return '#2e7d32';
                if (score >= 50) return '#ed6c02';
                return '#d32f2f';
            }
            return '#666';
        };

        const getScoreLabel = (score, type) => {
            if (type === 'ess') {
                if (score <= 10) return 'Normal';
                if (score <= 15) return 'Moderate';
                return 'Severe';
            }
            if (type === 'isi') {
                if (score <= 7) return 'Normal';
                if (score <= 14) return 'Subthreshold';
                if (score <= 21) return 'Moderate';
                return 'Severe';
            }
            if (type === 'stopbang') {
                if (score <= 2) return 'Low Risk';
                if (score <= 4) return 'Intermediate';
                return 'High Risk';
            }
            return '';
        };

        summaryContainer.innerHTML = `
            <div style="background: linear-gradient(135deg, ${getScoreColor(overallScore, 'overall')}22 0%, ${getScoreColor(overallScore, 'overall')}11 100%); border: 1px solid ${getScoreColor(overallScore, 'overall')}33; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: ${getScoreColor(overallScore, 'overall')};">${overallScore}</div>
                <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">Overall Score</div>
            </div>
            <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: ${getScoreColor(scores.ess || 0, 'ess')};">${scores.ess ?? 'N/A'}</div>
                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">ESS</div>
                <div style="font-size: 12px; color: ${getScoreColor(scores.ess || 0, 'ess')}; margin-top: 4px;">${getScoreLabel(scores.ess || 0, 'ess')}</div>
            </div>
            <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: ${getScoreColor(scores.isi || 0, 'isi')};">${scores.isi ?? 'N/A'}</div>
                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">ISI</div>
                <div style="font-size: 12px; color: ${getScoreColor(scores.isi || 0, 'isi')}; margin-top: 4px;">${getScoreLabel(scores.isi || 0, 'isi')}</div>
            </div>
            <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: ${getScoreColor(scores.stopbang || 0, 'stopbang')};">${scores.stopbang ?? 'N/A'}</div>
                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">STOP-BANG</div>
                <div style="font-size: 12px; color: ${getScoreColor(scores.stopbang || 0, 'stopbang')}; margin-top: 4px;">${getScoreLabel(scores.stopbang || 0, 'stopbang')}</div>
            </div>
        `;

        // Show findings
        const findings = assessment.findings || [];
        if (findings.length > 0) {
            findingsCard.style.display = 'block';
            findingsList.innerHTML = findings.map(f => `<li style="margin-bottom: 8px;">${f}</li>`).join('');
        } else {
            findingsCard.style.display = 'none';
        }
    }

    async function loadClientActions(clientId) {
        const container = document.getElementById('actions-list');

        try {
            const snapshot = await db.collection('users').doc(clientId).collection('actions').get();

            if (snapshot.empty) {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No actions yet. Add next steps for this client.</p>';
                return;
            }

            const actions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            actions.sort((a, b) => {
                const priorityOrder = { high: 0, normal: 1, low: 2 };
                return (priorityOrder[a.priority] || 1) - (priorityOrder[b.priority] || 1);
            });

            container.innerHTML = actions.map(action => {
                const priorityColors = { high: '#d32f2f', normal: '#0f1c2e', low: '#666' };
                const priorityColor = priorityColors[action.priority] || '#0f1c2e';
                const isCompleted = action.completed;
                const dueDate = action.dueDate ? new Date(action.dueDate).toLocaleDateString() : '';

                return `
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid #eee; ${isCompleted ? 'opacity: 0.6;' : ''}">
                        <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleAction('${clientId}', '${action.id}', this.checked)"
                            style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer; accent-color: var(--gold);">
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: ${priorityColor}; ${isCompleted ? 'text-decoration: line-through;' : ''}">${action.text}</div>
                            ${dueDate ? `<div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">Due: ${dueDate}</div>` : ''}
                        </div>
                        ${action.priority === 'high' ? '<span style="background: #d32f2f22; color: #d32f2f; font-size: 10px; padding: 2px 8px; border-radius: 10px;">HIGH</span>' : ''}
                        <button onclick="deleteAction('${clientId}', '${action.id}')" style="background: none; border: none; color: #999; cursor: pointer; font-size: 18px;">&times;</button>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading actions:', error);
            container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">Error loading actions</p>';
        }
    }

    async function loadClientMessages(clientId) {
        const container = document.getElementById('recent-messages');

        try {
            // Find conversation with this client
            const snapshot = await db.collection('conversations')
                .where('participants', 'array-contains', currentUser.uid)
                .get();

            const conversation = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .find(conv => conv.participants.includes(clientId));

            if (!conversation) {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No messages yet</p>';
                return;
            }

            // Get recent messages
            const messagesSnapshot = await db.collection('conversations').doc(conversation.id)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(3)
                .get();

            if (messagesSnapshot.empty) {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No messages yet</p>';
                return;
            }

            const messages = messagesSnapshot.docs.map(doc => doc.data()).reverse();

            container.innerHTML = messages.map(msg => {
                const isAdmin = msg.senderId === currentUser.uid;
                const time = msg.timestamp?.toDate?.();
                const timeStr = time ? formatTimeAgo(time) : '';

                return `
                    <div style="display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="width: 32px; height: 32px; background: ${isAdmin ? 'var(--gold)' : 'var(--navy)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; flex-shrink: 0;">
                            ${isAdmin ? 'You' : currentViewedClient?.displayName?.charAt(0) || '?'}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: var(--navy);">${msg.text}</div>
                            <div style="font-size: 11px; color: var(--text-light); margin-top: 4px;">${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading messages:', error);
            container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">Error loading messages</p>';
        }
    }

    function formatTimeAgo(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);

        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
        if (diff < 86400) return Math.floor(diff / 3600) + ' hr ago';
        if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
        return date.toLocaleDateString();
    }

    async function loadClientModules(clientId) {
        const container = document.getElementById('client-modules');

        const moduleNames = {
            'sleep-hygiene': 'Sleep Hygiene',
            'breathing-478': '4-7-8 Breathing',
            'pmr': 'Progressive Muscle Relaxation',
            'cbti-restriction': 'CBT-I: Sleep Restriction',
            'cbti-stimulus': 'CBT-I: Stimulus Control',
            'cbti-cognitive': 'CBT-I: Cognitive Restructuring',
            'sleep-diary': 'Interactive Sleep Diary',
            'mindfulness-bodyscan': 'Mindfulness & Body Scan',
            'paradoxical-intention': 'Paradoxical Intention',
            'worry-management': 'Worry Management',
            'circadian-rhythm': 'Circadian Rhythm',
            'guided-imagery': 'Guided Imagery',
            'autogenic-training': 'Autogenic Training'
        };

        const allModuleIds = Object.keys(moduleNames);

        try {
            const snapshot = await db.collection('unlocks')
                .where('userId', '==', clientId)
                .get();

            const unlocks = snapshot.docs.map(doc => doc.data());
            const assignedModules = unlocks.flatMap(u => u.modules || []);
            const uniqueAssigned = [...new Set(assignedModules)];

            // Show all modules with assigned/unassigned status
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                    ${allModuleIds.map(m => {
                        const isAssigned = uniqueAssigned.includes(m) || m === 'sleep-hygiene';
                        const isFree = m === 'sleep-hygiene';
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; background: ${isAssigned ? '#f0f9f0' : '#fafafa'}; border: 1px solid ${isAssigned ? 'rgba(46, 125, 50, 0.2)' : 'rgba(0,0,0,0.06)'};">
                                ${isAssigned ?
                                    `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>` :
                                    `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`
                                }
                                <span style="font-size: 12px; color: ${isAssigned ? '#2e7d32' : 'var(--text-light)'}; font-weight: ${isAssigned ? '500' : '400'};">
                                    ${moduleNames[m]}${isFree ? ' <span style="font-size: 10px; opacity: 0.7;">(Free)</span>' : ''}
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
                <p style="font-size: 12px; color: var(--text-light); margin-top: 15px; text-align: center;">
                    ${uniqueAssigned.length} of ${allModuleIds.length} modules assigned
                </p>
            `;
        } catch (error) {
            console.error('Error loading modules:', error);
            container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">Error loading modules</p>';
        }
    }

    // Action management
    function showAddActionModal() {
        document.getElementById('action-text').value = '';
        document.getElementById('action-priority').value = 'normal';
        document.getElementById('action-due').value = '';
        document.getElementById('action-modal').style.display = 'flex';
    }

    async function addClientAction() {
        if (!currentViewedClient) return;

        const text = document.getElementById('action-text').value.trim();
        const priority = document.getElementById('action-priority').value;
        const dueDate = document.getElementById('action-due').value;

        if (!text) {
            alert('Please enter an action description.');
            return;
        }

        try {
            await db.collection('users').doc(currentViewedClient.id).collection('actions').add({
                text,
                priority,
                dueDate: dueDate || null,
                completed: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            });

            closeModal('action-modal');
            loadClientActions(currentViewedClient.id);
        } catch (error) {
            console.error('Error adding action:', error);
            alert('Error adding action. Please try again.');
        }
    }

    async function toggleAction(clientId, actionId, completed) {
        try {
            await db.collection('users').doc(clientId).collection('actions').doc(actionId).update({
                completed,
                completedAt: completed ? firebase.firestore.FieldValue.serverTimestamp() : null
            });
            loadClientActions(clientId);
        } catch (error) {
            console.error('Error toggling action:', error);
        }
    }

    async function deleteAction(clientId, actionId) {
        if (!confirm('Delete this action?')) return;

        try {
            await db.collection('users').doc(clientId).collection('actions').doc(actionId).delete();
            loadClientActions(clientId);
        } catch (error) {
            console.error('Error deleting action:', error);
        }
    }

    // Open chat with current client
    function openClientChat() {
        if (!currentViewedClient) return;

        // Switch to messages section and open chat with this client
        showSection('messages');
        setTimeout(() => {
            openConversation(currentViewedClient.id, currentViewedClient.displayName, currentViewedClient.displayName?.charAt(0) || '?');
        }, 100);
    }

    // Unlock module for current client
    async function showUnlockModuleForClient() {
        if (!currentViewedClient) return;

        // Pre-select the current client in the unlock modal
        const select = document.getElementById('unlock-client');
        const clients = await FirebaseDB.getAllUsers();

        select.innerHTML = '<option value="">Select a client</option>' +
            clients.map(c => `<option value="${c.id}" ${c.id === currentViewedClient.id ? 'selected' : ''}>${c.displayName || c.email}</option>`).join('');

        document.querySelectorAll('input[name="unlock-modules"]').forEach(cb => cb.checked = false);
        document.getElementById('unlock-notes').value = '';

        document.getElementById('unlock-modal').classList.add('active');
    }

    // Modal functions
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
        modal.classList.remove('active');
    }

    // Logout
    async function handleLogout() {
        await auth.signOut();
        window.location.href = '../auth.html';
    }

    // Close modals on outside click
    ['invite-modal', 'action-modal'].forEach(modalId => {
        document.getElementById(modalId).addEventListener('click', (e) => {
            if (e.target.id === modalId) {
                e.target.style.display = 'none';
            }
        });
    });

    // Close other modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
                overlay.classList.remove('active');
            }
        });
    });
</script>

</body>
</html>
