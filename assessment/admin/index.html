<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sleep Wellness</title>
    <link rel="stylesheet" href="../styles.css">
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --deep-navy: #0f1c2e;
            --navy: #1a2a3a;
            --navy-light: #2a3a4a;
            --gold: #C9A962;
            --gold-light: #d4b978;
            --gold-dark: #9a7b3c;
            --cream: #FAF8F5;
            --text-light: #6b7b8a;
            --success: #2e7d32;
            --warning: #ed6c02;
            --danger: #d32f2f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--cream);
            min-height: 100vh;
        }

        /* Admin Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 280px;
            background: var(--deep-navy);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 11px;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            padding: 0 15px;
            margin-bottom: 10px;
        }

        .nav-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            padding: 10px;
            margin-top: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--gold);
            color: var(--deep-navy);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding: 20px 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--deep-navy);
        }

        .admin-name {
            font-size: 14px;
            font-weight: 500;
        }

        .admin-role {
            font-size: 11px;
            color: var(--gold);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            color: var(--navy);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            color: var(--navy);
            font-weight: 600;
        }

        .stat-change {
            font-size: 12px;
            color: var(--success);
            margin-top: 5px;
        }

        /* Data Table */
        .data-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-card-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            color: var(--navy);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 15px 25px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-table td {
            padding: 18px 25px;
            font-size: 14px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(201, 169, 98, 0.05);
        }

        .client-name {
            font-weight: 500;
            color: var(--navy);
        }

        .client-email {
            font-size: 12px;
            color: var(--text-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 20px;
        }

        .badge-athlete { background: rgba(42, 139, 139, 0.1); color: #2A8B8B; }
        .badge-executive { background: rgba(74, 96, 133, 0.1); color: #4A6085; }
        .badge-hotel { background: rgba(139, 77, 92, 0.1); color: #8B4D5C; }
        .badge-pending { background: rgba(237, 108, 2, 0.1); color: var(--warning); }
        .badge-confirmed { background: rgba(46, 125, 50, 0.1); color: var(--success); }
        .badge-cancelled { background: rgba(211, 47, 47, 0.1); color: var(--danger); }
        .badge-unused { background: rgba(46, 125, 50, 0.1); color: var(--success); }
        .badge-used { background: rgba(107, 123, 138, 0.1); color: var(--text-light); }

        .action-btn {
            padding: 8px 16px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .action-btn-primary {
            background: var(--gold);
            color: var(--deep-navy);
        }

        .action-btn-primary:hover {
            background: var(--gold-light);
        }

        .action-btn-secondary {
            background: var(--navy);
            color: white;
        }

        .action-btn-secondary:hover {
            background: var(--navy-light);
        }

        .action-btn-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .action-btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* Admin Section */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            font-size: 14px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-family: 'Montserrat', sans-serif;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Invite Code Display */
        .invite-code-display {
            background: var(--cream);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
        }

        .invite-code-value {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            font-weight: bold;
            color: var(--navy);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .copy-btn {
            padding: 8px 20px;
            background: var(--navy);
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--navy-light);
        }

        /* Messages Section */
        .conversations-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: rgba(201, 169, 98, 0.05);
        }

        .conversation-avatar {
            width: 45px;
            height: 45px;
            background: var(--navy);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .conversation-preview {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-light);
        }

        .conversation-unread {
            width: 10px;
            height: 10px;
            background: var(--gold);
            border-radius: 50%;
        }

        /* Chat View */
        .chat-container {
            display: none;
            height: 70vh;
            flex-direction: column;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .chat-back {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 14px;
        }

        .message.received .message-content {
            background: rgba(0,0,0,0.05);
            color: var(--navy);
        }

        .message.sent .message-content {
            background: var(--navy);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
            text-align: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            padding: 20px 25px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .chat-input input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .chat-input button {
            padding: 14px 25px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        /* Assessment View */
        .assessment-detail {
            padding: 25px;
        }

        .assessment-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: var(--cream);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .score-card-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .score-card-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 600;
        }

        .score-card-value.good { color: var(--success); }
        .score-card-value.moderate { color: var(--warning); }
        .score-card-value.poor { color: var(--danger); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 10px;
        }

        /* Search & Filter */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .filter-select {
            padding: 12px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            min-width: 150px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 70px;
            }

            .sidebar-header,
            .sidebar-footer,
            .nav-section-title {
                display: none;
            }

            .nav-item span:not(.badge) {
                display: none;
            }

            .nav-item {
                justify-content: center;
                padding: 15px;
            }

            .admin-main {
                margin-left: 70px;
            }
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                display: none;
            }

            .admin-main {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>

<div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">SLEEP WELLNESS</div>
            <div class="sidebar-subtitle">Admin Portal</div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <a class="nav-item active" onclick="showSection('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Clients</div>
                <a class="nav-item" onclick="showSection('clients')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>All Clients</span>
                </a>
                <a class="nav-item" onclick="showSection('assessments')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <span>Assessments</span>
                </a>
                <a class="nav-item" onclick="showSection('invites')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span>Invite Codes</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Communication</div>
                <a class="nav-item" onclick="showSection('messages')" id="nav-messages">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Messages</span>
                </a>
                <a class="nav-item" onclick="showSection('appointments')" id="nav-appointments">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>Appointments</span>
                    <span class="badge" id="pending-badge" style="display: none;">0</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Content</div>
                <a class="nav-item" onclick="showSection('unlocks')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
                    </svg>
                    <span>Module Unlocks</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div>
                    <div class="admin-name" id="adminName">Admin</div>
                    <div class="admin-role">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Dashboard Section -->
        <section class="admin-section active" id="section-dashboard">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Welcome back, Dr. Alen</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('clients')">
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-value" id="stat-clients">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('assessments')">
                    <div class="stat-label">Assessments</div>
                    <div class="stat-value" id="stat-assessments">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('appointments')">
                    <div class="stat-label">Pending Appointments</div>
                    <div class="stat-value" id="stat-pending">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('invites')">
                    <div class="stat-label">Active Invite Codes</div>
                    <div class="stat-value" id="stat-invites">0</div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header">
                    <h2 class="data-card-title">Recent Assessments</h2>
                    <button class="action-btn action-btn-secondary" onclick="showSection('assessments')">View All</button>
                </div>
                <div id="recent-assessments">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header">
                    <h2 class="data-card-title">Pending Appointments</h2>
                    <button class="action-btn action-btn-secondary" onclick="showSection('appointments')">View All</button>
                </div>
                <div id="pending-appointments">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Clients Section -->
        <section class="admin-section" id="section-clients">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Clients</h1>
                    <p class="page-subtitle">Manage your client accounts</p>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search clients..." id="client-search" oninput="filterClients()">
                <select class="filter-select" id="client-filter" onchange="filterClients()">
                    <option value="">All Types</option>
                    <option value="athlete">Athletes</option>
                    <option value="executive">Executives</option>
                    <option value="hotel">Travelers</option>
                </select>
            </div>

            <div class="data-card">
                <div id="clients-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Assessments Section -->
        <section class="admin-section" id="section-assessments">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Assessments</h1>
                    <p class="page-subtitle">View all client assessments</p>
                </div>
            </div>

            <div class="data-card">
                <div id="assessments-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Invite Codes Section -->
        <section class="admin-section" id="section-invites">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Invite Codes</h1>
                    <p class="page-subtitle">Generate and manage client invitations</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showGenerateInviteModal()">
                    Generate New Code
                </button>
            </div>

            <div class="data-card">
                <div id="invites-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Messages Section -->
        <section class="admin-section" id="section-messages">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Messages</h1>
                    <p class="page-subtitle">Communicate with your clients</p>
                </div>
            </div>

            <div class="data-card">
                <div class="conversations-list" id="conversations-list">
                    <div class="loading">Loading...</div>
                </div>
                <div class="chat-container" id="chat-container">
                    <div class="chat-header">
                        <button class="chat-back" onclick="closeChat()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <div class="conversation-avatar" id="chat-avatar">?</div>
                        <div class="conversation-name" id="chat-name">Client</div>
                    </div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleMessageKeypress(event)">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Appointments Section -->
        <section class="admin-section" id="section-appointments">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Appointments</h1>
                    <p class="page-subtitle">Manage consultation requests</p>
                </div>
            </div>

            <div class="data-card">
                <div id="appointments-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Module Unlocks Section -->
        <section class="admin-section" id="section-unlocks">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Module Unlocks</h1>
                    <p class="page-subtitle">Grant therapeutic content access to clients</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showUnlockModal()">
                    Grant Access
                </button>
            </div>

            <div class="data-card">
                <div id="unlocks-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Generate Invite Modal -->
<div id="invite-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Generate Invite Code</h2>
            <button onclick="closeModal('invite-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div id="invite-form-view">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Client Email (optional)</label>
                <input type="email" id="invite-email" placeholder="client@email.com" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Notes</label>
                <textarea id="invite-notes" rows="3" placeholder="Any notes about this invite..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal('invite-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button onclick="generateInviteCode()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Generate Code</button>
            </div>
        </div>

        <div id="invite-result-view" style="display: none;">
            <p style="text-align: center; margin-bottom: 10px; color: #666;">Share this code with your client:</p>
            <div style="background: #f5f5f5; padding: 20px; text-align: center; border-radius: 8px; margin: 20px 0;">
                <div id="generated-code" style="font-family: 'Courier New', monospace; font-size: 28px; font-weight: bold; color: #0f1c2e; letter-spacing: 2px; margin-bottom: 15px;">SW-XXXX-XXXX</div>
                <button onclick="copyInviteCode()" style="padding: 10px 20px; background: #0f1c2e; color: white; border: none; cursor: pointer; border-radius: 4px;">Copy Code</button>
            </div>

            <!-- Email Section -->
            <div id="email-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="font-size: 14px; color: #0f1c2e; font-weight: 500; margin-bottom: 15px; text-align: center;">Send Welcome Email to Client</p>
                <div id="email-preview" style="background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 15px; font-size: 13px; line-height: 1.7; color: #333;">
                    <!-- Email preview will be inserted here -->
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="send-email-btn" onclick="sendInviteEmail()" style="padding: 12px 24px; background: #2e7d32; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        Send Email
                    </button>
                </div>
                <p id="email-status" style="text-align: center; margin-top: 10px; font-size: 13px; display: none;"></p>
            </div>

            <p style="font-size: 13px; color: #666; text-align: center; margin-top: 15px;">
                The client will use this code to create their account at:<br>
                <strong id="auth-url"></strong>
            </p>
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button onclick="closeInviteModal()" style="padding: 12px 30px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- Unlock Module Modal -->
<div class="modal-overlay" id="unlock-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Grant Module Access</h2>
            <button class="modal-close" onclick="closeModal('unlock-modal')">&times;</button>
        </div>

        <div class="form-group">
            <label for="unlock-client">Select Client</label>
            <select id="unlock-client">
                <option value="">Loading clients...</option>
            </select>
        </div>

        <div class="form-group">
            <label>Modules to Unlock</label>
            <div style="margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="breathing-478"> 4-7-8 Breathing Technique
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="pmr"> Progressive Muscle Relaxation
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-restriction"> CBT-I: Sleep Restriction
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-stimulus"> CBT-I: Stimulus Control
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-cognitive"> CBT-I: Cognitive Restructuring
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="sleep-diary"> Sleep Diary
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="unlock-notes">Notes</label>
            <textarea id="unlock-notes" rows="2" placeholder="Reason for unlocking..."></textarea>
        </div>

        <div class="form-actions">
            <button class="action-btn action-btn-secondary" onclick="closeModal('unlock-modal')">Cancel</button>
            <button class="action-btn action-btn-primary" onclick="grantUnlock()">Grant Access</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="../firebase-config.js"></script>
<script src="../auth.js"></script>

<script>
    let currentUser = null;
    let allClients = [];
    let allAssessments = [];
    let currentConversation = null;
    let messageListener = null;

    // Check admin access
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = '../auth.html';
            return;
        }

        const profile = await FirebaseDB.getUserProfile(user.uid);
        if (!profile || profile.role !== 'admin') {
            window.location.href = '../account.html';
            return;
        }

        currentUser = user;
        document.getElementById('adminName').textContent = profile.displayName || 'Admin';
        document.getElementById('adminAvatar').textContent = (profile.displayName || 'A')[0].toUpperCase();

        // Load dashboard data
        loadDashboard();
    });

    // Navigate to section (from stat cards)
    function navigateToSection(sectionId) {
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

        // Show section
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + sectionId).classList.add('active');

        // Load section data
        loadSectionData(sectionId);
    }

    // Show section
    function showSection(sectionId) {
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        if (event && event.target) {
            event.target.closest('.nav-item')?.classList.add('active');
        }

        // Show section
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + sectionId).classList.add('active');

        // Load section data
        loadSectionData(sectionId);
    }

    // Load section data
    function loadSectionData(sectionId) {
        switch(sectionId) {
            case 'dashboard': loadDashboard(); break;
            case 'clients': loadClients(); break;
            case 'assessments': loadAssessments(); break;
            case 'invites': loadInvites(); break;
            case 'messages': loadConversations(); break;
            case 'appointments': loadAppointments(); break;
            case 'unlocks': loadUnlocks(); break;
        }
    }

    // Load dashboard
    async function loadDashboard() {
        const analytics = await FirebaseDB.getAnalytics();

        document.getElementById('stat-clients').textContent = analytics.totalClients;
        document.getElementById('stat-assessments').textContent = analytics.totalAssessments;
        document.getElementById('stat-pending').textContent = analytics.pendingAppointments;

        // Load invite count
        const invites = await FirebaseDB.getAllInviteCodes();
        const unusedInvites = invites.filter(i => !i.used).length;
        document.getElementById('stat-invites').textContent = unusedInvites;

        // Update pending badge
        const badge = document.getElementById('pending-badge');
        if (analytics.pendingAppointments > 0) {
            badge.textContent = analytics.pendingAppointments;
            badge.style.display = '';
        } else {
            badge.style.display = 'none';
        }

        // Load recent assessments
        const assessments = await FirebaseDB.getAllAssessments();
        const recentContainer = document.getElementById('recent-assessments');

        if (assessments.length === 0) {
            recentContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Assessments Yet</h3>
                    <p>Assessments will appear here once clients complete them.</p>
                </div>
            `;
        } else {
            const recent = assessments.slice(0, 5);
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Score</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const a of recent) {
                const client = await FirebaseDB.getUserProfile(a.userId);
                const score = a.overallScore || 0;
                const date = a.createdAt?.toDate()?.toLocaleDateString() || 'N/A';

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${client?.displayName || 'Unknown'}</div>
                            <div class="client-email">${client?.email || ''}</div>
                        </td>
                        <td><span class="badge ${score >= 70 ? 'badge-confirmed' : score >= 40 ? 'badge-pending' : 'badge-cancelled'}">${score}/100</span></td>
                        <td>${date}</td>
                        <td><button class="action-btn action-btn-secondary" onclick="viewAssessment('${a.id}')">View</button></td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            recentContainer.innerHTML = html;
        }

        // Load pending appointments
        const appointments = await FirebaseDB.getAllAppointments();
        const pending = appointments.filter(a => a.status === 'pending');
        const appointmentsContainer = document.getElementById('pending-appointments');

        if (pending.length === 0) {
            appointmentsContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Pending Appointments</h3>
                    <p>Appointment requests will appear here.</p>
                </div>
            `;
        } else {
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Type</th>
                        <th>Requested Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const apt of pending.slice(0, 5)) {
                const client = await FirebaseDB.getUserProfile(apt.userId);
                const dateTime = apt.dateTime?.toDate();
                const formattedDate = dateTime ? dateTime.toLocaleString() : 'N/A';

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${client?.displayName || 'Unknown'}</div>
                            <div class="client-email">${client?.email || ''}</div>
                        </td>
                        <td>${apt.type || 'Consultation'}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="action-btn action-btn-primary" onclick="confirmAppointment('${apt.id}')">Confirm</button>
                            <button class="action-btn action-btn-danger" onclick="cancelAppointment('${apt.id}')">Decline</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            appointmentsContainer.innerHTML = html;
        }
    }

    // Load clients
    async function loadClients() {
        const container = document.getElementById('clients-list');
        allClients = await FirebaseDB.getAllUsers();

        renderClients(allClients);
    }

    function renderClients(clients) {
        const container = document.getElementById('clients-list');

        if (clients.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Clients Yet</h3>
                    <p>Generate invite codes to onboard new clients.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Joined</th>
                    <th>Last Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const client of clients) {
            const joined = client.createdAt?.toDate()?.toLocaleDateString() || 'N/A';
            const lastActive = client.lastLogin?.toDate()?.toLocaleDateString() || 'N/A';
            const typeClass = client.clientType ? `badge-${client.clientType}` : '';
            const typeLabel = client.clientType ? client.clientType.charAt(0).toUpperCase() + client.clientType.slice(1) : 'Unknown';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client.displayName || 'Unknown'}</div>
                        <div class="client-email">${client.email}</div>
                    </td>
                    <td><span class="badge ${typeClass}">${typeLabel}</span></td>
                    <td>${joined}</td>
                    <td>${lastActive}</td>
                    <td>
                        <button class="action-btn action-btn-secondary" onclick="viewClient('${client.id}')">View</button>
                        <button class="action-btn action-btn-primary" onclick="messageClient('${client.id}')">Message</button>
                    </td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function filterClients() {
        const search = document.getElementById('client-search').value.toLowerCase();
        const type = document.getElementById('client-filter').value;

        let filtered = allClients;

        if (search) {
            filtered = filtered.filter(c =>
                (c.displayName || '').toLowerCase().includes(search) ||
                (c.email || '').toLowerCase().includes(search)
            );
        }

        if (type) {
            filtered = filtered.filter(c => c.clientType === type);
        }

        renderClients(filtered);
    }

    // Load assessments
    async function loadAssessments() {
        const container = document.getElementById('assessments-list');
        allAssessments = await FirebaseDB.getAllAssessments();

        if (allAssessments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Assessments Yet</h3>
                    <p>Assessments will appear here once clients complete them.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Overall Score</th>
                    <th>Key Findings</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const a of allAssessments) {
            const client = await FirebaseDB.getUserProfile(a.userId);
            const score = a.overallScore || 0;
            const date = a.createdAt?.toDate()?.toLocaleDateString() || 'N/A';
            const findings = a.findings?.slice(0, 2).join(', ') || 'N/A';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${client?.email || ''}</div>
                    </td>
                    <td><span class="badge ${score >= 70 ? 'badge-confirmed' : score >= 40 ? 'badge-pending' : 'badge-cancelled'}">${score}/100</span></td>
                    <td style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${findings}</td>
                    <td>${date}</td>
                    <td><button class="action-btn action-btn-secondary" onclick="viewAssessment('${a.id}')">View Details</button></td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Load invite codes
    async function loadInvites() {
        const container = document.getElementById('invites-list');
        const invites = await FirebaseDB.getAllInviteCodes();

        if (invites.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Invite Codes</h3>
                    <p>Generate codes to invite new clients.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const invite of invites) {
            const created = invite.createdAt?.toDate()?.toLocaleDateString() || 'N/A';
            const statusClass = invite.used ? 'badge-used' : 'badge-unused';
            const statusText = invite.used ? 'Used' : 'Available';

            html += `
                <tr>
                    <td><strong style="font-family: monospace; letter-spacing: 1px;">${invite.code}</strong></td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${created}</td>
                    <td>${invite.notes || invite.clientEmail || '-'}</td>
                    <td>
                        ${!invite.used ? `
                            <button class="action-btn action-btn-secondary" onclick="copyCode('${invite.code}')">Copy</button>
                            <button class="action-btn action-btn-danger" onclick="deleteInvite('${invite.code}')">Delete</button>
                        ` : '-'}
                    </td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Generate invite code
    function showGenerateInviteModal() {
        document.getElementById('invite-form-view').style.display = 'block';
        document.getElementById('invite-result-view').style.display = 'none';
        document.getElementById('invite-email').value = '';
        document.getElementById('invite-notes').value = '';
        document.getElementById('invite-modal').style.display = 'flex';
    }

    // Store current invite data for email
    let currentInviteData = {};

    async function generateInviteCode() {
        const email = document.getElementById('invite-email').value.trim();
        const notes = document.getElementById('invite-notes').value;

        const code = await FirebaseDB.generateInviteCode(currentUser.uid, email, notes);
        const authUrl = window.location.origin + '/assessment/auth.html';

        // Store for email sending
        currentInviteData = { email, code, authUrl };

        document.getElementById('generated-code').textContent = code;
        document.getElementById('auth-url').textContent = authUrl;
        document.getElementById('invite-form-view').style.display = 'none';
        document.getElementById('invite-result-view').style.display = 'block';

        // Show email section if email was provided
        const emailSection = document.getElementById('email-section');
        const emailStatus = document.getElementById('email-status');
        emailStatus.style.display = 'none';

        if (email) {
            emailSection.style.display = 'block';
            document.getElementById('email-preview').innerHTML = generateEmailPreview(email, code, authUrl);
            document.getElementById('send-email-btn').disabled = false;
            document.getElementById('send-email-btn').innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                Send Email
            `;
        } else {
            emailSection.style.display = 'none';
        }
    }

    function generateEmailPreview(email, code, authUrl) {
        return `
            <div style="font-family: Georgia, serif; color: #0f1c2e;">
                <p style="margin: 0 0 15px 0;">Dear Client,</p>

                <p style="margin: 0 0 15px 0;">I hope this message finds you well. I am delighted to welcome you to my <strong>Sleep Wellness</strong> practice.</p>

                <p style="margin: 0 0 15px 0;">Your personalized client portal is now ready. This secure space will allow us to work together on optimizing your sleep health, track your progress, and communicate directly.</p>

                <p style="margin: 0 0 10px 0;"><strong>Your Personal Invite Code:</strong></p>
                <p style="margin: 0 0 15px 0; font-family: 'Courier New', monospace; font-size: 18px; background: #f0f0f0; padding: 12px; text-align: center; letter-spacing: 2px; font-weight: bold;">${code}</p>

                <p style="margin: 0 0 10px 0;"><strong>To get started:</strong></p>
                <ol style="margin: 0 0 15px 0; padding-left: 20px;">
                    <li style="margin-bottom: 5px;">Visit: <a href="${authUrl}" style="color: #9a7b3c;">${authUrl}</a></li>
                    <li style="margin-bottom: 5px;">Click "Create Account"</li>
                    <li style="margin-bottom: 5px;">Enter your invite code above</li>
                    <li style="margin-bottom: 5px;">Complete your profile</li>
                </ol>

                <p style="margin: 0 0 15px 0;">I look forward to supporting you on your journey to better sleep and improved well-being.</p>

                <p style="margin: 0 0 5px 0;">Warm regards,</p>
                <p style="margin: 0; font-style: italic;">Dr. Alen Juginovic</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Sleep Wellness by Dr. Alen</p>
            </div>
        `;
    }

    async function sendInviteEmail() {
        const { email, code, authUrl } = currentInviteData;
        if (!email) return;

        const btn = document.getElementById('send-email-btn');
        const status = document.getElementById('email-status');

        btn.disabled = true;
        btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 70"/></svg>
            Sending...
        `;

        try {
            // EmailJS configuration - REPLACE THESE WITH YOUR OWN
            const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
            const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
            const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

            // Check if EmailJS is configured
            if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                // Fallback: Open email client
                const subject = encodeURIComponent('Welcome to Sleep Wellness - Your Access Code');
                const body = encodeURIComponent(`Dear Client,

I hope this message finds you well. I am delighted to welcome you to my Sleep Wellness practice.

Your personalized client portal is now ready. This secure space will allow us to work together on optimizing your sleep health, track your progress, and communicate directly.

Your Personal Invite Code: ${code}

To get started:
1. Visit: ${authUrl}
2. Click "Create Account"
3. Enter your invite code above
4. Complete your profile

I look forward to supporting you on your journey to better sleep and improved well-being.

Warm regards,
Dr. Alen Juginovic
Sleep Wellness by Dr. Alen`);

                window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');

                status.style.display = 'block';
                status.style.color = '#ed6c02';
                status.textContent = 'Email client opened. Please send the email manually.';
                btn.innerHTML = `
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    Open Email Again
                `;
                btn.disabled = false;
                return;
            }

            // Send via EmailJS
            emailjs.init(EMAILJS_PUBLIC_KEY);

            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                to_email: email,
                invite_code: code,
                auth_url: authUrl,
                from_name: 'Dr. Alen Juginovic',
                reply_to: 'alen_juginovic@hms.harvard.edu'
            });

            status.style.display = 'block';
            status.style.color = '#2e7d32';
            status.textContent = 'Email sent successfully!';
            btn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>
                Sent!
            `;
        } catch (error) {
            console.error('Email error:', error);
            status.style.display = 'block';
            status.style.color = '#d32f2f';
            status.textContent = 'Failed to send. Opening email client instead...';

            // Fallback to mailto
            setTimeout(() => {
                const subject = encodeURIComponent('Welcome to Sleep Wellness - Your Access Code');
                const body = encodeURIComponent(`Your invite code: ${code}\n\nCreate your account at: ${authUrl}`);
                window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
            }, 1000);

            btn.disabled = false;
            btn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                Try Again
            `;
        }
    }

    function copyInviteCode() {
        const code = document.getElementById('generated-code').textContent;
        navigator.clipboard.writeText(code);
        event.target.textContent = 'Copied!';
        setTimeout(() => event.target.textContent = 'Copy Code', 2000);
    }

    function closeInviteModal() {
        document.getElementById('invite-modal').style.display = 'none';
        loadInvites();
        loadDashboard();
    }

    function copyCode(code) {
        navigator.clipboard.writeText(code);
        event.target.textContent = 'Copied!';
        setTimeout(() => event.target.textContent = 'Copy', 2000);
    }

    async function deleteInvite(code) {
        if (confirm('Are you sure you want to delete this invite code?')) {
            await FirebaseDB.deleteInviteCode(code);
            loadInvites();
        }
    }

    // Load conversations
    async function loadConversations() {
        const container = document.getElementById('conversations-list');
        container.style.display = 'block';
        document.getElementById('chat-container').classList.remove('active');

        try {
            // Get all conversations where admin is a participant
            const snapshot = await db.collection('conversations')
                .where('participants', 'array-contains', currentUser.uid)
                .get();

            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Conversations</h3>
                        <p>Messages from clients will appear here.</p>
                    </div>
                `;
                return;
            }

            // Sort by lastMessageAt client-side
            const conversations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            conversations.sort((a, b) => {
                const aTime = a.lastMessageAt?.toDate?.() || new Date(0);
                const bTime = b.lastMessageAt?.toDate?.() || new Date(0);
                return bTime - aTime;
            });

            let html = '';
            for (const conv of conversations) {
                const clientId = conv.participants.find(p => p !== currentUser.uid);
                const client = await FirebaseDB.getUserProfile(clientId);

                const lastTime = conv.lastMessageAt?.toDate?.();
                const timeStr = lastTime ? formatTime(lastTime) : '';

                html += `
                    <div class="conversation-item" onclick="openChat('${conv.id}', '${clientId}', '${client?.displayName || 'Client'}')">
                        <div class="conversation-avatar">${(client?.displayName || 'C')[0].toUpperCase()}</div>
                        <div class="conversation-info">
                            <div class="conversation-name">${client?.displayName || 'Client'}</div>
                            <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
                        </div>
                        <div class="conversation-time">${timeStr}</div>
                    </div>
                `;
            }

            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading conversations:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <h3>Error Loading Messages</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    function formatTime(date) {
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
        return date.toLocaleDateString();
    }

    async function openChat(conversationId, clientId, clientName) {
        currentConversation = { id: conversationId, clientId, clientName };

        document.getElementById('conversations-list').style.display = 'none';
        document.getElementById('chat-container').classList.add('active');
        document.getElementById('chat-avatar').textContent = clientName[0].toUpperCase();
        document.getElementById('chat-name').textContent = clientName;

        // Listen for messages
        if (messageListener) messageListener();

        messageListener = FirebaseDB.getMessagesListener(conversationId, (messages) => {
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(m => `
                <div class="message ${m.senderId === currentUser.uid ? 'sent' : 'received'}">
                    <div class="message-content">${m.text}</div>
                    <div class="message-time">${m.createdAt?.toDate()?.toLocaleTimeString() || ''}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        });
    }

    function closeChat() {
        if (messageListener) {
            messageListener();
            messageListener = null;
        }
        currentConversation = null;
        document.getElementById('chat-container').classList.remove('active');
        document.getElementById('conversations-list').style.display = 'block';
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();

        if (!text || !currentConversation) return;

        input.value = '';
        await FirebaseDB.sendMessage(currentConversation.id, currentUser.uid, text);
    }

    function handleMessageKeypress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function messageClient(clientId) {
        try {
            console.log('Messaging client:', clientId);
            // Get or create conversation
            const conv = await FirebaseDB.getOrCreateConversation(clientId, currentUser.uid);
            const client = await FirebaseDB.getUserProfile(clientId);

            console.log('Conversation:', conv);
            console.log('Client:', client);

            // Navigate to messages section
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-messages').classList.add('active');

            // Open the chat after a brief delay
            setTimeout(() => {
                openChat(conv.id, clientId, client?.displayName || 'Client');
            }, 200);
        } catch (error) {
            console.error('Error messaging client:', error);
            alert('Error opening conversation: ' + error.message);
        }
    }

    // Load appointments
    async function loadAppointments() {
        const container = document.getElementById('appointments-list');
        const appointments = await FirebaseDB.getAllAppointments();

        if (appointments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Appointments</h3>
                    <p>Client appointment requests will appear here.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Type</th>
                    <th>Date/Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        for (const apt of appointments) {
            const client = await FirebaseDB.getUserProfile(apt.userId);
            const dateTime = apt.dateTime?.toDate();
            const formattedDate = dateTime ? dateTime.toLocaleString() : 'N/A';
            const statusClass = apt.status === 'confirmed' ? 'badge-confirmed' : apt.status === 'cancelled' ? 'badge-cancelled' : 'badge-pending';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${client?.email || ''}</div>
                    </td>
                    <td>${apt.type || 'Consultation'}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge ${statusClass}">${apt.status}</span></td>
                    <td>
                        ${apt.status === 'pending' ? `
                            <button class="action-btn action-btn-primary" onclick="confirmAppointment('${apt.id}')">Confirm</button>
                            <button class="action-btn action-btn-danger" onclick="cancelAppointment('${apt.id}')">Decline</button>
                        ` : `
                            <button class="action-btn action-btn-secondary" onclick="messageClient('${apt.userId}')">Message</button>
                        `}
                    </td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function confirmAppointment(appointmentId) {
        await FirebaseDB.updateAppointmentStatus(appointmentId, 'confirmed');
        loadAppointments();
        loadDashboard();
    }

    async function cancelAppointment(appointmentId) {
        if (confirm('Are you sure you want to decline this appointment?')) {
            await FirebaseDB.updateAppointmentStatus(appointmentId, 'cancelled');
            loadAppointments();
            loadDashboard();
        }
    }

    // Load unlocks
    async function loadUnlocks() {
        const container = document.getElementById('unlocks-list');

        // Get all unlocks
        const snapshot = await db.collection('unlocks')
            .orderBy('createdAt', 'desc')
            .get();

        if (snapshot.empty) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Unlocks Granted</h3>
                    <p>Grant access to therapeutic modules here.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Modules</th>
                    <th>Granted</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>`;

        for (const doc of snapshot.docs) {
            const unlock = { id: doc.id, ...doc.data() };
            const client = await FirebaseDB.getUserProfile(unlock.userId);
            const granted = unlock.createdAt?.toDate()?.toLocaleDateString() || 'N/A';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${client?.email || ''}</div>
                    </td>
                    <td>${unlock.modules?.join(', ') || '-'}</td>
                    <td>${granted}</td>
                    <td>${unlock.notes || '-'}</td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Unlock modal
    async function showUnlockModal() {
        const select = document.getElementById('unlock-client');
        const clients = await FirebaseDB.getAllUsers();

        select.innerHTML = '<option value="">Select a client</option>' +
            clients.map(c => `<option value="${c.id}">${c.displayName || c.email}</option>`).join('');

        document.querySelectorAll('input[name="unlock-modules"]').forEach(cb => cb.checked = false);
        document.getElementById('unlock-notes').value = '';

        document.getElementById('unlock-modal').classList.add('active');
    }

    async function grantUnlock() {
        const clientId = document.getElementById('unlock-client').value;
        const modules = Array.from(document.querySelectorAll('input[name="unlock-modules"]:checked')).map(cb => cb.value);
        const notes = document.getElementById('unlock-notes').value;

        if (!clientId || modules.length === 0) {
            alert('Please select a client and at least one module.');
            return;
        }

        await FirebaseDB.grantUnlock(clientId, modules, currentUser.uid, notes);

        closeModal('unlock-modal');
        loadUnlocks();
        alert('Access granted successfully!');
    }

    // View assessment details
    function viewAssessment(assessmentId) {
        const assessment = allAssessments.find(a => a.id === assessmentId);
        if (!assessment) return;

        alert('Assessment Details:\n\n' +
            'Overall Score: ' + (assessment.overallScore || 'N/A') + '/100\n' +
            'ESS Score: ' + (assessment.scores?.ess || 'N/A') + '\n' +
            'ISI Score: ' + (assessment.scores?.isi || 'N/A') + '\n' +
            'STOP-BANG Score: ' + (assessment.scores?.stopbang || 'N/A') + '\n\n' +
            'Key Findings:\n' + (assessment.findings?.join('\n') || 'None'));
    }

    function viewClient(clientId) {
        const client = allClients.find(c => c.id === clientId);
        if (!client) return;

        alert('Client Details:\n\n' +
            'Name: ' + (client.displayName || 'N/A') + '\n' +
            'Email: ' + (client.email || 'N/A') + '\n' +
            'Type: ' + (client.clientType || 'N/A') + '\n' +
            'Joined: ' + (client.createdAt?.toDate()?.toLocaleDateString() || 'N/A'));
    }

    // Modal functions
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Logout
    async function handleLogout() {
        await auth.signOut();
        window.location.href = '../auth.html';
    }

    // Close invite modal on outside click
    document.getElementById('invite-modal').addEventListener('click', (e) => {
        if (e.target.id === 'invite-modal') {
            e.target.style.display = 'none';
        }
    });

    // Close other modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
            }
        });
    });
</script>

</body>
</html>
