<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sleep Wellness</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --deep-navy: #0f1c2e;
            --navy: #1a2a3a;
            --navy-light: #2a3a4a;
            --gold: #C9A962;
            --gold-light: #d4b978;
            --gold-dark: #9a7b3c;
            --cream: #FAF8F5;
            --text-light: #6b7b8a;
            --success: #2e7d32;
            --warning: #ed6c02;
            --danger: #d32f2f;
        }

        /* ========== TOAST NOTIFICATIONS ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            max-width: 450px;
            pointer-events: auto;
            animation: toastSlideIn 0.3s ease;
            border-left: 4px solid var(--gold);
        }

        .toast.toast-success { border-left-color: var(--success); }
        .toast.toast-error { border-left-color: var(--danger); }
        .toast.toast-warning { border-left-color: var(--warning); }
        .toast.toast-info { border-left-color: #1976d2; }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-success .toast-icon { background: rgba(46, 125, 50, 0.1); color: var(--success); }
        .toast-error .toast-icon { background: rgba(211, 47, 47, 0.1); color: var(--danger); }
        .toast-warning .toast-icon { background: rgba(237, 108, 2, 0.1); color: var(--warning); }
        .toast-info .toast-icon { background: rgba(25, 118, 210, 0.1); color: #1976d2; }

        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; font-size: 14px; color: var(--deep-navy); margin-bottom: 2px; }
        .toast-message { font-size: 13px; color: var(--text-light); }

        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            line-height: 1;
        }

        .toast-close:hover { color: #333; }

        .toast.toast-exit { animation: toastSlideOut 0.3s ease forwards; }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ========== CONFIRMATION MODAL ========== */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .confirm-modal-overlay.active .confirm-modal {
            transform: scale(1);
        }

        .confirm-modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .confirm-modal-icon.warning { background: rgba(237, 108, 2, 0.1); color: var(--warning); }
        .confirm-modal-icon.danger { background: rgba(211, 47, 47, 0.1); color: var(--danger); }
        .confirm-modal-icon.info { background: rgba(25, 118, 210, 0.1); color: #1976d2; }

        .confirm-modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--deep-navy);
            margin-bottom: 10px;
        }

        .confirm-modal-message {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .confirm-modal-btn.cancel { background: #f5f5f5; color: #666; }
        .confirm-modal-btn.cancel:hover { background: #e0e0e0; }
        .confirm-modal-btn.confirm { background: var(--gold); color: var(--deep-navy); }
        .confirm-modal-btn.confirm:hover { background: var(--gold-light); }
        .confirm-modal-btn.danger { background: var(--danger); color: white; }
        .confirm-modal-btn.danger:hover { background: #b71c1c; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--cream);
            min-height: 100vh;
        }

        /* Admin Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 280px;
            background: var(--deep-navy);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 11px;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            padding: 0 15px;
            margin-bottom: 10px;
        }

        .nav-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            padding: 10px;
            margin-top: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--gold);
            color: var(--deep-navy);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding: 20px 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--deep-navy);
        }

        .admin-name {
            font-size: 14px;
            font-weight: 500;
        }

        .admin-role {
            font-size: 11px;
            color: var(--gold);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            color: var(--navy);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            color: var(--navy);
            font-weight: 600;
        }

        .stat-change {
            font-size: 12px;
            color: var(--success);
            margin-top: 5px;
        }

        /* Data Table */
        .data-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-card-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            color: var(--navy);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 15px 25px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-table td {
            padding: 18px 25px;
            font-size: 14px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(201, 169, 98, 0.05);
        }

        .client-name {
            font-weight: 500;
            color: var(--navy);
        }

        .client-email {
            font-size: 12px;
            color: var(--text-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 20px;
        }

        .badge-athlete { background: rgba(42, 139, 139, 0.1); color: #2A8B8B; }
        .badge-executive { background: rgba(74, 96, 133, 0.1); color: #4A6085; }
        .badge-hotel { background: rgba(139, 77, 92, 0.1); color: #8B4D5C; }
        .badge-pending { background: rgba(237, 108, 2, 0.1); color: var(--warning); }
        .badge-confirmed { background: rgba(46, 125, 50, 0.1); color: var(--success); }
        .badge-cancelled { background: rgba(211, 47, 47, 0.1); color: var(--danger); }
        .badge-unused { background: rgba(46, 125, 50, 0.1); color: var(--success); }
        .badge-used { background: rgba(107, 123, 138, 0.1); color: var(--text-light); }
        .badge-success { background: rgba(46, 125, 50, 0.15); color: var(--success); font-weight: 500; }

        .action-btn {
            padding: 8px 16px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .action-btn-primary {
            background: var(--gold);
            color: var(--deep-navy);
        }

        .action-btn-primary:hover {
            background: var(--gold-light);
        }

        .action-btn-secondary {
            background: var(--navy);
            color: white;
        }

        .action-btn-secondary:hover {
            background: var(--navy-light);
        }

        .action-btn-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .action-btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* Admin Section */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            font-size: 14px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-family: 'Montserrat', sans-serif;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Invite Code Display */
        .invite-code-display {
            background: var(--cream);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
        }

        .invite-code-value {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            font-weight: bold;
            color: var(--navy);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .copy-btn {
            padding: 8px 20px;
            background: var(--navy);
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--navy-light);
        }

        /* Messages Section */
        .conversations-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: rgba(201, 169, 98, 0.05);
        }

        .conversation-avatar {
            width: 45px;
            height: 45px;
            background: var(--navy);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .conversation-preview {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-light);
        }

        .conversation-unread {
            width: 10px;
            height: 10px;
            background: var(--gold);
            border-radius: 50%;
        }

        /* Chat View */
        .chat-container {
            display: none;
            height: 70vh;
            flex-direction: column;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .chat-back {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 14px;
        }

        .message.received .message-content {
            background: rgba(0,0,0,0.05);
            color: var(--navy);
        }

        .message.sent .message-content {
            background: var(--navy);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
            text-align: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            padding: 20px 25px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .chat-input input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .chat-input button {
            padding: 14px 25px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        /* Assessment View */
        .assessment-detail {
            padding: 25px;
        }

        .assessment-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: var(--cream);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .score-card-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .score-card-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 600;
        }

        .score-card-value.good { color: var(--success); }
        .score-card-value.moderate { color: var(--warning); }
        .score-card-value.poor { color: var(--danger); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 10px;
        }

        /* Search & Filter */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .filter-select {
            padding: 12px 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            min-width: 150px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 70px;
            }

            .sidebar-header,
            .sidebar-footer,
            .nav-section-title {
                display: none;
            }

            .nav-item span:not(.badge) {
                display: none;
            }

            .nav-item {
                justify-content: center;
                padding: 15px;
            }

            .admin-main {
                margin-left: 70px;
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 200;
            background: var(--gold);
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
            color: var(--deep-navy);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 150;
            }

            .admin-sidebar.mobile-open {
                transform: translateX(0);
            }

            .admin-main {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>

<!-- Toast Notification Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Confirmation Modal -->
<div class="confirm-modal-overlay" id="confirmModal">
    <div class="confirm-modal">
        <div class="confirm-modal-icon warning" id="confirmIcon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        </div>
        <h3 class="confirm-modal-title" id="confirmTitle">Are you sure?</h3>
        <p class="confirm-modal-message" id="confirmMessage">This action cannot be undone.</p>
        <div class="confirm-modal-buttons">
            <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancel</button>
            <button class="confirm-modal-btn confirm" id="confirmBtn" onclick="executeConfirm()">Confirm</button>
        </div>
    </div>
</div>

<div class="admin-layout">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
    </button>

    <!-- Sidebar -->
    <aside class="admin-sidebar" id="admin-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">SLEEP WELLNESS</div>
            <div class="sidebar-subtitle">Admin Portal</div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <a class="nav-item active" onclick="showSection('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Clients</div>
                <a class="nav-item" onclick="showSection('clients')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>All Clients</span>
                </a>
                <a class="nav-item" onclick="showSection('invites')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span>Invite Codes</span>
                </a>
                <a class="nav-item" onclick="showSection('assessments')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <span>All Assessments</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Communication</div>
                <a class="nav-item" onclick="showSection('messages')" id="nav-messages">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Messages</span>
                </a>
                <a class="nav-item" onclick="showSection('appointments')" id="nav-appointments">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>Appointments</span>
                    <span class="badge" id="pending-badge" style="display: none;">0</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Content</div>
                <a class="nav-item" onclick="showSection('questionnaires')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <span>Questionnaires</span>
                    <span class="badge" id="questionnaires-badge" style="display: none;">0</span>
                </a>
                <a class="nav-item" onclick="showSection('modules')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
                    </svg>
                    <span>Modules</span>
                    <span class="badge" id="requests-badge" style="display: none;">0</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Partners</div>
                <a class="nav-item" onclick="showSection('hotel-partners')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 21h18"/>
                        <path d="M5 21V7l8-4v18"/>
                        <path d="M19 21V11l-6-4"/>
                        <path d="M9 9v.01"/>
                        <path d="M9 12v.01"/>
                        <path d="M9 15v.01"/>
                        <path d="M9 18v.01"/>
                    </svg>
                    <span>Hotel Partners</span>
                    <span class="badge" id="hotel-guests-badge" style="display: none;">0</span>
                </a>
                <a class="nav-item" onclick="showSection('athletic-partners')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="5" r="3"/>
                        <path d="M12 8v8"/>
                        <path d="M8 21l4-4 4 4"/>
                        <path d="M6 12l2 2"/>
                        <path d="M18 12l-2 2"/>
                    </svg>
                    <span>Athletic Partners</span>
                    <span class="badge" id="athletic-badge" style="display: none;">0</span>
                </a>
                <a class="nav-item" onclick="showSection('business-partners')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                    </svg>
                    <span>Business Partners</span>
                    <span class="badge" id="business-badge" style="display: none;">0</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar" id="adminAvatar">A</div>
                <div>
                    <div class="admin-name" id="adminName">Admin</div>
                    <div class="admin-role">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Dashboard Section -->
        <section class="admin-section active" id="section-dashboard">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Welcome back, Dr. Alen</p>
                </div>
                <div id="notification-bell" style="position: relative; cursor: pointer;" onclick="toggleNotifications()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span id="notification-count" style="display: none; position: absolute; top: -5px; right: -5px; background: #c62828; color: white; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center;">0</span>
                </div>
            </div>

            <!-- Notifications Dropdown -->
            <div id="notifications-dropdown" style="display: none; position: absolute; top: 120px; right: 40px; width: 380px; background: white; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1000; max-height: 400px; overflow-y: auto;">
                <div style="padding: 15px 20px; border-bottom: 1px solid rgba(201, 169, 98, 0.15); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin: 0;">Notifications</h3>
                    <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: var(--gold); font-size: 12px; cursor: pointer;">Mark all read</button>
                </div>
                <div id="notifications-list" style="padding: 10px 0;">
                    <p style="text-align: center; color: var(--text-light); padding: 20px; font-size: 14px;">No notifications</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('clients')">
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-value" id="stat-clients">0</div>
                    <div id="clients-breakdown" style="display: flex; gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(201, 169, 98, 0.2);">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 8px; height: 8px; background: #2A8B8B; border-radius: 50%;"></span>
                            <span style="font-size: 11px; color: var(--text-light);"><span id="stat-athletes">0</span> Athletes</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 8px; height: 8px; background: #8B4D5C; border-radius: 50%;"></span>
                            <span style="font-size: 11px; color: var(--text-light);"><span id="stat-hotels">0</span> Hotels</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 8px; height: 8px; background: #4A6085; border-radius: 50%;"></span>
                            <span style="font-size: 11px; color: var(--text-light);"><span id="stat-executives">0</span> Execs</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('messages')">
                    <div class="stat-label">Unread Messages</div>
                    <div class="stat-value" id="stat-messages">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="navigateToSection('appointments')">
                    <div class="stat-label">Pending Appointments</div>
                    <div class="stat-value" id="stat-pending">0</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="scrollToTasks()">
                    <div class="stat-label">Open Tasks</div>
                    <div class="stat-value" id="stat-tasks">0</div>
                </div>
            </div>

            <!-- Two Column Layout for Dashboard -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                <!-- My Tasks -->
                <div class="data-card" id="tasks-card">
                    <div class="data-card-header">
                        <h2 class="data-card-title">My Tasks</h2>
                        <button class="action-btn action-btn-primary" onclick="showAddTaskModal()" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Add Task
                        </button>
                    </div>
                    <div id="dashboard-tasks" style="max-height: 350px; overflow-y: auto;">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Incoming Messages -->
                <div class="data-card">
                    <div class="data-card-header">
                        <h2 class="data-card-title">Incoming Messages</h2>
                        <button class="action-btn action-btn-secondary" onclick="showSection('messages')">View All</button>
                    </div>
                    <div id="dashboard-messages" style="max-height: 350px; overflow-y: auto;">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Needs Attention Section -->
            <div class="data-card" style="margin-bottom: 25px;">
                <div class="data-card-header">
                    <h2 class="data-card-title">Needs Attention</h2>
                </div>
                <div id="needs-attention" style="padding: 0;">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Pending Appointments -->
            <div class="data-card">
                <div class="data-card-header">
                    <h2 class="data-card-title">Pending Appointments</h2>
                    <button class="action-btn action-btn-secondary" onclick="showSection('appointments')">View All</button>
                </div>
                <div id="pending-appointments">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Clients Section -->
        <section class="admin-section" id="section-clients">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Clients</h1>
                    <p class="page-subtitle">Manage your client accounts</p>
                </div>
                <button class="action-btn action-btn-secondary" onclick="loadClients()" style="display: flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Refresh
                </button>
            </div>

            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search clients..." id="client-search" oninput="filterClients()">
                <select class="filter-select" id="client-filter" onchange="filterClients()">
                    <option value="">All Active</option>
                    <option value="athlete">Athletes</option>
                    <option value="executive">Executives</option>
                    <option value="hotel">Travelers</option>
                    <option value="archived" style="color: #888;">Archived Clients</option>
                </select>
            </div>

            <div class="data-card">
                <div id="clients-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Client Detail Section -->
        <section class="admin-section" id="section-client-detail">
            <div class="page-header" style="margin-bottom: 0;">
                <button onclick="showSection('clients')" style="display: flex; align-items: center; gap: 8px; background: none; border: none; color: var(--gold); cursor: pointer; font-size: 14px; padding: 0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    Back to Clients
                </button>
            </div>

            <!-- Client Profile Header -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div id="client-avatar" style="width: 70px; height: 70px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; font-weight: 600;">?</div>
                    <div style="flex: 1;">
                        <h1 id="client-name" style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--navy); margin: 0 0 5px 0;">Client Name</h1>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 13px; color: var(--text-light);">
                            <span id="client-type-badge" style="background: var(--gold); color: var(--deep-navy); padding: 4px 12px; border-radius: 20px; font-weight: 500; text-transform: capitalize;">Type</span>
                            <span id="client-email">email@example.com</span>
                            <span id="client-joined">Joined: --</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openClientChat()" class="action-btn action-btn-secondary" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            Message
                        </button>
                        <button onclick="showAssignTaskModal()" class="action-btn action-btn-primary" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                            Assign Task
                        </button>
                        <button onclick="showArchiveClientModal()" class="action-btn" style="display: flex; align-items: center; gap: 6px; background: #f5f5f5; color: #666; border: 1px solid #ddd;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
                            Archive
                        </button>
                    </div>
                </div>
            </div>

            <!-- Program Duration Banner -->
            <div id="program-duration-banner" class="data-card" style="margin-top: 20px; padding: 20px 25px; background: linear-gradient(135deg, rgba(201, 169, 98, 0.1) 0%, rgba(201, 169, 98, 0.05) 100%); border: 1px solid rgba(201, 169, 98, 0.3); display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        <div>
                            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">Program Duration</div>
                            <div id="program-duration-text" style="font-size: 16px; color: var(--navy); font-weight: 600;">--</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: var(--text-light);">Time Remaining</div>
                        <div id="program-remaining" style="font-size: 16px; color: var(--gold); font-weight: 600;">--</div>
                    </div>
                </div>
            </div>

            <!-- Client Demographics & Primary Goal -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- Demographics -->
                <div class="data-card" style="margin: 0; padding: 22px 25px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Client Profile
                    </h2>
                    <div id="client-demographics" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
                        <div>
                            <span style="color: var(--text-light); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Age</span>
                            <div id="demo-age" style="color: var(--navy); font-weight: 500; margin-top: 4px;">--</div>
                        </div>
                        <div>
                            <span style="color: var(--text-light); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Sex</span>
                            <div id="demo-sex" style="color: var(--navy); font-weight: 500; margin-top: 4px;">--</div>
                        </div>
                        <div>
                            <span style="color: var(--text-light); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Occupation</span>
                            <div id="demo-occupation" style="color: var(--navy); font-weight: 500; margin-top: 4px;">--</div>
                        </div>
                        <div>
                            <span style="color: var(--text-light); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Phone</span>
                            <div id="demo-phone" style="color: var(--navy); font-weight: 500; margin-top: 4px;">--</div>
                        </div>
                    </div>
                </div>

                <!-- Primary Goal / Main Complaint -->
                <div class="data-card" style="margin: 0; padding: 22px 25px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
                        Primary Goal
                    </h2>
                    <div id="client-primary-goal" style="font-size: 15px; color: var(--navy); line-height: 1.6;">
                        <p style="margin: 0; color: var(--text-light); font-style: italic;">No primary goal set</p>
                    </div>
                    <div id="client-notes" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(201, 169, 98, 0.15); font-size: 13px; color: var(--text-light); display: none;">
                    </div>
                </div>
            </div>

            <!-- Sleep Habits Summary -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    Sleep Habits Summary
                </h2>
                <div id="no-sleep-summary-notice" style="display: none; text-align: center; padding: 20px; color: var(--text-light);">
                    <p style="margin: 0;">No sleep data available yet</p>
                </div>
                <div id="sleep-habits-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, rgba(15, 28, 46, 0.05) 0%, rgba(15, 28, 46, 0.02) 100%); border-radius: 10px;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Avg. Bedtime</div>
                        <div id="avg-bedtime" style="font-size: 24px; font-weight: 600; color: var(--navy);">--</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, rgba(15, 28, 46, 0.05) 0%, rgba(15, 28, 46, 0.02) 100%); border-radius: 10px;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Avg. Wake Time</div>
                        <div id="avg-waketime" style="font-size: 24px; font-weight: 600; color: var(--navy);">--</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, rgba(15, 28, 46, 0.05) 0%, rgba(15, 28, 46, 0.02) 100%); border-radius: 10px;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Avg. Duration</div>
                        <div id="avg-duration" style="font-size: 24px; font-weight: 600; color: var(--navy);">--</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, rgba(15, 28, 46, 0.05) 0%, rgba(15, 28, 46, 0.02) 100%); border-radius: 10px;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Avg. Quality</div>
                        <div id="avg-quality" style="font-size: 24px; font-weight: 600; color: var(--navy);">--<span style="font-size: 14px; color: var(--text-light);">/10</span></div>
                    </div>
                </div>
                <div id="main-sleep-complaint" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(201, 169, 98, 0.15); display: none;">
                    <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Main Sleep Complaint</div>
                    <div id="complaint-text" style="font-size: 15px; color: var(--navy); font-weight: 500;"></div>
                </div>
            </div>

            <!-- Diary Entries (Night by Night) -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleDiaryDetail()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    Diary Entries (Night by Night)
                    <svg id="diary-detail-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-light)" stroke-width="2" style="margin-left: auto; transition: transform 0.3s;"><polyline points="6 9 12 15 18 9"/></svg>
                </h2>
                <div id="diary-detail-container" style="display: none;">
                    <div id="no-diary-detail-notice" style="display: none; text-align: center; padding: 20px; color: var(--text-light);">
                        <p style="margin: 0;">No diary entries recorded yet</p>
                    </div>
                    <div id="diary-detail-table" style="overflow-x: auto;"></div>
                </div>
            </div>

            <!-- Baseline Questionnaire Scores -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    Baseline Questionnaires
                </h2>
                <div id="no-questionnaires-notice" style="display: none; text-align: center; padding: 20px; color: var(--text-light);">
                    <p style="margin: 0;">No baseline questionnaires completed yet</p>
                </div>
                <div id="baseline-questionnaires" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- ISI, ESS, STOP-BANG cards will be inserted here -->
                </div>
            </div>

            <!-- Entry vs Exit Comparison -->
            <div class="data-card" id="entry-exit-card" style="margin-top: 20px; padding: 22px 25px; display: none;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                    Entry vs Exit Comparison
                </h2>
                <div id="entry-exit-comparisons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;"></div>
            </div>

            <!-- Sleep Health Summary -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 20px 0;">Sleep Health Summary</h2>
                <div id="no-assessment-notice" style="display: none; text-align: center; padding: 30px; color: var(--text-light);">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 15px; opacity: 0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    <p style="margin: 0;">No assessment completed yet</p>
                </div>
                <div id="assessment-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                    <!-- Score cards will be inserted here -->
                </div>
            </div>

            <!-- AI Summary -->
            <div class="data-card" id="ai-summary-card" style="margin-top: 20px; padding: 22px 25px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border: 1px solid rgba(201, 169, 98, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0; display: flex; align-items: center; gap: 10px;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5">
                            <path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2z"/>
                            <path d="M8 12h8M12 8v8"/>
                        </svg>
                        AI Summary
                    </h2>
                    <button onclick="generateClientAISummary()" id="ai-summary-btn" style="background: var(--deep-navy); color: var(--gold); border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                        Generate
                    </button>
                </div>
                <div id="ai-summary-content" style="font-size: 14px; line-height: 1.7; color: var(--navy);">
                    <p style="color: var(--text-light); text-align: center; padding: 20px 0;">
                        Click "Generate" to create an AI-powered summary of this client's sleep profile, including assessment results, identified concerns, and recommended focus areas.
                    </p>
                </div>
            </div>

            <!-- Key Findings -->
            <div class="data-card" id="findings-card" style="margin-top: 20px; padding: 22px 25px; display: none;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0 0 20px 0;">Key Findings</h2>
                <ul id="findings-list" style="margin: 0; padding-left: 20px; color: var(--navy);">
                    <!-- Findings will be inserted here -->
                </ul>
            </div>

            <!-- Next Steps -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Next Steps</h2>
                    <button onclick="showAddActionModal()" style="background: var(--gold); color: var(--deep-navy); border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Action
                    </button>
                </div>
                <div id="actions-list">
                    <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No actions yet. Add next steps for this client.</p>
                </div>
            </div>

            <!-- Recent Messages -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Recent Messages</h2>
                    <button onclick="openClientChat()" style="background: none; border: 1px solid var(--gold); color: var(--gold); padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer;">Open Full Chat</button>
                </div>
                <div id="recent-messages">
                    <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No messages yet</p>
                </div>
            </div>

            <!-- Unlocked Modules -->
            <div class="data-card" style="margin-top: 20px; padding: 22px 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Unlocked Modules</h2>
                    <button onclick="showUnlockModuleForClient()" style="background: none; border: 1px solid var(--gold); color: var(--gold); padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer;">Manage Modules</button>
                </div>
                <div id="client-modules">
                    <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No modules unlocked yet</p>
                </div>
            </div>
        </section>

        <!-- Invite Codes Section -->
        <section class="admin-section" id="section-invites">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Invite Codes</h1>
                    <p class="page-subtitle">Generate and manage client invitations</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showGenerateInviteModal()">
                    Generate New Code
                </button>
            </div>

            <div class="data-card">
                <div id="invites-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- All Assessments Section -->
        <section class="admin-section" id="section-assessments">
            <div class="page-header">
                <div>
                    <h1 class="page-title">All Assessments</h1>
                    <p class="page-subtitle">View all client sleep assessments</p>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search by client name..." id="assessment-search" oninput="filterAssessments()">
                <select class="filter-select" id="assessment-filter" onchange="filterAssessments()">
                    <option value="">All Scores</option>
                    <option value="good">Good (70+)</option>
                    <option value="moderate">Moderate (40-69)</option>
                    <option value="poor">Poor (&lt;40)</option>
                </select>
            </div>

            <!-- Score Calculation Info -->
            <div class="data-card" style="padding: 18px 22px; margin-bottom: 20px; background: linear-gradient(135deg, rgba(201, 169, 98, 0.08) 0%, rgba(201, 169, 98, 0.03) 100%); border: 1px solid rgba(201, 169, 98, 0.2);">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <div>
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--navy); font-weight: 600;">How the Overall Score (0-100) is Calculated</h4>
                        <p style="margin: 0; font-size: 13px; color: var(--text-light); line-height: 1.6;">
                            The overall sleep health score is a weighted composite of three validated clinical instruments:<br>
                            <strong style="color: var(--navy);">ISI</strong> (Insomnia Severity Index, 40% weight) - measures insomnia severity<br>
                            <strong style="color: var(--navy);">ESS</strong> (Epworth Sleepiness Scale, 35% weight) - measures daytime sleepiness<br>
                            <strong style="color: var(--navy);">STOP-BANG</strong> (25% weight) - screens for sleep apnea risk<br><br>
                            Each instrument is normalized to a 0-100 scale (where higher = better sleep health), then combined using the weights above.
                            A score of <span style="color: #2e7d32; font-weight: 500;">70+</span> indicates good sleep health,
                            <span style="color: #f57c00; font-weight: 500;">40-69</span> is moderate, and
                            <span style="color: #c62828; font-weight: 500;">below 40</span> indicates significant sleep concerns.
                        </p>
                    </div>
                </div>
            </div>

            <div class="data-card" style="padding: 22px 25px;">
                <div id="assessments-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Messages Section -->
        <section class="admin-section" id="section-messages">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Messages</h1>
                    <p class="page-subtitle">Communicate with your clients</p>
                </div>
            </div>

            <div class="data-card">
                <div class="conversations-list" id="conversations-list">
                    <div class="loading">Loading...</div>
                </div>
                <div class="chat-container" id="chat-container">
                    <div class="chat-header">
                        <button class="chat-back" onclick="closeChat()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <div class="conversation-avatar" id="chat-avatar">?</div>
                        <div class="conversation-name" id="chat-name">Client</div>
                    </div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleMessageKeypress(event)">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Appointments Section -->
        <section class="admin-section" id="section-appointments">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Appointments</h1>
                    <p class="page-subtitle">Manage consultation requests and schedule sessions</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showScheduleAppointmentModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Schedule Appointment
                </button>
            </div>

            <!-- Quick Availability Card -->
            <div class="data-card" style="margin-bottom: 25px; padding: 22px 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Your Availability</h3>
                    <button class="action-btn action-btn-secondary" onclick="showSetAvailabilityModal()" style="font-size: 12px; padding: 8px 16px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Set Availability
                    </button>
                </div>
                <div id="availability-preview" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; text-align: center;">
                    <div style="padding: 10px; background: rgba(46, 125, 50, 0.1); border-radius: 6px; border: 1px solid rgba(46, 125, 50, 0.3);">
                        <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Mon</div>
                        <div style="font-size: 13px; color: var(--navy); font-weight: 500;">9am-5pm</div>
                    </div>
                    <div style="padding: 10px; background: rgba(46, 125, 50, 0.1); border-radius: 6px; border: 1px solid rgba(46, 125, 50, 0.3);">
                        <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Tue</div>
                        <div style="font-size: 13px; color: var(--navy); font-weight: 500;">9am-5pm</div>
                    </div>
                    <div style="padding: 10px; background: rgba(46, 125, 50, 0.1); border-radius: 6px; border: 1px solid rgba(46, 125, 50, 0.3);">
                        <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Wed</div>
                        <div style="font-size: 13px; color: var(--navy); font-weight: 500;">9am-5pm</div>
                    </div>
                    <div style="padding: 10px; background: rgba(46, 125, 50, 0.1); border-radius: 6px; border: 1px solid rgba(46, 125, 50, 0.3);">
                        <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Thu</div>
                        <div style="font-size: 13px; color: var(--navy); font-weight: 500;">9am-5pm</div>
                    </div>
                    <div style="padding: 10px; background: rgba(46, 125, 50, 0.1); border-radius: 6px; border: 1px solid rgba(46, 125, 50, 0.3);">
                        <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Fri</div>
                        <div style="font-size: 13px; color: var(--navy); font-weight: 500;">9am-3pm</div>
                    </div>
                    <div style="padding: 10px; background: rgba(211, 47, 47, 0.1); border-radius: 6px; border: 1px solid rgba(211, 47, 47, 0.2);">
                        <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Sat</div>
                        <div style="font-size: 13px; color: var(--danger);">Closed</div>
                    </div>
                    <div style="padding: 10px; background: rgba(211, 47, 47, 0.1); border-radius: 6px; border: 1px solid rgba(211, 47, 47, 0.2);">
                        <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Sun</div>
                        <div style="font-size: 13px; color: var(--danger);">Closed</div>
                    </div>
                </div>
                <p style="font-size: 12px; color: var(--text-light); margin-top: 12px;">
                    <strong>Zoom Link:</strong> <a href="https://harvard.zoom.us/my/alen1" target="_blank" style="color: var(--gold);">https://harvard.zoom.us/my/alen1</a>
                </p>
            </div>

            <div class="data-card" style="padding: 22px 25px;">
                <div id="appointments-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Questionnaires Section -->
        <section class="admin-section" id="section-questionnaires">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Questionnaires</h1>
                    <p class="page-subtitle">Assign validated clinical questionnaires and view results</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showAssignQuestionnaireModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Assign Questionnaire
                </button>
            </div>

            <!-- Available Questionnaires Grid -->
            <div class="data-card" style="margin-bottom: 25px;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Available Clinical Instruments</h3>
                <div id="questionnaires-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Questionnaire cards will be inserted here -->
                </div>
            </div>

            <!-- Pending Questionnaires -->
            <div class="data-card" style="margin-bottom: 25px;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Pending Assignments</h3>
                <div id="pending-questionnaires-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Completed Questionnaire Results -->
            <div class="data-card">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Recent Results</h3>
                <div id="questionnaire-results-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Hotel Partners Section -->
        <section class="admin-section" id="section-hotel-partners">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Hotel Partners</h1>
                    <p class="page-subtitle">B2B partnerships and guest sleep improvement tracking</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" style="background: #2e7d32; color: white;" onclick="createDemoHotelData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                        </svg>
                        Create Demo Data
                    </button>
                    <button class="action-btn action-btn-primary" onclick="showAddHotelModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Hotel Partner
                    </button>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Active Partners</div>
                    <div class="stat-value" id="stat-hotel-partners">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Guests</div>
                    <div class="stat-value" id="stat-active-hotel-guests">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Improvement</div>
                    <div class="stat-value" id="stat-avg-improvement">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Reports Pending</div>
                    <div class="stat-value" id="stat-pending-reports">0</div>
                </div>
            </div>

            <!-- Hotel Partners List -->
            <div class="data-card" style="margin-bottom: 25px;">
                <div class="data-card-header">
                    <h2 class="data-card-title">Partner Hotels</h2>
                </div>
                <div id="hotel-partners-list" style="padding: 15px;">
                    <div class="loading">Loading hotel partners...</div>
                </div>
            </div>

            <!-- Pending Reports -->
            <div class="data-card" id="pending-reports-card" style="display: none;">
                <div class="data-card-header">
                    <h2 class="data-card-title">Reports Pending Generation</h2>
                </div>
                <div id="pending-reports-list" style="padding: 15px;">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Hotel Partner Detail Section -->
        <section class="admin-section" id="section-hotel-detail">
            <div class="page-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="showSection('hotel-partners')" style="background: white; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <div>
                        <h1 class="page-title" id="hotel-detail-name">Hotel Name</h1>
                        <p class="page-subtitle" id="hotel-detail-contact">Contact: loading...</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn action-btn-secondary" onclick="editCurrentHotel()">Edit Hotel</button>
                    <button class="action-btn action-btn-primary" onclick="showHotelInviteModal()">Generate Guest Invite</button>
                </div>
            </div>

            <!-- Hotel Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Total Guests</div>
                    <div class="stat-value" id="hotel-stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Stays</div>
                    <div class="stat-value" id="hotel-stat-active">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Sleep Improvement</div>
                    <div class="stat-value" id="hotel-stat-improvement">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Rating</div>
                    <div class="stat-value" id="hotel-stat-rating">-</div>
                </div>
            </div>

            <!-- Guests Tabs -->
            <div class="data-card">
                <div class="data-card-header" style="border-bottom: none;">
                    <div style="display: flex; gap: 20px;">
                        <button class="hotel-tab active" data-tab="active" onclick="switchHotelTab('active')">Active Guests</button>
                        <button class="hotel-tab" data-tab="completed" onclick="switchHotelTab('completed')">Completed Stays</button>
                    </div>
                </div>
                <div id="hotel-guests-list" style="padding: 0;">
                    <div class="loading" style="padding: 20px;">Loading guests...</div>
                </div>
            </div>
        </section>

        <!-- Athletic Partners Section -->
        <section class="admin-section" id="section-athletic-partners">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Athletic Partners</h1>
                    <p class="page-subtitle">Sports teams and athlete sleep performance programs</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" style="background: #2e7d32; color: white;" onclick="createDemoAthleticData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                        </svg>
                        Create Demo Data
                    </button>
                    <button class="action-btn action-btn-primary" onclick="showAddAthleticPartnerModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Team/Organization
                    </button>
                </div>
            </div>

            <!-- Athletic Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Active Teams</div>
                    <div class="stat-value" id="stat-athletic-teams">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Athletes</div>
                    <div class="stat-value" id="stat-total-athletes">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Recovery Score</div>
                    <div class="stat-value" id="stat-avg-recovery">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Programs</div>
                    <div class="stat-value" id="stat-active-programs">0</div>
                </div>
            </div>

            <!-- Athletic Partners List -->
            <div class="data-card" style="margin-bottom: 25px;">
                <div class="data-card-header">
                    <h2 class="data-card-title">Teams & Organizations</h2>
                </div>
                <div id="athletic-partners-list" style="padding: 15px;">
                    <p style="color: var(--text-light); text-align: center; padding: 40px 20px;">
                        No athletic partners yet. Click "Add Team/Organization" to create your first partnership.
                    </p>
                </div>
            </div>
        </section>

        <!-- Athletic Partner Detail Section -->
        <section class="admin-section" id="section-athletic-detail">
            <div class="page-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="showSection('athletic-partners')" style="background: white; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <div>
                        <h1 class="page-title" id="athletic-detail-name">Team Name</h1>
                        <p class="page-subtitle" id="athletic-detail-sport">Sport: Loading...</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn action-btn-secondary" onclick="editCurrentAthleticPartner()">Edit Team</button>
                    <button class="action-btn action-btn-primary" onclick="showAthleteInviteModal()">Add Athlete</button>
                </div>
            </div>

            <!-- Team Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Total Athletes</div>
                    <div class="stat-value" id="athletic-stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Season</div>
                    <div class="stat-value" id="athletic-stat-season">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Sleep Score</div>
                    <div class="stat-value" id="athletic-stat-sleep">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Recovery</div>
                    <div class="stat-value" id="athletic-stat-recovery">0%</div>
                </div>
            </div>

            <!-- Athletes List -->
            <div class="data-card">
                <div class="data-card-header" style="border-bottom: none;">
                    <div style="display: flex; gap: 20px;">
                        <button class="hotel-tab active" data-tab="roster" onclick="switchAthleticTab('roster')">Team Roster</button>
                        <button class="hotel-tab" data-tab="reports" onclick="switchAthleticTab('reports')">Performance Reports</button>
                    </div>
                </div>
                <div id="athletic-members-list" style="padding: 0;">
                    <div class="loading" style="padding: 20px;">Loading athletes...</div>
                </div>
            </div>
        </section>

        <!-- Business Partners Section -->
        <section class="admin-section" id="section-business-partners">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Business Partners</h1>
                    <p class="page-subtitle">Corporate executive wellness and leadership programs</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" style="background: #2e7d32; color: white;" onclick="createDemoBusinessData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                        </svg>
                        Create Demo Data
                    </button>
                    <button class="action-btn action-btn-primary" onclick="showAddBusinessPartnerModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Organization
                    </button>
                </div>
            </div>

            <!-- Business Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Partner Organizations</div>
                    <div class="stat-value" id="stat-business-orgs">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Executives</div>
                    <div class="stat-value" id="stat-total-executives">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Performance Gain</div>
                    <div class="stat-value" id="stat-avg-performance">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Programs</div>
                    <div class="stat-value" id="stat-business-programs">0</div>
                </div>
            </div>

            <!-- Business Partners List -->
            <div class="data-card" style="margin-bottom: 25px;">
                <div class="data-card-header">
                    <h2 class="data-card-title">Partner Organizations</h2>
                </div>
                <div id="business-partners-list" style="padding: 15px;">
                    <p style="color: var(--text-light); text-align: center; padding: 40px 20px;">
                        No business partners yet. Click "Add Organization" to create your first partnership.
                    </p>
                </div>
            </div>
        </section>

        <!-- Business Partner Detail Section -->
        <section class="admin-section" id="section-business-detail">
            <div class="page-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="showSection('business-partners')" style="background: white; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <div>
                        <h1 class="page-title" id="business-detail-name">Organization Name</h1>
                        <p class="page-subtitle" id="business-detail-industry">Industry: Loading...</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn action-btn-secondary" onclick="editCurrentBusinessPartner()">Edit Organization</button>
                    <button class="action-btn action-btn-primary" onclick="showExecutiveInviteModal()">Add Executive</button>
                </div>
            </div>

            <!-- Organization Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Total Participants</div>
                    <div class="stat-value" id="business-stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Program Type</div>
                    <div class="stat-value" id="business-stat-program" style="font-size: 18px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Sleep Improvement</div>
                    <div class="stat-value" id="business-stat-sleep">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completion Rate</div>
                    <div class="stat-value" id="business-stat-completion">0%</div>
                </div>
            </div>

            <!-- Participants List -->
            <div class="data-card">
                <div class="data-card-header" style="border-bottom: none;">
                    <div style="display: flex; gap: 20px;">
                        <button class="hotel-tab active" data-tab="participants" onclick="switchBusinessTab('participants')">Participants</button>
                        <button class="hotel-tab" data-tab="progress" onclick="switchBusinessTab('progress')">Program Progress</button>
                    </div>
                </div>
                <div id="business-members-list" style="padding: 0;">
                    <div class="loading" style="padding: 20px;">Loading participants...</div>
                </div>
            </div>
        </section>

        <!-- Modules Section (merged) -->
        <section class="admin-section" id="section-modules">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Therapeutic Modules</h1>
                    <p class="page-subtitle">Evidence-based interventions for sleep improvement</p>
                </div>
                <button class="action-btn action-btn-primary" onclick="showUnlockModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Assign to Client
                </button>
            </div>

            <!-- Pending Module Requests -->
            <div class="data-card" id="module-requests-card" style="margin-bottom: 25px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">
                        <span style="color: var(--gold);"></span> Pending Requests
                    </h3>
                </div>
                <div id="requests-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- All Available Modules -->
            <div class="data-card" style="margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Available Therapeutic Modules</h3>
                    <span style="font-size: 12px; color: var(--text-light); background: rgba(201, 169, 98, 0.15); padding: 4px 12px; border-radius: 20px;">14 modules  All scientifically validated</span>
                </div>
                <div id="all-modules-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <div class="loading">Loading modules...</div>
                </div>
            </div>

            <!-- Assignment History -->
            <div class="data-card">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 20px;">Recent Assignments</h3>
                <div id="unlocks-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Generate Invite Modal -->
<div id="invite-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Generate Invite Code</h2>
            <button onclick="closeModal('invite-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div id="invite-form-view">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Client Email (optional)</label>
                <input type="email" id="invite-email" placeholder="client@email.com" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Notes</label>
                <textarea id="invite-notes" rows="3" placeholder="Any notes about this invite..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal('invite-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button onclick="generateInviteCode()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Generate Code</button>
            </div>
        </div>

        <div id="invite-result-view" style="display: none;">
            <p style="text-align: center; margin-bottom: 10px; color: #666;">Share this code with your client:</p>
            <div style="background: #f5f5f5; padding: 20px; text-align: center; border-radius: 8px; margin: 20px 0;">
                <div id="generated-code" style="font-family: 'Courier New', monospace; font-size: 28px; font-weight: bold; color: #0f1c2e; letter-spacing: 2px; margin-bottom: 15px;">SW-XXXX-XXXX</div>
                <button onclick="copyInviteCode()" style="padding: 10px 20px; background: #0f1c2e; color: white; border: none; cursor: pointer; border-radius: 4px;">Copy Code</button>
            </div>

            <!-- Email Section -->
            <div id="email-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="font-size: 14px; color: #0f1c2e; font-weight: 500; margin-bottom: 15px; text-align: center;">Send Welcome Email to Client</p>
                <div id="email-preview" style="background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 15px; font-size: 13px; line-height: 1.7; color: #333;">
                    <!-- Email preview will be inserted here -->
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="send-email-btn" onclick="sendInviteEmail()" style="padding: 12px 24px; background: #2e7d32; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        Send Email
                    </button>
                </div>
                <p id="email-status" style="text-align: center; margin-top: 10px; font-size: 13px; display: none;"></p>
            </div>

            <p style="font-size: 13px; color: #666; text-align: center; margin-top: 15px;">
                The client will use this code to create their account at:<br>
                <strong id="auth-url"></strong>
            </p>
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button onclick="closeInviteModal()" style="padding: 12px 30px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Action Modal -->
<div id="action-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Add Next Step</h2>
            <button onclick="closeModal('action-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Action Description *</label>
            <input type="text" id="action-text" placeholder="e.g., Schedule follow-up consultation" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Priority</label>
            <select id="action-priority" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="normal">Normal</option>
                <option value="high">High Priority</option>
                <option value="low">Low Priority</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Due Date (optional)</label>
            <input type="date" id="action-due" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('action-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="addClientAction()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Add Action</button>
        </div>
    </div>
</div>

<!-- Assign Questionnaire Modal -->
<div id="assign-questionnaire-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative;">
        <div class="modal-header">
            <h2 class="modal-title">Assign Questionnaire</h2>
            <button class="modal-close" onclick="closeModal('assign-questionnaire-modal')">&times;</button>
        </div>

        <div class="form-group">
            <label>Select Questionnaire</label>
            <select id="questionnaire-select" style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 6px; font-size: 14px;">
                <option value="">Choose a questionnaire...</option>
            </select>
            <div id="questionnaire-preview" style="display: none; margin-top: 15px; padding: 15px; background: #f8f6f3; border-radius: 8px;">
                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                    <span id="qp-time" style="font-size: 12px; color: var(--text-light);"></span>
                    <span id="qp-category" style="font-size: 12px; color: var(--gold); font-weight: 500;"></span>
                </div>
                <p id="qp-description" style="font-size: 13px; color: var(--navy); margin: 0;"></p>
            </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label>Select Clients</label>
            <div id="questionnaire-clients-list" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 6px; padding: 10px;">
                <div class="loading">Loading clients...</div>
            </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label>Due Date</label>
            <input type="date" id="questionnaire-due-date" style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 6px; font-size: 14px;">
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <label>Notes (optional)</label>
            <textarea id="questionnaire-notes" rows="2" placeholder="Any instructions for the client..." style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
        </div>

        <div class="form-actions" style="margin-top: 25px;">
            <button class="action-btn action-btn-secondary" onclick="closeModal('assign-questionnaire-modal')">Cancel</button>
            <button class="action-btn action-btn-primary" onclick="assignQuestionnaireToClients()">Assign Questionnaire</button>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="task-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Add Task</h2>
            <button onclick="closeModal('task-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Task Description *</label>
            <input type="text" id="task-title" placeholder="e.g., Follow up with John about sleep diary" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Related Client (optional)</label>
            <select id="task-client" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">No specific client</option>
            </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Due Date</label>
                <input type="date" id="task-due" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Priority</label>
                <select id="task-priority" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Notes (optional)</label>
            <textarea id="task-notes" rows="2" placeholder="Additional details..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('task-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveTask()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Save Task</button>
        </div>
    </div>
</div>

<!-- Unlock Module Modal -->
<div id="unlock-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative;">
        <div class="modal-header">
            <h2 class="modal-title">Grant Module Access</h2>
            <button class="modal-close" onclick="closeModal('unlock-modal')">&times;</button>
        </div>

        <div class="form-group">
            <label for="unlock-client">Select Client</label>
            <select id="unlock-client">
                <option value="">Loading clients...</option>
            </select>
        </div>

        <div class="form-group">
            <label>Modules to Unlock</label>
            <div style="margin-top: 10px; max-height: 350px; overflow-y: auto;">
                <p style="font-size: 11px; color: var(--text-light); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Relaxation Techniques</p>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="breathing-478"> 4-7-8 Breathing Technique
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="pmr"> Progressive Muscle Relaxation
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="mindfulness-bodyscan"> Mindfulness & Body Scan
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="autogenic-training"> Autogenic Training
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="guided-imagery"> Guided Imagery for Sleep
                </label>

                <p style="font-size: 11px; color: var(--text-light); margin: 15px 0 12px; text-transform: uppercase; letter-spacing: 1px;">CBT-I Components</p>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-restriction"> CBT-I: Sleep Restriction
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-stimulus"> CBT-I: Stimulus Control
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="cbti-cognitive"> CBT-I: Cognitive Restructuring
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="paradoxical-intention"> Paradoxical Intention
                </label>

                <p style="font-size: 11px; color: var(--text-light); margin: 15px 0 12px; text-transform: uppercase; letter-spacing: 1px;">Cognitive & Lifestyle</p>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="worry-management"> Worry Time & Constructive Worry
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="circadian-rhythm"> Circadian Rhythm Optimization
                </label>

                <p style="font-size: 11px; color: var(--text-light); margin: 15px 0 12px; text-transform: uppercase; letter-spacing: 1px;">Tools</p>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" name="unlock-modules" value="sleep-diary"> Interactive Sleep Diary
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="unlock-notes">Notes</label>
            <textarea id="unlock-notes" rows="2" placeholder="Reason for unlocking..."></textarea>
        </div>

        <div class="form-actions">
            <button class="action-btn action-btn-secondary" onclick="closeModal('unlock-modal')">Cancel</button>
            <button class="action-btn action-btn-primary" onclick="grantUnlock()">Grant Access</button>
        </div>
    </div>
</div>

<!-- Module Detail Modal -->
<div id="module-detail-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative;">
        <div class="modal-header">
            <h2 class="modal-title" id="module-detail-title">Module Name</h2>
            <button class="modal-close" onclick="closeModal('module-detail-modal')">&times;</button>
        </div>

        <div id="module-detail-content" style="padding: 0 25px;">
            <!-- Module info will be injected here -->
        </div>

        <div style="padding: 20px 25px; border-top: 1px solid rgba(201, 169, 98, 0.2); margin-top: 20px;">
            <h4 style="font-size: 14px; color: var(--navy); margin-bottom: 15px;">Assign to Clients</h4>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="font-size: 13px; color: var(--text-light); margin-bottom: 8px; display: block;">Select clients to assign this module:</label>
                <div id="module-assign-clients" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 6px; padding: 10px;">
                    <div class="loading">Loading clients...</div>
                </div>
            </div>
            <input type="hidden" id="module-assign-id">
            <div style="display: flex; gap: 10px;">
                <button class="action-btn action-btn-secondary" onclick="closeModal('module-detail-modal')" style="flex: 1;">Cancel</button>
                <button class="action-btn action-btn-primary" onclick="assignModuleToSelected()" id="assign-module-btn" style="flex: 1;">Assign Module</button>
            </div>
        </div>
    </div>
</div>

<!-- Archive Client Modal -->
<div id="archive-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Archive Client</h2>
            <button onclick="closeModal('archive-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                <div style="font-size: 13px; color: #856404; line-height: 1.5;">
                    <strong>This will archive <span id="archive-client-name">the client</span>.</strong><br>
                    All data will be preserved and can be restored later. The client will no longer appear in your active client list.
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Reason for archiving (optional)</label>
            <select id="archive-reason" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Select a reason...</option>
                <option value="program_completed">Program completed successfully</option>
                <option value="client_request">Client requested to pause/stop</option>
                <option value="non_responsive">Client non-responsive</option>
                <option value="transferred">Transferred to another provider</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Notes</label>
            <textarea id="archive-notes" rows="3" placeholder="Any additional notes about archiving this client..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('archive-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="archiveClient()" style="padding: 12px 24px; background: #f57c00; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Archive Client</button>
        </div>
    </div>
</div>

<!-- Assign Task Modal -->
<div id="assign-task-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; margin: 20px auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Assign Task</h2>
            <button onclick="closeModal('assign-task-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Assign a task to <strong id="assign-task-client-name">this client</strong>. They will receive a notification.</p>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Task Type *</label>
            <select id="task-type" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;" onchange="onTaskTypeChange()">
                <option value="">Select a task type...</option>
                <optgroup label="Sleep Diary & Tracking">
                    <option value="diary">Complete Sleep Diary</option>
                    <option value="diary-week">Complete Sleep Diary for 1 Week</option>
                    <option value="actigraphy">Review Actigraphy Data</option>
                </optgroup>
                <optgroup label="Questionnaires">
                    <option value="questionnaire-isi">Complete ISI Questionnaire</option>
                    <option value="questionnaire-ess">Complete ESS Questionnaire</option>
                    <option value="questionnaire-psqi">Complete PSQI Questionnaire</option>
                    <option value="questionnaire-all">Complete All Baseline Questionnaires</option>
                </optgroup>
                <optgroup label="Modules & Learning">
                    <option value="module">Complete Assigned Module</option>
                    <option value="reading">Read Educational Material</option>
                    <option value="practice">Practice Relaxation Technique</option>
                </optgroup>
                <optgroup label="Behavioral Tasks">
                    <option value="sleep-schedule">Follow Sleep Schedule</option>
                    <option value="stimulus-control">Practice Stimulus Control</option>
                    <option value="sleep-hygiene">Implement Sleep Hygiene Changes</option>
                    <option value="worry-time">Schedule Worry Time</option>
                </optgroup>
                <optgroup label="Appointments & Communication">
                    <option value="schedule-appointment">Schedule Follow-up Appointment</option>
                    <option value="check-in">Send Progress Update</option>
                    <option value="questions">Review and Ask Questions</option>
                </optgroup>
                <optgroup label="Custom">
                    <option value="custom">Custom Task...</option>
                </optgroup>
            </select>
        </div>

        <div id="custom-task-field" style="display: none; margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Custom Task Title *</label>
            <input type="text" id="custom-task-title" placeholder="Enter task title..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Instructions / Notes (optional)</label>
            <textarea id="task-instructions" rows="3" placeholder="Add any specific instructions or context for this task..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Priority</label>
                <select id="task-priority" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="normal">Normal</option>
                    <option value="high">High Priority</option>
                    <option value="low">Low Priority</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Due Date (optional)</label>
                <input type="date" id="task-due-date" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>

        <div style="background: rgba(201, 169, 98, 0.1); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="task-send-notification" checked style="width: 18px; height: 18px;">
                <span style="font-size: 14px; color: #0f1c2e;">Send notification to client</span>
            </label>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('assign-task-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="assignTaskToClient()" id="assign-task-btn" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Assign Task</button>
        </div>
    </div>
</div>

<!-- Schedule Appointment Modal -->
<div id="schedule-appointment-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; margin: 20px auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Schedule Appointment</h2>
            <button onclick="closeModal('schedule-appointment-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <!-- Step 1: Select Client -->
        <div id="schedule-step-1">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Select Client *</label>
                <select id="schedule-client" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;" onchange="onScheduleClientChange()">
                    <option value="">Choose a client...</option>
                </select>
            </div>

            <div id="client-email-warning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <div style="font-size: 13px; color: #856404; line-height: 1.5;">
                        <strong>No email on file.</strong> This client won't receive an email confirmation. Consider adding their email to their profile.
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Appointment Type</label>
                <select id="schedule-type" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="initial">Initial Consultation (60 min)</option>
                    <option value="followup" selected>Follow-up Session (30 min)</option>
                    <option value="review">Progress Review (45 min)</option>
                    <option value="extended">Extended Session (90 min)</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Select Date *</label>
                <input type="date" id="schedule-date" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;" onchange="generateTimeSlots()">
            </div>

            <div id="time-slots-container" style="display: none;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 12px;">Available Time Slots</label>
                <div id="time-slots-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                    <!-- Time slots will be generated here -->
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Meeting Location</label>
                <select id="schedule-location" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="zoom" selected>Zoom Video Call</option>
                    <option value="phone">Phone Call</option>
                    <option value="inperson">In-Person</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Notes (optional)</label>
                <textarea id="schedule-notes" rows="2" placeholder="Any notes about this appointment..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal('schedule-appointment-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button onclick="confirmScheduleAppointment()" id="schedule-confirm-btn" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; opacity: 0.5;" disabled>Schedule & Send Confirmation</button>
            </div>
        </div>

        <!-- Step 2: Confirmation -->
        <div id="schedule-step-2" style="display: none;">
            <div style="text-align: center; padding: 30px 0;">
                <div style="width: 80px; height: 80px; background: rgba(46, 125, 50, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin-bottom: 10px;">Appointment Scheduled!</h3>
                <p id="schedule-confirmation-text" style="color: #666; margin-bottom: 20px;">The appointment has been created and a confirmation email has been sent.</p>

                <div id="schedule-summary" style="background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: left; margin-bottom: 25px;">
                    <!-- Summary will be inserted here -->
                </div>

                <button onclick="closeScheduleModal()" style="padding: 12px 30px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- Set Availability Modal -->
<div id="set-availability-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; margin: 20px auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Set Your Availability</h2>
            <button onclick="closeModal('set-availability-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Configure your weekly availability for client appointments. Clients will only be able to book during these hours.</p>

        <div id="availability-settings">
            <div style="display: grid; gap: 12px;">
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <span style="font-weight: 500; color: #0f1c2e;">Monday</span>
                    <input type="time" id="avail-mon-start" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="time" id="avail-mon-end" value="17:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" id="avail-mon-closed"> Closed</label>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <span style="font-weight: 500; color: #0f1c2e;">Tuesday</span>
                    <input type="time" id="avail-tue-start" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="time" id="avail-tue-end" value="17:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" id="avail-tue-closed"> Closed</label>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <span style="font-weight: 500; color: #0f1c2e;">Wednesday</span>
                    <input type="time" id="avail-wed-start" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="time" id="avail-wed-end" value="17:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" id="avail-wed-closed"> Closed</label>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <span style="font-weight: 500; color: #0f1c2e;">Thursday</span>
                    <input type="time" id="avail-thu-start" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="time" id="avail-thu-end" value="17:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" id="avail-thu-closed"> Closed</label>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <span style="font-weight: 500; color: #0f1c2e;">Friday</span>
                    <input type="time" id="avail-fri-start" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="time" id="avail-fri-end" value="15:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" id="avail-fri-closed"> Closed</label>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <span style="font-weight: 500; color: #0f1c2e;">Saturday</span>
                    <input type="time" id="avail-sat-start" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                    <input type="time" id="avail-sat-end" value="17:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" id="avail-sat-closed" checked onchange="toggleAvailabilityInputs('sat')"> Closed</label>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <span style="font-weight: 500; color: #0f1c2e;">Sunday</span>
                    <input type="time" id="avail-sun-start" value="09:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                    <input type="time" id="avail-sun-end" value="17:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" id="avail-sun-closed" checked onchange="toggleAvailabilityInputs('sun')"> Closed</label>
                </div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Appointment Duration (default)</label>
            <select id="avail-default-duration" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="30">30 minutes</option>
                <option value="45">45 minutes</option>
                <option value="60">60 minutes</option>
            </select>
        </div>

        <div style="margin-top: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Zoom Meeting Link</label>
            <input type="url" id="avail-zoom-link" value="https://harvard.zoom.us/my/alen1" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
            <button onclick="closeModal('set-availability-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveAvailability()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Save Availability</button>
        </div>
    </div>
</div>

<!-- Add/Edit Hotel Partner Modal -->
<div id="hotel-partner-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; margin: 20px auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;" id="hotel-modal-title">Add Hotel Partner</h2>
            <button onclick="closeModal('hotel-partner-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <input type="hidden" id="hotel-edit-id">

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Hotel Name *</label>
            <input type="text" id="hotel-name" placeholder="e.g., Ritz Paris" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Hotel ID (URL slug) *</label>
            <input type="text" id="hotel-id" placeholder="e.g., ritz-paris" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            <p style="font-size: 11px; color: #888; margin-top: 5px;">Used in guest signup URL: /auth.html?hotel=<strong id="hotel-id-preview">...</strong></p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Contact Name *</label>
                <input type="text" id="hotel-contact-name" placeholder="e.g., Jean-Pierre Dubois" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Contact Email *</label>
                <input type="email" id="hotel-contact-email" placeholder="e.g., gm@ritzparis.com" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Hotel Logo URL (optional)</label>
            <input type="url" id="hotel-logo-url" placeholder="https://..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Partnership Status</label>
            <select id="hotel-status" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>

        <div style="background: #f8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 12px;">Report Settings</p>
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="hotel-include-name" style="width: 16px; height: 16px;">
                Include guest name in reports (uncheck for anonymized reports)
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="hotel-email-on-checkout" checked style="width: 16px; height: 16px;">
                Email report to hotel on guest checkout
            </label>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('hotel-partner-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveHotelPartner()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Save Hotel Partner</button>
        </div>
    </div>
</div>

<!-- Hotel Guest Invite Modal -->
<div id="hotel-invite-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Guest Signup Link</h2>
            <button onclick="closeModal('hotel-invite-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Share this link with <strong id="hotel-invite-hotel-name">the hotel</strong> to provide to their guests:</p>

        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="font-size: 12px; color: #888; margin-bottom: 5px;">Guest Signup URL:</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <code id="hotel-signup-url" style="flex: 1; font-size: 13px; word-break: break-all; color: #0f1c2e;"></code>
                <button onclick="copyHotelSignupUrl()" style="padding: 8px 16px; background: #0f1c2e; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap;">Copy</button>
            </div>
        </div>

        <div style="background: rgba(201, 169, 98, 0.1); border: 1px solid var(--gold); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="font-size: 13px; color: #0f1c2e; margin: 0;">
                <strong>How it works:</strong><br>
                <span style="font-size: 12px; color: #666;">
                1. Guest visits the link and creates an account<br>
                2. They enter their room number and checkout date<br>
                3. Assessments are automatically tagged for this stay<br>
                4. Report is generated when they complete checkout
                </span>
            </p>
        </div>

        <div style="display: flex; justify-content: center;">
            <button onclick="closeModal('hotel-invite-modal')" style="padding: 12px 30px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Done</button>
        </div>
    </div>
</div>

<!-- Guest Stay Detail Modal -->
<div id="guest-stay-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; margin: 20px auto; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;">Guest Stay Details</h2>
            <button onclick="closeModal('guest-stay-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <div id="guest-stay-content">
            <div class="loading">Loading...</div>
        </div>

        <div id="guest-stay-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
            <button onclick="closeModal('guest-stay-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Close</button>
            <button id="generate-report-btn" onclick="generateGuestReport()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Generate Report</button>
        </div>
    </div>
</div>

<!-- Add/Edit Athletic Partner Modal -->
<div id="athletic-partner-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; margin: 20px auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;" id="athletic-modal-title">Add Athletic Partner</h2>
            <button onclick="closeModal('athletic-partner-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <input type="hidden" id="athletic-edit-id">

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Team/Organization Name *</label>
            <input type="text" id="athletic-name" placeholder="e.g., LA Lakers, US Ski Team" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Partner ID (URL slug) *</label>
            <input type="text" id="athletic-id" placeholder="e.g., la-lakers" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            <p style="font-size: 11px; color: #888; margin-top: 5px;">Used in athlete signup URL: /auth.html?team=<strong id="athletic-id-preview">...</strong></p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Sport/Discipline *</label>
                <select id="athletic-sport" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="basketball">Basketball</option>
                    <option value="football">Football</option>
                    <option value="soccer">Soccer</option>
                    <option value="baseball">Baseball</option>
                    <option value="hockey">Hockey</option>
                    <option value="tennis">Tennis</option>
                    <option value="golf">Golf</option>
                    <option value="swimming">Swimming</option>
                    <option value="track-field">Track & Field</option>
                    <option value="skiing">Skiing</option>
                    <option value="cycling">Cycling</option>
                    <option value="mma">MMA/Combat Sports</option>
                    <option value="esports">Esports</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Competition Level</label>
                <select id="athletic-level" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="professional">Professional</option>
                    <option value="olympic">Olympic/National</option>
                    <option value="college">College/University</option>
                    <option value="amateur">Amateur/Club</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Contact Name *</label>
                <input type="text" id="athletic-contact-name" placeholder="e.g., Performance Director" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Contact Email *</label>
                <input type="email" id="athletic-contact-email" placeholder="e.g., performance@team.com" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Team Logo URL (optional)</label>
            <input type="url" id="athletic-logo-url" placeholder="https://..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Partnership Status</label>
            <select id="athletic-status" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>

        <div style="background: #f8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 12px;">Program Focus</p>
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="athletic-focus-recovery" checked style="width: 16px; height: 16px;">
                Recovery optimization
            </label>
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="athletic-focus-travel" checked style="width: 16px; height: 16px;">
                Travel/jet lag management
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="athletic-focus-performance" checked style="width: 16px; height: 16px;">
                Game-day performance
            </label>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('athletic-partner-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveAthleticPartner()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Save Partner</button>
        </div>
    </div>
</div>

<!-- Add/Edit Business Partner Modal -->
<div id="business-partner-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; margin: 20px auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: #0f1c2e; margin: 0;" id="business-modal-title">Add Business Partner</h2>
            <button onclick="closeModal('business-partner-modal')" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
        </div>

        <input type="hidden" id="business-edit-id">

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Organization Name *</label>
            <input type="text" id="business-name" placeholder="e.g., Goldman Sachs, McKinsey & Company" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Partner ID (URL slug) *</label>
            <input type="text" id="business-id" placeholder="e.g., goldman-sachs" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            <p style="font-size: 11px; color: #888; margin-top: 5px;">Used in executive signup URL: /auth.html?corp=<strong id="business-id-preview">...</strong></p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Industry *</label>
                <select id="business-industry" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="finance">Finance & Banking</option>
                    <option value="consulting">Consulting</option>
                    <option value="technology">Technology</option>
                    <option value="healthcare">Healthcare</option>
                    <option value="legal">Legal</option>
                    <option value="manufacturing">Manufacturing</option>
                    <option value="media">Media & Entertainment</option>
                    <option value="retail">Retail</option>
                    <option value="energy">Energy</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Program Type</label>
                <select id="business-program" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="executive">Executive Coaching</option>
                    <option value="leadership">Leadership Program</option>
                    <option value="wellness">Corporate Wellness</option>
                    <option value="workshop">Workshop Series</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Contact Name *</label>
                <input type="text" id="business-contact-name" placeholder="e.g., HR Director" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Contact Email *</label>
                <input type="email" id="business-contact-email" placeholder="e.g., hr@company.com" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Company Logo URL (optional)</label>
            <input type="url" id="business-logo-url" placeholder="https://..." style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 8px;">Partnership Status</label>
            <select id="business-status" style="width: 100%; padding: 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>

        <div style="background: #f8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="font-size: 13px; font-weight: 500; color: #0f1c2e; margin-bottom: 12px;">Program Focus</p>
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="business-focus-decision" checked style="width: 16px; height: 16px;">
                Decision quality & cognitive performance
            </label>
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="business-focus-travel" checked style="width: 16px; height: 16px;">
                Travel & jet lag optimization
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px;">
                <input type="checkbox" id="business-focus-stress" checked style="width: 16px; height: 16px;">
                Stress & burnout prevention
            </label>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('business-partner-modal')" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveBusinessPartner()" style="padding: 12px 24px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">Save Partner</button>
        </div>
    </div>
</div>

<style>
    /* Hotel Partner Cards */
    .hotel-partner-card {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: white;
        border: 1px solid rgba(201, 169, 98, 0.2);
        border-radius: 12px;
        margin-bottom: 15px;
        transition: all 0.2s;
        cursor: pointer;
    }

    .hotel-partner-card:hover {
        border-color: var(--gold);
        box-shadow: 0 4px 15px rgba(201, 169, 98, 0.15);
    }

    .hotel-partner-logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0f1c2e, #1a2a3a);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .hotel-partner-logo svg {
        width: 28px;
        height: 28px;
        color: var(--gold);
    }

    .hotel-partner-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
    }

    .hotel-partner-info {
        flex: 1;
    }

    .hotel-partner-name {
        font-family: 'Cormorant Garamond', serif;
        font-size: 20px;
        color: #0f1c2e;
        margin-bottom: 5px;
    }

    .hotel-partner-contact {
        font-size: 13px;
        color: #888;
    }

    .hotel-partner-stats {
        display: flex;
        gap: 25px;
        text-align: center;
    }

    .hotel-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .hotel-stat-value {
        font-family: 'Cormorant Garamond', serif;
        font-size: 24px;
        color: #0f1c2e;
        font-weight: 600;
    }

    .hotel-stat-label {
        font-size: 11px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .hotel-partner-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
    }

    .hotel-partner-status.active {
        background: rgba(46, 125, 50, 0.1);
        color: #2e7d32;
    }

    .hotel-partner-status.pending {
        background: rgba(237, 108, 2, 0.1);
        color: #ed6c02;
    }

    .hotel-partner-status.inactive {
        background: rgba(107, 123, 138, 0.1);
        color: #6b7b8a;
    }

    /* Hotel tabs */
    .hotel-tab {
        background: none;
        border: none;
        padding: 12px 20px;
        font-size: 13px;
        color: #888;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .hotel-tab:hover {
        color: #0f1c2e;
    }

    .hotel-tab.active {
        color: #0f1c2e;
        border-bottom-color: var(--gold);
    }

    /* Guest stay row */
    .guest-stay-row {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: background 0.2s;
    }

    .guest-stay-row:hover {
        background: rgba(201, 169, 98, 0.05);
    }

    .guest-stay-row:last-child {
        border-bottom: none;
    }

    .guest-avatar {
        width: 40px;
        height: 40px;
        background: var(--gold);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #0f1c2e;
        flex-shrink: 0;
    }

    .guest-info {
        flex: 1;
    }

    .guest-name {
        font-size: 14px;
        font-weight: 500;
        color: #0f1c2e;
    }

    .guest-dates {
        font-size: 12px;
        color: #888;
    }

    .guest-room {
        font-size: 13px;
        color: #0f1c2e;
        background: rgba(201, 169, 98, 0.1);
        padding: 4px 10px;
        border-radius: 4px;
    }

    .guest-improvement {
        text-align: center;
        min-width: 80px;
    }

    .guest-improvement-value {
        font-family: 'Cormorant Garamond', serif;
        font-size: 20px;
        font-weight: 600;
    }

    .guest-improvement-value.positive {
        color: #2e7d32;
    }

    .guest-improvement-value.neutral {
        color: #888;
    }

    .guest-improvement-label {
        font-size: 10px;
        color: #888;
        text-transform: uppercase;
    }

    .guest-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
    }

    .guest-status.active {
        background: rgba(33, 150, 243, 0.1);
        color: #1976d2;
    }

    .guest-status.checked-out {
        background: rgba(237, 108, 2, 0.1);
        color: #ed6c02;
    }

    .guest-status.report-sent {
        background: rgba(46, 125, 50, 0.1);
        color: #2e7d32;
    }

    /* Partner card styles (reusable for all partner types) */
    .partner-card {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: white;
        border: 1px solid rgba(201, 169, 98, 0.2);
        border-radius: 12px;
        margin-bottom: 15px;
        transition: all 0.2s;
        cursor: pointer;
    }

    .partner-card:hover {
        border-color: var(--gold);
        box-shadow: 0 4px 15px rgba(201, 169, 98, 0.15);
    }

    .partner-card-logo {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .partner-card-logo.athletic {
        background: linear-gradient(135deg, #1565c0, #0d47a1);
    }

    .partner-card-logo.business {
        background: linear-gradient(135deg, #2e7d32, #1b5e20);
    }

    .partner-card-logo svg {
        width: 28px;
        height: 28px;
        color: white;
    }

    .partner-card-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
    }

    .partner-card-info {
        flex: 1;
    }

    .partner-card-name {
        font-family: 'Cormorant Garamond', serif;
        font-size: 20px;
        color: #0f1c2e;
        margin-bottom: 5px;
    }

    .partner-card-meta {
        font-size: 13px;
        color: #888;
    }

    .partner-card-stats {
        display: flex;
        gap: 25px;
        text-align: center;
    }

    .partner-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .partner-stat-value {
        font-family: 'Cormorant Garamond', serif;
        font-size: 24px;
        color: #0f1c2e;
        font-weight: 600;
    }

    .partner-stat-label {
        font-size: 11px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .partner-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
    }

    .partner-status.active {
        background: rgba(46, 125, 50, 0.1);
        color: #2e7d32;
    }

    .partner-status.pending {
        background: rgba(237, 108, 2, 0.1);
        color: #ed6c02;
    }

    .partner-status.inactive {
        background: rgba(107, 123, 138, 0.1);
        color: #6b7b8a;
    }

    .sport-badge {
        background: rgba(21, 101, 192, 0.1);
        color: #1565c0;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        text-transform: capitalize;
    }

    .industry-badge {
        background: rgba(46, 125, 50, 0.1);
        color: #2e7d32;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        text-transform: capitalize;
    }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="../firebase-config.js"></script>
<script src="demo-mode-admin.js"></script>
<script src="../auth.js"></script>
<script src="../content.js"></script>
<script src="../questionnaires.js"></script>

<script>
    console.log('Admin JS starting...');

    // ==================== TOAST NOTIFICATION SYSTEM ====================

    function showToast(message, type = 'info', title = null, duration = 4000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icons = {
            success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            warning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
        };

        const defaultTitles = { success: 'Success', error: 'Error', warning: 'Warning', info: 'Info' };

        toast.innerHTML = `
            <div class="toast-icon">${icons[type]}</div>
            <div class="toast-content">
                <div class="toast-title">${title || defaultTitles[type]}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // ==================== CONFIRMATION MODAL SYSTEM ====================

    let confirmCallback = null;

    function showConfirm(title, message, onConfirm, type = 'warning', confirmText = 'Confirm') {
        const modal = document.getElementById('confirmModal');
        const iconEl = document.getElementById('confirmIcon');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const btnEl = document.getElementById('confirmBtn');

        titleEl.textContent = title;
        messageEl.textContent = message;
        btnEl.textContent = confirmText;

        iconEl.className = `confirm-modal-icon ${type}`;
        btnEl.className = `confirm-modal-btn ${type === 'danger' ? 'danger' : 'confirm'}`;

        const icons = {
            warning: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            danger: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            info: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
        };
        iconEl.innerHTML = icons[type] || icons.warning;

        confirmCallback = onConfirm;
        modal.classList.add('active');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
        confirmCallback = null;
    }

    function executeConfirm() {
        if (confirmCallback) confirmCallback();
        closeConfirmModal();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeConfirmModal();
    });

    // ==================== MAIN APPLICATION ====================

    let currentUser = null;
    let allClients = [];
    let allAssessments = [];
    let currentConversation = null;
    let messageListener = null;
    let hotelPartners = [];
    let currentHotelId = null;
    let athleticPartners = [];
    let currentAthleticId = null;
    let businessPartners = [];
    let currentBusinessId = null;

    // Toggle mobile menu - defined early so it works immediately
    function toggleMobileMenu() {
        const sidebar = document.getElementById('admin-sidebar');
        if (sidebar) sidebar.classList.toggle('mobile-open');
    }

    // Show section - defined early so nav works immediately
    function showSection(sectionId) {
        console.log('showSection called:', sectionId);

        // Close mobile menu
        const sidebar = document.getElementById('admin-sidebar');
        if (sidebar) sidebar.classList.remove('mobile-open');

        // Update nav highlight
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        if (event && event.target) {
            const navItem = event.target.closest('.nav-item');
            if (navItem) navItem.classList.add('active');
        }

        // Show the requested section
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        const section = document.getElementById('section-' + sectionId);
        if (section) {
            section.classList.add('active');
            // Load section data if user is authenticated
            if (currentUser) {
                loadSectionData(sectionId);
            }
        }
    }

    // Wait for Firebase to initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Check admin access once auth is ready
        if (typeof auth !== 'undefined') {
            auth.onAuthStateChanged(async (user) => {
                // Demo mode: use mock admin, skip Firebase
                if (typeof isDemoMode === 'function' && isDemoMode()) {
                    const demoUser = window.DEMO_ADMIN_USER;
                    const demoProfile = window.DEMO_ADMIN_PROFILE;
                    currentUser = demoUser;
                    document.getElementById('adminName').textContent = demoProfile.displayName || 'Admin';
                    document.getElementById('adminAvatar').textContent = (demoProfile.displayName || 'A')[0].toUpperCase();
                    loadDashboard();
                    loadNotifications();
                    return;
                }

                console.log('Auth state changed:', user ? user.email : 'no user');
                if (!user) {
                    window.location.href = '../auth.html';
                    return;
                }

                const profile = await FirebaseDB.getUserProfile(user.uid);
                if (!profile || profile.role !== 'admin') {
                    window.location.href = '../account.html';
                    return;
                }

                currentUser = user;
                document.getElementById('adminName').textContent = profile.displayName || 'Admin';
                document.getElementById('adminAvatar').textContent = (profile.displayName || 'A')[0].toUpperCase();

                // Load dashboard data
                loadDashboard();
                loadNotifications();
            });
        } else {
            console.error('Auth not available');
        }
    });

    // Navigate to section (from stat cards)
    function navigateToSection(sectionId) {
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

        // Show section
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + sectionId).classList.add('active');

        // Load section data
        loadSectionData(sectionId);
    }

    // Load section data
    function loadSectionData(sectionId) {
        switch(sectionId) {
            case 'dashboard': loadDashboard(); break;
            case 'clients': loadClients(); break;
            case 'assessments': loadAssessments(); break;
            case 'invites': loadInvites(); break;
            case 'messages': loadConversations(); break;
            case 'appointments': loadAppointments(); break;
            case 'modules': loadModulesSection(); break;
            case 'questionnaires': loadQuestionnaires(); break;
            case 'hotel-partners': loadHotelPartners(); break;
            case 'athletic-partners': loadAthleticPartners(); break;
            case 'business-partners': loadBusinessPartners(); break;
        }
    }

    // Load the merged Modules section
    async function loadModulesSection() {
        // Load module requests
        await loadRequests();
        // Load available modules and assignments
        loadUnlocks();
    }

    // ============================================
    // TASK MANAGEMENT SYSTEM
    // ============================================

    // Get tasks from localStorage
    function getTasks() {
        const tasks = localStorage.getItem('sleepwellness_tasks');
        return tasks ? JSON.parse(tasks) : [];
    }

    // Save tasks to localStorage
    function saveTasks(tasks) {
        localStorage.setItem('sleepwellness_tasks', JSON.stringify(tasks));
    }

    // Show add task modal
    function showAddTaskModal() {
        document.getElementById('task-title').value = '';
        document.getElementById('task-notes').value = '';
        document.getElementById('task-priority').value = 'normal';
        document.getElementById('task-due').value = '';

        // Populate client dropdown
        const clientSelect = document.getElementById('task-client');
        clientSelect.innerHTML = '<option value="">No specific client</option>';
        allClients.forEach(c => {
            clientSelect.innerHTML += `<option value="${c.id}">${c.displayName || c.email}</option>`;
        });

        document.getElementById('task-modal').style.display = 'flex';
    }

    // Save task
    function saveTask() {
        const title = document.getElementById('task-title').value.trim();
        if (!title) {
            showToast('Please enter a task description.', 'warning', 'Missing Information');
            return;
        }

        const tasks = getTasks();
        const newTask = {
            id: Date.now().toString(),
            title: title,
            clientId: document.getElementById('task-client').value || null,
            clientName: document.getElementById('task-client').selectedOptions[0]?.text || null,
            dueDate: document.getElementById('task-due').value || null,
            priority: document.getElementById('task-priority').value,
            notes: document.getElementById('task-notes').value.trim(),
            completed: false,
            createdAt: new Date().toISOString()
        };

        tasks.push(newTask);
        saveTasks(tasks);
        closeModal('task-modal');
        loadDashboardTasks();
        updateTaskStats();
    }

    // Complete task
    function completeTask(taskId) {
        const tasks = getTasks();
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = true;
            task.completedAt = new Date().toISOString();
            saveTasks(tasks);
            loadDashboardTasks();
            updateTaskStats();
        }
    }

    // Delete task
    function deleteTask(taskId) {
        showConfirm('Delete Task', 'Are you sure you want to delete this task?', () => {
            // Continue with deletion
        }, 'danger', 'Delete');
        return; // The actual deletion will happen in the confirm callback
    }

    async function confirmDeleteTask(taskId) {
        const tasks = getTasks().filter(t => t.id !== taskId);
        saveTasks(tasks);
        loadDashboardTasks();
        updateTaskStats();
    }

    // Update task stats
    function updateTaskStats(useMockup = false) {
        const realTasks = getTasks();
        const openTasks = realTasks.filter(t => !t.completed).length;
        const mockupCount = typeof MOCKUP_DATA !== 'undefined' ? MOCKUP_DATA.tasks.length : 0;
        document.getElementById('stat-tasks').textContent = useMockup && openTasks === 0 ? mockupCount : openTasks;
    }

    // Scroll to tasks section
    function scrollToTasks() {
        document.getElementById('tasks-card').scrollIntoView({ behavior: 'smooth' });
    }

    // Load tasks for dashboard
    function loadDashboardTasks(useMockup = false) {
        const container = document.getElementById('dashboard-tasks');
        let tasks = getTasks().filter(t => !t.completed);

        // Use mockup if no real tasks
        if (tasks.length === 0 && useMockup && typeof MOCKUP_DATA !== 'undefined') {
            tasks = MOCKUP_DATA.tasks;
        }

        // Sort by due date (soonest first), then by priority
        tasks.sort((a, b) => {
            if (a.priority === 'high' && b.priority !== 'high') return -1;
            if (b.priority === 'high' && a.priority !== 'high') return 1;
            if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
            if (a.dueDate) return -1;
            if (b.dueDate) return 1;
            return 0;
        });

        if (tasks.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 15px; opacity: 0.4;"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    <p style="margin: 0;">No open tasks</p>
                    <p style="margin: 5px 0 0; font-size: 12px;">Click "Add Task" to create a reminder</p>
                </div>
            `;
            return;
        }

        let html = '';
        tasks.forEach(task => {
            const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !task.completed;
            const dueText = task.dueDate ? formatDueDate(task.dueDate) : '';
            const priorityColor = task.priority === 'high' ? '#d32f2f' : task.priority === 'low' ? '#6b7b8a' : 'var(--gold)';
            const isMockup = task.id?.startsWith('t');

            html += `
                <div style="display: flex; align-items: flex-start; gap: 12px; padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); ${isOverdue ? 'background: rgba(211, 47, 47, 0.05);' : ''}">
                    <button onclick="${isMockup ? "showToast('This is a demo feature', 'info', 'Demo Mode')" : `completeTask('${task.id}')`}" style="flex-shrink: 0; width: 22px; height: 22px; border: 2px solid ${priorityColor}; border-radius: 50%; background: none; cursor: pointer; margin-top: 2px;" title="Mark complete"></button>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 14px; color: var(--navy); font-weight: 500;">${task.title}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; font-size: 12px; color: var(--text-light);">
                            ${task.clientName ? `<span style="display: flex; align-items: center; gap: 4px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M5.5 21v-2a5 5 0 0 1 10 0v2"/></svg>${task.clientName}</span>` : ''}
                            ${dueText ? `<span style="color: ${isOverdue ? '#d32f2f' : 'inherit'};">${isOverdue ? 'Overdue: ' : ''}${dueText}</span>` : ''}
                            ${task.priority === 'high' ? '<span style="color: #d32f2f; font-weight: 500;">High Priority</span>' : ''}
                        </div>
                        ${task.notes ? `<div style="font-size: 12px; color: var(--text-light); margin-top: 6px; font-style: italic;">${task.notes}</div>` : ''}
                    </div>
                    <button onclick="${isMockup ? "showToast('This is a demo feature', 'info', 'Demo Mode')" : `deleteTask('${task.id}')`}" style="flex-shrink: 0; background: none; border: none; cursor: pointer; color: #999; padding: 4px;" title="Delete task">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Format due date
    function formatDueDate(dateStr) {
        const date = new Date(dateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        if (date.toDateString() === today.toDateString()) return 'Today';
        if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Load incoming messages for dashboard
    async function loadDashboardMessages(useMockup = false) {
        const container = document.getElementById('dashboard-messages');

        // Use mockup data if needed
        if (useMockup && typeof MOCKUP_DATA !== 'undefined') {
            const messages = MOCKUP_DATA.messages;
            document.getElementById('stat-messages').textContent = messages.length;

            const typeColors = { athlete: '#2A8B8B', hotel: '#8B4D5C', executive: '#4A6085' };

            let html = '';
            messages.forEach(msg => {
                const time = msg.timestamp.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                const avatarColor = typeColors[msg.clientType] || 'var(--navy)';

                html += `
                    <div onclick="showToast('This is a demo feature', 'info', 'Demo Mode')" style="display: flex; align-items: flex-start; gap: 12px; padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(201,169,98,0.05)'" onmouseout="this.style.background='transparent'">
                        <div style="width: 40px; height: 40px; background: ${avatarColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;">${msg.clientName[0]}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-weight: 500; color: var(--navy);">${msg.clientName}</span>
                                <span style="font-size: 11px; color: var(--text-light);">${time}</span>
                            </div>
                            <div style="font-size: 13px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${msg.text}</div>
                        </div>
                        <div style="width: 10px; height: 10px; background: var(--gold); border-radius: 50%; flex-shrink: 0; margin-top: 5px;"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
            return;
        }

        try {
            // Get all conversations and find unread messages
            const snapshot = await db.collection('conversations').get();
            let unreadMessages = [];

            for (const doc of snapshot.docs) {
                const conv = { id: doc.id, ...doc.data() };
                const clientId = conv.participants?.find(p => p !== currentUser.uid);
                const client = clientId ? await FirebaseDB.getUserProfile(clientId) : null;

                // Get messages in this conversation
                const messagesSnap = await db.collection('conversations').doc(doc.id)
                    .collection('messages')
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();

                messagesSnap.docs.forEach(msgDoc => {
                    const msg = msgDoc.data();
                    if (msg.senderId !== currentUser.uid && !msg.read) {
                        unreadMessages.push({
                            ...msg,
                            conversationId: doc.id,
                            clientId,
                            clientName: client?.displayName || 'Unknown',
                            clientType: client?.clientType || 'unknown'
                        });
                    }
                });
            }

            // Update stat
            document.getElementById('stat-messages').textContent = unreadMessages.length;

            if (unreadMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 15px; opacity: 0.4;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <p style="margin: 0;">No unread messages</p>
                    </div>
                `;
                return;
            }

            // Sort by timestamp
            unreadMessages.sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate());

            let html = '';
            unreadMessages.slice(0, 5).forEach(msg => {
                const time = msg.timestamp?.toDate()?.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) || '';

                html += `
                    <div onclick="openConversation('${msg.conversationId}')" style="display: flex; align-items: flex-start; gap: 12px; padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(201,169,98,0.05)'" onmouseout="this.style.background='transparent'">
                        <div style="width: 40px; height: 40px; background: var(--navy); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;">${(msg.clientName || '?')[0].toUpperCase()}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-weight: 500; color: var(--navy);">${msg.clientName}</span>
                                <span style="font-size: 11px; color: var(--text-light);">${time}</span>
                            </div>
                            <div style="font-size: 13px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${msg.text || ''}</div>
                        </div>
                        <div style="width: 10px; height: 10px; background: var(--gold); border-radius: 50%; flex-shrink: 0; margin-top: 5px;"></div>
                    </div>
                `;
            });

            if (unreadMessages.length > 5) {
                html += `<div style="padding: 15px 20px; text-align: center;"><a onclick="showSection('messages')" style="color: var(--gold); cursor: pointer; font-size: 13px;">View ${unreadMessages.length - 5} more messages</a></div>`;
            }

            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading messages:', error);
            container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-light);">Unable to load messages</div>`;
        }
    }

    // Open conversation from dashboard
    function openConversation(conversationId) {
        showSection('messages');
        // Small delay to let section render, then open chat
        setTimeout(() => {
            openChat(conversationId);
        }, 100);
    }

    // Load needs attention items
    async function loadNeedsAttention(useMockup = false) {
        const container = document.getElementById('needs-attention');

        const icons = {
            'clipboard': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
            'clock': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'unlock': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>'
        };

        // Use mockup data if needed
        if (useMockup && typeof MOCKUP_DATA !== 'undefined') {
            const items = MOCKUP_DATA.needsAttention;

            let html = '<div style="display: grid; gap: 0;">';
            items.forEach(item => {
                const bgColor = item.priority === 'high' ? 'rgba(211, 47, 47, 0.05)' : 'transparent';
                const borderColor = item.priority === 'high' ? 'rgba(211, 47, 47, 0.2)' : 'rgba(0,0,0,0.05)';

                html += `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px 25px; border-bottom: 1px solid ${borderColor}; background: ${bgColor};">
                        <div style="width: 36px; height: 36px; background: ${item.priority === 'high' ? 'rgba(211, 47, 47, 0.1)' : 'var(--cream)'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: ${item.priority === 'high' ? '#d32f2f' : 'var(--navy)'};">${icons[item.icon]}</div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: var(--navy);">${item.text}</div>
                            <div style="font-size: 12px; color: var(--text-light);">${item.subtext}</div>
                        </div>
                        <button onclick="showToast('This is a demo feature', 'info', 'Demo Mode')" class="action-btn action-btn-secondary" style="font-size: 11px; padding: 6px 12px;">${item.type === 'no-assessment' ? 'View Client' : item.type === 'overdue-task' ? 'Complete' : 'Review'}</button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            return;
        }

        let items = [];

        try {
            // Check for clients without assessments
            for (const client of allClients) {
                const assessments = await db.collection('assessments')
                    .where('userId', '==', client.id)
                    .limit(1)
                    .get();

                if (assessments.empty) {
                    const joinedDays = Math.floor((Date.now() - (client.createdAt?.toDate() || Date.now())) / (1000 * 60 * 60 * 24));
                    if (joinedDays >= 3) {
                        items.push({
                            type: 'no-assessment',
                            icon: 'clipboard',
                            text: `${client.displayName || client.email} hasn't completed their assessment`,
                            subtext: `Joined ${joinedDays} days ago`,
                            clientId: client.id,
                            priority: joinedDays > 7 ? 'high' : 'normal'
                        });
                    }
                }
            }

            // Check for overdue tasks
            const tasks = getTasks().filter(t => !t.completed && t.dueDate);
            tasks.forEach(task => {
                if (new Date(task.dueDate) < new Date()) {
                    items.push({
                        type: 'overdue-task',
                        icon: 'clock',
                        text: task.title,
                        subtext: `Due: ${formatDueDate(task.dueDate)}`,
                        taskId: task.id,
                        priority: 'high'
                    });
                }
            });

            // Check for module requests
            const requests = await db.collection('moduleRequests')
                .where('status', '==', 'pending')
                .get();

            requests.docs.forEach(doc => {
                const req = doc.data();
                items.push({
                    type: 'module-request',
                    icon: 'unlock',
                    text: `Module request from client`,
                    subtext: req.moduleName || 'Module access',
                    requestId: doc.id,
                    priority: 'normal'
                });
            });

        } catch (error) {
            console.error('Error loading needs attention:', error);
        }

        // Sort by priority
        items.sort((a, b) => (a.priority === 'high' ? -1 : 1) - (b.priority === 'high' ? -1 : 1));

        if (items.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 30px 20px; color: var(--text-light);">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 10px; opacity: 0.4;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    <p style="margin: 0; font-size: 14px;">All caught up! Nothing needs immediate attention.</p>
                </div>
            `;
            return;
        }

        let html = '<div style="display: grid; gap: 0;">';
        items.slice(0, 5).forEach(item => {
            const bgColor = item.priority === 'high' ? 'rgba(211, 47, 47, 0.05)' : 'transparent';
            const borderColor = item.priority === 'high' ? 'rgba(211, 47, 47, 0.2)' : 'rgba(0,0,0,0.05)';

            html += `
                <div style="display: flex; align-items: center; gap: 15px; padding: 15px 25px; border-bottom: 1px solid ${borderColor}; background: ${bgColor};">
                    <div style="width: 36px; height: 36px; background: ${item.priority === 'high' ? 'rgba(211, 47, 47, 0.1)' : 'var(--cream)'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: ${item.priority === 'high' ? '#d32f2f' : 'var(--navy)'};">${icons[item.icon]}</div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; color: var(--navy);">${item.text}</div>
                        <div style="font-size: 12px; color: var(--text-light);">${item.subtext}</div>
                    </div>
                    ${item.clientId ? `<button onclick="viewClient('${item.clientId}')" class="action-btn action-btn-secondary" style="font-size: 11px; padding: 6px 12px;">View Client</button>` : ''}
                    ${item.taskId ? `<button onclick="completeTask('${item.taskId}')" class="action-btn action-btn-primary" style="font-size: 11px; padding: 6px 12px;">Complete</button>` : ''}
                    ${item.requestId ? `<button onclick="showSection('requests')" class="action-btn action-btn-secondary" style="font-size: 11px; padding: 6px 12px;">Review</button>` : ''}
                </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // Load dashboard
    // Mockup data for demonstration
    const MOCKUP_DATA = {
        clients: [
            { id: 'mock1', displayName: 'Michael Chen', email: 'michael.chen@team.com', clientType: 'athlete', createdAt: { toDate: () => new Date('2025-12-15') } },
            { id: 'mock2', displayName: 'Sarah Williams', email: 'sarah@luxuryresort.com', clientType: 'hotel', createdAt: { toDate: () => new Date('2025-12-20') } },
            { id: 'mock3', displayName: 'James Rodriguez', email: 'jrodriguez@corp.com', clientType: 'executive', createdAt: { toDate: () => new Date('2025-12-28') } },
            { id: 'mock4', displayName: 'Emma Thompson', email: 'emma.t@athletics.org', clientType: 'athlete', createdAt: { toDate: () => new Date('2026-01-05') } },
            { id: 'mock5', displayName: 'David Park', email: 'dpark@grandhotel.com', clientType: 'hotel', createdAt: { toDate: () => new Date('2026-01-10') } },
            { id: 'mock6', displayName: 'Lisa Anderson', email: 'landerson@tech.com', clientType: 'executive', createdAt: { toDate: () => new Date('2026-01-15') } }
        ],
        tasks: [
            { id: 't1', title: 'Follow up with Michael on sleep diary progress', clientId: 'mock1', clientName: 'Michael Chen', dueDate: '2026-01-24', priority: 'high', completed: false },
            { id: 't2', title: 'Review Sarah\'s initial assessment results', clientId: 'mock2', clientName: 'Sarah Williams', dueDate: '2026-01-25', priority: 'normal', completed: false },
            { id: 't3', title: 'Send CBT-I module to James', clientId: 'mock3', clientName: 'James Rodriguez', dueDate: '2026-01-26', priority: 'normal', completed: false }
        ],
        messages: [
            { clientName: 'Michael Chen', text: 'Hi Dr. Alen, I had trouble falling asleep last night...', timestamp: new Date(Date.now() - 3600000), clientType: 'athlete' },
            { clientName: 'Sarah Williams', text: 'Thank you for the breathing exercise recommendations!', timestamp: new Date(Date.now() - 7200000), clientType: 'hotel' },
            { clientName: 'James Rodriguez', text: 'Quick question about the sleep restriction protocol...', timestamp: new Date(Date.now() - 18000000), clientType: 'executive' }
        ],
        appointments: [
            { id: 'apt1', userId: 'mock1', type: 'Follow-up', dateTime: new Date('2026-01-28T10:00:00'), status: 'pending', clientName: 'Michael Chen', clientEmail: 'michael.chen@team.com' },
            { id: 'apt2', userId: 'mock3', type: 'Initial Consultation', dateTime: new Date('2026-01-29T14:30:00'), status: 'pending', clientName: 'James Rodriguez', clientEmail: 'jrodriguez@corp.com' }
        ],
        needsAttention: [
            { type: 'no-assessment', icon: 'clipboard', text: 'Emma Thompson hasn\'t completed their assessment', subtext: 'Joined 18 days ago', priority: 'high' },
            { type: 'overdue-task', icon: 'clock', text: 'Review David\'s questionnaire results', subtext: 'Due: Yesterday', priority: 'high' },
            { type: 'module-request', icon: 'unlock', text: 'Module request from Lisa Anderson', subtext: 'CBT-I: Sleep Restriction', priority: 'normal' }
        ]
    };

    // Check if using mockup mode (no real clients)
    function shouldUseMockup() {
        return allClients.length === 0;
    }

    async function loadDashboard() {
        const analytics = await FirebaseDB.getAnalytics();

        // Load clients first
        if (allClients.length === 0) {
            try {
                const snapshot = await db.collection('users').where('role', '==', 'client').get();
                allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.log('Using mockup data');
            }
        }

        const useMockup = shouldUseMockup();
        const clients = useMockup ? MOCKUP_DATA.clients : allClients;

        // Update total clients and breakdown
        document.getElementById('stat-clients').textContent = clients.length;
        document.getElementById('stat-athletes').textContent = clients.filter(c => c.clientType === 'athlete').length;
        document.getElementById('stat-hotels').textContent = clients.filter(c => c.clientType === 'hotel').length;
        document.getElementById('stat-executives').textContent = clients.filter(c => c.clientType === 'executive').length;

        document.getElementById('stat-pending').textContent = useMockup ? MOCKUP_DATA.appointments.length : analytics.pendingAppointments;

        // Update pending badge
        const badge = document.getElementById('pending-badge');
        const pendingCount = useMockup ? MOCKUP_DATA.appointments.length : analytics.pendingAppointments;
        if (pendingCount > 0) {
            badge.textContent = pendingCount;
            badge.style.display = '';
        } else {
            badge.style.display = 'none';
        }

        // Update module requests badge
        updateRequestsBadge();

        // Load tasks (with mockup if needed)
        loadDashboardTasks(useMockup);
        updateTaskStats(useMockup);

        // Load messages (with mockup if needed)
        loadDashboardMessages(useMockup);

        // Load needs attention (with mockup if needed)
        loadNeedsAttention(useMockup);

        // Load pending appointments (with mockup if needed)
        loadPendingAppointments(useMockup);
    }

    // Load pending appointments for dashboard
    async function loadPendingAppointments(useMockup = false) {
        const appointmentsContainer = document.getElementById('pending-appointments');

        if (useMockup) {
            const pending = MOCKUP_DATA.appointments;
            let html = `<table class="data-table">
                <thead><tr><th>Client</th><th>Type</th><th>Requested Time</th><th>Actions</th></tr></thead>
                <tbody>`;

            for (const apt of pending) {
                html += `
                    <tr>
                        <td>
                            <div class="client-name">${apt.clientName}</div>
                            <div class="client-email">${apt.clientEmail}</div>
                        </td>
                        <td>${apt.type}</td>
                        <td>${apt.dateTime.toLocaleString()}</td>
                        <td>
                            <button class="action-btn action-btn-primary" onclick="showToast('This is a demo feature', 'info', 'Demo Mode')">Confirm</button>
                            <button class="action-btn action-btn-danger" onclick="showToast('This is a demo feature', 'info', 'Demo Mode')">Decline</button>
                        </td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            appointmentsContainer.innerHTML = html;
            return;
        }

        const appointments = await FirebaseDB.getAllAppointments();
        const pending = appointments.filter(a => a.status === 'pending');

        if (pending.length === 0) {
            appointmentsContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Pending Appointments</h3>
                    <p>Appointment requests will appear here.</p>
                </div>
            `;
        } else {
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Type</th>
                        <th>Requested Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const apt of pending.slice(0, 5)) {
                const client = await FirebaseDB.getUserProfile(apt.userId);
                const dateTime = apt.dateTime?.toDate();
                const formattedDate = dateTime ? dateTime.toLocaleString() : 'N/A';

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${client?.displayName || 'Unknown'}</div>
                            <div class="client-email">${client?.email || ''}</div>
                        </td>
                        <td>${apt.type || 'Consultation'}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="action-btn action-btn-primary" onclick="confirmAppointment('${apt.id}')">Confirm</button>
                            <button class="action-btn action-btn-danger" onclick="cancelAppointment('${apt.id}')">Decline</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            appointmentsContainer.innerHTML = html;
        }
    }

    // Load clients
    async function loadClients() {
        const container = document.getElementById('clients-list');
        container.innerHTML = '<div class="loading">Loading clients...</div>';

        try {
            // Force fresh fetch from Firestore
            const snapshot = await db.collection('users')
                .where('role', '==', 'client')
                .get({ source: 'server' });

            allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Sort by createdAt
            allClients.sort((a, b) => {
                const aTime = a.createdAt?.toDate?.() || new Date(0);
                const bTime = b.createdAt?.toDate?.() || new Date(0);
                return bTime - aTime;
            });

            console.log('Loaded clients:', allClients.length, allClients);
            renderClients(allClients);
        } catch (error) {
            console.error('Error loading clients:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <h3>Error Loading Clients</h3>
                    <p>${error.message}</p>
                    <button class="action-btn action-btn-primary" onclick="loadClients()">Retry</button>
                </div>
            `;
        }
    }

    function renderClients(clients, showArchived = false) {
        const container = document.getElementById('clients-list');

        if (clients.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>${showArchived ? 'No Archived Clients' : 'No Clients Yet'}</h3>
                    <p>${showArchived ? 'Archived clients will appear here.' : 'Generate invite codes to onboard new clients.'}</p>
                </div>
            `;
            return;
        }

        // If showing archived clients, use a simple list view
        if (showArchived) {
            container.innerHTML = `
                <div style="background: #f5f5f5; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/></svg>
                    <span style="color: #666; font-size: 14px;">These clients are archived. Their data is preserved and can be restored at any time.</span>
                </div>
                ${clients.map(client => `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 12px; background: #fafafa;">
                        <div style="width: 50px; height: 50px; background: #9e9e9e; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">${(client.displayName || '?')[0].toUpperCase()}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--navy);">${client.displayName || 'Unknown'}</div>
                            <div style="font-size: 13px; color: var(--text-light);">${client.email || ''}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 4px;">
                                <span style="text-transform: capitalize;">${client.clientType || 'Client'}</span>
                                ${client.archivedAt ? `  Archived ${client.archivedAt?.toDate?.().toLocaleDateString() || ''}` : ''}
                                ${client.archiveReason ? `  ${client.archiveReason.replace(/_/g, ' ')}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="viewClient('${client.id}')" style="padding: 8px 16px; background: transparent; border: 1px solid var(--gold); color: var(--gold); border-radius: 4px; font-size: 13px; cursor: pointer;">View</button>
                            <button onclick="restoreClient('${client.id}')" style="padding: 8px 16px; background: #2e7d32; border: none; color: white; border-radius: 4px; font-size: 13px; cursor: pointer;">Restore</button>
                        </div>
                    </div>
                `).join('')}
            `;
            return;
        }

        // Group clients by type
        const grouped = {
            athlete: clients.filter(c => c.clientType === 'athlete'),
            executive: clients.filter(c => c.clientType === 'executive'),
            hotel: clients.filter(c => c.clientType === 'hotel'),
            other: clients.filter(c => !c.clientType || !['athlete', 'executive', 'hotel'].includes(c.clientType))
        };

        const categoryInfo = {
            athlete: { label: 'Athletes', subtitle: 'Elite performance optimization', icon: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 0 20M12 2a10 10 0 0 0 0 20M2 12h20"/></svg>', color: '#2A8B8B', bgGradient: 'linear-gradient(135deg, rgba(42,139,139,0.1), rgba(42,139,139,0.02))' },
            executive: { label: 'Executives', subtitle: 'Corporate sleep wellness', icon: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>', color: '#4A6085', bgGradient: 'linear-gradient(135deg, rgba(74,96,133,0.1), rgba(74,96,133,0.02))' },
            hotel: { label: 'Hotels & Travelers', subtitle: 'Guest experience programs', icon: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 21h18M3 10h18M3 7l9-4 9 4M4 10v11M20 10v11"/></svg>', color: '#8B4D5C', bgGradient: 'linear-gradient(135deg, rgba(139,77,92,0.1), rgba(139,77,92,0.02))' },
            other: { label: 'Other Clients', subtitle: 'General wellness', icon: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="7" r="4"/><path d="M5.5 21v-2a5 5 0 0 1 10 0v2"/></svg>', color: '#6b7b8a', bgGradient: 'linear-gradient(135deg, rgba(107,123,138,0.1), rgba(107,123,138,0.02))' }
        };

        // Three-column grid layout
        let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 30px;">';

        ['athlete', 'hotel', 'executive'].forEach(type => {
            const group = grouped[type];
            const info = categoryInfo[type];

            html += `
                <div class="data-card" style="background: ${info.bgGradient}; border: 1px solid rgba(${type === 'athlete' ? '42,139,139' : type === 'executive' ? '74,96,133' : '139,77,92'}, 0.15); border-top: 3px solid ${info.color};">
                    <div style="padding: 25px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
                            <div style="width: 50px; height: 50px; background: ${info.color}; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
                                ${info.icon}
                            </div>
                            <div>
                                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: var(--navy); margin: 0;">${info.label}</h3>
                                <p style="font-size: 12px; color: var(--text-light); margin: 0;">${info.subtitle}</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 15px;">
                            <span style="font-size: 36px; font-weight: 600; color: ${info.color};">${group.length}</span>
                            <span style="font-size: 14px; color: var(--text-light);">client${group.length !== 1 ? 's' : ''}</span>
                        </div>
                    </div>
                    <div style="max-height: 320px; overflow-y: auto;">
                        ${group.length === 0 ? `
                            <div style="padding: 40px 20px; text-align: center; color: var(--text-light);">
                                <p style="margin: 0;">No ${info.label.toLowerCase()} yet</p>
                            </div>
                        ` : group.map(client => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: background 0.2s;" onclick="viewClient('${client.id}')" onmouseover="this.style.background='rgba(201,169,98,0.08)'" onmouseout="this.style.background='transparent'">
                                <div style="width: 40px; height: 40px; background: ${info.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">${(client.displayName || client.email || '?')[0].toUpperCase()}</div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; color: var(--navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${client.displayName || 'Unknown'}</div>
                                    <div style="font-size: 12px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${client.email || ''}</div>
                                </div>
                                <button onclick="event.stopPropagation(); messageClient('${client.id}')" style="padding: 6px 12px; background: transparent; border: 1px solid ${info.color}; color: ${info.color}; border-radius: 4px; font-size: 11px; cursor: pointer;">Message</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        html += '</div>';

        // Other clients section (if any)
        if (grouped.other.length > 0) {
            const info = categoryInfo.other;
            html += `
                <div class="data-card" style="margin-top: 20px;">
                    <div class="data-card-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: ${info.color};">${info.icon}</span>
                            <h2 class="data-card-title">${info.label} (${grouped.other.length})</h2>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>Name</th><th>Email</th><th>Joined</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${grouped.other.map(client => `
                                <tr>
                                    <td><strong>${client.displayName || 'Unknown'}</strong></td>
                                    <td>${client.email || ''}</td>
                                    <td>${client.createdAt?.toDate()?.toLocaleDateString() || 'N/A'}</td>
                                    <td>
                                        <button class="action-btn action-btn-secondary" onclick="viewClient('${client.id}')">View</button>
                                        <button class="action-btn action-btn-primary" onclick="messageClient('${client.id}')">Message</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    function filterClients() {
        const search = document.getElementById('client-search').value.toLowerCase();
        const type = document.getElementById('client-filter').value;

        let filtered = allClients;

        // Handle archived filter specially
        if (type === 'archived') {
            filtered = filtered.filter(c => c.status === 'archived');
        } else {
            // By default, show only active clients (not archived)
            filtered = filtered.filter(c => c.status !== 'archived');

            if (type) {
                filtered = filtered.filter(c => c.clientType === type);
            }
        }

        if (search) {
            filtered = filtered.filter(c =>
                (c.displayName || '').toLowerCase().includes(search) ||
                (c.email || '').toLowerCase().includes(search)
            );
        }

        renderClients(filtered, type === 'archived');
    }

    // Load assessments
    // Score interpretation helper
    function getScoreInterpretation(score, type = 'general') {
        if (type === 'psqi' || type === 'pittsburgh') {
            // PSQI: 0-5 good, 6-10 poor, 11+ very poor
            if (score <= 5) return { label: 'Good Sleep Quality', color: '#2e7d32', icon: '' };
            if (score <= 10) return { label: 'Poor Sleep Quality', color: '#f57c00', icon: '!' };
            return { label: 'Very Poor Sleep', color: '#c62828', icon: '' };
        }
        if (type === 'ess' || type === 'epworth') {
            // ESS: 0-10 normal, 11-14 mild, 15-17 moderate, 18+ severe
            if (score <= 10) return { label: 'Normal Daytime Sleepiness', color: '#2e7d32', icon: '' };
            if (score <= 14) return { label: 'Mild Sleepiness', color: '#f57c00', icon: '!' };
            if (score <= 17) return { label: 'Moderate Sleepiness', color: '#e65100', icon: '!' };
            return { label: 'Severe Sleepiness', color: '#c62828', icon: '' };
        }
        if (type === 'isi' || type === 'insomnia') {
            // ISI: 0-7 none, 8-14 subthreshold, 15-21 moderate, 22+ severe
            if (score <= 7) return { label: 'No Insomnia', color: '#2e7d32', icon: '' };
            if (score <= 14) return { label: 'Subthreshold Insomnia', color: '#f57c00', icon: '!' };
            if (score <= 21) return { label: 'Moderate Insomnia', color: '#e65100', icon: '!' };
            return { label: 'Severe Insomnia', color: '#c62828', icon: '' };
        }
        // General 0-100 scale
        if (score >= 70) return { label: 'Good', color: '#2e7d32', icon: '' };
        if (score >= 40) return { label: 'Moderate', color: '#f57c00', icon: '!' };
        return { label: 'Needs Attention', color: '#c62828', icon: '' };
    }

    async function loadAssessments() {
        const container = document.getElementById('assessments-list');
        allAssessments = await FirebaseDB.getAllAssessments();

        if (allAssessments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Assessments Yet</h3>
                    <p>Assessments will appear here once clients complete them.</p>
                </div>
            `;
            return;
        }

        // Get client info for all assessments
        const assessmentsWithClients = [];
        for (const a of allAssessments) {
            const client = await FirebaseDB.getUserProfile(a.userId);
            assessmentsWithClients.push({ ...a, client });
        }

        // Group by client type
        const grouped = {
            athlete: assessmentsWithClients.filter(a => a.client?.clientType === 'athlete'),
            executive: assessmentsWithClients.filter(a => a.client?.clientType === 'executive'),
            hotel: assessmentsWithClients.filter(a => a.client?.clientType === 'hotel'),
            other: assessmentsWithClients.filter(a => !a.client?.clientType || !['athlete', 'executive', 'hotel'].includes(a.client?.clientType))
        };

        const categoryInfo = {
            athlete: { label: 'Athletes', color: '#2A8B8B' },
            executive: { label: 'Executives', color: '#4A6085' },
            hotel: { label: 'Hotels & Travelers', color: '#8B4D5C' },
            other: { label: 'Other', color: '#6b7b8a' }
        };

        function renderAssessmentCard(a) {
            const score = a.overallScore || 0;
            const scoreType = a.assessmentType || 'general';
            const interp = getScoreInterpretation(score, scoreType);
            const date = a.createdAt?.toDate()?.toLocaleDateString() || 'N/A';

            return `
                <div style="background: white; border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="viewAssessment('${a.id}')" onmouseover="this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <div style="font-weight: 600; color: var(--navy);">${a.client?.displayName || 'Unknown'}</div>
                            <div style="font-size: 12px; color: var(--text-light);">${date}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 28px; font-weight: 700; color: ${interp.color};">${score}</div>
                            <div style="font-size: 10px; color: var(--text-light);">out of 100</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: rgba(${interp.color === '#2e7d32' ? '46,125,50' : interp.color === '#f57c00' ? '245,124,0' : '198,40,40'}, 0.1); border-radius: 6px;">
                        <span style="color: ${interp.color}; font-weight: 600;">${interp.icon}</span>
                        <span style="font-size: 13px; color: ${interp.color}; font-weight: 500;">${interp.label}</span>
                    </div>
                    ${a.findings && a.findings.length > 0 ? `
                        <div style="margin-top: 12px; font-size: 12px; color: var(--text-light);">
                            <strong>Key findings:</strong> ${a.findings.slice(0, 2).join(', ')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        let html = '';

        ['athlete', 'executive', 'hotel', 'other'].forEach(type => {
            const group = grouped[type];
            if (group.length === 0) return;

            const info = categoryInfo[type];
            html += `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 15px 0; border-bottom: 2px solid ${info.color}; margin-bottom: 20px;">
                        <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">${info.label}</h3>
                        <span style="background: ${info.color}; color: white; font-size: 11px; padding: 3px 10px; border-radius: 10px; font-weight: 600;">${group.length}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                        ${group.map(a => renderAssessmentCard(a)).join('')}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Filter assessments
    let assessmentsWithClients = [];
    async function filterAssessments() {
        const search = document.getElementById('assessment-search').value.toLowerCase();
        const scoreFilter = document.getElementById('assessment-filter').value;
        const container = document.getElementById('assessments-list');

        // Build client map if not done
        if (assessmentsWithClients.length === 0 && allAssessments.length > 0) {
            for (const a of allAssessments) {
                const client = await FirebaseDB.getUserProfile(a.userId);
                assessmentsWithClients.push({ ...a, client });
            }
        }

        let filtered = assessmentsWithClients;

        if (search) {
            filtered = filtered.filter(a =>
                (a.client?.displayName || '').toLowerCase().includes(search) ||
                (a.client?.email || '').toLowerCase().includes(search)
            );
        }

        if (scoreFilter) {
            filtered = filtered.filter(a => {
                const score = a.overallScore || 0;
                if (scoreFilter === 'good') return score >= 70;
                if (scoreFilter === 'moderate') return score >= 40 && score < 70;
                if (scoreFilter === 'poor') return score < 40;
                return true;
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Matching Assessments</h3>
                    <p>Try adjusting your search or filters.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead><tr><th>Client</th><th>Overall Score</th><th>Key Findings</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody>`;

        for (const a of filtered) {
            const score = a.overallScore || 0;
            const date = a.createdAt?.toDate()?.toLocaleDateString() || 'N/A';
            const findings = a.findings?.slice(0, 2).join(', ') || 'N/A';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${a.client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${a.client?.email || ''}</div>
                    </td>
                    <td><span class="badge ${score >= 70 ? 'badge-confirmed' : score >= 40 ? 'badge-pending' : 'badge-cancelled'}">${score}/100</span></td>
                    <td style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${findings}</td>
                    <td>${date}</td>
                    <td><button class="action-btn action-btn-secondary" onclick="viewAssessment('${a.id}')">View Details</button></td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Load invite codes
    async function loadInvites() {
        const container = document.getElementById('invites-list');
        const invites = await FirebaseDB.getAllInviteCodes();

        if (invites.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Invite Codes</h3>
                    <p>Generate codes to invite new clients.</p>
                </div>
            `;
            return;
        }

        // Separate available and used invites
        const available = invites.filter(i => !i.used);
        const used = invites.filter(i => i.used);

        // Group used invites by client type
        const usedByType = {
            athlete: [],
            executive: [],
            hotel: [],
            other: []
        };

        for (const invite of used) {
            const client = invite.usedBy ? allClients.find(c => c.id === invite.usedBy) : null;
            const type = client?.clientType || 'other';
            const validType = ['athlete', 'executive', 'hotel'].includes(type) ? type : 'other';
            usedByType[validType].push({ ...invite, client });
        }

        const categoryInfo = {
            athlete: { label: 'Athletes', color: '#2A8B8B' },
            executive: { label: 'Executives', color: '#4A6085' },
            hotel: { label: 'Hotels & Travelers', color: '#8B4D5C' },
            other: { label: 'Other', color: '#6b7b8a' }
        };

        let html = '';

        // Available codes section
        if (available.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 15px 25px; background: rgba(46, 125, 50, 0.08); border-left: 4px solid #2e7d32;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Available Codes</h3>
                        <span style="background: #2e7d32; color: white; font-size: 11px; padding: 3px 10px; border-radius: 10px; font-weight: 600;">${available.length}</span>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>Code</th><th>Created</th><th>Notes</th><th>Actions</th></tr></thead>
                        <tbody>`;

            for (const invite of available) {
                const created = invite.createdAt?.toDate()?.toLocaleDateString() || 'N/A';
                html += `
                    <tr>
                        <td><strong style="font-family: monospace; letter-spacing: 1px;">${invite.code}</strong></td>
                        <td>${created}</td>
                        <td>${invite.notes || invite.clientEmail || '-'}</td>
                        <td>
                            <button class="action-btn action-btn-secondary" onclick="copyCode('${invite.code}')">Copy</button>
                            <button class="action-btn action-btn-danger" onclick="deleteInvite('${invite.code}')">Delete</button>
                        </td>
                    </tr>
                `;
            }
            html += '</tbody></table></div>';
        }

        // Used codes grouped by client type
        if (used.length > 0) {
            html += `
                <div style="margin-bottom: 15px; padding: 15px 25px; background: var(--cream);">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Registered Clients (${used.length})</h3>
                </div>`;

            ['athlete', 'executive', 'hotel', 'other'].forEach(type => {
                const group = usedByType[type];
                if (group.length === 0) return;

                const info = categoryInfo[type];
                html += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px 25px; background: rgba(0,0,0,0.02);">
                            <span style="width: 8px; height: 8px; background: ${info.color}; border-radius: 50%;"></span>
                            <span style="font-size: 13px; font-weight: 500; color: var(--navy);">${info.label}</span>
                            <span style="font-size: 12px; color: var(--text-light);">(${group.length})</span>
                        </div>
                        <table class="data-table">
                            <thead><tr><th>Code</th><th>Client</th><th>Registered</th><th>Actions</th></tr></thead>
                            <tbody>`;

                for (const invite of group) {
                    const regDate = invite.usedAt?.toDate()?.toLocaleDateString() || 'N/A';
                    const clientName = invite.client?.displayName || invite.clientEmail || 'Unknown';

                    html += `
                        <tr>
                            <td><span style="font-family: monospace; font-size: 12px; color: var(--text-light);">${invite.code}</span></td>
                            <td><strong>${clientName}</strong></td>
                            <td>${regDate}</td>
                            <td><button class="action-btn action-btn-secondary" onclick="viewClient('${invite.usedBy}')">View Client</button></td>
                        </tr>
                    `;
                }
                html += '</tbody></table></div>';
            });
        }

        container.innerHTML = html;
    }

    // Generate invite code
    function showGenerateInviteModal() {
        document.getElementById('invite-form-view').style.display = 'block';
        document.getElementById('invite-result-view').style.display = 'none';
        document.getElementById('invite-email').value = '';
        document.getElementById('invite-notes').value = '';
        document.getElementById('invite-modal').style.display = 'flex';
    }

    // Store current invite data for email
    let currentInviteData = {};

    async function generateInviteCode() {
        const email = document.getElementById('invite-email').value.trim();
        const notes = document.getElementById('invite-notes').value;

        const code = await FirebaseDB.generateInviteCode(currentUser.uid, email, notes);
        const authUrl = window.location.origin + '/assessment/auth.html';

        // Store for email sending
        currentInviteData = { email, code, authUrl };

        document.getElementById('generated-code').textContent = code;
        document.getElementById('auth-url').textContent = authUrl;
        document.getElementById('invite-form-view').style.display = 'none';
        document.getElementById('invite-result-view').style.display = 'block';

        // Show email section if email was provided
        const emailSection = document.getElementById('email-section');
        const emailStatus = document.getElementById('email-status');
        emailStatus.style.display = 'none';

        if (email) {
            emailSection.style.display = 'block';
            document.getElementById('email-preview').innerHTML = generateEmailPreview(email, code, authUrl);
            document.getElementById('send-email-btn').disabled = false;
            document.getElementById('send-email-btn').innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                Send Email
            `;
        } else {
            emailSection.style.display = 'none';
        }
    }

    function generateEmailPreview(email, code, authUrl) {
        return `
            <div style="font-family: Georgia, serif; color: #0f1c2e;">
                <p style="margin: 0 0 15px 0;">Dear Client,</p>

                <p style="margin: 0 0 15px 0;">I hope this message finds you well. I am delighted to welcome you to my <strong>Sleep Wellness</strong> practice.</p>

                <p style="margin: 0 0 15px 0;">Your personalized client portal is now ready. This secure space will allow us to work together on optimizing your sleep health, track your progress, and communicate directly.</p>

                <p style="margin: 0 0 10px 0;"><strong>Your Personal Invite Code:</strong></p>
                <p style="margin: 0 0 15px 0; font-family: 'Courier New', monospace; font-size: 18px; background: #f0f0f0; padding: 12px; text-align: center; letter-spacing: 2px; font-weight: bold;">${code}</p>

                <p style="margin: 0 0 10px 0;"><strong>To get started:</strong></p>
                <ol style="margin: 0 0 15px 0; padding-left: 20px;">
                    <li style="margin-bottom: 5px;">Visit: <a href="${authUrl}" style="color: #9a7b3c;">${authUrl}</a></li>
                    <li style="margin-bottom: 5px;">Click "Create Account"</li>
                    <li style="margin-bottom: 5px;">Enter your invite code above</li>
                    <li style="margin-bottom: 5px;">Complete your profile</li>
                </ol>

                <p style="margin: 0 0 15px 0;">I look forward to supporting you on your journey to better sleep and improved well-being.</p>

                <p style="margin: 0 0 5px 0;">Warm regards,</p>
                <p style="margin: 0; font-style: italic;">Dr. Alen Juginovic</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Sleep Wellness by Dr. Alen</p>
            </div>
        `;
    }

    async function sendInviteEmail() {
        const { email, code, authUrl } = currentInviteData;
        if (!email) return;

        const btn = document.getElementById('send-email-btn');
        const status = document.getElementById('email-status');

        btn.disabled = true;
        btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 70"/></svg>
            Sending...
        `;

        try {
            // EmailJS configuration - REPLACE THESE WITH YOUR OWN
            const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
            const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
            const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

            // Check if EmailJS is configured
            if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                // Fallback: Open email client
                const subject = encodeURIComponent('Welcome to Sleep Wellness - Your Access Code');
                const body = encodeURIComponent(`Dear Client,

I hope this message finds you well. I am delighted to welcome you to my Sleep Wellness practice.

Your personalized client portal is now ready. This secure space will allow us to work together on optimizing your sleep health, track your progress, and communicate directly.

Your Personal Invite Code: ${code}

To get started:
1. Visit: ${authUrl}
2. Click "Create Account"
3. Enter your invite code above
4. Complete your profile

I look forward to supporting you on your journey to better sleep and improved well-being.

Warm regards,
Dr. Alen Juginovic
Sleep Wellness by Dr. Alen`);

                window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');

                status.style.display = 'block';
                status.style.color = '#ed6c02';
                status.textContent = 'Email client opened. Please send the email manually.';
                btn.innerHTML = `
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    Open Email Again
                `;
                btn.disabled = false;
                return;
            }

            // Send via EmailJS
            emailjs.init(EMAILJS_PUBLIC_KEY);

            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                to_email: email,
                invite_code: code,
                auth_url: authUrl,
                from_name: 'Dr. Alen Juginovic',
                reply_to: 'alen_juginovic@hms.harvard.edu'
            });

            status.style.display = 'block';
            status.style.color = '#2e7d32';
            status.textContent = 'Email sent successfully!';
            btn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>
                Sent!
            `;
        } catch (error) {
            console.error('Email error:', error);
            status.style.display = 'block';
            status.style.color = '#d32f2f';
            status.textContent = 'Failed to send. Opening email client instead...';

            // Fallback to mailto
            setTimeout(() => {
                const subject = encodeURIComponent('Welcome to Sleep Wellness - Your Access Code');
                const body = encodeURIComponent(`Your invite code: ${code}\n\nCreate your account at: ${authUrl}`);
                window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
            }, 1000);

            btn.disabled = false;
            btn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                Try Again
            `;
        }
    }

    function copyInviteCode() {
        const code = document.getElementById('generated-code').textContent;
        navigator.clipboard.writeText(code);
        event.target.textContent = 'Copied!';
        setTimeout(() => event.target.textContent = 'Copy Code', 2000);
    }

    function closeInviteModal() {
        document.getElementById('invite-modal').style.display = 'none';
        loadInvites();
        loadDashboard();
    }

    function copyCode(code) {
        navigator.clipboard.writeText(code);
        event.target.textContent = 'Copied!';
        setTimeout(() => event.target.textContent = 'Copy', 2000);
    }

    async function deleteInvite(code) {
        if (confirm('Are you sure you want to delete this invite code?')) {
            await FirebaseDB.deleteInviteCode(code);
            loadInvites();
        }
    }

    // Load conversations
    async function loadConversations() {
        const container = document.getElementById('conversations-list');
        container.style.display = 'block';
        document.getElementById('chat-container').classList.remove('active');

        try {
            // Get all conversations where admin is a participant
            const snapshot = await db.collection('conversations')
                .where('participants', 'array-contains', currentUser.uid)
                .get();

            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Conversations</h3>
                        <p>Messages from clients will appear here.</p>
                    </div>
                `;
                return;
            }

            // Sort by lastMessageAt client-side and get client info
            const conversations = [];
            for (const doc of snapshot.docs) {
                const conv = { id: doc.id, ...doc.data() };
                const clientId = conv.participants.find(p => p !== currentUser.uid);
                const client = await FirebaseDB.getUserProfile(clientId);
                conversations.push({ ...conv, clientId, client });
            }

            conversations.sort((a, b) => {
                const aTime = a.lastMessageAt?.toDate?.() || new Date(0);
                const bTime = b.lastMessageAt?.toDate?.() || new Date(0);
                return bTime - aTime;
            });

            // Group by client type
            const grouped = {
                athlete: conversations.filter(c => c.client?.clientType === 'athlete'),
                executive: conversations.filter(c => c.client?.clientType === 'executive'),
                hotel: conversations.filter(c => c.client?.clientType === 'hotel'),
                other: conversations.filter(c => !c.client?.clientType || !['athlete', 'executive', 'hotel'].includes(c.client?.clientType))
            };

            const categoryInfo = {
                athlete: { label: 'Athletes', color: '#2A8B8B' },
                executive: { label: 'Executives', color: '#4A6085' },
                hotel: { label: 'Hotels & Travelers', color: '#8B4D5C' },
                other: { label: 'Other', color: '#6b7b8a' }
            };

            let html = '';

            ['athlete', 'executive', 'hotel', 'other'].forEach(type => {
                const group = grouped[type];
                if (group.length === 0) return;

                const info = categoryInfo[type];
                html += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; background: rgba(0,0,0,0.03); border-left: 3px solid ${info.color};">
                            <span style="font-size: 13px; font-weight: 600; color: ${info.color};">${info.label}</span>
                            <span style="font-size: 12px; color: var(--text-light);">(${group.length})</span>
                        </div>`;

                for (const conv of group) {
                    const lastTime = conv.lastMessageAt?.toDate?.();
                    const timeStr = lastTime ? formatTime(lastTime) : '';
                    const clientName = conv.client?.displayName || 'Client';

                    html += `
                        <div class="conversation-item" onclick="openChat('${conv.id}', '${conv.clientId}', '${clientName}')">
                            <div class="conversation-avatar" style="background: ${info.color};">${clientName[0].toUpperCase()}</div>
                            <div class="conversation-info">
                                <div class="conversation-name">${clientName}</div>
                                <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
                            </div>
                            <div class="conversation-time">${timeStr}</div>
                        </div>
                    `;
                }
                html += '</div>';
            });

            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading conversations:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <h3>Error Loading Messages</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    function formatTime(date) {
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
        return date.toLocaleDateString();
    }

    async function openChat(conversationId, clientId, clientName) {
        currentConversation = { id: conversationId, clientId, clientName };

        document.getElementById('conversations-list').style.display = 'none';
        document.getElementById('chat-container').classList.add('active');
        document.getElementById('chat-avatar').textContent = clientName[0].toUpperCase();
        document.getElementById('chat-name').textContent = clientName;

        // Listen for messages
        if (messageListener) messageListener();

        messageListener = FirebaseDB.getMessagesListener(conversationId, (messages) => {
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(m => `
                <div class="message ${m.senderId === currentUser.uid ? 'sent' : 'received'}">
                    <div class="message-content">${m.text}</div>
                    <div class="message-time">${m.createdAt?.toDate()?.toLocaleTimeString() || ''}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        });
    }

    function closeChat() {
        if (messageListener) {
            messageListener();
            messageListener = null;
        }
        currentConversation = null;
        document.getElementById('chat-container').classList.remove('active');
        document.getElementById('conversations-list').style.display = 'block';
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();

        if (!text || !currentConversation) return;

        const savedText = text;
        input.value = '';
        try {
            await FirebaseDB.sendMessage(currentConversation.id, currentUser.uid, savedText);
        } catch (err) {
            console.error('Failed to send message:', err);
            input.value = savedText;
            alert('Message failed to send. Please try again.');
        }
    }

    function handleMessageKeypress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function messageClient(clientId) {
        try {
            console.log('Messaging client:', clientId);
            // Get or create conversation
            const conv = await FirebaseDB.getOrCreateConversation(clientId, currentUser.uid);
            const client = await FirebaseDB.getUserProfile(clientId);

            console.log('Conversation:', conv);
            console.log('Client:', client);

            // Navigate to messages section
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-messages').classList.add('active');

            // Open the chat after a brief delay
            setTimeout(() => {
                openChat(conv.id, clientId, client?.displayName || 'Client');
            }, 200);
        } catch (error) {
            console.error('Error messaging client:', error);
            showToast('Error opening conversation: ' + error.message, 'error');
        }
    }

    // Load appointments
    async function loadAppointments() {
        const container = document.getElementById('appointments-list');
        const appointments = await FirebaseDB.getAllAppointments();

        if (appointments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Appointments</h3>
                    <p>Client appointment requests will appear here.</p>
                </div>
            `;
            return;
        }

        // Get client info for all appointments
        const appointmentsWithClients = [];
        for (const apt of appointments) {
            const client = await FirebaseDB.getUserProfile(apt.userId);
            appointmentsWithClients.push({ ...apt, client });
        }

        // Group by status, then by client type
        const pending = appointmentsWithClients.filter(a => a.status === 'pending');
        const confirmed = appointmentsWithClients.filter(a => a.status === 'confirmed');
        const past = appointmentsWithClients.filter(a => a.status === 'cancelled' || (a.dateTime?.toDate() < new Date() && a.status !== 'pending'));

        const categoryInfo = {
            athlete: { label: 'Athletes', color: '#2A8B8B' },
            executive: { label: 'Executives', color: '#4A6085' },
            hotel: { label: 'Hotels & Travelers', color: '#8B4D5C' },
            other: { label: 'Other', color: '#6b7b8a' }
        };

        function groupByType(apts) {
            return {
                athlete: apts.filter(a => a.client?.clientType === 'athlete'),
                executive: apts.filter(a => a.client?.clientType === 'executive'),
                hotel: apts.filter(a => a.client?.clientType === 'hotel'),
                other: apts.filter(a => !a.client?.clientType || !['athlete', 'executive', 'hotel'].includes(a.client?.clientType))
            };
        }

        function renderAppointmentRow(apt, showActions = true) {
            const dateTime = apt.dateTime?.toDate();
            const formattedDate = dateTime ? dateTime.toLocaleString() : 'N/A';
            const statusClass = apt.status === 'confirmed' ? 'badge-confirmed' : apt.status === 'cancelled' ? 'badge-cancelled' : 'badge-pending';

            return `
                <tr>
                    <td>
                        <div class="client-name">${apt.client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${apt.client?.email || ''}</div>
                    </td>
                    <td>${apt.type || 'Consultation'}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge ${statusClass}">${apt.status}</span></td>
                    <td>
                        ${showActions && apt.status === 'pending' ? `
                            <button class="action-btn action-btn-primary" onclick="confirmAppointment('${apt.id}')">Confirm</button>
                            <button class="action-btn action-btn-danger" onclick="cancelAppointment('${apt.id}')">Decline</button>
                        ` : `
                            <button class="action-btn action-btn-secondary" onclick="messageClient('${apt.userId}')">Message</button>
                        `}
                    </td>
                </tr>
            `;
        }

        let html = '';

        // Pending appointments (needs action)
        if (pending.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 15px 25px; background: rgba(198, 40, 40, 0.08); border-left: 4px solid #c62828;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#c62828" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Pending Requests</h3>
                        <span style="background: #c62828; color: white; font-size: 11px; padding: 3px 10px; border-radius: 10px; font-weight: 600;">${pending.length}</span>
                    </div>`;

            const pendingGrouped = groupByType(pending);
            ['athlete', 'executive', 'hotel', 'other'].forEach(type => {
                const group = pendingGrouped[type];
                if (group.length === 0) return;
                const info = categoryInfo[type];

                html += `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 25px; background: rgba(0,0,0,0.02);">
                            <span style="width: 6px; height: 6px; background: ${info.color}; border-radius: 50%;"></span>
                            <span style="font-size: 12px; font-weight: 500; color: var(--text-light);">${info.label}</span>
                        </div>
                        <table class="data-table">
                            <thead><tr><th>Client</th><th>Type</th><th>Date/Time</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>${group.map(a => renderAppointmentRow(a, true)).join('')}</tbody>
                        </table>
                    </div>`;
            });
            html += '</div>';
        }

        // Confirmed appointments
        if (confirmed.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 15px 25px; background: rgba(46, 125, 50, 0.08); border-left: 4px solid #2e7d32;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin: 0;">Confirmed</h3>
                        <span style="background: #2e7d32; color: white; font-size: 11px; padding: 3px 10px; border-radius: 10px; font-weight: 600;">${confirmed.length}</span>
                    </div>`;

            const confirmedGrouped = groupByType(confirmed);
            ['athlete', 'executive', 'hotel', 'other'].forEach(type => {
                const group = confirmedGrouped[type];
                if (group.length === 0) return;
                const info = categoryInfo[type];

                html += `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 25px; background: rgba(0,0,0,0.02);">
                            <span style="width: 6px; height: 6px; background: ${info.color}; border-radius: 50%;"></span>
                            <span style="font-size: 12px; font-weight: 500; color: var(--text-light);">${info.label}</span>
                        </div>
                        <table class="data-table">
                            <thead><tr><th>Client</th><th>Type</th><th>Date/Time</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>${group.map(a => renderAppointmentRow(a, false)).join('')}</tbody>
                        </table>
                    </div>`;
            });
            html += '</div>';
        }

        // Past/Cancelled (collapsed by default)
        if (past.length > 0) {
            html += `
                <details style="margin-bottom: 20px;">
                    <summary style="display: flex; align-items: center; gap: 12px; padding: 15px 25px; background: rgba(0,0,0,0.03); border-left: 4px solid #999; cursor: pointer;">
                        <span style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--text-light);">Past & Cancelled (${past.length})</span>
                    </summary>
                    <table class="data-table">
                        <thead><tr><th>Client</th><th>Type</th><th>Date/Time</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody>${past.map(a => renderAppointmentRow(a, false)).join('')}</tbody>
                    </table>
                </details>`;
        }

        container.innerHTML = html;
    }

    async function confirmAppointment(appointmentId) {
        await FirebaseDB.updateAppointmentStatus(appointmentId, 'confirmed');
        loadAppointments();
        loadDashboard();
    }

    async function cancelAppointment(appointmentId) {
        if (confirm('Are you sure you want to decline this appointment?')) {
            await FirebaseDB.updateAppointmentStatus(appointmentId, 'cancelled');
            loadAppointments();
            loadDashboard();
        }
    }

    // Load module requests
    async function loadRequests() {
        const container = document.getElementById('requests-list');
        const requestsCard = document.getElementById('module-requests-card');

        try {
            const requests = await FirebaseDB.getPendingModuleRequests();

            // Update badge
            const badge = document.getElementById('requests-badge');
            if (requests.length > 0) {
                badge.textContent = requests.length;
                badge.style.display = 'inline-flex';
                // Show the requests card when there are pending requests
                if (requestsCard) requestsCard.style.display = 'block';
            } else {
                badge.style.display = 'none';
                // Hide the requests card when there are no pending requests
                if (requestsCard) requestsCard.style.display = 'none';
            }

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Pending Requests</h3>
                        <p>When clients request module access, they'll appear here.</p>
                    </div>
                `;
                return;
            }

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Module Requested</th>
                        <th>Reason</th>
                        <th>Requested</th>
                        <th style="width: 180px;">Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const req of requests) {
                const requested = req.createdAt?.toDate?.()?.toLocaleDateString() || 'N/A';

                html += `
                    <tr id="request-${req.id}">
                        <td>
                            <div class="client-name">${req.userName}</div>
                            <div class="client-email">${req.userEmail}</div>
                        </td>
                        <td><strong>${req.moduleName || req.moduleId}</strong></td>
                        <td style="max-width: 250px; font-size: 13px; color: var(--text-light);">${req.reason || '<em>No reason provided</em>'}</td>
                        <td>${requested}</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="approveRequest('${req.id}')" class="action-btn action-btn-primary" style="padding: 8px 16px; font-size: 12px;">
                                    Approve
                                </button>
                                <button onclick="denyRequest('${req.id}')" class="action-btn action-btn-secondary" style="padding: 8px 16px; font-size: 12px;">
                                    Deny
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading requests:', error);
            container.innerHTML = '<p style="color: red;">Error loading requests</p>';
        }
    }

    // Approve module request
    async function approveRequest(requestId) {
        if (!confirm('Approve this module request?')) return;

        try {
            await FirebaseDB.approveModuleRequest(requestId);
            showToast('The module has been unlocked for this client.', 'success', 'Request Approved');
            loadModulesSection(); // Refresh the entire modules section
        } catch (error) {
            console.error('Error approving request:', error);
            showToast('Error approving request. Please try again.', 'error');
        }
    }

    // Deny module request
    async function denyRequest(requestId) {
        const reason = prompt('Reason for denial (optional):');
        if (reason === null) return; // User cancelled

        try {
            await FirebaseDB.denyModuleRequest(requestId, reason);
            showToast('Request has been denied.', 'info', 'Request Denied');
            loadModulesSection(); // Refresh the entire modules section
        } catch (error) {
            console.error('Error denying request:', error);
            showToast('Error denying request. Please try again.', 'error');
        }
    }

    // Update requests badge count
    async function updateRequestsBadge() {
        try {
            const count = await FirebaseDB.getPendingRequestsCount();
            const badge = document.getElementById('requests-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        } catch (error) {
            console.error('Error updating requests badge:', error);
        }
    }

    // Render all available modules in a grid for admin view
    function renderAllModulesGrid() {
        const container = document.getElementById('all-modules-grid');
        if (!container || !window.Content) return;

        const modules = Content.modules;
        const moduleCategories = {
            'Relaxation Techniques': ['breathing-478', 'pmr', 'mindfulness-bodyscan', 'autogenic-training', 'guided-imagery'],
            'CBT-I Components': ['cbti-restriction', 'cbti-stimulus', 'cbti-cognitive', 'paradoxical-intention'],
            'Cognitive & Lifestyle': ['worry-management', 'circadian-rhythm'],
            'Travel & Performance': ['jet-lag-calculator'],
            'Foundational': ['sleep-hygiene'],
            'Tools': ['sleep-diary']
        };

        let html = '';

        for (const category in moduleCategories) {
            const moduleIds = moduleCategories[category];
            html += `<div style="grid-column: 1 / -1; margin-top: ${html ? '20px' : '0'};"><h4 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 12px;">${category}</h4></div>`;

            for (const id of moduleIds) {
                const m = modules[id];
                if (!m) continue;

                const isLocked = m.locked;
                html += `
                    <div onclick="openModuleDetail('${id}')" style="background: ${isLocked ? '#fafafa' : '#f0f9f0'}; border: 1px solid ${isLocked ? 'rgba(201, 169, 98, 0.2)' : 'rgba(46, 125, 50, 0.2)'}; border-radius: 8px; padding: 16px; position: relative; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)';">
                        ${!isLocked ? '<span style="position: absolute; top: 10px; right: 10px; background: #2e7d32; color: white; font-size: 9px; padding: 3px 8px; border-radius: 10px; text-transform: uppercase;">Free</span>' : ''}
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <svg style="width: 24px; height: 24px; stroke: var(--gold); flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke-width="1.5">${Content.getModuleIconSVG(m.icon)}</svg>
                            <h5 style="font-size: 14px; font-weight: 600; color: var(--navy); margin: 0;">${m.title}</h5>
                        </div>
                        <p style="font-size: 12px; color: var(--text-light); margin: 0; line-height: 1.5;">${m.description}</p>
                        <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                            <span style="font-size: 10px; background: rgba(201, 169, 98, 0.15); color: var(--gold-dark); padding: 3px 8px; border-radius: 10px;">${m.duration || 'Varies'}</span>
                            <span style="font-size: 10px; background: rgba(15, 28, 46, 0.08); color: var(--navy); padding: 3px 8px; border-radius: 10px;">${m.difficulty || 'Beginner'}</span>
                        </div>
                    </div>
                `;
            }
        }

        container.innerHTML = html;
    }

    // Open module detail modal
    async function openModuleDetail(moduleId) {
        document.getElementById('module-detail-modal').style.display = 'flex';

        try {
            const modules = Content.modules;
            const m = modules[moduleId];
            if (!m) return;

            // Set title
            document.getElementById('module-detail-title').textContent = m.title;
            document.getElementById('module-assign-id').value = moduleId;

            // Build module info HTML
            const infoHtml = `
            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">${m.description}</p>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: #fafafa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 5px;">Duration</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--navy);">${m.duration || 'Varies'}</div>
                </div>
                <div style="background: #fafafa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 5px;">Difficulty</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--navy);">${m.difficulty || 'Beginner'}</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 10px;">Best For</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${(m.indications || ['General use']).map(ind => `
                        <span style="font-size: 12px; background: rgba(46, 125, 50, 0.1); color: #2e7d32; padding: 6px 12px; border-radius: 15px;">${ind}</span>
                    `).join('')}
                </div>
            </div>

            <div style="background: rgba(201, 169, 98, 0.1); padding: 12px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                <svg style="width: 18px; height: 18px; stroke: var(--gold); flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span style="font-size: 13px; color: var(--navy);"><strong>Evidence:</strong> ${m.evidence || 'Clinical guidelines'}</span>
            </div>
        `;

        document.getElementById('module-detail-content').innerHTML = infoHtml;

        // Load clients for assignment
        const clientsContainer = document.getElementById('module-assign-clients');
        const clients = await FirebaseDB.getAllUsers();

        // Get all existing unlocks to show who already has this module
        const unlocksSnapshot = await db.collection('unlocks').get();
        const clientsWithModule = new Set();
        unlocksSnapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.modules && data.modules.includes(moduleId)) {
                clientsWithModule.add(data.userId);
            }
        });

        if (clients.length === 0) {
            clientsContainer.innerHTML = '<p style="color: var(--text-light); font-size: 13px; text-align: center; padding: 10px;">No clients found</p>';
        } else {
            clientsContainer.innerHTML = clients.map(c => {
                const hasModule = clientsWithModule.has(c.id) || !m.locked;
                return `
                    <label style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: ${hasModule ? 'default' : 'pointer'}; border-radius: 6px; ${hasModule ? 'opacity: 0.6;' : ''}" ${hasModule ? '' : `onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''"`}>
                        <input type="checkbox" name="module-assign-client" value="${c.id}" ${hasModule ? 'disabled checked' : ''} style="width: 16px; height: 16px;">
                        <div>
                            <div style="font-size: 13px; font-weight: 500; color: var(--navy);">${c.displayName || c.email}</div>
                            ${hasModule ? '<div style="font-size: 11px; color: #2e7d32;">Already has access</div>' : ''}
                        </div>
                    </label>
                `;
            }).join('');
        }

            // Show modal
            console.log('Showing modal now');
            document.getElementById('module-detail-modal').classList.add('active');
        } catch (error) {
            console.error('Error in openModuleDetail:', error);
        }
    }

    // Assign module to selected clients
    async function assignModuleToSelected() {
        const moduleId = document.getElementById('module-assign-id').value;
        const selectedClients = Array.from(document.querySelectorAll('input[name="module-assign-client"]:checked:not(:disabled)')).map(cb => cb.value);

        if (selectedClients.length === 0) {
            showToast('Please select at least one client to assign this module.', 'warning');
            return;
        }

        const btn = document.getElementById('assign-module-btn');
        btn.disabled = true;
        btn.textContent = 'Assigning...';

        try {
            // Assign to each selected client
            for (const clientId of selectedClients) {
                await FirebaseDB.grantUnlock(clientId, [moduleId], currentUser.uid, 'Assigned from module detail');
            }

            closeModal('module-detail-modal');
            showToast(`Module assigned to ${selectedClients.length} client(s) successfully!`, 'success');
            loadModulesSection(); // Refresh the modules section
        } catch (error) {
            console.error('Error assigning module:', error);
            showToast('Error assigning module. Please try again.', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Assign Module';
        }
    }

    // Load unlocks / assign modules section
    async function loadUnlocks() {
        // Render all available modules grid
        renderAllModulesGrid();

        // Load assignment history
        const container = document.getElementById('unlocks-list');

        // Get all unlocks
        const snapshot = await db.collection('unlocks')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();

        if (snapshot.empty) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 30px;">
                    <p style="color: var(--text-light);">No modules have been assigned yet.</p>
                </div>
            `;
            return;
        }

        let html = `<table class="data-table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Modules</th>
                    <th>Granted</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>`;

        for (const doc of snapshot.docs) {
            const unlock = { id: doc.id, ...doc.data() };
            const client = await FirebaseDB.getUserProfile(unlock.userId);
            const granted = unlock.createdAt?.toDate()?.toLocaleDateString() || 'N/A';

            html += `
                <tr>
                    <td>
                        <div class="client-name">${client?.displayName || 'Unknown'}</div>
                        <div class="client-email">${client?.email || ''}</div>
                    </td>
                    <td>${unlock.modules?.join(', ') || '-'}</td>
                    <td>${granted}</td>
                    <td>${unlock.notes || '-'}</td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Unlock modal
    async function showUnlockModal() {
        const select = document.getElementById('unlock-client');
        const clients = await FirebaseDB.getAllUsers();

        select.innerHTML = '<option value="">Select a client</option>' +
            clients.map(c => `<option value="${c.id}">${c.displayName || c.email}</option>`).join('');

        document.querySelectorAll('input[name="unlock-modules"]').forEach(cb => cb.checked = false);
        document.getElementById('unlock-notes').value = '';

        document.getElementById('unlock-modal').style.display = 'flex';
    }

    async function grantUnlock() {
        const clientId = document.getElementById('unlock-client').value;
        const modules = Array.from(document.querySelectorAll('input[name="unlock-modules"]:checked')).map(cb => cb.value);
        const notes = document.getElementById('unlock-notes').value;

        if (!clientId || modules.length === 0) {
            showToast('Please select a client and at least one module.', 'warning');
            return;
        }

        await FirebaseDB.grantUnlock(clientId, modules, currentUser.uid, notes);

        closeModal('unlock-modal');
        loadModulesSection();
        showToast('Access granted successfully!', 'success');
    }

    // ========== QUESTIONNAIRE FUNCTIONS ==========

    // Load questionnaires section
    async function loadQuestionnaires() {
        renderQuestionnairesGrid();
        await loadPendingQuestionnaires();
        await loadQuestionnaireResults();
    }

    // Render available questionnaires grid
    function renderQuestionnairesGrid() {
        const container = document.getElementById('questionnaires-grid');
        if (!container || !window.Questionnaires) return;

        const instruments = Questionnaires.getAllInstruments();

        const categoryColors = {
            'Insomnia': '#5c6bc0',
            'Sleepiness': '#26a69a',
            'Sleep Apnea': '#ef5350',
            'Mood': '#ab47bc'
        };

        let html = '';
        for (const inst of instruments) {
            const catColor = categoryColors[inst.category] || 'var(--gold)';
            html += `
                <div onclick="openQuestionnaireDetail('${inst.id}')" style="background: white; border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.04);" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 6px 16px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.04)';">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <span style="background: ${catColor}; color: white; font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 500;">${inst.category}</span>
                        <span style="font-size: 11px; color: var(--text-light);">${inst.timeToComplete}</span>
                    </div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--navy); margin: 0 0 6px 0;">${inst.name}</h4>
                    <p style="font-size: 11px; color: var(--gold-dark); margin: 0 0 10px 0;">${inst.shortName}</p>
                    <p style="font-size: 13px; color: var(--text-light); margin: 0; line-height: 1.5;">${inst.description}</p>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(201, 169, 98, 0.1);">
                        <span style="font-size: 11px; color: var(--text-light);">${inst.questions.length} questions</span>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // Open questionnaire detail (for now just show assign modal)
    function openQuestionnaireDetail(instrumentId) {
        showAssignQuestionnaireModal(instrumentId);
    }

    // Load pending questionnaire assignments
    async function loadPendingQuestionnaires() {
        const container = document.getElementById('pending-questionnaires-list');

        try {
            // Get all pending questionnaire assignments
            const snapshot = await db.collection('questionnaireAssignments')
                .where('status', '==', 'pending')
                .orderBy('dueDate', 'asc')
                .get();

            if (snapshot.empty) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-light);">
                        <p>No pending questionnaire assignments.</p>
                    </div>
                `;
                return;
            }

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Questionnaire</th>
                        <th>Due Date</th>
                        <th>Assigned</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>`;

            snapshot.forEach(doc => {
                const data = doc.data();
                const dueDate = data.dueDate?.toDate?.();
                const assignedDate = data.createdAt?.toDate?.();
                const isOverdue = dueDate && dueDate < new Date();

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${data.userName || 'Unknown'}</div>
                            <div class="client-email">${data.userEmail || ''}</div>
                        </td>
                        <td><strong>${data.questionnaireName || data.questionnaireId}</strong></td>
                        <td style="color: ${isOverdue ? '#c62828' : 'inherit'}; font-weight: ${isOverdue ? '600' : 'normal'};">
                            ${dueDate ? dueDate.toLocaleDateString() : 'No due date'}
                            ${isOverdue ? ' <span style="font-size: 10px;">(Overdue)</span>' : ''}
                        </td>
                        <td>${assignedDate ? assignedDate.toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <span style="background: #fff3e0; color: #ef6c00; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">Pending</span>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Update badge
            updateQuestionnairesBadge(snapshot.size);
        } catch (error) {
            console.error('Error loading pending questionnaires:', error);
            container.innerHTML = '<p style="color: red;">Error loading pending questionnaires</p>';
        }
    }

    // Load completed questionnaire results
    async function loadQuestionnaireResults() {
        const container = document.getElementById('questionnaire-results-list');

        try {
            const results = await FirebaseDB.getRecentCompletedQuestionnaires(20);

            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-light);">
                        <p>No completed questionnaires yet.</p>
                    </div>
                `;
                return;
            }

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Questionnaire</th>
                        <th>Score</th>
                        <th>Interpretation</th>
                        <th>Completed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const result of results) {
                const completedDate = result.completedAt?.toDate?.();

                html += `
                    <tr>
                        <td>
                            <div class="client-name">${result.userName || 'Unknown'}</div>
                            <div class="client-email">${result.userEmail || ''}</div>
                        </td>
                        <td><strong>${result.questionnaireName || result.questionnaireId}</strong></td>
                        <td style="font-weight: 600; font-size: 16px;">${result.score}/${result.maxScore}</td>
                        <td>
                            <span style="background: ${result.color || '#666'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                ${result.interpretation || 'N/A'}
                            </span>
                        </td>
                        <td>${completedDate ? completedDate.toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <button onclick="viewQuestionnaireResult('${result.id}')" class="action-btn action-btn-secondary" style="padding: 6px 12px; font-size: 11px;">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading questionnaire results:', error);
            container.innerHTML = '<p style="color: red;">Error loading results</p>';
        }
    }

    // Update questionnaires badge
    function updateQuestionnairesBadge(count) {
        const badge = document.getElementById('questionnaires-badge');
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-flex';
        } else {
            badge.style.display = 'none';
        }
    }

    // Show assign questionnaire modal
    async function showAssignQuestionnaireModal(preselectedId = null) {
        const select = document.getElementById('questionnaire-select');
        const clientsContainer = document.getElementById('questionnaire-clients-list');
        const preview = document.getElementById('questionnaire-preview');

        // Populate questionnaire options
        const instruments = Questionnaires.getAllInstruments();
        select.innerHTML = '<option value="">Choose a questionnaire...</option>' +
            instruments.map(inst => `<option value="${inst.id}">${inst.name} (${inst.shortName})</option>`).join('');

        // Set preselected if provided
        if (preselectedId) {
            select.value = preselectedId;
            updateQuestionnairePreview();
        } else {
            preview.style.display = 'none';
        }

        // Add change listener for preview
        select.onchange = updateQuestionnairePreview;

        // Set default due date to 7 days from now
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 7);
        document.getElementById('questionnaire-due-date').value = dueDate.toISOString().split('T')[0];

        // Clear notes
        document.getElementById('questionnaire-notes').value = '';

        // Load clients
        const clients = await FirebaseDB.getAllUsers();
        clientsContainer.innerHTML = clients.map(c => `
            <label style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
                <input type="checkbox" name="questionnaire-clients" value="${c.id}" data-name="${c.displayName || c.email}" data-email="${c.email || ''}">
                <div>
                    <div style="font-size: 13px; font-weight: 500; color: var(--navy);">${c.displayName || 'Unnamed'}</div>
                    <div style="font-size: 11px; color: var(--text-light);">${c.email || ''}</div>
                </div>
            </label>
        `).join('');

        document.getElementById('assign-questionnaire-modal').style.display = 'flex';
    }

    // Update questionnaire preview in modal
    function updateQuestionnairePreview() {
        const select = document.getElementById('questionnaire-select');
        const preview = document.getElementById('questionnaire-preview');
        const inst = Questionnaires.getInstrument(select.value);

        if (inst) {
            document.getElementById('qp-time').textContent = inst.timeToComplete;
            document.getElementById('qp-category').textContent = inst.category;
            document.getElementById('qp-description').textContent = inst.description;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    // Assign questionnaire to selected clients
    async function assignQuestionnaireToClients() {
        const questionnaireId = document.getElementById('questionnaire-select').value;
        const selectedCheckboxes = document.querySelectorAll('input[name="questionnaire-clients"]:checked');
        const dueDate = document.getElementById('questionnaire-due-date').value;
        const notes = document.getElementById('questionnaire-notes').value;

        if (!questionnaireId) {
            showToast('Please select a questionnaire.', 'warning');
            return;
        }

        if (selectedCheckboxes.length === 0) {
            showToast('Please select at least one client.', 'warning');
            return;
        }

        const instrument = Questionnaires.getInstrument(questionnaireId);

        try {
            for (const cb of selectedCheckboxes) {
                await FirebaseDB.assignQuestionnaire(
                    cb.value,
                    questionnaireId,
                    instrument.name,
                    dueDate ? new Date(dueDate) : null,
                    notes
                );
            }

            closeModal('assign-questionnaire-modal');
            showToast(`Questionnaire assigned to ${selectedCheckboxes.length} client(s) successfully!`, 'success');
            loadQuestionnaires();
        } catch (error) {
            console.error('Error assigning questionnaire:', error);
            showToast('Error assigning questionnaire. Please try again.', 'error');
        }
    }

    // View questionnaire result details
    async function viewQuestionnaireResult(resultId) {
        try {
            const doc = await db.collection('questionnaireAssignments').doc(resultId).get();
            if (!doc.exists) {
                alert('Result not found');
                return;
            }

            const result = doc.data();
            const answers = result.answers || [];

            // Build details string
            let details = `Client: ${result.userName || 'Unknown'}\n`;
            details += `Questionnaire: ${result.questionnaireName || result.questionnaireId}\n`;
            details += `Completed: ${result.completedAt?.toDate?.().toLocaleString() || 'N/A'}\n\n`;
            details += `SCORE: ${result.score}/${result.maxScore}\n`;
            details += `Interpretation: ${result.interpretation || 'N/A'}\n`;
            details += `Severity: ${result.severity || 'N/A'}\n\n`;
            details += `Individual Responses:\n`;

            const instrument = Questionnaires.getInstrument(result.questionnaireId);
            if (instrument) {
                answers.forEach((ans, i) => {
                    const q = instrument.questions[i];
                    const option = q?.options?.find(o => o.value === ans.value);
                    details += `Q${i + 1}: ${option?.label || ans.value} (${ans.value})\n`;
                });
            }

            alert(details);
        } catch (error) {
            console.error('Error loading result:', error);
            alert('Error loading result details.');
        }
    }

    // ========== END QUESTIONNAIRE FUNCTIONS ==========

    // ========== NOTIFICATION FUNCTIONS ==========

    let notificationsVisible = false;

    async function loadNotifications() {
        try {
            const notifications = await FirebaseDB.getUnreadNotifications(currentUser.uid);

            // Update count badge
            const countEl = document.getElementById('notification-count');
            if (notifications.length > 0) {
                countEl.textContent = notifications.length;
                countEl.style.display = 'inline-flex';
            } else {
                countEl.style.display = 'none';
            }

            // Update dropdown
            const container = document.getElementById('notifications-list');
            if (notifications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px; font-size: 14px;">No new notifications</p>';
                return;
            }

            container.innerHTML = notifications.map(n => {
                const time = n.createdAt?.toDate?.();
                const timeAgo = time ? formatTimeAgo(time) : '';
                const iconColor = n.type === 'questionnaire_completed' ? '#2e7d32' : 'var(--gold)';

                return `
                    <div style="padding: 12px 20px; border-bottom: 1px solid rgba(201, 169, 98, 0.1); display: flex; gap: 12px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8f6f3'" onmouseout="this.style.background=''" onclick="handleNotificationClick('${n.id}', '${n.type}')">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: ${iconColor}15; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2">
                                ${n.type === 'questionnaire_completed' ?
                                    '<path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>' :
                                    '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>'}
                            </svg>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 500; color: var(--navy); margin-bottom: 3px;">${n.title}</div>
                            <div style="font-size: 12px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${n.message}</div>
                            <div style="font-size: 11px; color: var(--gold-dark); margin-top: 4px;">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    function toggleNotifications() {
        const dropdown = document.getElementById('notifications-dropdown');
        notificationsVisible = !notificationsVisible;
        dropdown.style.display = notificationsVisible ? 'block' : 'none';

        if (notificationsVisible) {
            loadNotifications();
        }
    }

    async function handleNotificationClick(notificationId, type) {
        // Mark as read
        await FirebaseDB.markNotificationRead(notificationId);

        // Navigate based on type
        if (type === 'questionnaire_completed') {
            toggleNotifications();
            showSection('questionnaires');
        }

        loadNotifications();
    }

    async function markAllNotificationsRead() {
        try {
            const notifications = await FirebaseDB.getUnreadNotifications(currentUser.uid);
            for (const n of notifications) {
                await FirebaseDB.markNotificationRead(n.id);
            }
            loadNotifications();
        } catch (error) {
            console.error('Error marking notifications as read:', error);
        }
    }

    // Close notifications when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('notifications-dropdown');
        const bell = document.getElementById('notification-bell');
        if (notificationsVisible && !dropdown?.contains(e.target) && !bell?.contains(e.target)) {
            notificationsVisible = false;
            dropdown.style.display = 'none';
        }
    });

    // ========== END NOTIFICATION FUNCTIONS ==========

    // View assessment details
    function viewAssessment(assessmentId) {
        const assessment = allAssessments.find(a => a.id === assessmentId);
        if (!assessment) return;

        alert('Assessment Details:\n\n' +
            'Overall Score: ' + (assessment.overallScore || 'N/A') + '/100\n' +
            'ESS Score: ' + (assessment.scores?.ess || 'N/A') + '\n' +
            'ISI Score: ' + (assessment.scores?.isi || 'N/A') + '\n' +
            'STOP-BANG Score: ' + (assessment.scores?.stopbang || 'N/A') + '\n\n' +
            'Key Findings:\n' + (assessment.findings?.join('\n') || 'None'));
    }

    // Current client being viewed
    let currentViewedClient = null;

    async function viewClient(clientId) {
        console.log('viewClient called with:', clientId);
        console.log('allClients:', allClients);

        let client = allClients.find(c => c.id === clientId);

        // If not in cache, fetch directly
        if (!client) {
            console.log('Client not in cache, fetching from database...');
            try {
                const profile = await FirebaseDB.getUserProfile(clientId);
                if (profile) {
                    client = { id: clientId, ...profile };
                }
            } catch (error) {
                console.error('Error fetching client:', error);
            }
        }

        if (!client) {
            console.error('Client not found:', clientId);
            alert('Error: Client not found');
            return;
        }

        currentViewedClient = client;

        // Update profile header
        const initials = (client.displayName || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        document.getElementById('client-avatar').textContent = initials;
        document.getElementById('client-name').textContent = client.displayName || 'Unknown';
        document.getElementById('client-type-badge').textContent = client.clientType || 'Client';
        document.getElementById('client-email').textContent = client.email || '';
        document.getElementById('client-joined').textContent = 'Joined: ' + (client.createdAt?.toDate?.() ? client.createdAt.toDate().toLocaleDateString() : 'Unknown');

        // Update demographics
        document.getElementById('demo-age').textContent = client.age ? `${client.age} years` : '--';
        document.getElementById('demo-sex').textContent = client.sex || '--';
        document.getElementById('demo-occupation').textContent = client.occupation || client.sport || client.title || '--';
        document.getElementById('demo-phone').textContent = client.phone || '--';

        // Update primary goal
        const goalEl = document.getElementById('client-primary-goal');
        const notesEl = document.getElementById('client-notes');
        if (client.primaryGoal) {
            goalEl.innerHTML = `<p style="margin: 0; font-weight: 500;">${client.primaryGoal}</p>`;
        } else {
            goalEl.innerHTML = `<p style="margin: 0; color: var(--text-light); font-style: italic;">No primary goal set</p>`;
        }
        if (client.notes) {
            notesEl.style.display = 'block';
            notesEl.innerHTML = `<strong>Notes:</strong> ${client.notes}`;
        } else {
            notesEl.style.display = 'none';
        }

        // Update program duration banner
        const durationBanner = document.getElementById('program-duration-banner');
        if (client.programStartDate && client.programDuration) {
            durationBanner.style.display = 'block';
            const startDate = client.programStartDate?.toDate ? client.programStartDate.toDate() : new Date(client.programStartDate);
            const durationWeeks = parseInt(client.programDuration) || 0;
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + (durationWeeks * 7));

            document.getElementById('program-duration-text').textContent = `${durationWeeks} weeks (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`;

            const now = new Date();
            const remainingDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            if (remainingDays > 0) {
                const remainingWeeks = Math.floor(remainingDays / 7);
                const extraDays = remainingDays % 7;
                document.getElementById('program-remaining').textContent = remainingWeeks > 0 ?
                    `${remainingWeeks} week${remainingWeeks > 1 ? 's' : ''} ${extraDays > 0 ? `, ${extraDays} day${extraDays > 1 ? 's' : ''}` : ''}` :
                    `${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
                document.getElementById('program-remaining').style.color = remainingDays < 14 ? '#f57c00' : 'var(--gold)';
            } else {
                document.getElementById('program-remaining').textContent = 'Program Completed';
                document.getElementById('program-remaining').style.color = '#2e7d32';
            }
        } else {
            durationBanner.style.display = 'none';
        }

        // Show client detail section first so user sees immediate feedback
        showSection('client-detail');

        // Load all client data
        try {
            await Promise.all([
                loadClientAssessment(clientId),
                loadClientActions(clientId),
                loadClientMessages(clientId),
                loadClientModules(clientId),
                loadClientBaselineQuestionnaires(clientId),
                loadSleepHabitsSummary(clientId),
                loadDiaryEntriesDetail(clientId),
                loadEntryExitComparison(clientId)
            ]);
        } catch (error) {
            console.error('Error loading client data:', error);
        }
    }

    // Load baseline questionnaires for client
    async function loadClientBaselineQuestionnaires(clientId) {
        const container = document.getElementById('baseline-questionnaires');
        const noticeEl = document.getElementById('no-questionnaires-notice');

        try {
            const snapshot = await db.collection('questionnaireAssignments')
                .where('userId', '==', clientId)
                .where('status', '==', 'completed')
                .get();

            if (snapshot.empty) {
                container.style.display = 'none';
                noticeEl.style.display = 'block';
                return;
            }

            const results = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Get the most recent result for each instrument type
            const latestByType = {};
            results.forEach(r => {
                if (!latestByType[r.instrumentId] ||
                    (r.completedAt?.toDate?.() > latestByType[r.instrumentId].completedAt?.toDate?.())) {
                    latestByType[r.instrumentId] = r;
                }
            });

            const baselineInstruments = ['isi', 'ess', 'stopbang', 'phq9', 'gad7', 'psqi'];
            const instrumentNames = {
                'isi': { name: 'ISI', full: 'Insomnia Severity Index', max: 28 },
                'ess': { name: 'ESS', full: 'Epworth Sleepiness Scale', max: 24 },
                'stopbang': { name: 'STOP-BANG', full: 'Sleep Apnea Risk', max: 8 },
                'phq9': { name: 'PHQ-9', full: 'Depression Screen', max: 27 },
                'gad7': { name: 'GAD-7', full: 'Anxiety Screen', max: 21 },
                'psqi': { name: 'PSQI', full: 'Sleep Quality Index', max: 21 }
            };

            let html = '';
            let hasAny = false;

            baselineInstruments.forEach(instrId => {
                const result = latestByType[instrId];
                const info = instrumentNames[instrId];

                if (result && result.result) {
                    hasAny = true;
                    const score = result.result.score || 0;
                    const max = result.result.maxScore || info.max;
                    const severity = result.result.severity || 'unknown';
                    const label = result.result.label || '';

                    // Determine color based on severity
                    let color = '#6b7b8a';
                    if (['none', 'normal', 'minimal', 'low'].includes(severity)) color = '#2e7d32';
                    else if (['mild', 'subthreshold', 'intermediate'].includes(severity)) color = '#f9a825';
                    else if (['moderate'].includes(severity)) color = '#ef6c00';
                    else if (['severe', 'high', 'moderately_severe'].includes(severity)) color = '#c62828';

                    const date = result.completedAt?.toDate?.()?.toLocaleDateString() || '';

                    html += `
                        <div style="background: linear-gradient(135deg, rgba(${color === '#2e7d32' ? '46,125,50' : color === '#f9a825' ? '249,168,37' : color === '#ef6c00' ? '239,108,0' : '198,40,40'}, 0.08) 0%, white 100%); border: 1px solid rgba(${color === '#2e7d32' ? '46,125,50' : color === '#f9a825' ? '249,168,37' : color === '#ef6c00' ? '239,108,0' : '198,40,40'}, 0.2); border-radius: 10px; padding: 18px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">${info.name}</div>
                            <div style="font-size: 32px; font-weight: 700; color: ${color}; line-height: 1;">${score}<span style="font-size: 14px; color: var(--text-light);">/${max}</span></div>
                            <div style="font-size: 12px; color: ${color}; font-weight: 500; margin-top: 6px;">${label}</div>
                            <div style="font-size: 10px; color: var(--text-light); margin-top: 8px;">${date}</div>
                        </div>
                    `;
                }
            });

            if (hasAny) {
                container.style.display = 'grid';
                noticeEl.style.display = 'none';
                container.innerHTML = html;
            } else {
                container.style.display = 'none';
                noticeEl.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading baseline questionnaires:', error);
            container.style.display = 'none';
            noticeEl.style.display = 'block';
        }
    }

    // Load sleep habits summary from diary entries
    async function loadSleepHabitsSummary(clientId) {
        const summaryEl = document.getElementById('sleep-habits-summary');
        const noticeEl = document.getElementById('no-sleep-summary-notice');
        const complaintEl = document.getElementById('main-sleep-complaint');
        const complaintText = document.getElementById('complaint-text');

        try {
            // Get diary entries for this client
            const snapshot = await db.collection('diaryEntries')
                .where('userId', '==', clientId)
                .orderBy('date', 'desc')
                .limit(14) // Last 2 weeks
                .get();

            if (snapshot.empty) {
                summaryEl.style.display = 'none';
                noticeEl.style.display = 'block';
            } else {
                const entries = snapshot.docs.map(doc => doc.data());

                // Calculate averages
                let totalBedMinutes = 0, totalWakeMinutes = 0, totalDuration = 0, totalQuality = 0;
                let validEntries = 0;

                entries.forEach(entry => {
                    if (entry.bedTime && entry.wakeTime) {
                        const bedParts = entry.bedTime.split(':');
                        const wakeParts = entry.wakeTime.split(':');
                        let bedMinutes = parseInt(bedParts[0]) * 60 + parseInt(bedParts[1]);
                        let wakeMinutes = parseInt(wakeParts[0]) * 60 + parseInt(wakeParts[1]);

                        // Adjust for midnight crossing
                        if (bedMinutes > 720) bedMinutes -= 1440; // Treat late night as negative

                        totalBedMinutes += bedMinutes;
                        totalWakeMinutes += wakeMinutes;

                        // Calculate duration
                        let duration = wakeMinutes - bedMinutes;
                        if (duration < 0) duration += 1440;
                        totalDuration += duration;

                        validEntries++;
                    }
                    if (entry.sleepQuality) {
                        totalQuality += entry.sleepQuality;
                    }
                });

                if (validEntries > 0) {
                    summaryEl.style.display = 'grid';
                    noticeEl.style.display = 'none';

                    // Format average bedtime
                    let avgBedMinutes = Math.round(totalBedMinutes / validEntries);
                    if (avgBedMinutes < 0) avgBedMinutes += 1440;
                    const avgBedHour = Math.floor(avgBedMinutes / 60);
                    const avgBedMin = avgBedMinutes % 60;
                    document.getElementById('avg-bedtime').textContent =
                        `${avgBedHour > 12 ? avgBedHour - 12 : avgBedHour || 12}:${avgBedMin.toString().padStart(2, '0')} ${avgBedHour >= 12 ? 'PM' : 'AM'}`;

                    // Format average wake time
                    const avgWakeMinutes = Math.round(totalWakeMinutes / validEntries);
                    const avgWakeHour = Math.floor(avgWakeMinutes / 60);
                    const avgWakeMin = avgWakeMinutes % 60;
                    document.getElementById('avg-waketime').textContent =
                        `${avgWakeHour > 12 ? avgWakeHour - 12 : avgWakeHour || 12}:${avgWakeMin.toString().padStart(2, '0')} ${avgWakeHour >= 12 ? 'PM' : 'AM'}`;

                    // Format average duration
                    const avgDuration = Math.round(totalDuration / validEntries);
                    const durationHours = Math.floor(avgDuration / 60);
                    const durationMins = avgDuration % 60;
                    document.getElementById('avg-duration').textContent = `${durationHours}h ${durationMins}m`;

                    // Average quality
                    const avgQuality = (totalQuality / entries.length).toFixed(1);
                    document.getElementById('avg-quality').innerHTML = `${avgQuality}<span style="font-size: 14px; color: var(--text-light);">/10</span>`;
                } else {
                    summaryEl.style.display = 'none';
                    noticeEl.style.display = 'block';
                }
            }

            // Load main sleep complaint from client profile
            if (currentViewedClient && currentViewedClient.mainComplaint) {
                complaintEl.style.display = 'block';
                complaintText.textContent = currentViewedClient.mainComplaint;
            } else if (currentViewedClient && currentViewedClient.primaryGoal) {
                complaintEl.style.display = 'block';
                complaintText.textContent = currentViewedClient.primaryGoal;
            } else {
                complaintEl.style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading sleep habits:', error);
            summaryEl.style.display = 'none';
            noticeEl.style.display = 'block';
        }
    }

    // Toggle diary detail visibility
    function toggleDiaryDetail() {
        const container = document.getElementById('diary-detail-container');
        const chevron = document.getElementById('diary-detail-chevron');
        const isHidden = container.style.display === 'none';
        container.style.display = isHidden ? 'block' : 'none';
        chevron.style.transform = isHidden ? 'rotate(180deg)' : '';
    }

    // Load night-by-night diary entries for admin client view
    async function loadDiaryEntriesDetail(clientId) {
        const tableEl = document.getElementById('diary-detail-table');
        const noticeEl = document.getElementById('no-diary-detail-notice');

        try {
            const snapshot = await db.collection('diaryEntries')
                .where('userId', '==', clientId)
                .orderBy('date', 'desc')
                .limit(30)
                .get();

            if (snapshot.empty) {
                tableEl.innerHTML = '';
                noticeEl.style.display = 'block';
                return;
            }

            noticeEl.style.display = 'none';
            const entries = snapshot.docs.map(doc => doc.data());

            // Build table
            let html = `<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(201,169,98,0.3); text-align: left;">
                        <th style="padding: 10px 8px; color: var(--text-light); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Date</th>
                        <th style="padding: 10px 8px; color: var(--text-light); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Bedtime</th>
                        <th style="padding: 10px 8px; color: var(--text-light); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Wake</th>
                        <th style="padding: 10px 8px; color: var(--text-light); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">TST</th>
                        <th style="padding: 10px 8px; color: var(--text-light); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">SE%</th>
                        <th style="padding: 10px 8px; color: var(--text-light); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Quality</th>
                        <th style="padding: 10px 8px; color: var(--text-light); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Notes</th>
                    </tr>
                </thead>
                <tbody>`;

            entries.forEach(entry => {
                const date = entry.date || '--';
                const bedTime = entry.bedTime || '--';
                const wakeTime = entry.wakeTime || '--';

                // Calculate TST and SE
                let tst = '--', se = '--', seColor = 'var(--navy)';
                if (entry.bedTime && entry.wakeTime) {
                    const bedParts = entry.bedTime.split(':');
                    const wakeParts = entry.wakeTime.split(':');
                    let bedMin = parseInt(bedParts[0]) * 60 + parseInt(bedParts[1]);
                    let wakeMin = parseInt(wakeParts[0]) * 60 + parseInt(wakeParts[1]);
                    let timeInBed = wakeMin - bedMin;
                    if (timeInBed < 0) timeInBed += 1440;

                    const sol = entry.sleepOnsetLatency || 0;
                    const waso = entry.waso || 0;
                    const totalSleep = timeInBed - sol - waso;
                    const tstHours = Math.floor(Math.max(0, totalSleep) / 60);
                    const tstMins = Math.max(0, totalSleep) % 60;
                    tst = `${tstHours}h ${tstMins}m`;

                    const seVal = timeInBed > 0 ? Math.round((Math.max(0, totalSleep) / timeInBed) * 100) : 0;
                    se = seVal + '%';
                    seColor = seVal >= 85 ? '#2e7d32' : seVal >= 75 ? '#f9a825' : '#c62828';
                }

                const quality = entry.sleepQuality ? `${entry.sleepQuality}/10` : '--';
                const notes = entry.notes || entry.comments || '';
                const truncatedNotes = notes.length > 40 ? notes.substring(0, 40) + '...' : notes;

                html += `
                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                        <td style="padding: 10px 8px; color: var(--navy); font-weight: 500;">${date}</td>
                        <td style="padding: 10px 8px;">${bedTime}</td>
                        <td style="padding: 10px 8px;">${wakeTime}</td>
                        <td style="padding: 10px 8px;">${tst}</td>
                        <td style="padding: 10px 8px; font-weight: 600; color: ${seColor};">${se}</td>
                        <td style="padding: 10px 8px;">${quality}</td>
                        <td style="padding: 10px 8px; color: var(--text-light); font-size: 12px;" title="${notes}">${truncatedNotes}</td>
                    </tr>`;
            });

            html += '</tbody></table>';
            tableEl.innerHTML = html;
        } catch (error) {
            console.error('Error loading diary entries detail:', error);
            tableEl.innerHTML = '';
            noticeEl.style.display = 'block';
        }
    }

    // Load entry vs exit comparison for admin client view
    async function loadEntryExitComparison(clientId) {
        const card = document.getElementById('entry-exit-card');
        const container = document.getElementById('entry-exit-comparisons');

        try {
            const [questionnaires, diarySnapshot] = await Promise.all([
                (async () => {
                    const snap = await db.collection('questionnaireAssignments')
                        .where('userId', '==', clientId)
                        .where('status', '==', 'completed')
                        .get();
                    return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                })(),
                (async () => {
                    const snap = await db.collection('diaryEntries')
                        .where('userId', '==', clientId)
                        .get();
                    return snap.docs.map(doc => doc.data());
                })()
            ]);

            const comparisons = [];

            // Compare questionnaire scores (instruments with 2+ completions)
            const byInstrument = {};
            questionnaires.forEach(q => {
                if (!byInstrument[q.instrumentId]) byInstrument[q.instrumentId] = [];
                byInstrument[q.instrumentId].push(q);
            });

            for (const [instrumentId, results] of Object.entries(byInstrument)) {
                if (results.length < 2) continue;
                results.sort((a, b) => {
                    const aTime = a.completedAt?.toDate?.() || new Date(0);
                    const bTime = b.completedAt?.toDate?.() || new Date(0);
                    return aTime - bTime;
                });
                const first = results[0];
                const last = results[results.length - 1];
                const firstScore = first.result?.score ?? first.score;
                const lastScore = last.result?.score ?? last.score;

                if (firstScore != null && lastScore != null) {
                    const change = lastScore - firstScore;
                    comparisons.push({
                        label: first.instrumentName || instrumentId.toUpperCase(),
                        firstValue: firstScore,
                        lastValue: lastScore,
                        change,
                        improved: change < 0,
                        unit: 'pts'
                    });
                }
            }

            // Compare diary (first 3 vs last 3 nights)
            if (diarySnapshot.length >= 6) {
                const sorted = [...diarySnapshot].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                const firstThree = sorted.slice(0, 3);
                const lastThree = sorted.slice(-3);

                const avgSE = (entries) => {
                    let total = 0, count = 0;
                    entries.forEach(e => { if (e.sleepEfficiency != null) { total += e.sleepEfficiency; count++; } });
                    return count > 0 ? Math.round(total / count) : null;
                };

                const firstSE = avgSE(firstThree);
                const lastSE = avgSE(lastThree);
                if (firstSE != null && lastSE != null) {
                    comparisons.push({
                        label: 'Sleep Efficiency',
                        firstValue: firstSE + '%',
                        lastValue: lastSE + '%',
                        change: lastSE - firstSE,
                        improved: lastSE > firstSE,
                        unit: '%'
                    });
                }
            }

            if (comparisons.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            container.innerHTML = comparisons.map(c => {
                const arrow = c.improved ? '&#9650;' : (c.change === 0 ? '&#9654;' : '&#9660;');
                const color = c.improved ? '#2e7d32' : (c.change === 0 ? '#888' : '#c62828');

                return `
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, rgba(15,28,46,0.05) 0%, rgba(15,28,46,0.02) 100%); border-radius: 10px;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">${c.label}</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="font-size: 20px; font-weight: 600; color: var(--navy);">${c.firstValue}</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                            <span style="font-size: 20px; font-weight: 600; color: var(--navy);">${c.lastValue}</span>
                        </div>
                        <div style="font-size: 12px; font-weight: 600; color: ${color}; margin-top: 6px;">${arrow} ${c.change > 0 ? '+' : ''}${c.change} ${c.unit}</div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading entry/exit comparison:', error);
            card.style.display = 'none';
        }
    }

    async function loadClientAssessment(clientId) {
        const summaryContainer = document.getElementById('assessment-summary');
        const noAssessmentNotice = document.getElementById('no-assessment-notice');
        const findingsCard = document.getElementById('findings-card');
        const findingsList = document.getElementById('findings-list');

        // Find assessment for this client
        const assessment = allAssessments.find(a => a.userId === clientId);

        if (!assessment) {
            summaryContainer.innerHTML = '';
            noAssessmentNotice.style.display = 'block';
            findingsCard.style.display = 'none';
            return;
        }

        noAssessmentNotice.style.display = 'none';

        // Build score cards
        const scores = assessment.scores || {};
        const overallScore = assessment.overallScore || 0;

        const getScoreColor = (score, type) => {
            if (type === 'ess') {
                if (score <= 10) return '#2e7d32';
                if (score <= 15) return '#ed6c02';
                return '#d32f2f';
            }
            if (type === 'isi') {
                if (score <= 7) return '#2e7d32';
                if (score <= 14) return '#ed6c02';
                if (score <= 21) return '#ed6c02';
                return '#d32f2f';
            }
            if (type === 'stopbang') {
                if (score <= 2) return '#2e7d32';
                if (score <= 4) return '#ed6c02';
                return '#d32f2f';
            }
            if (type === 'overall') {
                if (score >= 70) return '#2e7d32';
                if (score >= 50) return '#ed6c02';
                return '#d32f2f';
            }
            return '#666';
        };

        const getScoreLabel = (score, type) => {
            if (type === 'ess') {
                if (score <= 10) return 'Normal';
                if (score <= 15) return 'Moderate';
                return 'Severe';
            }
            if (type === 'isi') {
                if (score <= 7) return 'Normal';
                if (score <= 14) return 'Subthreshold';
                if (score <= 21) return 'Moderate';
                return 'Severe';
            }
            if (type === 'stopbang') {
                if (score <= 2) return 'Low Risk';
                if (score <= 4) return 'Intermediate';
                return 'High Risk';
            }
            return '';
        };

        summaryContainer.innerHTML = `
            <div style="background: linear-gradient(135deg, ${getScoreColor(overallScore, 'overall')}22 0%, ${getScoreColor(overallScore, 'overall')}11 100%); border: 1px solid ${getScoreColor(overallScore, 'overall')}33; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: ${getScoreColor(overallScore, 'overall')};">${overallScore}</div>
                <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">Overall Score</div>
            </div>
            <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: ${getScoreColor(scores.ess || 0, 'ess')};">${scores.ess ?? 'N/A'}</div>
                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">ESS</div>
                <div style="font-size: 12px; color: ${getScoreColor(scores.ess || 0, 'ess')}; margin-top: 4px;">${getScoreLabel(scores.ess || 0, 'ess')}</div>
            </div>
            <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: ${getScoreColor(scores.isi || 0, 'isi')};">${scores.isi ?? 'N/A'}</div>
                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">ISI</div>
                <div style="font-size: 12px; color: ${getScoreColor(scores.isi || 0, 'isi')}; margin-top: 4px;">${getScoreLabel(scores.isi || 0, 'isi')}</div>
            </div>
            <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: ${getScoreColor(scores.stopbang || 0, 'stopbang')};">${scores.stopbang ?? 'N/A'}</div>
                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px;">STOP-BANG</div>
                <div style="font-size: 12px; color: ${getScoreColor(scores.stopbang || 0, 'stopbang')}; margin-top: 4px;">${getScoreLabel(scores.stopbang || 0, 'stopbang')}</div>
            </div>
        `;

        // Show findings
        const findings = assessment.findings || [];
        if (findings.length > 0) {
            findingsCard.style.display = 'block';
            findingsList.innerHTML = findings.map(f => `<li style="margin-bottom: 8px;">${f}</li>`).join('');
        } else {
            findingsCard.style.display = 'none';
        }
    }

    async function loadClientActions(clientId) {
        const container = document.getElementById('actions-list');

        try {
            const snapshot = await db.collection('clientActions')
                .where('clientId', '==', clientId)
                .get();

            if (snapshot.empty) {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No actions yet. Add next steps for this client.</p>';
                return;
            }

            const actions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Sort: active first, then by priority, then completed last
            actions.sort((a, b) => {
                const statusOrder = { active: 0, pending: 1, completed: 2 };
                const priorityOrder = { high: 0, normal: 1, low: 2 };
                const statusDiff = (statusOrder[a.status] || 1) - (statusOrder[b.status] || 1);
                if (statusDiff !== 0) return statusDiff;
                return (priorityOrder[a.priority] || 1) - (priorityOrder[b.priority] || 1);
            });

            container.innerHTML = actions.map(action => {
                const priorityColors = { high: '#d32f2f', normal: '#0f1c2e', low: '#666' };
                const priorityColor = priorityColors[action.priority] || '#0f1c2e';
                const isCompleted = action.status === 'completed';
                const dueDate = action.dueDate?.toDate ? action.dueDate.toDate().toLocaleDateString() : (action.dueDate ? new Date(action.dueDate).toLocaleDateString() : '');
                const statusBadge = action.status === 'active' ? '<span style="background: #2e7d3222; color: #2e7d32; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-right: 6px;">ACTIVE</span>' :
                                   action.status === 'pending' ? '<span style="background: #f9a82522; color: #f9a825; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-right: 6px;">PENDING</span>' : '';

                return `
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid #eee; ${isCompleted ? 'opacity: 0.6;' : ''}">
                        <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleAction('${action.id}', this.checked)"
                            style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer; accent-color: var(--gold);">
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: ${priorityColor}; ${isCompleted ? 'text-decoration: line-through;' : ''}">${action.text}</div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 6px;">
                                ${statusBadge}
                                ${action.priority === 'high' ? '<span style="background: #d32f2f22; color: #d32f2f; font-size: 10px; padding: 2px 8px; border-radius: 10px;">HIGH PRIORITY</span>' : ''}
                                ${dueDate ? `<span style="font-size: 11px; color: var(--text-light);">Due: ${dueDate}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="deleteAction('${action.id}')" style="background: none; border: none; color: #999; cursor: pointer; font-size: 18px;" title="Delete">&times;</button>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading actions:', error);
            container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">Error loading actions</p>';
        }
    }

    async function loadClientMessages(clientId) {
        const container = document.getElementById('recent-messages');

        try {
            // Find conversation with this client
            const snapshot = await db.collection('conversations')
                .where('participants', 'array-contains', currentUser.uid)
                .get();

            const conversation = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .find(conv => conv.participants.includes(clientId));

            if (!conversation) {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No messages yet</p>';
                return;
            }

            // Get recent messages
            const messagesSnapshot = await db.collection('conversations').doc(conversation.id)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(3)
                .get();

            if (messagesSnapshot.empty) {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">No messages yet</p>';
                return;
            }

            const messages = messagesSnapshot.docs.map(doc => doc.data()).reverse();

            container.innerHTML = messages.map(msg => {
                const isAdmin = msg.senderId === currentUser.uid;
                const time = msg.timestamp?.toDate?.();
                const timeStr = time ? formatTimeAgo(time) : '';

                return `
                    <div style="display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="width: 32px; height: 32px; background: ${isAdmin ? 'var(--gold)' : 'var(--navy)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; flex-shrink: 0;">
                            ${isAdmin ? 'You' : currentViewedClient?.displayName?.charAt(0) || '?'}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: var(--navy);">${msg.text}</div>
                            <div style="font-size: 11px; color: var(--text-light); margin-top: 4px;">${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading messages:', error);
            container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">Error loading messages</p>';
        }
    }

    function formatTimeAgo(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);

        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
        if (diff < 86400) return Math.floor(diff / 3600) + ' hr ago';
        if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
        return date.toLocaleDateString();
    }

    async function loadClientModules(clientId) {
        const container = document.getElementById('client-modules');

        const moduleNames = {
            'sleep-hygiene': 'Sleep Hygiene',
            'breathing-478': '4-7-8 Breathing',
            'pmr': 'Progressive Muscle Relaxation',
            'cbti-restriction': 'CBT-I: Sleep Restriction',
            'cbti-stimulus': 'CBT-I: Stimulus Control',
            'cbti-cognitive': 'CBT-I: Cognitive Restructuring',
            'sleep-diary': 'Interactive Sleep Diary',
            'mindfulness-bodyscan': 'Mindfulness & Body Scan',
            'paradoxical-intention': 'Paradoxical Intention',
            'worry-management': 'Worry Management',
            'circadian-rhythm': 'Circadian Rhythm',
            'guided-imagery': 'Guided Imagery',
            'autogenic-training': 'Autogenic Training'
        };

        const allModuleIds = Object.keys(moduleNames);

        try {
            const snapshot = await db.collection('unlocks')
                .where('userId', '==', clientId)
                .get();

            const unlocks = snapshot.docs.map(doc => doc.data());
            const assignedModules = unlocks.flatMap(u => u.modules || []);
            const uniqueAssigned = [...new Set(assignedModules)];

            // Show all modules with assigned/unassigned status
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                    ${allModuleIds.map(m => {
                        const isAssigned = uniqueAssigned.includes(m) || m === 'sleep-hygiene';
                        const isFree = m === 'sleep-hygiene';
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; background: ${isAssigned ? '#f0f9f0' : '#fafafa'}; border: 1px solid ${isAssigned ? 'rgba(46, 125, 50, 0.2)' : 'rgba(0,0,0,0.06)'};">
                                ${isAssigned ?
                                    `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>` :
                                    `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`
                                }
                                <span style="font-size: 12px; color: ${isAssigned ? '#2e7d32' : 'var(--text-light)'}; font-weight: ${isAssigned ? '500' : '400'};">
                                    ${moduleNames[m]}${isFree ? ' <span style="font-size: 10px; opacity: 0.7;">(Free)</span>' : ''}
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
                <p style="font-size: 12px; color: var(--text-light); margin-top: 15px; text-align: center;">
                    ${uniqueAssigned.length} of ${allModuleIds.length} modules assigned
                </p>
            `;
        } catch (error) {
            console.error('Error loading modules:', error);
            container.innerHTML = '<p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 20px;">Error loading modules</p>';
        }
    }

    // Action management
    function showAddActionModal() {
        document.getElementById('action-text').value = '';
        document.getElementById('action-priority').value = 'normal';
        document.getElementById('action-due').value = '';
        document.getElementById('action-modal').style.display = 'flex';
    }

    async function addClientAction() {
        if (!currentViewedClient) return;

        const text = document.getElementById('action-text').value.trim();
        const priority = document.getElementById('action-priority').value;
        const dueDate = document.getElementById('action-due').value;

        if (!text) {
            alert('Please enter an action description.');
            return;
        }

        try {
            await db.collection('clientActions').add({
                clientId: currentViewedClient.id,
                text,
                priority,
                dueDate: dueDate ? new Date(dueDate) : null,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            });

            closeModal('action-modal');
            loadClientActions(currentViewedClient.id);
        } catch (error) {
            console.error('Error adding action:', error);
            alert('Error adding action. Please try again.');
        }
    }

    async function toggleAction(actionId, completed) {
        try {
            await db.collection('clientActions').doc(actionId).update({
                status: completed ? 'completed' : 'active',
                completedAt: completed ? firebase.firestore.FieldValue.serverTimestamp() : null
            });
            if (currentViewedClient) loadClientActions(currentViewedClient.id);
        } catch (error) {
            console.error('Error toggling action:', error);
        }
    }

    async function deleteAction(actionId) {
        if (!confirm('Delete this action?')) return;

        try {
            await db.collection('clientActions').doc(actionId).delete();
            if (currentViewedClient) loadClientActions(currentViewedClient.id);
        } catch (error) {
            console.error('Error deleting action:', error);
        }
    }

    // Open chat with current client
    function openClientChat() {
        if (!currentViewedClient) return;

        // Switch to messages section and open chat with this client
        showSection('messages');
        setTimeout(() => {
            openConversation(currentViewedClient.id, currentViewedClient.displayName, currentViewedClient.displayName?.charAt(0) || '?');
        }, 100);
    }

    // Archive client functions
    function showArchiveClientModal() {
        if (!currentViewedClient) return;

        document.getElementById('archive-client-name').textContent = currentViewedClient.displayName || 'this client';
        document.getElementById('archive-reason').value = '';
        document.getElementById('archive-notes').value = '';
        document.getElementById('archive-modal').style.display = 'flex';
    }

    async function archiveClient() {
        if (!currentViewedClient) return;

        const reason = document.getElementById('archive-reason').value;
        const notes = document.getElementById('archive-notes').value.trim();

        try {
            // Update client with archived status
            await db.collection('users').doc(currentViewedClient.id).update({
                status: 'archived',
                archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
                archivedBy: currentUser.uid,
                archiveReason: reason || null,
                archiveNotes: notes || null
            });

            closeModal('archive-modal');
            showToast(`${currentViewedClient.displayName} has been archived. Their data is preserved and can be restored.`, 'success', 'Client Archived');

            // Go back to clients list and refresh
            showSection('clients');
            loadClients();
        } catch (error) {
            console.error('Error archiving client:', error);
            alert('Error archiving client. Please try again.');
        }
    }

    async function restoreClient(clientId) {
        if (!confirm('Restore this client to active status?')) return;

        try {
            await db.collection('users').doc(clientId).update({
                status: 'active',
                restoredAt: firebase.firestore.FieldValue.serverTimestamp(),
                restoredBy: currentUser.uid
            });

            showToast('Client restored successfully!', 'success');
            loadClients();
        } catch (error) {
            console.error('Error restoring client:', error);
            alert('Error restoring client. Please try again.');
        }
    }

    // ============ APPOINTMENT SCHEDULING ============

    let selectedTimeSlot = null;
    let selectedClientForSchedule = null;

    // Default availability (can be saved to Firestore later)
    const defaultAvailability = {
        mon: { start: '09:00', end: '17:00', closed: false },
        tue: { start: '09:00', end: '17:00', closed: false },
        wed: { start: '09:00', end: '17:00', closed: false },
        thu: { start: '09:00', end: '17:00', closed: false },
        fri: { start: '09:00', end: '15:00', closed: false },
        sat: { start: '09:00', end: '17:00', closed: true },
        sun: { start: '09:00', end: '17:00', closed: true },
        zoomLink: 'https://harvard.zoom.us/my/alen1',
        defaultDuration: 30
    };

    function showScheduleAppointmentModal() {
        // Reset modal state
        selectedTimeSlot = null;
        selectedClientForSchedule = null;
        document.getElementById('schedule-step-1').style.display = 'block';
        document.getElementById('schedule-step-2').style.display = 'none';
        document.getElementById('time-slots-container').style.display = 'none';
        document.getElementById('client-email-warning').style.display = 'none';
        document.getElementById('schedule-confirm-btn').disabled = true;
        document.getElementById('schedule-confirm-btn').style.opacity = '0.5';

        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('schedule-date').value = '';
        document.getElementById('schedule-date').min = today;

        // Populate clients dropdown
        const select = document.getElementById('schedule-client');
        const activeClients = allClients.filter(c => c.status !== 'archived' && c.role !== 'admin');
        select.innerHTML = '<option value="">Choose a client...</option>' +
            activeClients.map(c => `<option value="${c.id}" data-email="${c.email || ''}">${c.displayName || c.email}</option>`).join('');

        document.getElementById('schedule-appointment-modal').style.display = 'flex';
    }

    function onScheduleClientChange() {
        const select = document.getElementById('schedule-client');
        const selectedOption = select.options[select.selectedIndex];
        const clientId = select.value;

        if (clientId) {
            selectedClientForSchedule = allClients.find(c => c.id === clientId);
            const hasEmail = selectedOption.dataset.email && selectedOption.dataset.email.length > 0;
            document.getElementById('client-email-warning').style.display = hasEmail ? 'none' : 'block';
        } else {
            selectedClientForSchedule = null;
            document.getElementById('client-email-warning').style.display = 'none';
        }

        updateScheduleButton();
    }

    function generateTimeSlots() {
        const dateInput = document.getElementById('schedule-date').value;
        if (!dateInput) {
            document.getElementById('time-slots-container').style.display = 'none';
            return;
        }

        const date = new Date(dateInput + 'T00:00:00');
        const dayOfWeek = date.getDay(); // 0 = Sunday
        const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        const dayKey = days[dayOfWeek];
        const avail = defaultAvailability[dayKey];

        const container = document.getElementById('time-slots-container');
        const grid = document.getElementById('time-slots-grid');

        if (avail.closed) {
            grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--danger); text-align: center; padding: 20px;">You are not available on this day. Please select another date.</p>`;
            container.style.display = 'block';
            return;
        }

        // Generate time slots
        const slots = [];
        const [startH, startM] = avail.start.split(':').map(Number);
        const [endH, endM] = avail.end.split(':').map(Number);
        const startMinutes = startH * 60 + startM;
        const endMinutes = endH * 60 + endM;

        // Get appointment duration based on type
        const typeSelect = document.getElementById('schedule-type');
        let duration = 30; // default
        switch (typeSelect.value) {
            case 'initial': duration = 60; break;
            case 'followup': duration = 30; break;
            case 'review': duration = 45; break;
            case 'extended': duration = 90; break;
        }

        for (let mins = startMinutes; mins + duration <= endMinutes; mins += 30) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            const displayTime = formatTimeDisplay(h, m);
            slots.push({ time: timeStr, display: displayTime });
        }

        if (slots.length === 0) {
            grid.innerHTML = `<p style="grid-column: 1/-1; color: var(--text-light); text-align: center; padding: 20px;">No available slots for this appointment type on this day.</p>`;
        } else {
            grid.innerHTML = slots.map(slot => `
                <button onclick="selectTimeSlot('${slot.time}', this)" class="time-slot-btn" style="
                    padding: 12px 8px;
                    border: 1px solid rgba(201, 169, 98, 0.3);
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 500;
                    color: var(--navy);
                    transition: all 0.2s;
                ">${slot.display}</button>
            `).join('');
        }

        container.style.display = 'block';
        selectedTimeSlot = null;
        updateScheduleButton();
    }

    function formatTimeDisplay(h, m) {
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return `${h12}:${m.toString().padStart(2, '0')} ${ampm}`;
    }

    function selectTimeSlot(time, btn) {
        // Remove selection from all buttons
        document.querySelectorAll('.time-slot-btn').forEach(b => {
            b.style.background = 'white';
            b.style.color = 'var(--navy)';
            b.style.borderColor = 'rgba(201, 169, 98, 0.3)';
        });

        // Select this button
        btn.style.background = 'var(--gold)';
        btn.style.color = 'var(--deep-navy)';
        btn.style.borderColor = 'var(--gold)';

        selectedTimeSlot = time;
        updateScheduleButton();
    }

    function updateScheduleButton() {
        const btn = document.getElementById('schedule-confirm-btn');
        const clientSelected = document.getElementById('schedule-client').value;
        const dateSelected = document.getElementById('schedule-date').value;
        const timeSelected = selectedTimeSlot;

        if (clientSelected && dateSelected && timeSelected) {
            btn.disabled = false;
            btn.style.opacity = '1';
        } else {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        }
    }

    async function confirmScheduleAppointment() {
        const clientId = document.getElementById('schedule-client').value;
        const client = allClients.find(c => c.id === clientId);
        const date = document.getElementById('schedule-date').value;
        const time = selectedTimeSlot;
        const type = document.getElementById('schedule-type').value;
        const location = document.getElementById('schedule-location').value;
        const notes = document.getElementById('schedule-notes').value.trim();

        if (!clientId || !date || !time) {
            showToast('Please fill in all required fields.', 'warning');
            return;
        }

        // Get duration based on type
        let duration = 30;
        let typeName = 'Follow-up Session';
        switch (type) {
            case 'initial': duration = 60; typeName = 'Initial Consultation'; break;
            case 'followup': duration = 30; typeName = 'Follow-up Session'; break;
            case 'review': duration = 45; typeName = 'Progress Review'; break;
            case 'extended': duration = 90; typeName = 'Extended Session'; break;
        }

        // Create datetime
        const [h, m] = time.split(':').map(Number);
        const dateTime = new Date(date + 'T' + time + ':00');
        const endTime = new Date(dateTime.getTime() + duration * 60000);

        // Location details
        let locationText = 'Zoom Video Call';
        let meetingLink = defaultAvailability.zoomLink;
        if (location === 'phone') {
            locationText = 'Phone Call';
            meetingLink = '';
        } else if (location === 'inperson') {
            locationText = 'In-Person Meeting';
            meetingLink = '';
        }

        try {
            // Save appointment to Firestore
            const appointmentRef = await db.collection('appointments').add({
                clientId: clientId,
                userId: clientId,
                clientName: client.displayName || client.email,
                clientEmail: client.email || '',
                dateTime: firebase.firestore.Timestamp.fromDate(dateTime),
                endTime: firebase.firestore.Timestamp.fromDate(endTime),
                duration: duration,
                type: type,
                typeName: typeName,
                location: location,
                locationText: locationText,
                meetingLink: meetingLink,
                notes: notes,
                status: 'confirmed',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            });

            // Send confirmation email if client has email
            let emailSent = false;
            if (client.email) {
                try {
                    await sendAppointmentConfirmationEmail(client, dateTime, duration, typeName, locationText, meetingLink);
                    emailSent = true;
                } catch (emailError) {
                    console.error('Error sending email:', emailError);
                }
            }

            // Show confirmation step
            document.getElementById('schedule-step-1').style.display = 'none';
            document.getElementById('schedule-step-2').style.display = 'block';

            // Format date for display
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateTime.toLocaleDateString('en-US', options);
            const formattedTime = formatTimeDisplay(dateTime.getHours(), dateTime.getMinutes());
            const formattedEndTime = formatTimeDisplay(endTime.getHours(), endTime.getMinutes());

            document.getElementById('schedule-confirmation-text').textContent = emailSent ?
                'The appointment has been created and a confirmation email has been sent to ' + client.email :
                'The appointment has been created. (No email sent - client has no email on file)';

            document.getElementById('schedule-summary').innerHTML = `
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Client:</span>
                        <span style="font-weight: 500; color: #0f1c2e;">${client.displayName || client.email}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Date:</span>
                        <span style="font-weight: 500; color: #0f1c2e;">${formattedDate}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Time:</span>
                        <span style="font-weight: 500; color: #0f1c2e;">${formattedTime} - ${formattedEndTime}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Type:</span>
                        <span style="font-weight: 500; color: #0f1c2e;">${typeName} (${duration} min)</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Location:</span>
                        <span style="font-weight: 500; color: #0f1c2e;">${locationText}</span>
                    </div>
                    ${meetingLink ? `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #666;">Meeting Link:</span>
                        <a href="${meetingLink}" target="_blank" style="color: var(--gold); font-weight: 500;">${meetingLink}</a>
                    </div>
                    ` : ''}
                </div>
            `;

        } catch (error) {
            console.error('Error scheduling appointment:', error);
            showToast('Error scheduling appointment. Please try again.', 'error');
        }
    }

    async function sendAppointmentConfirmationEmail(client, dateTime, duration, typeName, locationText, meetingLink) {
        // Format date and time
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = dateTime.toLocaleDateString('en-US', options);
        const formattedTime = formatTimeDisplay(dateTime.getHours(), dateTime.getMinutes());

        const endTime = new Date(dateTime.getTime() + duration * 60000);
        const formattedEndTime = formatTimeDisplay(endTime.getHours(), endTime.getMinutes());

        // EmailJS template parameters
        const templateParams = {
            to_email: client.email,
            to_name: client.displayName || 'Client',
            appointment_type: typeName,
            appointment_date: formattedDate,
            appointment_time: `${formattedTime} - ${formattedEndTime}`,
            appointment_duration: `${duration} minutes`,
            appointment_location: locationText,
            meeting_link: meetingLink || 'N/A',
            consultant_name: 'Dr. Alen Juginovic',
            from_name: 'Sleep Wellness Consulting'
        };

        // Send via EmailJS
        await emailjs.send('service_sleepwellness', 'template_appointment', templateParams);
    }

    function closeScheduleModal() {
        closeModal('schedule-appointment-modal');
        loadAppointments();
        loadDashboard();
    }

    function showSetAvailabilityModal() {
        document.getElementById('set-availability-modal').style.display = 'flex';
    }

    function toggleAvailabilityInputs(day) {
        const closed = document.getElementById(`avail-${day}-closed`).checked;
        document.getElementById(`avail-${day}-start`).disabled = closed;
        document.getElementById(`avail-${day}-end`).disabled = closed;
    }

    function saveAvailability() {
        // In a full implementation, this would save to Firestore
        // For now, we'll just close the modal
        alert('Availability settings saved!');
        closeModal('set-availability-modal');
    }

    // ============ END APPOINTMENT SCHEDULING ============

    // ============ TASK ASSIGNMENT ============

    // Default deadlines for task types (in days) - scientifically validated
    const taskDefaults = {
        'diary': { title: 'Complete Sleep Diary', deadline: 1, description: 'Please log your sleep from last night in your sleep diary.' },
        'diary-week': { title: 'Complete Sleep Diary for 1 Week', deadline: 7, description: 'Please complete your sleep diary entries for the entire week.' },
        'actigraphy': { title: 'Review Actigraphy Data', deadline: 3, description: 'Please review and sync your actigraphy/wearable data.' },
        'questionnaire-isi': { title: 'Complete ISI Questionnaire', deadline: 3, description: 'Please complete the Insomnia Severity Index questionnaire.' },
        'questionnaire-ess': { title: 'Complete ESS Questionnaire', deadline: 3, description: 'Please complete the Epworth Sleepiness Scale questionnaire.' },
        'questionnaire-psqi': { title: 'Complete PSQI Questionnaire', deadline: 3, description: 'Please complete the Pittsburgh Sleep Quality Index questionnaire.' },
        'questionnaire-all': { title: 'Complete All Baseline Questionnaires', deadline: 5, description: 'Please complete all baseline questionnaires (ISI, ESS, PSQI).' },
        'module': { title: 'Complete Assigned Module', deadline: 7, description: 'Please complete the therapeutic module that has been assigned to you.' },
        'reading': { title: 'Read Educational Material', deadline: 5, description: 'Please read the educational materials provided.' },
        'practice': { title: 'Practice Relaxation Technique', deadline: 3, description: 'Please practice the relaxation technique we discussed.' },
        'sleep-schedule': { title: 'Follow Sleep Schedule', deadline: 7, description: 'Please follow the prescribed sleep schedule for the next week.' },
        'stimulus-control': { title: 'Practice Stimulus Control', deadline: 7, description: 'Please implement stimulus control instructions: use bed only for sleep, leave bed if awake >20 min.' },
        'sleep-hygiene': { title: 'Implement Sleep Hygiene Changes', deadline: 7, description: 'Please implement the sleep hygiene recommendations we discussed.' },
        'worry-time': { title: 'Schedule Worry Time', deadline: 3, description: 'Set aside 15-20 minutes each day for "worry time" - not close to bedtime.' },
        'schedule-appointment': { title: 'Schedule Follow-up Appointment', deadline: 5, description: 'Please schedule your next follow-up appointment.' },
        'check-in': { title: 'Send Progress Update', deadline: 3, description: 'Please send a brief update on your progress and any concerns.' },
        'questions': { title: 'Review and Ask Questions', deadline: 5, description: 'Review your materials and send any questions you have.' },
        'custom': { title: '', deadline: 7, description: '' }
    };

    function showAssignTaskModal() {
        if (!currentViewedClient) {
            alert('No client selected');
            return;
        }

        // Reset form
        document.getElementById('task-type').value = '';
        document.getElementById('custom-task-title').value = '';
        document.getElementById('task-instructions').value = '';
        document.getElementById('task-priority').value = 'normal';
        document.getElementById('task-due-date').value = '';
        document.getElementById('task-send-notification').checked = true;
        document.getElementById('custom-task-field').style.display = 'none';

        // Set client name
        document.getElementById('assign-task-client-name').textContent = currentViewedClient.displayName || 'this client';

        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('task-due-date').min = today;

        document.getElementById('assign-task-modal').style.display = 'flex';
    }

    function onTaskTypeChange() {
        const taskType = document.getElementById('task-type').value;
        const customField = document.getElementById('custom-task-field');
        const dueDateInput = document.getElementById('task-due-date');

        if (taskType === 'custom') {
            customField.style.display = 'block';
            dueDateInput.value = '';
        } else {
            customField.style.display = 'none';
            // Set default deadline
            if (taskType && taskDefaults[taskType]) {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + taskDefaults[taskType].deadline);
                dueDateInput.value = dueDate.toISOString().split('T')[0];
            }
        }
    }

    async function assignTaskToClient() {
        if (!currentViewedClient) return;

        const taskType = document.getElementById('task-type').value;
        const customTitle = document.getElementById('custom-task-title').value.trim();
        const instructions = document.getElementById('task-instructions').value.trim();
        const priority = document.getElementById('task-priority').value;
        const dueDate = document.getElementById('task-due-date').value;
        const sendNotification = document.getElementById('task-send-notification').checked;

        if (!taskType) {
            alert('Please select a task type.');
            return;
        }

        if (taskType === 'custom' && !customTitle) {
            alert('Please enter a custom task title.');
            return;
        }

        // Get task details
        const taskInfo = taskDefaults[taskType];
        const taskTitle = taskType === 'custom' ? customTitle : taskInfo.title;
        const taskDescription = instructions || taskInfo.description;

        // Calculate due date
        let dueDateObj = null;
        if (dueDate) {
            dueDateObj = new Date(dueDate + 'T23:59:59');
        } else if (taskInfo.deadline) {
            dueDateObj = new Date();
            dueDateObj.setDate(dueDateObj.getDate() + taskInfo.deadline);
            dueDateObj.setHours(23, 59, 59);
        }

        try {
            // Create task in Firestore
            const taskRef = await db.collection('clientTasks').add({
                clientId: currentViewedClient.id,
                clientName: currentViewedClient.displayName || currentViewedClient.email,
                clientEmail: currentViewedClient.email || '',
                taskType: taskType,
                title: taskTitle,
                description: taskDescription,
                instructions: instructions,
                priority: priority,
                dueDate: dueDateObj ? firebase.firestore.Timestamp.fromDate(dueDateObj) : null,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid,
                reminderSent: false,
                adminNotified: false
            });

            // Create notification for client
            if (sendNotification) {
                const dueDateFormatted = dueDateObj ? dueDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) : 'as soon as possible';

                await db.collection('notifications').add({
                    userId: currentViewedClient.id,
                    type: 'task_assigned',
                    title: 'New Task Assigned',
                    message: `Dr. Juginovic has assigned you a new task: "${taskTitle}". Please complete by ${dueDateFormatted}.`,
                    taskId: taskRef.id,
                    taskTitle: taskTitle,
                    dueDate: dueDateObj ? firebase.firestore.Timestamp.fromDate(dueDateObj) : null,
                    priority: priority,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            closeModal('assign-task-modal');

            // Show success message
            const dueDateText = dueDateObj ? dueDateObj.toLocaleDateString() : 'No deadline';
            alert(`Task assigned successfully!\n\nTask: ${taskTitle}\nDue: ${dueDateText}\n${sendNotification ? 'Client has been notified.' : 'No notification sent.'}`);

            // Reload client actions to show new task
            loadClientActions(currentViewedClient.id);

        } catch (error) {
            console.error('Error assigning task:', error);
            alert('Error assigning task. Please try again.');
        }
    }

    // ============ END TASK ASSIGNMENT ============

    // Unlock module for current client
    async function showUnlockModuleForClient() {
        if (!currentViewedClient) return;

        // Pre-select the current client in the unlock modal
        const select = document.getElementById('unlock-client');
        const clients = await FirebaseDB.getAllUsers();

        select.innerHTML = '<option value="">Select a client</option>' +
            clients.map(c => `<option value="${c.id}" ${c.id === currentViewedClient.id ? 'selected' : ''}>${c.displayName || c.email}</option>`).join('');

        document.querySelectorAll('input[name="unlock-modules"]').forEach(cb => cb.checked = false);
        document.getElementById('unlock-notes').value = '';

        document.getElementById('unlock-modal').style.display = 'flex';
    }

    // Modal functions
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
        modal.classList.remove('active');
    }

    // Logout
    async function handleLogout() {
        await auth.signOut();
        window.location.href = '../auth.html';
    }

    // Close modals on outside click
    ['invite-modal', 'action-modal'].forEach(modalId => {
        document.getElementById(modalId).addEventListener('click', (e) => {
            if (e.target.id === modalId) {
                e.target.style.display = 'none';
            }
        });
    });

    // Close other modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
                overlay.classList.remove('active');
            }
        });
    });

    // ============================================
    // ADMIN AI ASSISTANT
    // ============================================

    // Generate AI summary for current client
    async function generateClientAISummary() {
        const btn = document.getElementById('ai-summary-btn');
        const content = document.getElementById('ai-summary-content');

        if (!currentViewedClient) {
            alert('No client selected');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/></svg> Generating...';

        content.innerHTML = '<div style="text-align: center; padding: 30px;"><div style="display: inline-block; width: 30px; height: 30px; border: 3px solid rgba(201, 169, 98, 0.3); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 15px; color: var(--text-light);">Analyzing client data...</p></div>';

        try {
            // Gather all client data
            const clientData = await gatherClientData(currentViewedClient.id);

            // Generate summary (using demo mode or API)
            const summary = await getAIClientSummary(clientData);

            content.innerHTML = summary;
        } catch (error) {
            console.error('Error generating AI summary:', error);
            content.innerHTML = '<p style="color: #c62828; text-align: center; padding: 20px;">Error generating summary. Please try again.</p>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg> Regenerate';
        }
    }

    // Gather all data about a client
    async function gatherClientData(clientId) {
        const client = allClients.find(c => c.id === clientId) || currentViewedClient;
        const assessment = allAssessments.find(a => a.userId === clientId);

        // Get additional data
        let messages = [];
        let unlocks = [];
        let appointments = [];

        try {
            const msgSnapshot = await db.collection('messages')
                .where('participants', 'array-contains', clientId)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get();
            messages = msgSnapshot.docs.map(d => d.data());
        } catch (e) { }

        try {
            const unlockSnapshot = await db.collection('unlocks')
                .where('userId', '==', clientId)
                .get();
            unlocks = unlockSnapshot.docs.map(d => d.data());
        } catch (e) { }

        return {
            profile: {
                name: client.displayName || 'Unknown',
                email: client.email,
                type: client.clientType || 'general',
                joined: client.createdAt?.toDate?.()?.toLocaleDateString() || 'Unknown'
            },
            assessment: assessment ? {
                completed: assessment.createdAt?.toDate?.()?.toLocaleDateString(),
                overallScore: assessment.overallScore,
                scores: assessment.scores,
                findings: assessment.findings,
                recommendations: assessment.recommendations,
                demographics: assessment.demographics
            } : null,
            modules: unlocks.flatMap(u => u.modules || []),
            messageCount: messages.length,
            recentActivity: messages.length > 0 ? 'Active communication' : 'No recent messages'
        };
    }

    // Get AI summary (demo mode or API)
    async function getAIClientSummary(clientData) {
        const ADMIN_AI_ENDPOINT = window.ADMIN_AI_ENDPOINT || null;

        if (ADMIN_AI_ENDPOINT) {
            // Production: Use backend proxy
            const response = await fetch(ADMIN_AI_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'client_summary',
                    data: clientData
                })
            });
            if (!response.ok) throw new Error('API request failed');
            const result = await response.json();
            return result.summary;
        }

        // Demo mode: Generate intelligent summary locally
        return generateDemoClientSummary(clientData);
    }

    // Generate demo client summary
    function generateDemoClientSummary(data) {
        const { profile, assessment, modules, messageCount } = data;

        let html = '<div style="space-y: 15px;">';

        // Profile Overview
        html += `<div style="margin-bottom: 20px;">
            <h4 style="font-size: 14px; color: var(--gold); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Client Profile</h4>
            <p style="margin: 0;"><strong>${profile.name}</strong> is a <strong>${profile.type}</strong> client who joined on ${profile.joined}. `;

        if (assessment) {
            html += `They have completed their initial assessment.</p></div>`;

            // Assessment Analysis
            html += `<div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; color: var(--gold); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Sleep Health Analysis</h4>
                <p style="margin: 0;">`;

            const overallScore = assessment.overallScore || 0;
            if (overallScore >= 70) {
                html += `Overall sleep health appears <strong style="color: #2e7d32;">good</strong> with a score of ${overallScore}/100. `;
            } else if (overallScore >= 50) {
                html += `Overall sleep health is <strong style="color: #ed6c02;">moderate</strong> with a score of ${overallScore}/100, indicating room for improvement. `;
            } else {
                html += `Overall sleep health shows <strong style="color: #c62828;">significant concerns</strong> with a score of ${overallScore}/100, requiring focused intervention. `;
            }

            // Analyze specific scores
            const scores = assessment.scores || {};
            const concerns = [];

            if (scores.isi > 14) concerns.push('clinical insomnia symptoms');
            if (scores.ess > 10) concerns.push('excessive daytime sleepiness');
            if (scores.stopbang >= 3) concerns.push('potential sleep apnea risk');

            if (concerns.length > 0) {
                html += `Key concerns include: <strong>${concerns.join(', ')}</strong>.</p></div>`;
            } else {
                html += `No major clinical concerns were identified.</p></div>`;
            }

            // Key Findings
            if (assessment.findings && assessment.findings.length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; color: var(--gold); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Key Findings</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${assessment.findings.slice(0, 5).map(f => `<li style="margin-bottom: 5px;">${f}</li>`).join('')}
                    </ul>
                </div>`;
            }

            // Recommendations
            html += `<div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; color: var(--gold); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Recommended Focus Areas</h4>
                <ul style="margin: 0; padding-left: 20px;">`;

            if (scores.isi > 14) {
                html += `<li style="margin-bottom: 5px;">Consider CBT-I components (Sleep Restriction, Stimulus Control)</li>`;
            }
            if (scores.ess > 10) {
                html += `<li style="margin-bottom: 5px;">Evaluate for underlying sleep disorders; consider sleep study</li>`;
            }
            if (scores.stopbang >= 3) {
                html += `<li style="margin-bottom: 5px;">Recommend polysomnography to rule out OSA</li>`;
            }
            if (!scores.isi || scores.isi <= 7) {
                html += `<li style="margin-bottom: 5px;">Maintain good sleep hygiene practices</li>`;
            }
            html += `<li style="margin-bottom: 5px;">Follow up in 2-4 weeks to assess progress</li>`;
            html += `</ul></div>`;

        } else {
            html += `They have not yet completed their initial assessment.</p></div>`;
            html += `<div style="background: rgba(201, 169, 98, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0;"><strong>Recommended Action:</strong> Send a reminder to complete the sleep assessment to establish baseline metrics and identify any concerns.</p>
            </div>`;
        }

        // Engagement Status
        html += `<div style="margin-bottom: 10px;">
            <h4 style="font-size: 14px; color: var(--gold); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Engagement</h4>
            <p style="margin: 0;">`;

        if (modules.length > 0) {
            html += `<strong>${modules.length}</strong> therapeutic module(s) assigned. `;
        } else {
            html += `No therapeutic modules assigned yet. `;
        }
        html += `${messageCount > 0 ? `${messageCount} recent messages exchanged.` : 'No recent message activity.'}</p></div>`;

        html += '</div>';
        return html;
    }

    // Add CSS for spin animation
    const aiStyles = document.createElement('style');
    aiStyles.textContent = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(aiStyles);

    // Initialize admin AI assistant chatbot
    function initAdminAIChatbot() {
        // Create floating AI assistant button
        const chatbotHtml = `
            <div id="admin-ai-chatbot" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
                <div id="admin-ai-panel" style="display: none; position: absolute; bottom: 70px; right: 0; width: 400px; max-width: calc(100vw - 40px); height: 500px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #0f1c2e 0%, #1a2a3a 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(201, 169, 98, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#C9A962" stroke-width="1.5"><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2z"/><path d="M8 12h8M12 8v8"/></svg>
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Admin AI Assistant</h4>
                                <span style="font-size: 11px; color: #8BC34A;">Ready to help</span>
                            </div>
                        </div>
                        <button onclick="toggleAdminAI()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div id="admin-ai-messages" style="flex: 1; overflow-y: auto; padding: 20px; background: #fafafa;">
                        <div style="text-align: center; padding: 20px;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #0f1c2e 0%, #1a2a3a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#C9A962" stroke-width="1.5"><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2z"/><path d="M8 12h8M12 8v8"/></svg>
                            </div>
                            <h4 style="color: #0f1c2e; margin: 0 0 10px;">Admin AI Assistant</h4>
                            <p style="color: #666; font-size: 13px; margin: 0 0 15px; line-height: 1.5;">I can help you with client summaries, data analysis, and quick answers about your practice.</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                                <button onclick="askAdminAI('Summarize all clients with high insomnia scores')" style="background: rgba(201, 169, 98, 0.1); border: 1px solid rgba(201, 169, 98, 0.3); color: #0f1c2e; padding: 6px 12px; border-radius: 15px; font-size: 11px; cursor: pointer;">High insomnia clients</button>
                                <button onclick="askAdminAI('What clients need follow-up?')" style="background: rgba(201, 169, 98, 0.1); border: 1px solid rgba(201, 169, 98, 0.3); color: #0f1c2e; padding: 6px 12px; border-radius: 15px; font-size: 11px; cursor: pointer;">Need follow-up</button>
                                <button onclick="askAdminAI('Overview of my practice metrics')" style="background: rgba(201, 169, 98, 0.1); border: 1px solid rgba(201, 169, 98, 0.3); color: #0f1c2e; padding: 6px 12px; border-radius: 15px; font-size: 11px; cursor: pointer;">Practice overview</button>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px;">
                        <input type="text" id="admin-ai-input" placeholder="Ask about clients, data, or practice..." style="flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; font-family: inherit;" onkeypress="if(event.key==='Enter')sendAdminAIMessage()">
                        <button onclick="sendAdminAIMessage()" style="width: 44px; height: 44px; border-radius: 50%; background: #0f1c2e; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#C9A962" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                        </button>
                    </div>
                </div>
                <button onclick="toggleAdminAI()" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0f1c2e 0%, #1a2a3a 100%); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(15, 28, 46, 0.4); transition: all 0.3s ease;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#C9A962" stroke-width="1.5">
                        <path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2z"/>
                        <path d="M8 12h8M12 8v8"/>
                    </svg>
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', chatbotHtml);
    }

    let adminAIOpen = false;
    function toggleAdminAI() {
        adminAIOpen = !adminAIOpen;
        const panel = document.getElementById('admin-ai-panel');
        panel.style.display = adminAIOpen ? 'flex' : 'none';
        if (adminAIOpen) {
            document.getElementById('admin-ai-input').focus();
        }
    }

    function askAdminAI(question) {
        document.getElementById('admin-ai-input').value = question;
        sendAdminAIMessage();
    }

    async function sendAdminAIMessage() {
        const input = document.getElementById('admin-ai-input');
        const question = input.value.trim();
        if (!question) return;

        const messagesContainer = document.getElementById('admin-ai-messages');

        // Clear welcome if first message
        if (messagesContainer.querySelector('div[style*="text-align: center"]')) {
            messagesContainer.innerHTML = '';
        }

        // Add user message
        messagesContainer.innerHTML += `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                <div style="max-width: 85%; background: #0f1c2e; color: white; padding: 12px 16px; border-radius: 18px 18px 4px 18px; font-size: 14px;">${question}</div>
            </div>
        `;
        input.value = '';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Add loading
        messagesContainer.innerHTML += `
            <div id="admin-ai-loading" style="display: flex; justify-content: flex-start; margin-bottom: 15px;">
                <div style="background: white; padding: 15px; border-radius: 18px 18px 18px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 4px;">
                        <span style="width: 8px; height: 8px; background: #C9A962; border-radius: 50%; animation: typing 1.4s infinite;"></span>
                        <span style="width: 8px; height: 8px; background: #C9A962; border-radius: 50%; animation: typing 1.4s infinite 0.2s;"></span>
                        <span style="width: 8px; height: 8px; background: #C9A962; border-radius: 50%; animation: typing 1.4s infinite 0.4s;"></span>
                    </div>
                </div>
            </div>
        `;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Get response
        const response = await getAdminAIResponse(question);

        // Remove loading and add response
        document.getElementById('admin-ai-loading')?.remove();
        messagesContainer.innerHTML += `
            <div style="display: flex; justify-content: flex-start; margin-bottom: 15px;">
                <div style="max-width: 85%; background: white; color: #333; padding: 12px 16px; border-radius: 18px 18px 18px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.5;">${response}</div>
            </div>
        `;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function getAdminAIResponse(question) {
        const lowerQ = question.toLowerCase();

        // Practice overview
        if (lowerQ.includes('overview') || lowerQ.includes('metrics') || lowerQ.includes('summary')) {
            const athletes = allClients.filter(c => c.clientType === 'athlete').length;
            const hotels = allClients.filter(c => c.clientType === 'hotel').length;
            const executives = allClients.filter(c => c.clientType === 'executive').length;
            return `<strong>Practice Overview</strong><br><br>
                You currently have <strong>${allClients.length}</strong> clients:<br>
                 Athletes: ${athletes}<br>
                 Hotel Guests: ${hotels}<br>
                 Executives: ${executives}<br><br>
                <strong>${allAssessments.length}</strong> assessments completed.<br><br>
                Would you like me to analyze a specific segment?`;
        }

        // High insomnia
        if (lowerQ.includes('insomnia') || lowerQ.includes('isi')) {
            const highISI = allAssessments.filter(a => a.scores?.isi > 14);
            if (highISI.length === 0) {
                return 'No clients currently have ISI scores above 14 (clinical threshold).';
            }
            const names = highISI.slice(0, 5).map(a => {
                const client = allClients.find(c => c.id === a.userId);
                return client?.displayName || 'Unknown';
            });
            return `<strong>${highISI.length} client(s)</strong> have ISI scores above 14:<br><br>
                ${names.map(n => ` ${n}`).join('<br>')}<br><br>
                These clients may benefit from CBT-I interventions.`;
        }

        // Follow-up
        if (lowerQ.includes('follow') || lowerQ.includes('action') || lowerQ.includes('need')) {
            const needsAttention = allAssessments.filter(a => a.overallScore < 50);
            return `<strong>${needsAttention.length} client(s)</strong> have overall scores below 50 and may need follow-up attention.<br><br>
                Consider reaching out to clients who:<br>
                 Haven't completed assessments<br>
                 Have pending appointments<br>
                 Show declining scores`;
        }

        // Sleep apnea
        if (lowerQ.includes('apnea') || lowerQ.includes('stopbang') || lowerQ.includes('snor')) {
            const highRisk = allAssessments.filter(a => a.scores?.stopbang >= 5);
            return `<strong>${highRisk.length} client(s)</strong> are at high risk for sleep apnea (STOP-BANG  5).<br><br>
                Recommendation: Consider polysomnography referral for these clients.`;
        }

        // Default response
        return `I can help you with:<br><br>
             <strong>Client analysis</strong> - "Show clients with high insomnia scores"<br>
             <strong>Practice metrics</strong> - "Give me a practice overview"<br>
             <strong>Follow-up needs</strong> - "What clients need follow-up?"<br>
             <strong>Specific conditions</strong> - "Who has sleep apnea risk?"<br><br>
            What would you like to know?`;
    }

    // Add typing animation styles
    const typingStyles = document.createElement('style');
    typingStyles.textContent = `@keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-5px); opacity: 1; } }`;
    document.head.appendChild(typingStyles);

    // Initialize admin AI chatbot
    initAdminAIChatbot();

    // ============================================
    // HOTEL PARTNER MANAGEMENT
    // ============================================

    // Create comprehensive demo data for hotel partner feature
    async function createDemoHotelData() {
        const btn = event.target.closest('button');
        btn.disabled = true;
        btn.innerHTML = '<span style="margin-right: 6px;"></span> Creating...';

        try {
            const hotelId = 'ritz-carlton-demo';

            // Create luxury hotel partner
            await db.collection('hotelPartners').doc(hotelId).set({
                id: hotelId,
                name: 'The Ritz-Carlton',
                contactName: 'Jean-Pierre Dubois',
                contactEmail: 'gm@ritzcarlton-demo.com',
                logoUrl: null,
                partnershipStatus: 'active',
                reportSettings: {
                    includeGuestName: true,
                    emailOnCheckout: true
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            });

            // Guest 1: Completed 7-day stay with excellent results
            const guest1Id = 'demo-guest-001';
            await db.collection('users').doc(guest1Id).set({
                email: 'sarah.johnson@email.com',
                displayName: 'Sarah Johnson',
                role: 'client',
                clientType: 'hotel',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                hotelAffiliation: { hotelPartnerId: hotelId, isHotelGuest: true }
            });

            const checkIn1 = new Date();
            checkIn1.setDate(checkIn1.getDate() - 8);
            const checkout1 = new Date();
            checkout1.setDate(checkout1.getDate() - 1);

            await db.collection('guestStays').add({
                guestUserId: guest1Id,
                guestName: 'Sarah Johnson',
                hotelPartnerId: hotelId,
                checkInDate: checkIn1,
                checkoutDate: checkout1,
                actualCheckoutDate: checkout1,
                roomNumber: 'Suite 412',
                stayStatus: 'checked-out',
                baselineAssessments: { isi: 21, ess: 16 },  // Severe insomnia
                postStayAssessments: { isi: 8, ess: 7 },    // Normal range!
                engagement: {
                    chatSessions: 12,
                    diaryEntries: 7,
                    guidesViewed: 5,
                    interventions: ['personalized-schedule', 'room-optimization', 'relaxation-techniques', 'light-therapy', 'sleep-hygiene']
                },
                sleepMetrics: {
                    avgSleepDuration: { baseline: 4.8, postStay: 7.4 },
                    avgSleepLatency: { baseline: 55, postStay: 12 },
                    avgAwakenings: { baseline: 4.1, postStay: 0.8 },
                    avgSleepEfficiency: { baseline: 68, postStay: 92 },
                    avgRestedness: { baseline: 3.2, postStay: 8.6 },
                    avgDaytimeEnergy: { baseline: 3.8, postStay: 8.2 }
                },
                hotelExperience: {
                    mattress: 10,
                    pillows: 9,
                    bedding: 9,
                    roomTemp: 9,
                    darkness: 10,
                    quietness: 8,
                    airQuality: 9,
                    topFactor: 'The blackout curtains and mattress quality were exceptional'
                },
                guestFeedback: {
                    rating: 5,
                    wouldRecommend: true,
                    mostHelpful: 'personalized-schedule',
                    comments: 'Life-changing experience! I came here exhausted from chronic insomnia and left feeling like a new person. The personalized sleep schedule and Dr. Alen\'s guidance through the app were incredible. My sleep improved dramatically by day 3.',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                reportPdfUrl: null,
                reportSentAt: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Guest 2: Completed 5-day stay with good results
            const guest2Id = 'demo-guest-002';
            await db.collection('users').doc(guest2Id).set({
                email: 'michael.chen@email.com',
                displayName: 'Michael Chen',
                role: 'client',
                clientType: 'hotel',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                hotelAffiliation: { hotelPartnerId: hotelId, isHotelGuest: true }
            });

            const checkIn2 = new Date();
            checkIn2.setDate(checkIn2.getDate() - 6);
            const checkout2 = new Date();
            checkout2.setDate(checkout2.getDate() - 1);

            await db.collection('guestStays').add({
                guestUserId: guest2Id,
                guestName: 'Michael Chen',
                hotelPartnerId: hotelId,
                checkInDate: checkIn2,
                checkoutDate: checkout2,
                actualCheckoutDate: checkout2,
                roomNumber: 'Room 308',
                stayStatus: 'checked-out',
                baselineAssessments: { isi: 15, ess: 12 },  // Moderate insomnia
                postStayAssessments: { isi: 7, ess: 6 },    // Normal range
                engagement: {
                    chatSessions: 8,
                    diaryEntries: 5,
                    guidesViewed: 3,
                    interventions: ['room-optimization', 'relaxation-techniques', 'caffeine-timing']
                },
                sleepMetrics: {
                    avgSleepDuration: { baseline: 5.8, postStay: 7.1 },
                    avgSleepLatency: { baseline: 35, postStay: 18 },
                    avgAwakenings: { baseline: 2.5, postStay: 1.2 },
                    avgSleepEfficiency: { baseline: 76, postStay: 88 },
                    avgRestedness: { baseline: 4.5, postStay: 7.8 },
                    avgDaytimeEnergy: { baseline: 5.0, postStay: 7.5 }
                },
                hotelExperience: {
                    mattress: 8,
                    pillows: 9,
                    bedding: 8,
                    roomTemp: 10,
                    darkness: 9,
                    quietness: 6,
                    airQuality: 8,
                    topFactor: 'Perfect room temperature control made all the difference'
                },
                guestFeedback: {
                    rating: 5,
                    wouldRecommend: true,
                    mostHelpful: 'room-optimization',
                    comments: 'The room optimization tips were game-changers - especially the blackout guidance and temperature settings. Slept better here than at home!',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                reportPdfUrl: null,
                reportSentAt: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Guest 3: Currently active stay
            const guest3Id = 'demo-guest-003';
            await db.collection('users').doc(guest3Id).set({
                email: 'emma.williams@email.com',
                displayName: 'Emma Williams',
                role: 'client',
                clientType: 'hotel',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                hotelAffiliation: { hotelPartnerId: hotelId, isHotelGuest: true }
            });

            const checkIn3 = new Date();
            checkIn3.setDate(checkIn3.getDate() - 2);
            const checkout3 = new Date();
            checkout3.setDate(checkout3.getDate() + 3);

            await db.collection('guestStays').add({
                guestUserId: guest3Id,
                guestName: 'Emma Williams',
                hotelPartnerId: hotelId,
                checkInDate: checkIn3,
                checkoutDate: checkout3,
                roomNumber: 'Suite 501',
                stayStatus: 'active',
                baselineAssessments: { isi: 18, ess: 14 },
                postStayAssessments: null,
                engagement: {
                    chatSessions: 3,
                    diaryEntries: 2,
                    guidesViewed: 2,
                    interventions: ['personalized-schedule', 'room-optimization']
                },
                guestFeedback: null,
                reportPdfUrl: null,
                reportSentAt: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Demo data created successfully!\n\n The Ritz-Carlton hotel partner\n 2 completed guest stays (ready for reports)\n 1 active guest stay\n\nClick on the hotel card to view details and generate reports.');
            loadHotelPartners();

        } catch (error) {
            console.error('Error creating demo data:', error);
            alert('Error creating demo data: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg> Create Demo Data';
        }
    }

    // Legacy function name for compatibility
    async function createTestHotelData() {
        return createDemoHotelData();
    }

    // Load hotel partners section
    async function loadHotelPartners() {
        const container = document.getElementById('hotel-partners-list');
        container.innerHTML = '<div class="loading">Loading hotel partners...</div>';

        try {
            console.log('Loading hotel partners...');
            hotelPartners = await FirebaseDB.getAllHotelPartners();
            console.log('Loaded hotel partners:', hotelPartners);

            // DEV: Auto-create test data if no hotel partners exist
            if (hotelPartners.length === 0) {
                console.log('No hotel partners found. Creating test data...');
                await createTestHotelData();
                hotelPartners = await FirebaseDB.getAllHotelPartners();
            }

            // Calculate aggregate stats
            let totalActiveGuests = 0;
            let totalImprovement = 0;
            let improvementCount = 0;

            for (const partner of hotelPartners) {
                const stats = await FirebaseDB.getHotelPartnerStats(partner.id);
                partner.stats = stats;
                totalActiveGuests += stats.activeGuests;
                if (stats.avgImprovement > 0) {
                    totalImprovement += stats.avgImprovement;
                    improvementCount++;
                }
            }

            // Update stats
            document.getElementById('stat-hotel-partners').textContent = hotelPartners.filter(p => p.partnershipStatus === 'active').length;
            document.getElementById('stat-active-hotel-guests').textContent = totalActiveGuests;
            document.getElementById('stat-avg-improvement').textContent = improvementCount > 0
                ? Math.round(totalImprovement / improvementCount) + '%'
                : '-';

            // Load pending reports
            const pendingReports = await FirebaseDB.getStaysPendingReport();
            document.getElementById('stat-pending-reports').textContent = pendingReports.length;

            if (pendingReports.length > 0) {
                document.getElementById('pending-reports-card').style.display = 'block';
                renderPendingReports(pendingReports);
            } else {
                document.getElementById('pending-reports-card').style.display = 'none';
            }

            // Update badge
            const badge = document.getElementById('hotel-guests-badge');
            if (totalActiveGuests > 0) {
                badge.textContent = totalActiveGuests;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }

            // Render hotel list
            if (hotelPartners.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #888;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 15px; opacity: 0.5;">
                            <path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-4"/>
                        </svg>
                        <p style="margin-bottom: 15px;">No hotel partners yet</p>
                        <button class="action-btn action-btn-primary" onclick="showAddHotelModal()">Add Your First Partner</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = hotelPartners.map(partner => `
                <div class="hotel-partner-card" onclick="viewHotelDetail('${partner.id}')">
                    <div class="hotel-partner-logo">
                        ${partner.logoUrl
                            ? `<img src="${partner.logoUrl}" alt="${partner.name}">`
                            : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-4"/></svg>`
                        }
                    </div>
                    <div class="hotel-partner-info">
                        <div class="hotel-partner-name">${partner.name}</div>
                        <div class="hotel-partner-contact">${partner.contactName}  ${partner.contactEmail}</div>
                    </div>
                    <div class="hotel-partner-stats">
                        <div class="hotel-stat">
                            <div class="hotel-stat-value">${partner.stats?.totalGuests || 0}</div>
                            <div class="hotel-stat-label">Guests</div>
                        </div>
                        <div class="hotel-stat">
                            <div class="hotel-stat-value">${partner.stats?.activeGuests || 0}</div>
                            <div class="hotel-stat-label">Active</div>
                        </div>
                        <div class="hotel-stat">
                            <div class="hotel-stat-value">${partner.stats?.avgImprovement || 0}%</div>
                            <div class="hotel-stat-label">Avg. Impr.</div>
                        </div>
                    </div>
                    <span class="hotel-partner-status ${partner.partnershipStatus}">${partner.partnershipStatus}</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading hotel partners:', error);
            container.innerHTML = `<div style="color: #d32f2f; padding: 20px; text-align: center;">
                Error loading hotel partners<br>
                <small style="color: #666;">${error.message || error}</small>
            </div>`;
        }
    }

    // Render pending reports
    function renderPendingReports(reports) {
        const container = document.getElementById('pending-reports-list');
        container.innerHTML = reports.map(stay => `
            <div class="guest-stay-row" onclick="viewGuestStay('${stay.id}')">
                <div class="guest-avatar">${(stay.guestName || 'G')[0].toUpperCase()}</div>
                <div class="guest-info">
                    <div class="guest-name">${stay.guestName}</div>
                    <div class="guest-dates">${stay.hotelName}  Checked out ${formatDate(stay.actualCheckoutDate?.toDate?.())}</div>
                </div>
                <button class="action-btn action-btn-primary" onclick="event.stopPropagation(); generateReportForStay('${stay.id}')">Generate Report</button>
            </div>
        `).join('');
    }

    // Show add hotel modal
    function showAddHotelModal() {
        document.getElementById('hotel-modal-title').textContent = 'Add Hotel Partner';
        document.getElementById('hotel-edit-id').value = '';
        document.getElementById('hotel-name').value = '';
        document.getElementById('hotel-id').value = '';
        document.getElementById('hotel-contact-name').value = '';
        document.getElementById('hotel-contact-email').value = '';
        document.getElementById('hotel-logo-url').value = '';
        document.getElementById('hotel-status').value = 'active';
        document.getElementById('hotel-include-name').checked = false;
        document.getElementById('hotel-email-on-checkout').checked = true;
        document.getElementById('hotel-id-preview').textContent = '...';

        // Auto-generate ID from name
        document.getElementById('hotel-name').oninput = function() {
            const slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            document.getElementById('hotel-id').value = slug;
            document.getElementById('hotel-id-preview').textContent = slug || '...';
        };

        document.getElementById('hotel-id').oninput = function() {
            document.getElementById('hotel-id-preview').textContent = this.value || '...';
        };

        document.getElementById('hotel-partner-modal').style.display = 'flex';
    }

    // Edit hotel modal
    function showEditHotelModal(partner) {
        document.getElementById('hotel-modal-title').textContent = 'Edit Hotel Partner';
        document.getElementById('hotel-edit-id').value = partner.id;
        document.getElementById('hotel-name').value = partner.name || '';
        document.getElementById('hotel-id').value = partner.id || '';
        document.getElementById('hotel-contact-name').value = partner.contactName || '';
        document.getElementById('hotel-contact-email').value = partner.contactEmail || '';
        document.getElementById('hotel-logo-url').value = partner.logoUrl || '';
        document.getElementById('hotel-status').value = partner.partnershipStatus || 'active';
        document.getElementById('hotel-include-name').checked = partner.reportSettings?.includeGuestName || false;
        document.getElementById('hotel-email-on-checkout').checked = partner.reportSettings?.emailOnCheckout !== false;
        document.getElementById('hotel-id-preview').textContent = partner.id || '...';

        document.getElementById('hotel-partner-modal').style.display = 'flex';
    }

    // Save hotel partner
    async function saveHotelPartner() {
        const editId = document.getElementById('hotel-edit-id').value;
        const name = document.getElementById('hotel-name').value.trim();
        const id = document.getElementById('hotel-id').value.trim();
        const contactName = document.getElementById('hotel-contact-name').value.trim();
        const contactEmail = document.getElementById('hotel-contact-email').value.trim();

        if (!name || !id || !contactName || !contactEmail) {
            alert('Please fill in all required fields');
            return;
        }

        const partnerData = {
            id: id,
            name: name,
            contactName: contactName,
            contactEmail: contactEmail,
            logoUrl: document.getElementById('hotel-logo-url').value.trim() || null,
            partnershipStatus: document.getElementById('hotel-status').value,
            reportSettings: {
                includeGuestName: document.getElementById('hotel-include-name').checked,
                emailOnCheckout: document.getElementById('hotel-email-on-checkout').checked
            }
        };

        try {
            if (editId) {
                await FirebaseDB.updateHotelPartner(editId, partnerData);
            } else {
                await FirebaseDB.createHotelPartner(partnerData);
            }
            closeModal('hotel-partner-modal');
            loadHotelPartners();
        } catch (error) {
            console.error('Error saving hotel partner:', error);
            alert('Error saving hotel partner: ' + error.message);
        }
    }

    // View hotel detail
    async function viewHotelDetail(hotelId) {
        currentHotelId = hotelId;

        // Show the section
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-hotel-detail').classList.add('active');

        const partner = await FirebaseDB.getHotelPartner(hotelId);
        if (!partner) {
            alert('Hotel not found');
            showSection('hotel-partners');
            return;
        }

        // Update header
        document.getElementById('hotel-detail-name').textContent = partner.name;
        document.getElementById('hotel-detail-contact').textContent = `Contact: ${partner.contactName} (${partner.contactEmail})`;

        // Load stats
        const stats = await FirebaseDB.getHotelPartnerStats(hotelId);
        document.getElementById('hotel-stat-total').textContent = stats.totalGuests;
        document.getElementById('hotel-stat-active').textContent = stats.activeGuests;
        document.getElementById('hotel-stat-improvement').textContent = stats.avgImprovement + '%';

        // Calculate average rating from completed stays
        const completedStays = await FirebaseDB.getHotelGuestStays(hotelId, 'report-sent');
        let totalRating = 0;
        let ratingCount = 0;
        completedStays.forEach(stay => {
            if (stay.guestFeedback?.rating) {
                totalRating += stay.guestFeedback.rating;
                ratingCount++;
            }
        });
        document.getElementById('hotel-stat-rating').textContent = ratingCount > 0
            ? (totalRating / ratingCount).toFixed(1) + '/5'
            : '-';

        // Load active guests by default
        switchHotelTab('active');
    }

    // Switch hotel guest tab
    async function switchHotelTab(tab) {
        document.querySelectorAll('.hotel-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.hotel-tab[data-tab="${tab}"]`).classList.add('active');

        const container = document.getElementById('hotel-guests-list');
        container.innerHTML = '<div class="loading" style="padding: 20px;">Loading guests...</div>';

        console.log('switchHotelTab called, currentHotelId:', currentHotelId, 'tab:', tab);

        const status = tab === 'active' ? 'active' : null;
        let stays = await FirebaseDB.getHotelGuestStays(currentHotelId, status);
        console.log('Stays loaded:', stays);

        // Filter for completed tab
        if (tab === 'completed') {
            stays = stays.filter(s => s.stayStatus === 'checked-out' || s.stayStatus === 'report-sent');
        }

        if (stays.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #888;">
                    No ${tab === 'active' ? 'active' : 'completed'} guest stays
                </div>
            `;
            return;
        }

        container.innerHTML = stays.map(stay => {
            const checkIn = stay.checkInDate?.toDate?.();
            const checkOut = stay.checkoutDate?.toDate?.() || stay.actualCheckoutDate?.toDate?.();

            // Calculate improvement
            let improvement = null;
            if (stay.baselineAssessments?.isi && stay.postStayAssessments?.isi) {
                improvement = Math.round(((stay.baselineAssessments.isi - stay.postStayAssessments.isi) / stay.baselineAssessments.isi) * 100);
            }

            return `
                <div class="guest-stay-row" onclick="viewGuestStay('${stay.id}')">
                    <div class="guest-avatar">${(stay.guestName || 'G')[0].toUpperCase()}</div>
                    <div class="guest-info">
                        <div class="guest-name">${stay.guestName}</div>
                        <div class="guest-dates">${formatDate(checkIn)} - ${checkOut ? formatDate(checkOut) : 'Ongoing'}</div>
                    </div>
                    <div class="guest-room">${stay.roomNumber || 'No room'}</div>
                    <div class="guest-improvement">
                        ${improvement !== null
                            ? `<div class="guest-improvement-value ${improvement > 0 ? 'positive' : 'neutral'}">${improvement > 0 ? '+' : ''}${improvement}%</div>
                               <div class="guest-improvement-label">Sleep Impr.</div>`
                            : `<div class="guest-improvement-value neutral">-</div>
                               <div class="guest-improvement-label">Pending</div>`
                        }
                    </div>
                    <span class="guest-status ${stay.stayStatus}">${formatStatus(stay.stayStatus)}</span>
                </div>
            `;
        }).join('');
    }

    // View guest stay detail
    async function viewGuestStay(stayId) {
        const container = document.getElementById('guest-stay-content');
        container.innerHTML = '<div class="loading">Loading stay details...</div>';
        document.getElementById('guest-stay-modal').style.display = 'flex';
        document.getElementById('guest-stay-modal').dataset.stayId = stayId;

        const stay = await FirebaseDB.getGuestStay(stayId);
        if (!stay) {
            container.innerHTML = '<p style="color: #d32f2f;">Stay not found</p>';
            return;
        }

        const [userProfile, hotel, assessments] = await Promise.all([
            FirebaseDB.getUserProfile(stay.guestUserId),
            FirebaseDB.getHotelPartner(stay.hotelPartnerId),
            FirebaseDB.getStayAssessments(stayId)
        ]);

        const checkIn = stay.checkInDate?.toDate?.();
        const checkOut = stay.checkoutDate?.toDate?.() || stay.actualCheckoutDate?.toDate?.();

        // Calculate improvement
        let improvement = null;
        if (stay.baselineAssessments?.isi && stay.postStayAssessments?.isi) {
            improvement = Math.round(((stay.baselineAssessments.isi - stay.postStayAssessments.isi) / stay.baselineAssessments.isi) * 100);
        }

        container.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div>
                    <h4 style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 8px;">Guest Information</h4>
                    <p style="font-size: 18px; color: #0f1c2e; font-weight: 500;">${userProfile?.displayName || 'Unknown Guest'}</p>
                    <p style="font-size: 13px; color: #666;">${userProfile?.email || ''}</p>
                </div>
                <div>
                    <h4 style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 8px;">Stay Details</h4>
                    <p style="font-size: 14px; color: #0f1c2e;">${hotel?.name || 'Unknown Hotel'}</p>
                    <p style="font-size: 13px; color: #666;">Room ${stay.roomNumber || 'N/A'}</p>
                    <p style="font-size: 13px; color: #666;">${formatDate(checkIn)} - ${checkOut ? formatDate(checkOut) : 'Ongoing'}</p>
                </div>
            </div>

            ${improvement !== null ? `
                <div style="background: linear-gradient(135deg, #0f1c2e, #1a2a3a); padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                    <p style="font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Overall Sleep Improvement</p>
                    <p style="font-family: 'Cormorant Garamond', serif; font-size: 56px; color: ${improvement > 0 ? '#C9A962' : '#fff'}; font-weight: 600; margin: 0;">${improvement > 0 ? '+' : ''}${improvement}%</p>
                </div>
            ` : ''}

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div style="background: #f8f6f3; padding: 20px; border-radius: 8px;">
                    <h4 style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 15px;">Baseline Assessments</h4>
                    <div style="display: flex; justify-content: space-around;">
                        <div style="text-align: center;">
                            <p style="font-size: 24px; font-weight: 600; color: #0f1c2e;">${stay.baselineAssessments?.isi ?? '-'}</p>
                            <p style="font-size: 11px; color: #888;">ISI Score</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="font-size: 24px; font-weight: 600; color: #0f1c2e;">${stay.baselineAssessments?.ess ?? '-'}</p>
                            <p style="font-size: 11px; color: #888;">ESS Score</p>
                        </div>
                    </div>
                </div>
                <div style="background: #f8f6f3; padding: 20px; border-radius: 8px;">
                    <h4 style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 15px;">Post-Stay Assessments</h4>
                    <div style="display: flex; justify-content: space-around;">
                        <div style="text-align: center;">
                            <p style="font-size: 24px; font-weight: 600; color: ${stay.postStayAssessments?.isi < stay.baselineAssessments?.isi ? '#2e7d32' : '#0f1c2e'};">${stay.postStayAssessments?.isi ?? '-'}</p>
                            <p style="font-size: 11px; color: #888;">ISI Score</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="font-size: 24px; font-weight: 600; color: ${stay.postStayAssessments?.ess < stay.baselineAssessments?.ess ? '#2e7d32' : '#0f1c2e'};">${stay.postStayAssessments?.ess ?? '-'}</p>
                            <p style="font-size: 11px; color: #888;">ESS Score</p>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <h4 style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 15px;">Engagement</h4>
                <div style="display: flex; gap: 20px;">
                    <div style="background: rgba(201, 169, 98, 0.1); padding: 15px 20px; border-radius: 8px; text-align: center;">
                        <p style="font-size: 20px; font-weight: 600; color: #0f1c2e;">${stay.engagement?.chatSessions || 0}</p>
                        <p style="font-size: 11px; color: #888;">Chat Sessions</p>
                    </div>
                    <div style="background: rgba(201, 169, 98, 0.1); padding: 15px 20px; border-radius: 8px; text-align: center;">
                        <p style="font-size: 20px; font-weight: 600; color: #0f1c2e;">${stay.engagement?.diaryEntries || 0}</p>
                        <p style="font-size: 11px; color: #888;">Diary Entries</p>
                    </div>
                    <div style="background: rgba(201, 169, 98, 0.1); padding: 15px 20px; border-radius: 8px; flex: 1;">
                        <p style="font-size: 12px; font-weight: 500; color: #0f1c2e; margin-bottom: 5px;">Interventions</p>
                        <p style="font-size: 12px; color: #666;">${stay.engagement?.interventions?.length > 0 ? stay.engagement.interventions.join(', ') : 'None recorded'}</p>
                    </div>
                </div>
            </div>

            ${stay.guestFeedback ? `
                <div style="background: #f8f6f3; padding: 20px; border-radius: 8px;">
                    <h4 style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 15px;">Guest Feedback</h4>
                    <div style="display: flex; gap: 30px; margin-bottom: 15px;">
                        <div>
                            <p style="font-size: 11px; color: #888;">Overall Rating</p>
                            <p style="font-size: 18px; color: #0f1c2e; font-weight: 500;">${stay.guestFeedback.rating}/5 ${''.repeat(stay.guestFeedback.rating)}${''.repeat(5 - stay.guestFeedback.rating)}</p>
                        </div>
                        <div>
                            <p style="font-size: 11px; color: #888;">Would Recommend</p>
                            <p style="font-size: 14px; color: #0f1c2e;">${stay.guestFeedback.wouldRecommend ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                    ${stay.guestFeedback.comments ? `
                        <div>
                            <p style="font-size: 11px; color: #888; margin-bottom: 5px;">Comments</p>
                            <p style="font-size: 13px; color: #0f1c2e; font-style: italic;">"${stay.guestFeedback.comments}"</p>
                        </div>
                    ` : ''}
                </div>
            ` : ''}

            <div style="margin-top: 20px;">
                <p style="font-size: 12px; color: #888;">Status: <span class="guest-status ${stay.stayStatus}">${formatStatus(stay.stayStatus)}</span></p>
                ${stay.reportPdfUrl ? `<p style="font-size: 12px; color: #888; margin-top: 10px;">Report: <a href="${stay.reportPdfUrl}" target="_blank" style="color: var(--gold);">View PDF</a></p>` : ''}
            </div>
        `;

        // Update generate button visibility
        const generateBtn = document.getElementById('generate-report-btn');
        if (stay.stayStatus === 'checked-out' && !stay.reportPdfUrl) {
            generateBtn.style.display = 'inline-block';
        } else {
            generateBtn.style.display = 'none';
        }
    }

    // Edit current hotel
    function editCurrentHotel() {
        const partner = hotelPartners.find(p => p.id === currentHotelId);
        if (partner) {
            showEditHotelModal(partner);
        }
    }

    // Show hotel invite modal
    function showHotelInviteModal() {
        const partner = hotelPartners.find(p => p.id === currentHotelId);
        if (!partner) return;

        document.getElementById('hotel-invite-hotel-name').textContent = partner.name;
        const baseUrl = window.location.origin + window.location.pathname.replace('/admin/index.html', '');
        const signupUrl = `${baseUrl}/auth.html?hotel=${currentHotelId}`;
        document.getElementById('hotel-signup-url').textContent = signupUrl;

        document.getElementById('hotel-invite-modal').style.display = 'flex';
    }

    // Copy hotel signup URL
    function copyHotelSignupUrl() {
        const url = document.getElementById('hotel-signup-url').textContent;
        navigator.clipboard.writeText(url).then(() => {
            alert('URL copied to clipboard!');
        });
    }

    // Generate report for a stay
    async function generateReportForStay(stayId) {
        document.getElementById('guest-stay-modal').dataset.stayId = stayId;
        await generateGuestReport();
    }

    // Generate guest report - creates HTML report and opens in new window for PDF printing
    async function generateGuestReport() {
        const stayId = document.getElementById('guest-stay-modal').dataset.stayId;
        if (!stayId) return;

        const stay = await FirebaseDB.getGuestStay(stayId);
        if (!stay) return;

        const [userProfile, hotel] = await Promise.all([
            FirebaseDB.getUserProfile(stay.guestUserId),
            FirebaseDB.getHotelPartner(stay.hotelPartnerId)
        ]);

        // Format dates
        const checkIn = stay.checkInDate?.toDate?.();
        const checkOut = stay.actualCheckoutDate?.toDate?.() || stay.checkoutDate?.toDate?.();
        const stayDuration = checkIn && checkOut ? Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24)) : 0;
        const formatDate = (d) => d ? d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '-';
        const formatShortDate = (d) => d ? d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '-';

        // Calculate improvements
        const isiBaseline = stay.baselineAssessments?.isi || 0;
        const isiPost = stay.postStayAssessments?.isi || 0;
        const isiImprovement = isiBaseline > 0 ? Math.round(((isiBaseline - isiPost) / isiBaseline) * 100) : 0;

        const essBaseline = stay.baselineAssessments?.ess || 0;
        const essPost = stay.postStayAssessments?.ess || 0;
        const essImprovement = essBaseline > 0 ? Math.round(((essBaseline - essPost) / essBaseline) * 100) : 0;

        // Sleep metrics from diary (use defaults if not available)
        const sleepMetrics = stay.sleepMetrics || {
            avgSleepDuration: { baseline: 5.5, postStay: 7.2 },
            avgSleepLatency: { baseline: 45, postStay: 15 },
            avgAwakenings: { baseline: 3.2, postStay: 1.1 },
            avgSleepEfficiency: { baseline: 72, postStay: 89 },
            avgRestedness: { baseline: 3.8, postStay: 8.2 },
            avgDaytimeEnergy: { baseline: 4.2, postStay: 7.8 }
        };

        // Calculate composite Sleep Wellness Score (0-100)
        const calculateWellnessScore = (metrics, isBaseline) => {
            const key = isBaseline ? 'baseline' : 'postStay';
            const duration = Math.min(metrics.avgSleepDuration[key] / 8, 1) * 25;
            const efficiency = (metrics.avgSleepEfficiency[key] / 100) * 25;
            const restedness = (metrics.avgRestedness[key] / 10) * 25;
            const latencyScore = Math.max(0, (60 - metrics.avgSleepLatency[key]) / 60) * 25;
            return Math.round(duration + efficiency + restedness + latencyScore);
        };

        const wellnessBaseline = calculateWellnessScore(sleepMetrics, true);
        const wellnessPost = calculateWellnessScore(sleepMetrics, false);
        const wellnessImprovement = wellnessBaseline > 0 ? Math.round(((wellnessPost - wellnessBaseline) / wellnessBaseline) * 100) : 0;

        // ISI severity labels
        const getISISeverity = (score) => {
            if (score <= 7) return { label: 'No clinically significant insomnia', color: '#2e7d32', short: 'Normal' };
            if (score <= 14) return { label: 'Subthreshold insomnia', color: '#f9a825', short: 'Mild' };
            if (score <= 21) return { label: 'Moderate clinical insomnia', color: '#ef6c00', short: 'Moderate' };
            return { label: 'Severe clinical insomnia', color: '#c62828', short: 'Severe' };
        };

        // ESS severity labels
        const getESSSeverity = (score) => {
            if (score <= 10) return { label: 'Normal daytime sleepiness', color: '#2e7d32', short: 'Normal' };
            if (score <= 14) return { label: 'Mild excessive sleepiness', color: '#f9a825', short: 'Mild' };
            if (score <= 18) return { label: 'Moderate excessive sleepiness', color: '#ef6c00', short: 'Moderate' };
            return { label: 'Severe excessive sleepiness', color: '#c62828', short: 'Severe' };
        };

        const baselineISI = getISISeverity(isiBaseline);
        const postISI = getISISeverity(isiPost);
        const baselineESS = getESSSeverity(essBaseline);
        const postESS = getESSSeverity(essPost);

        // Generate interventions list
        const interventionLabels = {
            'personalized-schedule': 'Personalized Sleep Schedule Optimization',
            'room-optimization': 'Sleep Environment & Room Optimization',
            'relaxation-techniques': 'Relaxation & Wind-Down Protocols',
            'light-therapy': 'Light Exposure Timing Guidance',
            'sleep-hygiene': 'Sleep Hygiene Education',
            'caffeine-timing': 'Caffeine & Stimulant Management',
            'sleep-diary': 'Sleep Diary Tracking & Analysis',
            'consultation': 'Direct Consultation with Sleep Specialist'
        };
        const interventions = stay.engagement?.interventions?.map(i => interventionLabels[i] || i) || [];

        // Guest name handling
        const guestName = stay.guestName || userProfile?.displayName || 'Guest';
        const guestIdentifier = hotel?.reportSettings?.includeGuestName !== false
            ? guestName
            : `Guest #${stayId.substring(0, 6).toUpperCase()}`;

        // Key conclusions
        const conclusions = [];
        if (isiImprovement >= 50) conclusions.push('Achieved clinically significant improvement in insomnia symptoms');
        else if (isiImprovement >= 25) conclusions.push('Showed meaningful improvement in sleep quality');
        if (postISI.short === 'Normal' && baselineISI.short !== 'Normal') conclusions.push('Insomnia symptoms resolved to normal range');
        if (sleepMetrics.avgSleepDuration.postStay >= 7) conclusions.push('Achieved recommended 7+ hours of sleep');
        if (sleepMetrics.avgSleepEfficiency.postStay >= 85) conclusions.push('Sleep efficiency improved to healthy range (85%+)');
        if (stay.guestFeedback?.rating >= 4) conclusions.push('Guest reported high satisfaction with sleep program');

        // Compute hotel experience ratings HTML
        const hotelExp = stay.hotelExperience || {
            mattress: 9, pillows: 8, bedding: 9, roomTemp: 8,
            darkness: 9, quietness: 7, airQuality: 8
        };
        const hotelRatingItems = [
            { key: 'mattress', label: 'Mattress Comfort', icon: '' },
            { key: 'pillows', label: 'Pillow Quality', icon: '' },
            { key: 'bedding', label: 'Bedding Quality', icon: '' },
            { key: 'roomTemp', label: 'Room Temperature', icon: '' },
            { key: 'darkness', label: 'Room Darkness', icon: '' },
            { key: 'quietness', label: 'Noise Level', icon: '' },
            { key: 'airQuality', label: 'Air Quality', icon: '' }
        ];
        const hotelRatingsHTML = hotelRatingItems.map(item => {
            const score = hotelExp[item.key] || 7;
            const color = score >= 8 ? '#2e7d32' : score >= 6 ? '#f9a825' : '#c62828';
            return '<div style="background: #f8f6f3; padding: 15px; border-radius: 8px; text-align: center;">' +
                '<div style="font-size: 20px; margin-bottom: 5px;">' + item.icon + '</div>' +
                '<div style="font-family: Cormorant Garamond, serif; font-size: 28px; font-weight: 600; color: ' + color + ';">' + score + '/10</div>' +
                '<div style="font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">' + item.label + '</div>' +
                '</div>';
        }).join('');

        // Compute hotel recommendations
        const hotelRecs = [];
        if ((hotelExp.quietness || 7) < 8) hotelRecs.push('Consider enhanced soundproofing or white noise options');
        if ((hotelExp.roomTemp || 8) < 8) hotelRecs.push('Review HVAC settings for optimal sleep temperature (65-68F)');
        if ((hotelExp.darkness || 9) < 8) hotelRecs.push('Upgrade to complete blackout curtains');
        if (hotelRecs.length === 0) hotelRecs.push('Guest rated all room factors highly - maintain current standards');
        const hotelRecsHTML = hotelRecs.map(r => '<li style="padding: 5px 0; font-size: 11px; color: #333;"> ' + r + '</li>').join('');

        // Create HTML report
        const reportHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sleep Wellness Report - ${guestIdentifier}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        @page { size: letter; margin: 0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: white; color: #1a1a1a; font-size: 11px; line-height: 1.5; }

        .page {
            width: 8.5in;
            height: 11in;
            padding: 0.6in 0.7in;
            page-break-after: always;
            position: relative;
            overflow: hidden;
        }
        .page:last-child { page-break-after: auto; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #C9A962;
            margin-bottom: 20px;
        }
        .logo { font-family: 'Cormorant Garamond', serif; }
        .logo-main { font-size: 22px; font-weight: 600; color: #0f1c2e; letter-spacing: 3px; }
        .logo-sub { font-size: 9px; color: #C9A962; letter-spacing: 1.5px; margin-top: 2px; }
        .header-info { text-align: right; font-size: 10px; color: #666; }
        .header-info strong { color: #0f1c2e; font-size: 11px; }

        /* Page 1: Executive Summary */
        .exec-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 26px;
            color: #0f1c2e;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .guest-banner {
            background: linear-gradient(135deg, #0f1c2e 0%, #1e3a5f 100%);
            padding: 18px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .guest-banner-left { color: white; }
        .guest-banner-name { font-size: 18px; font-weight: 600; margin-bottom: 3px; }
        .guest-banner-details { font-size: 10px; opacity: 0.8; }
        .guest-banner-right { text-align: right; color: white; }
        .stay-duration { font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 600; color: #C9A962; }
        .stay-duration-label { font-size: 9px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }

        /* Big Score */
        .wellness-score-container {
            background: #f8f6f3;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(201, 169, 98, 0.3);
        }
        .wellness-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .wellness-score { font-family: 'Cormorant Garamond', serif; font-size: 72px; font-weight: 700; color: #C9A962; line-height: 1; }
        .wellness-score-change { font-size: 18px; color: #2e7d32; font-weight: 600; margin-top: 5px; }
        .wellness-desc { font-size: 10px; color: #666; margin-top: 8px; }

        /* Key Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 15px 12px;
            text-align: center;
        }
        .metric-card.highlight { border-color: #C9A962; background: rgba(201, 169, 98, 0.05); }
        .metric-icon { font-size: 20px; margin-bottom: 6px; }
        .metric-value { font-family: 'Cormorant Garamond', serif; font-size: 24px; font-weight: 600; color: #0f1c2e; }
        .metric-change { font-size: 11px; color: #2e7d32; font-weight: 500; }
        .metric-change.negative { color: #c62828; }
        .metric-label { font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        /* Conclusions */
        .conclusions-box {
            background: #e8f5e9;
            border-left: 4px solid #2e7d32;
            padding: 15px 18px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }
        .conclusions-title { font-size: 11px; font-weight: 600; color: #2e7d32; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .conclusions-list { list-style: none; }
        .conclusions-list li { font-size: 11px; color: #1b5e20; padding: 3px 0; padding-left: 18px; position: relative; }
        .conclusions-list li:before { content: ''; position: absolute; left: 0; color: #2e7d32; font-weight: bold; }

        /* Guest Rating */
        .rating-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f6f3;
            padding: 15px 20px;
            border-radius: 8px;
        }
        .rating-stars { font-size: 22px; color: #C9A962; }
        .rating-text { font-size: 11px; color: #666; }
        .rating-text strong { color: #0f1c2e; }

        /* Footer */
        .footer {
            position: absolute;
            bottom: 0.5in;
            left: 0.7in;
            right: 0.7in;
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #999;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        /* Page 2: Detailed Analysis */
        .section-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 16px;
            color: #0f1c2e;
            margin: 18px 0 12px 0;
            padding-bottom: 6px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }

        .assessment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .assessment-card {
            border-radius: 8px;
            padding: 15px;
        }
        .assessment-card.baseline { background: #fff8e1; border: 1px solid #ffe082; }
        .assessment-card.postStay { background: #e8f5e9; border: 1px solid #a5d6a7; }
        .assessment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .assessment-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: #666; }
        .assessment-date { font-size: 9px; color: #999; }
        .assessment-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .assessment-row:last-child { border-bottom: none; }
        .assessment-metric { font-size: 10px; color: #333; }
        .assessment-value { font-weight: 600; font-size: 12px; }
        .assessment-value.good { color: #2e7d32; }
        .assessment-value.warn { color: #f9a825; }
        .assessment-value.bad { color: #c62828; }

        /* Sleep Diary Summary */
        .diary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .diary-item {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .diary-item-label { font-size: 9px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .diary-item-values { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .diary-item-baseline { font-size: 14px; color: #999; text-decoration: line-through; }
        .diary-item-arrow { color: #2e7d32; font-size: 12px; }
        .diary-item-post { font-size: 18px; font-weight: 600; color: #0f1c2e; }

        /* Engagement */
        .engagement-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .engagement-stat {
            flex: 1;
            background: rgba(201, 169, 98, 0.1);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(201, 169, 98, 0.2);
        }
        .engagement-stat-value { font-family: 'Cormorant Garamond', serif; font-size: 26px; color: #0f1c2e; font-weight: 600; }
        .engagement-stat-label { font-size: 9px; color: #888; text-transform: uppercase; }

        /* Interventions */
        .interventions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        .intervention-item {
            background: #f8f6f3;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 10px;
            color: #333;
            border-left: 3px solid #C9A962;
        }

        /* Page 3: Guest Experience */
        .feedback-card {
            background: linear-gradient(135deg, #f8f6f3, #fff);
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .feedback-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .feedback-stars { font-size: 28px; color: #C9A962; }
        .feedback-recommend {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 500;
        }
        .feedback-quote {
            font-size: 13px;
            font-style: italic;
            color: #333;
            line-height: 1.7;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #C9A962;
        }

        /* Signature */
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .signature-left {}
        .signature-name { font-family: 'Cormorant Garamond', serif; font-size: 18px; color: #0f1c2e; font-weight: 600; }
        .signature-title { font-size: 10px; color: #666; margin-top: 2px; }
        .signature-contact { font-size: 9px; color: #888; margin-top: 8px; }
        .signature-right { text-align: right; }
        .report-id { font-size: 9px; color: #ccc; }

        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .page { margin: 0; }
        }
    </style>
</head>
<body>
    <!-- PAGE 1: EXECUTIVE SUMMARY -->
    <div class="page">
        <div class="header">
            <div class="logo">
                <div class="logo-main">SLEEP WELLNESS</div>
                <div class="logo-sub">BY DR. ALEN JUGINOVIC  HARVARD MEDICAL SCHOOL</div>
            </div>
            <div class="header-info">
                <strong>${hotel?.name || 'Partner Hotel'}</strong><br>
                Report Generated: ${formatDate(new Date())}
            </div>
        </div>

        <div class="exec-title">Guest Sleep Improvement Report</div>

        <div class="guest-banner">
            <div class="guest-banner-left">
                <div class="guest-banner-name">${guestIdentifier}</div>
                <div class="guest-banner-details">${stay.roomNumber || 'N/A'}  ${formatShortDate(checkIn)}  ${formatShortDate(checkOut)}</div>
            </div>
            <div class="guest-banner-right">
                <div class="stay-duration">${stayDuration}</div>
                <div class="stay-duration-label">Night Stay</div>
            </div>
        </div>

        <div class="wellness-score-container">
            <div class="wellness-label">Sleep Wellness Score</div>
            <div class="wellness-score">${wellnessPost}</div>
            <div class="wellness-score-change">+${wellnessImprovement}% improvement</div>
            <div class="wellness-desc">Composite score based on sleep duration, efficiency, and restfulness (0-100 scale)</div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card highlight">
                <div class="metric-icon"></div>
                <div class="metric-value">${isiBaseline}  ${isiPost}</div>
                <div class="metric-change"> ${isiImprovement}%</div>
                <div class="metric-label">Insomnia Index (ISI)</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"></div>
                <div class="metric-value">${sleepMetrics.avgSleepDuration.postStay}h</div>
                <div class="metric-change">+${((sleepMetrics.avgSleepDuration.postStay - sleepMetrics.avgSleepDuration.baseline) / sleepMetrics.avgSleepDuration.baseline * 100).toFixed(0)}%</div>
                <div class="metric-label">Avg. Sleep Duration</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"></div>
                <div class="metric-value">${sleepMetrics.avgSleepEfficiency.postStay}%</div>
                <div class="metric-change">+${sleepMetrics.avgSleepEfficiency.postStay - sleepMetrics.avgSleepEfficiency.baseline}pts</div>
                <div class="metric-label">Sleep Efficiency</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"></div>
                <div class="metric-value">${sleepMetrics.avgRestedness.postStay}/10</div>
                <div class="metric-change">+${(sleepMetrics.avgRestedness.postStay - sleepMetrics.avgRestedness.baseline).toFixed(1)}</div>
                <div class="metric-label">Morning Restedness</div>
            </div>
        </div>

        ${conclusions.length > 0 ? `
        <div class="conclusions-box">
            <div class="conclusions-title">Key Outcomes</div>
            <ul class="conclusions-list">
                ${conclusions.map(c => `<li>${c}</li>`).join('')}
            </ul>
        </div>
        ` : ''}

        <div class="rating-row">
            <div>
                <div class="rating-stars">${''.repeat(stay.guestFeedback?.rating || 0)}${''.repeat(5 - (stay.guestFeedback?.rating || 0))}</div>
            </div>
            <div class="rating-text">
                <strong>Guest Satisfaction:</strong> ${stay.guestFeedback?.rating || '-'}/5 stars
                ${stay.guestFeedback?.wouldRecommend ? '  Would recommend to others' : ''}
            </div>
        </div>

        <div class="footer">
            <div>Sleep Wellness by Dr. Alen Juginovic | Confidential Report</div>
            <div>Page 1 of 2</div>
        </div>
    </div>

    <!-- PAGE 2: DETAILED ANALYSIS -->
    <div class="page">
        <div class="header">
            <div class="logo">
                <div class="logo-main">DETAILED ANALYSIS</div>
                <div class="logo-sub">${guestIdentifier}  ${hotel?.name || 'Partner Hotel'}</div>
            </div>
            <div class="header-info">
                ${formatShortDate(checkIn)}  ${formatShortDate(checkOut)}
            </div>
        </div>

        <div class="section-title">Clinical Assessment Comparison</div>
        <div class="assessment-grid">
            <div class="assessment-card baseline">
                <div class="assessment-header">
                    <div class="assessment-label">Baseline (Check-In)</div>
                    <div class="assessment-date">${formatShortDate(checkIn)}</div>
                </div>
                <div class="assessment-row">
                    <span class="assessment-metric">Insomnia Severity (ISI)</span>
                    <span class="assessment-value bad">${isiBaseline} - ${baselineISI.short}</span>
                </div>
                <div class="assessment-row">
                    <span class="assessment-metric">Daytime Sleepiness (ESS)</span>
                    <span class="assessment-value ${essBaseline > 10 ? 'warn' : 'good'}">${essBaseline} - ${baselineESS.short}</span>
                </div>
                <div class="assessment-row">
                    <span class="assessment-metric">Sleep Efficiency</span>
                    <span class="assessment-value ${sleepMetrics.avgSleepEfficiency.baseline < 80 ? 'warn' : 'good'}">${sleepMetrics.avgSleepEfficiency.baseline}%</span>
                </div>
            </div>
            <div class="assessment-card postStay">
                <div class="assessment-header">
                    <div class="assessment-label">Post-Stay (Check-Out)</div>
                    <div class="assessment-date">${formatShortDate(checkOut)}</div>
                </div>
                <div class="assessment-row">
                    <span class="assessment-metric">Insomnia Severity (ISI)</span>
                    <span class="assessment-value good">${isiPost} - ${postISI.short}</span>
                </div>
                <div class="assessment-row">
                    <span class="assessment-metric">Daytime Sleepiness (ESS)</span>
                    <span class="assessment-value good">${essPost} - ${postESS.short}</span>
                </div>
                <div class="assessment-row">
                    <span class="assessment-metric">Sleep Efficiency</span>
                    <span class="assessment-value good">${sleepMetrics.avgSleepEfficiency.postStay}%</span>
                </div>
            </div>
        </div>

        <div class="section-title">Sleep Diary Metrics (7-Day Averages)</div>
        <div class="diary-grid">
            <div class="diary-item">
                <div class="diary-item-label">Sleep Duration</div>
                <div class="diary-item-values">
                    <span class="diary-item-baseline">${sleepMetrics.avgSleepDuration.baseline}h</span>
                    <span class="diary-item-arrow"></span>
                    <span class="diary-item-post">${sleepMetrics.avgSleepDuration.postStay}h</span>
                </div>
            </div>
            <div class="diary-item">
                <div class="diary-item-label">Time to Fall Asleep</div>
                <div class="diary-item-values">
                    <span class="diary-item-baseline">${sleepMetrics.avgSleepLatency.baseline}m</span>
                    <span class="diary-item-arrow"></span>
                    <span class="diary-item-post">${sleepMetrics.avgSleepLatency.postStay}m</span>
                </div>
            </div>
            <div class="diary-item">
                <div class="diary-item-label">Night Awakenings</div>
                <div class="diary-item-values">
                    <span class="diary-item-baseline">${sleepMetrics.avgAwakenings.baseline}</span>
                    <span class="diary-item-arrow"></span>
                    <span class="diary-item-post">${sleepMetrics.avgAwakenings.postStay}</span>
                </div>
            </div>
        </div>

        <div class="section-title">Program Engagement</div>
        <div class="engagement-row">
            <div class="engagement-stat">
                <div class="engagement-stat-value">${stay.engagement?.chatSessions || 0}</div>
                <div class="engagement-stat-label">AI Coaching Sessions</div>
            </div>
            <div class="engagement-stat">
                <div class="engagement-stat-value">${stay.engagement?.diaryEntries || 0}</div>
                <div class="engagement-stat-label">Sleep Diary Entries</div>
            </div>
            <div class="engagement-stat">
                <div class="engagement-stat-value">${stay.engagement?.guidesViewed || 0}</div>
                <div class="engagement-stat-label">Guides Viewed</div>
            </div>
            <div class="engagement-stat">
                <div class="engagement-stat-value">${interventions.length}</div>
                <div class="engagement-stat-label">Interventions</div>
            </div>
        </div>

        ${interventions.length > 0 ? `
        <div class="section-title">Personalized Interventions Delivered</div>
        <div class="interventions-grid">
            ${interventions.map(i => `<div class="intervention-item">${i}</div>`).join('')}
        </div>
        ` : ''}

        <div class="footer">
            <div>Sleep Wellness by Dr. Alen Juginovic | Confidential</div>
            <div>Page 2 of 3</div>
        </div>
    </div>

    <!-- PAGE 3: GUEST EXPERIENCE & INSIGHTS -->
    <div class="page">
        <div class="header">
            <div class="logo">
                <div class="logo-main">GUEST EXPERIENCE</div>
                <div class="logo-sub">${guestIdentifier}  ${hotel?.name || 'Partner Hotel'}</div>
            </div>
            <div class="header-info">
                Insights & Feedback
            </div>
        </div>

        <div class="section-title">Room & Environment Ratings</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
            ${hotelRatingsHTML}
        </div>

        <div class="section-title">What Helped Most</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, rgba(201,169,98,0.1), rgba(201,169,98,0.05)); border: 1px solid rgba(201,169,98,0.3); border-radius: 10px; padding: 18px;">
                <div style="font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Top Sleep Factor</div>
                <div style="font-size: 15px; font-weight: 600; color: #0f1c2e;">${stay.hotelExperience?.topFactor || 'Room darkness & blackout curtains'}</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(46,125,50,0.1), rgba(46,125,50,0.05)); border: 1px solid rgba(46,125,50,0.3); border-radius: 10px; padding: 18px;">
                <div style="font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Program Feature</div>
                <div style="font-size: 15px; font-weight: 600; color: #0f1c2e;">${interventionLabels[stay.guestFeedback?.mostHelpful] || stay.guestFeedback?.mostHelpful || 'Personalized Schedule'}</div>
            </div>
        </div>

        <div class="section-title">Recommendations for Hotel</div>
        <div style="background: #fff8e1; border-left: 4px solid #f9a825; padding: 15px 18px; border-radius: 0 8px 8px 0; margin-bottom: 20px;">
            <ul style="list-style: none; margin: 0; padding: 0;">
                ${hotelRecsHTML}
            </ul>
        </div>

        ${stay.guestFeedback?.comments ? `
        <div class="section-title">Guest Testimonial</div>
        <div class="feedback-card" style="margin-bottom: 20px;">
            <div class="feedback-header">
                <div class="feedback-stars">${''.repeat(stay.guestFeedback.rating)}${''.repeat(5 - stay.guestFeedback.rating)}</div>
                ${stay.guestFeedback.wouldRecommend ? '<span class="feedback-recommend"> Would Recommend</span>' : ''}
            </div>
            <div class="feedback-quote">"${stay.guestFeedback.comments}"</div>
        </div>
        ` : ''}

        <div class="signature-section" style="margin-top: auto;">
            <div class="signature-left">
                <div class="signature-name">Alen Juginovic, M.D.</div>
                <div class="signature-title">Sleep Wellness Consultant</div>
                <div class="signature-title">Postdoctoral Researcher, Harvard Medical School</div>
                <div class="signature-contact">alen_juginovic@hms.harvard.edu | +1 (617) 982-8835</div>
            </div>
            <div class="signature-right">
                <div class="report-id">Report ID: ${stayId.substring(0, 8).toUpperCase()}</div>
            </div>
        </div>

        <div class="footer">
            <div>Sleep Wellness by Dr. Alen Juginovic | This report is confidential and intended for ${hotel?.name || 'hotel partner'} use only</div>
            <div>Page 3 of 3</div>
        </div>
    </div>

    <scr` + `ipt>
        window.onload = function() {
            setTimeout(function() { window.print(); }, 500);
        };
    </scr` + `ipt>
</body>
</html>`;

        // Open report in new window
        const reportWindow = window.open('', '_blank');
        reportWindow.document.write(reportHTML);
        reportWindow.document.close();

        // Mark report as generated
        await FirebaseDB.markReportSent(stayId, 'generated-' + new Date().toISOString());
        closeModal('guest-stay-modal');

        if (currentHotelId) {
            switchHotelTab('completed');
        }
        loadHotelPartners();
    }

    // Format date helper
    function formatDate(date) {
        if (!date) return '-';
        return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Format status helper
    function formatStatus(status) {
        const statusMap = {
            'active': 'Active Stay',
            'checked-out': 'Awaiting Report',
            'report-sent': 'Completed'
        };
        return statusMap[status] || status;
    }

    // ==========================================
    // ATHLETIC PARTNERS FUNCTIONS
    // ==========================================

    // Load athletic partners
    async function loadAthleticPartners() {
        const container = document.getElementById('athletic-partners-list');
        try {
            const snapshot = await db.collection('athleticPartners').orderBy('name').get();
            athleticPartners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Update stats
            document.getElementById('stat-athletic-teams').textContent = athleticPartners.filter(p => p.partnershipStatus === 'active').length;

            let totalAthletes = 0;
            let totalRecovery = 0;
            let recoveryCount = 0;

            for (const partner of athleticPartners) {
                const athletesSnap = await db.collection('athleteProfiles').where('teamPartnerId', '==', partner.id).get();
                partner.stats = {
                    totalAthletes: athletesSnap.size,
                    avgRecovery: 0
                };
                totalAthletes += athletesSnap.size;

                // Calculate avg recovery from athletes
                athletesSnap.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.avgRecoveryScore) {
                        totalRecovery += data.avgRecoveryScore;
                        recoveryCount++;
                    }
                });
            }

            document.getElementById('stat-total-athletes').textContent = totalAthletes;
            document.getElementById('stat-avg-recovery').textContent = recoveryCount > 0 ? Math.round(totalRecovery / recoveryCount) + '%' : '-';
            document.getElementById('stat-active-programs').textContent = athleticPartners.filter(p => p.partnershipStatus === 'active').length;

            if (athleticPartners.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #888;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 15px; opacity: 0.5;">
                            <circle cx="12" cy="5" r="3"/><path d="M12 8v8"/><path d="M8 21l4-4 4 4"/>
                        </svg>
                        <p style="margin-bottom: 15px;">No athletic partners yet</p>
                        <button class="action-btn action-btn-primary" onclick="showAddAthleticPartnerModal()">Add Your First Team</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = athleticPartners.map(partner => `
                <div class="partner-card" onclick="viewAthleticDetail('${partner.id}')">
                    <div class="partner-card-logo athletic">
                        ${partner.logoUrl
                            ? '<img src="' + partner.logoUrl + '" alt="' + partner.name + '">'
                            : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M12 8v8"/><path d="M8 21l4-4 4 4"/></svg>'
                        }
                    </div>
                    <div class="partner-card-info">
                        <div class="partner-card-name">${partner.name}</div>
                        <div class="partner-card-meta">
                            <span class="sport-badge">${partner.sport || 'Sport'}</span>
                            ${partner.competitionLevel || 'Professional'}  ${partner.contactName}
                        </div>
                    </div>
                    <div class="partner-card-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-value">${partner.stats?.totalAthletes || 0}</div>
                            <div class="partner-stat-label">Athletes</div>
                        </div>
                        <div class="partner-stat">
                            <div class="partner-stat-value">${partner.stats?.avgRecovery || '-'}</div>
                            <div class="partner-stat-label">Recovery</div>
                        </div>
                    </div>
                    <span class="partner-status ${partner.partnershipStatus}">${partner.partnershipStatus}</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading athletic partners:', error);
            container.innerHTML = '<div style="color: #d32f2f; padding: 20px; text-align: center;">Error loading athletic partners</div>';
        }
    }

    // Show add athletic partner modal
    function showAddAthleticPartnerModal() {
        document.getElementById('athletic-modal-title').textContent = 'Add Athletic Partner';
        document.getElementById('athletic-edit-id').value = '';
        document.getElementById('athletic-name').value = '';
        document.getElementById('athletic-id').value = '';
        document.getElementById('athletic-sport').value = 'basketball';
        document.getElementById('athletic-level').value = 'professional';
        document.getElementById('athletic-contact-name').value = '';
        document.getElementById('athletic-contact-email').value = '';
        document.getElementById('athletic-logo-url').value = '';
        document.getElementById('athletic-status').value = 'active';
        document.getElementById('athletic-id-preview').textContent = '...';

        document.getElementById('athletic-name').oninput = function() {
            const slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            document.getElementById('athletic-id').value = slug;
            document.getElementById('athletic-id-preview').textContent = slug || '...';
        };

        document.getElementById('athletic-partner-modal').style.display = 'flex';
    }

    // Save athletic partner
    async function saveAthleticPartner() {
        const editId = document.getElementById('athletic-edit-id').value;
        const name = document.getElementById('athletic-name').value.trim();
        const id = document.getElementById('athletic-id').value.trim();
        const sport = document.getElementById('athletic-sport').value;
        const level = document.getElementById('athletic-level').value;
        const contactName = document.getElementById('athletic-contact-name').value.trim();
        const contactEmail = document.getElementById('athletic-contact-email').value.trim();
        const logoUrl = document.getElementById('athletic-logo-url').value.trim();
        const status = document.getElementById('athletic-status').value;

        if (!name || !id || !contactName || !contactEmail) {
            alert('Please fill in all required fields');
            return;
        }

        const data = {
            name,
            sport,
            competitionLevel: level,
            contactName,
            contactEmail,
            logoUrl: logoUrl || null,
            partnershipStatus: status,
            programFocus: {
                recovery: document.getElementById('athletic-focus-recovery').checked,
                travel: document.getElementById('athletic-focus-travel').checked,
                performance: document.getElementById('athletic-focus-performance').checked
            },
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (editId) {
                await db.collection('athleticPartners').doc(editId).update(data);
            } else {
                data.id = id;
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                data.createdBy = currentUser.uid;
                await db.collection('athleticPartners').doc(id).set(data);
            }
            closeModal('athletic-partner-modal');
            loadAthleticPartners();
        } catch (error) {
            console.error('Error saving athletic partner:', error);
            alert('Error saving partner: ' + error.message);
        }
    }

    // View athletic partner detail
    async function viewAthleticDetail(partnerId) {
        currentAthleticId = partnerId;
        const partner = athleticPartners.find(p => p.id === partnerId);
        if (!partner) return;

        document.getElementById('athletic-detail-name').textContent = partner.name;
        document.getElementById('athletic-detail-sport').textContent = `${partner.sport || 'Sport'}  ${partner.competitionLevel || 'Professional'}  ${partner.contactEmail}`;

        // Load team stats
        const athletesSnap = await db.collection('athleteProfiles').where('teamPartnerId', '==', partnerId).get();
        document.getElementById('athletic-stat-total').textContent = athletesSnap.size;
        document.getElementById('athletic-stat-season').textContent = new Date().getFullYear();
        document.getElementById('athletic-stat-sleep').textContent = '-';
        document.getElementById('athletic-stat-recovery').textContent = '-';

        // Load athletes list
        const container = document.getElementById('athletic-members-list');
        if (athletesSnap.empty) {
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #888;">No athletes enrolled yet. Click "Add Athlete" to get started.</div>';
        } else {
            container.innerHTML = athletesSnap.docs.map(doc => {
                const a = doc.data();
                return `
                    <div class="guest-stay-row">
                        <div class="guest-avatar">${(a.displayName || 'A')[0].toUpperCase()}</div>
                        <div class="guest-info">
                            <div class="guest-name">${a.displayName || 'Athlete'}</div>
                            <div class="guest-dates">${a.position || 'Position'}  Joined ${formatDate(a.enrolledAt?.toDate?.())}</div>
                        </div>
                        <div class="guest-improvement">
                            <div class="guest-improvement-value ${a.avgRecoveryScore >= 80 ? 'positive' : ''}">${a.avgRecoveryScore || '-'}%</div>
                            <div class="guest-improvement-label">Recovery</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        showSection('athletic-detail');
    }

    // Switch athletic tab
    function switchAthleticTab(tab) {
        document.querySelectorAll('#section-athletic-detail .hotel-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`#section-athletic-detail .hotel-tab[data-tab="${tab}"]`).classList.add('active');
        // Tab content would be loaded here
    }

    // Create demo athletic data
    async function createDemoAthleticData() {
        if (!confirm('Create demo athletic partner data?')) return;

        try {
            const teamId = 'boston-celtics-demo';
            await db.collection('athleticPartners').doc(teamId).set({
                id: teamId,
                name: 'Boston Celtics (Demo)',
                sport: 'basketball',
                competitionLevel: 'professional',
                contactName: 'Dr. Performance Director',
                contactEmail: 'performance@celtics-demo.com',
                logoUrl: null,
                partnershipStatus: 'active',
                programFocus: {
                    recovery: true,
                    travel: true,
                    performance: true
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            });

            // Create demo athletes
            const athletes = [
                { name: 'James Wilson', position: 'Point Guard', recovery: 92 },
                { name: 'Marcus Thompson', position: 'Shooting Guard', recovery: 88 },
                { name: 'David Chen', position: 'Center', recovery: 85 }
            ];

            for (const athlete of athletes) {
                await db.collection('athleteProfiles').add({
                    teamPartnerId: teamId,
                    displayName: athlete.name,
                    position: athlete.position,
                    avgRecoveryScore: athlete.recovery,
                    enrolledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            alert('Demo athletic data created successfully!');
            loadAthleticPartners();
        } catch (error) {
            console.error('Error creating demo data:', error);
            alert('Error: ' + error.message);
        }
    }

    function editCurrentAthleticPartner() {
        const partner = athleticPartners.find(p => p.id === currentAthleticId);
        if (!partner) return;

        document.getElementById('athletic-modal-title').textContent = 'Edit Athletic Partner';
        document.getElementById('athletic-edit-id').value = partner.id;
        document.getElementById('athletic-name').value = partner.name;
        document.getElementById('athletic-id').value = partner.id;
        document.getElementById('athletic-sport').value = partner.sport || 'basketball';
        document.getElementById('athletic-level').value = partner.competitionLevel || 'professional';
        document.getElementById('athletic-contact-name').value = partner.contactName;
        document.getElementById('athletic-contact-email').value = partner.contactEmail;
        document.getElementById('athletic-logo-url').value = partner.logoUrl || '';
        document.getElementById('athletic-status').value = partner.partnershipStatus || 'active';
        document.getElementById('athletic-id-preview').textContent = partner.id;

        document.getElementById('athletic-partner-modal').style.display = 'flex';
    }

    function showAthleteInviteModal() {
        alert('Athlete invite link: ' + window.location.origin + '/auth.html?team=' + currentAthleticId);
    }

    // ==========================================
    // BUSINESS PARTNERS FUNCTIONS
    // ==========================================

    // Load business partners
    async function loadBusinessPartners() {
        const container = document.getElementById('business-partners-list');
        try {
            const snapshot = await db.collection('businessPartners').orderBy('name').get();
            businessPartners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Update stats
            document.getElementById('stat-business-orgs').textContent = businessPartners.filter(p => p.partnershipStatus === 'active').length;

            let totalExecs = 0;
            let totalPerformance = 0;
            let performanceCount = 0;

            for (const partner of businessPartners) {
                const execsSnap = await db.collection('executiveProfiles').where('orgPartnerId', '==', partner.id).get();
                partner.stats = {
                    totalExecs: execsSnap.size,
                    avgPerformance: 0
                };
                totalExecs += execsSnap.size;

                execsSnap.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.performanceGain) {
                        totalPerformance += data.performanceGain;
                        performanceCount++;
                    }
                });
            }

            document.getElementById('stat-total-executives').textContent = totalExecs;
            document.getElementById('stat-avg-performance').textContent = performanceCount > 0 ? Math.round(totalPerformance / performanceCount) + '%' : '-';
            document.getElementById('stat-business-programs').textContent = businessPartners.filter(p => p.partnershipStatus === 'active').length;

            if (businessPartners.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #888;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 15px; opacity: 0.5;">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                        </svg>
                        <p style="margin-bottom: 15px;">No business partners yet</p>
                        <button class="action-btn action-btn-primary" onclick="showAddBusinessPartnerModal()">Add Your First Organization</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = businessPartners.map(partner => `
                <div class="partner-card" onclick="viewBusinessDetail('${partner.id}')">
                    <div class="partner-card-logo business">
                        ${partner.logoUrl
                            ? '<img src="' + partner.logoUrl + '" alt="' + partner.name + '">'
                            : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>'
                        }
                    </div>
                    <div class="partner-card-info">
                        <div class="partner-card-name">${partner.name}</div>
                        <div class="partner-card-meta">
                            <span class="industry-badge">${partner.industry || 'Industry'}</span>
                            ${partner.programType || 'Executive Coaching'}  ${partner.contactName}
                        </div>
                    </div>
                    <div class="partner-card-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-value">${partner.stats?.totalExecs || 0}</div>
                            <div class="partner-stat-label">Executives</div>
                        </div>
                        <div class="partner-stat">
                            <div class="partner-stat-value">${partner.stats?.avgPerformance || '-'}</div>
                            <div class="partner-stat-label">Perf. Gain</div>
                        </div>
                    </div>
                    <span class="partner-status ${partner.partnershipStatus}">${partner.partnershipStatus}</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading business partners:', error);
            container.innerHTML = '<div style="color: #d32f2f; padding: 20px; text-align: center;">Error loading business partners</div>';
        }
    }

    // Show add business partner modal
    function showAddBusinessPartnerModal() {
        document.getElementById('business-modal-title').textContent = 'Add Business Partner';
        document.getElementById('business-edit-id').value = '';
        document.getElementById('business-name').value = '';
        document.getElementById('business-id').value = '';
        document.getElementById('business-industry').value = 'finance';
        document.getElementById('business-program').value = 'executive';
        document.getElementById('business-contact-name').value = '';
        document.getElementById('business-contact-email').value = '';
        document.getElementById('business-logo-url').value = '';
        document.getElementById('business-status').value = 'active';
        document.getElementById('business-id-preview').textContent = '...';

        document.getElementById('business-name').oninput = function() {
            const slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            document.getElementById('business-id').value = slug;
            document.getElementById('business-id-preview').textContent = slug || '...';
        };

        document.getElementById('business-partner-modal').style.display = 'flex';
    }

    // Save business partner
    async function saveBusinessPartner() {
        const editId = document.getElementById('business-edit-id').value;
        const name = document.getElementById('business-name').value.trim();
        const id = document.getElementById('business-id').value.trim();
        const industry = document.getElementById('business-industry').value;
        const programType = document.getElementById('business-program').value;
        const contactName = document.getElementById('business-contact-name').value.trim();
        const contactEmail = document.getElementById('business-contact-email').value.trim();
        const logoUrl = document.getElementById('business-logo-url').value.trim();
        const status = document.getElementById('business-status').value;

        if (!name || !id || !contactName || !contactEmail) {
            alert('Please fill in all required fields');
            return;
        }

        const data = {
            name,
            industry,
            programType,
            contactName,
            contactEmail,
            logoUrl: logoUrl || null,
            partnershipStatus: status,
            programFocus: {
                decision: document.getElementById('business-focus-decision').checked,
                travel: document.getElementById('business-focus-travel').checked,
                stress: document.getElementById('business-focus-stress').checked
            },
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (editId) {
                await db.collection('businessPartners').doc(editId).update(data);
            } else {
                data.id = id;
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                data.createdBy = currentUser.uid;
                await db.collection('businessPartners').doc(id).set(data);
            }
            closeModal('business-partner-modal');
            loadBusinessPartners();
        } catch (error) {
            console.error('Error saving business partner:', error);
            alert('Error saving partner: ' + error.message);
        }
    }

    // View business partner detail
    async function viewBusinessDetail(partnerId) {
        currentBusinessId = partnerId;
        const partner = businessPartners.find(p => p.id === partnerId);
        if (!partner) return;

        document.getElementById('business-detail-name').textContent = partner.name;
        document.getElementById('business-detail-industry').textContent = `${partner.industry || 'Industry'}  ${partner.programType || 'Executive'} Program  ${partner.contactEmail}`;

        // Load org stats
        const execsSnap = await db.collection('executiveProfiles').where('orgPartnerId', '==', partnerId).get();
        document.getElementById('business-stat-total').textContent = execsSnap.size;
        document.getElementById('business-stat-program').textContent = partner.programType || 'Executive';
        document.getElementById('business-stat-sleep').textContent = '-';
        document.getElementById('business-stat-completion').textContent = '-';

        // Load executives list
        const container = document.getElementById('business-members-list');
        if (execsSnap.empty) {
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #888;">No executives enrolled yet. Click "Add Executive" to get started.</div>';
        } else {
            container.innerHTML = execsSnap.docs.map(doc => {
                const e = doc.data();
                return `
                    <div class="guest-stay-row">
                        <div class="guest-avatar">${(e.displayName || 'E')[0].toUpperCase()}</div>
                        <div class="guest-info">
                            <div class="guest-name">${e.displayName || 'Executive'}</div>
                            <div class="guest-dates">${e.title || 'Title'}  Started ${formatDate(e.enrolledAt?.toDate?.())}</div>
                        </div>
                        <div class="guest-improvement">
                            <div class="guest-improvement-value ${e.performanceGain >= 15 ? 'positive' : ''}">${e.performanceGain || '-'}%</div>
                            <div class="guest-improvement-label">Improvement</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        showSection('business-detail');
    }

    // Switch business tab
    function switchBusinessTab(tab) {
        document.querySelectorAll('#section-business-detail .hotel-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`#section-business-detail .hotel-tab[data-tab="${tab}"]`).classList.add('active');
        // Tab content would be loaded here
    }

    // Create demo business data
    async function createDemoBusinessData() {
        if (!confirm('Create demo business partner data?')) return;

        try {
            const orgId = 'goldman-sachs-demo';
            await db.collection('businessPartners').doc(orgId).set({
                id: orgId,
                name: 'Goldman Sachs (Demo)',
                industry: 'finance',
                programType: 'executive',
                contactName: 'Sarah Chen, Head of Wellness',
                contactEmail: 'wellness@gs-demo.com',
                logoUrl: null,
                partnershipStatus: 'active',
                programFocus: {
                    decision: true,
                    travel: true,
                    stress: true
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            });

            // Create demo executives
            const executives = [
                { name: 'Robert Miller', title: 'Managing Director', gain: 28 },
                { name: 'Jennifer Adams', title: 'VP, Operations', gain: 22 },
                { name: 'Michael Park', title: 'Senior Associate', gain: 18 }
            ];

            for (const exec of executives) {
                await db.collection('executiveProfiles').add({
                    orgPartnerId: orgId,
                    displayName: exec.name,
                    title: exec.title,
                    performanceGain: exec.gain,
                    enrolledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            alert('Demo business data created successfully!');
            loadBusinessPartners();
        } catch (error) {
            console.error('Error creating demo data:', error);
            alert('Error: ' + error.message);
        }
    }

    function editCurrentBusinessPartner() {
        const partner = businessPartners.find(p => p.id === currentBusinessId);
        if (!partner) return;

        document.getElementById('business-modal-title').textContent = 'Edit Business Partner';
        document.getElementById('business-edit-id').value = partner.id;
        document.getElementById('business-name').value = partner.name;
        document.getElementById('business-id').value = partner.id;
        document.getElementById('business-industry').value = partner.industry || 'finance';
        document.getElementById('business-program').value = partner.programType || 'executive';
        document.getElementById('business-contact-name').value = partner.contactName;
        document.getElementById('business-contact-email').value = partner.contactEmail;
        document.getElementById('business-logo-url').value = partner.logoUrl || '';
        document.getElementById('business-status').value = partner.partnershipStatus || 'active';
        document.getElementById('business-id-preview').textContent = partner.id;

        document.getElementById('business-partner-modal').style.display = 'flex';
    }

    function showExecutiveInviteModal() {
        alert('Executive invite link: ' + window.location.origin + '/auth.html?corp=' + currentBusinessId);
    }
</script>

</body>
</html>
