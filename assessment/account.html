<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | Sleep Wellness by Dr. Alen</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Apple-inspired consistent border radius */
        :root {
            --radius-xl: 20px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-pill: 100px;
        }

        .dashboard-layout {
            display: flex;
            min-height: 100vh;
            padding-top: 56px;
        }

        /* Sidebar */
        .sidebar {
            width: 200px;
            background: var(--deep-navy);
            padding: 20px 0;
            position: fixed;
            top: 56px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(201, 169, 98, 0.2);
            margin-bottom: 15px;
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .sidebar-avatar {
            width: 38px;
            height: 38px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cormorant Garamond', serif;
            font-size: 16px;
            color: var(--deep-navy);
        }

        .sidebar-user-info h4 {
            color: var(--cream);
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-user-info p {
            color: var(--gold);
            font-size: 11px;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin: 2px 0;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s;
        }

        .sidebar-nav a:hover {
            background: rgba(201, 169, 98, 0.1);
            color: var(--cream);
        }

        .sidebar-nav a.active {
            background: rgba(201, 169, 98, 0.15);
            color: var(--gold);
            border-left: 3px solid var(--gold);
        }

        .sidebar-nav svg {
            width: 18px;
            height: 18px;
        }

        .sidebar-nav .badge {
            margin-left: auto;
            background: var(--gold);
            color: var(--deep-navy);
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding: 15px 18px;
            border-top: 1px solid rgba(201, 169, 98, 0.2);
            margin-top: auto;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
        }

        .logout-btn:hover {
            color: var(--cream);
        }

        /* Main Content */
        .dashboard-main {
            flex: 1;
            margin-left: 200px;
            padding: 25px 35px;
            background: var(--cream);
        }

        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 15px;
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: var(--radius-sm);
            color: var(--navy);
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--deep-navy);
        }

        .back-btn svg {
            width: 18px;
            height: 18px;
        }

        .section-header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--navy);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: var(--radius-md);
            color: var(--navy);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .quick-action-btn:hover {
            background: var(--gold);
            color: var(--deep-navy);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 169, 98, 0.3);
        }

        .quick-action-btn svg {
            width: 18px;
            height: 18px;
            color: var(--gold-dark);
        }

        .quick-action-btn:hover svg {
            color: var(--deep-navy);
        }

        .quick-action-btn.primary {
            background: var(--gold);
            color: var(--deep-navy);
            border-color: var(--gold);
        }

        .quick-action-btn.primary:hover {
            background: var(--gold-light);
        }

        .quick-action-btn.primary svg {
            color: var(--deep-navy);
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 25px;
        }

        .dashboard-card.clickable {
            cursor: pointer;
            transition: all 0.3s;
        }

        .dashboard-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card-icon {
            width: 45px;
            height: 45px;
            background: rgba(201, 169, 98, 0.15);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .card-icon svg {
            width: 22px;
            height: 22px;
            color: var(--gold-dark);
        }

        .dashboard-card h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .dashboard-card .value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            color: var(--navy);
        }

        .dashboard-card p {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 10px;
        }

        /* Recent Activity */
        .activity-list {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .activity-item {
            display: flex;
            gap: 15px;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(201, 169, 98, 0.1);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: var(--cream);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon svg {
            width: 18px;
            height: 18px;
            color: var(--gold-dark);
        }

        .activity-content h4 {
            font-size: 14px;
            color: var(--navy);
            margin-bottom: 3px;
        }

        .activity-content p {
            font-size: 13px;
            color: var(--text-light);
        }

        .activity-time {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-light);
        }

        /* Assessments List */
        .assessment-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .assessment-item {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .assessment-score {
            width: 70px;
            height: 70px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: white;
            flex-shrink: 0;
        }

        .assessment-score.good { background: var(--success); }
        .assessment-score.moderate { background: var(--warning); }
        .assessment-score.poor { background: var(--danger); }

        .assessment-details {
            flex: 1;
        }

        .assessment-details h4 {
            font-size: 16px;
            color: var(--navy);
            margin-bottom: 5px;
        }

        .assessment-details p {
            font-size: 13px;
            color: var(--text-light);
        }

        .assessment-actions {
            display: flex;
            gap: 10px;
        }

        /* Messages */
        .messages-container {
            display: flex;
            gap: 0;
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            height: 600px;
            overflow: hidden;
        }

        .messages-list {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .messages-header {
            padding: 20px;
            border-bottom: 1px solid rgba(201, 169, 98, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .messages-header-avatar {
            width: 50px;
            height: 50px;
            background: var(--navy);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
        }

        .messages-header-info h4 {
            font-size: 15px;
            color: var(--navy);
        }

        .messages-header-info p {
            font-size: 12px;
            color: var(--text-light);
        }

        .messages-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 75%;
            padding: 12px 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.received {
            background: var(--cream);
            border-radius: var(--radius-md) var(--radius-lg) var(--radius-lg) var(--radius-lg);
            align-self: flex-start;
        }

        .message.sent {
            background: var(--navy);
            color: var(--cream);
            border-radius: var(--radius-lg) var(--radius-md) var(--radius-lg) var(--radius-lg);
            align-self: flex-end;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 5px;
        }

        .message.sent .message-time {
            color: rgba(255,255,255,0.6);
        }

        .messages-input {
            padding: 15px 20px;
            border-top: 1px solid rgba(201, 169, 98, 0.2);
            display: flex;
            gap: 10px;
        }

        .messages-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .messages-input input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .messages-input button {
            padding: 12px 25px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messages-input button:hover {
            background: var(--gold-light);
        }

        /* Appointments */
        .appointments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .appointment-card {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 25px;
        }

        .appointment-card.pending {
            border-left: 4px solid var(--warning);
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
        }

        .appointment-card.confirmed {
            border-left: 4px solid var(--success);
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
        }

        .appointment-date {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .appointment-calendar {
            width: 55px;
            text-align: center;
            background: var(--cream);
            padding: 8px;
        }

        .appointment-calendar .month {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold-dark);
        }

        .appointment-calendar .day {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--navy);
        }

        .appointment-time h4 {
            font-size: 15px;
            color: var(--navy);
        }

        .appointment-time p {
            font-size: 13px;
            color: var(--text-light);
        }

        .appointment-status {
            display: inline-block;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: var(--radius-sm);
        }

        .appointment-status.pending {
            background: rgba(245, 124, 0, 0.1);
            color: var(--warning);
        }

        .appointment-status.confirmed {
            background: rgba(46, 125, 50, 0.1);
            color: var(--success);
        }

        /* Book Appointment Form */
        .book-appointment-form {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 500px;
        }

        .book-appointment-form h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 20px;
        }

        /* Sleep Diary - Enhanced */
        .diary-reminder {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #fff3e0 0%, #fffde7 100%);
            border: 1px solid #ffcc80;
            border-radius: var(--radius-lg);
            margin-bottom: 25px;
        }

        .diary-reminder-icon svg {
            width: 28px;
            height: 28px;
            stroke: #f57c00;
        }

        .diary-reminder-text {
            flex: 1;
            font-size: 14px;
            color: #e65100;
        }

        .diary-reminder-dismiss {
            background: none;
            border: none;
            font-size: 24px;
            color: #f57c00;
            cursor: pointer;
            padding: 0 5px;
        }

        .diary-section {
            margin-bottom: 30px;
        }

        .diary-label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 12px;
        }

        .diary-date-pills, .time-picker-grid, .quick-pick-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .date-pill, .time-pill, .quick-pill {
            padding: 10px 18px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-pill:hover, .time-pill:hover, .quick-pill:hover {
            background: #e8e8e8;
        }

        .date-pill.active, .time-pill.active, .quick-pill.active {
            background: var(--gold);
            color: var(--deep-navy);
            border-color: var(--gold);
        }

        .quality-rating {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .quality-star {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            background: #f8f8f8;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quality-star:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .quality-star.active {
            background: linear-gradient(135deg, #fff8e6 0%, #fffdf8 100%);
            border-color: var(--gold);
        }

        .quality-star.active svg {
            fill: var(--gold);
            stroke: var(--gold);
        }

        .quality-star svg {
            width: 32px;
            height: 32px;
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5;
            transition: all 0.2s;
        }

        .quality-star span {
            font-size: 11px;
            color: #888;
            text-align: center;
        }

        .quality-star.active span {
            color: var(--navy);
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .quality-rating {
                flex-wrap: wrap;
            }
            .quality-star {
                flex: 0 0 calc(33% - 7px);
            }
        }

        /* Sleep Diary */
        .diary-form {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 30px;
        }

        .diary-form h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 20px;
        }

        .diary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .diary-chart {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 25px;
        }

        .diary-history {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .diary-entry {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .diary-entry-date {
            text-align: center;
            min-width: 60px;
        }

        .diary-entry-date .day {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
        }

        .diary-entry-date .month {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .diary-entry-stats {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .diary-stat {
            text-align: center;
        }

        .diary-stat span {
            display: block;
            font-size: 11px;
            color: var(--text-light);
        }

        .diary-stat strong {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--navy);
        }

        /* Sleep Diary Tabs */
        .diary-tabs {
            display: flex;
            gap: 5px;
            background: rgba(15, 28, 46, 0.05);
            padding: 5px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
        }

        .diary-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .diary-tab:hover {
            color: var(--navy);
            background: rgba(255,255,255,0.5);
        }

        .diary-tab.active {
            background: white;
            color: var(--navy);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .diary-tab svg {
            width: 16px;
            height: 16px;
        }

        .diary-tab-content {
            display: none;
        }

        .diary-tab-content.active {
            display: block;
        }

        /* Sleep Analytics Dashboard */
        .analytics-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .analytics-period {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            padding: 8px 16px;
            border: 1px solid rgba(201, 169, 98, 0.3);
            background: white;
            color: var(--text);
            font-size: 12px;
            font-weight: 500;
            border-radius: var(--radius-pill);
            cursor: pointer;
            transition: all 0.3s;
        }

        .period-btn:hover {
            border-color: var(--gold);
        }

        .period-btn.active {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
        }

        /* Sleep Score Card */
        .sleep-score-card {
            background: linear-gradient(135deg, var(--navy) 0%, #1a2d47 100%);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .sleep-score-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(201, 169, 98, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        .sleep-score-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .sleep-score-circle {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .sleep-score-ring {
            transform: rotate(-90deg);
        }

        .sleep-score-ring-bg {
            fill: none;
            stroke: rgba(255,255,255,0.1);
            stroke-width: 8;
        }

        .sleep-score-ring-progress {
            fill: none;
            stroke: var(--gold);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .sleep-score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .sleep-score-number {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            color: white;
            line-height: 1;
        }

        .sleep-score-label {
            font-size: 10px;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sleep-score-details {
            flex: 1;
            min-width: 200px;
        }

        .sleep-score-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            color: white;
            margin-bottom: 5px;
        }

        .sleep-score-subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 15px;
        }

        .sleep-score-breakdown {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .score-component {
            text-align: center;
        }

        .score-component-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--gold);
        }

        .score-component-label {
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
        }

        /* Streak Badge */
        .streak-badge {
            background: rgba(201, 169, 98, 0.2);
            border: 1px solid var(--gold);
            border-radius: var(--radius-md);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .streak-icon {
            width: 40px;
            height: 40px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .streak-info {
            text-align: left;
        }

        .streak-count {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: white;
        }

        .streak-label {
            font-size: 11px;
            color: var(--gold);
        }

        /* Analytics Charts Grid */
        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 25px;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            color: var(--navy);
        }

        .chart-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
        }

        .chart-trend.up {
            color: #2E7D32;
        }

        .chart-trend.down {
            color: #C62828;
        }

        .chart-trend.neutral {
            color: var(--text-light);
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        /* Weekly Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .summary-card:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
        }

        .summary-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            background: rgba(201, 169, 98, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .summary-icon svg {
            width: 20px;
            height: 20px;
            color: var(--gold-dark);
        }

        .summary-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 26px;
            color: var(--navy);
            line-height: 1.2;
        }

        .summary-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-change {
            font-size: 11px;
            margin-top: 5px;
        }

        .summary-change.positive {
            color: #2E7D32;
        }

        .summary-change.negative {
            color: #C62828;
        }

        /* Insights Section */
        .insights-section {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 25px;
        }

        .insights-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .insights-icon {
            width: 35px;
            height: 35px;
            background: rgba(201, 169, 98, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .insights-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--navy);
        }

        .insight-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border-radius: var(--radius-md);
            padding: 18px;
            margin-bottom: 12px;
            border-left: 4px solid var(--gold);
        }

        .insight-card:last-child {
            margin-bottom: 0;
        }

        .insight-type {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold-dark);
            margin-bottom: 5px;
        }

        .insight-text {
            font-size: 14px;
            color: var(--text);
            line-height: 1.5;
        }

        .insight-action {
            margin-top: 10px;
            font-size: 13px;
            color: var(--navy);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Achievement Badges */
        .achievements-grid {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .achievement-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            transition: all 0.3s;
        }

        .achievement-badge.earned {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(201, 169, 98, 0.05) 0%, rgba(255,255,255,1) 100%);
        }

        .achievement-badge.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .achievement-badge.earned .achievement-icon {
            background: var(--gold);
        }

        .achievement-badge.locked .achievement-icon {
            background: #e0e0e0;
        }

        .achievement-info h5 {
            font-size: 13px;
            color: var(--navy);
            margin-bottom: 2px;
        }

        .achievement-info p {
            font-size: 11px;
            color: var(--text-light);
        }

        /* Evening Check-in */
        .checkin-card {
            background: linear-gradient(135deg, #f0f7ff 0%, #fff 100%);
            border: 1px solid rgba(74, 96, 133, 0.2);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 25px;
        }

        .checkin-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .checkin-icon {
            width: 45px;
            height: 45px;
            background: var(--navy);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkin-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--navy);
        }

        .checkin-subtitle {
            font-size: 13px;
            color: var(--text-light);
        }

        .checkin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkin-item {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.15);
            border-radius: var(--radius-md);
            padding: 15px;
        }

        .checkin-item label {
            display: block;
            font-size: 13px;
            color: var(--text);
            margin-bottom: 10px;
        }

        .checkin-slider {
            width: 100%;
            margin-bottom: 8px;
        }

        .checkin-value {
            text-align: center;
            font-size: 12px;
            color: var(--text-light);
        }

        @media (max-width: 768px) {
            .analytics-charts {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .sleep-score-content {
                flex-direction: column;
                text-align: center;
            }

            .streak-badge {
                width: 100%;
                justify-content: center;
            }

            .diary-tabs {
                flex-direction: column;
            }
        }

        /* Sleep Knowledge Quiz */
        .quiz-container {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-top: 40px;
        }

        .quiz-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .quiz-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quiz-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
        }

        .quiz-subtitle {
            font-size: 14px;
            color: var(--text-light);
        }

        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: rgba(15, 28, 46, 0.03);
            border-radius: var(--radius-md);
        }

        .quiz-progress-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .quiz-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold) 0%, var(--gold-dark) 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .quiz-progress-text {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
        }

        .quiz-question {
            margin-bottom: 25px;
        }

        .quiz-question-number {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold-dark);
            margin-bottom: 10px;
        }

        .quiz-question-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            color: var(--navy);
            line-height: 1.4;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .quiz-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: #fafafa;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover:not(.disabled) {
            background: rgba(201, 169, 98, 0.08);
            border-color: rgba(201, 169, 98, 0.3);
        }

        .quiz-option.selected {
            background: rgba(201, 169, 98, 0.1);
            border-color: var(--gold);
        }

        .quiz-option.correct {
            background: rgba(46, 125, 50, 0.1);
            border-color: #2E7D32;
        }

        .quiz-option.incorrect {
            background: rgba(198, 40, 40, 0.1);
            border-color: #C62828;
        }

        .quiz-option.disabled {
            cursor: default;
        }

        .quiz-option-letter {
            width: 32px;
            height: 32px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-light);
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .quiz-option.selected .quiz-option-letter {
            background: var(--gold);
            border-color: var(--gold);
            color: white;
        }

        .quiz-option.correct .quiz-option-letter {
            background: #2E7D32;
            border-color: #2E7D32;
            color: white;
        }

        .quiz-option.incorrect .quiz-option-letter {
            background: #C62828;
            border-color: #C62828;
            color: white;
        }

        .quiz-option-text {
            font-size: 15px;
            color: var(--text);
            line-height: 1.4;
        }

        .quiz-feedback {
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            display: none;
        }

        .quiz-feedback.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .quiz-feedback.correct {
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1) 0%, rgba(46, 125, 50, 0.05) 100%);
            border-left: 4px solid #2E7D32;
        }

        .quiz-feedback.incorrect {
            background: linear-gradient(135deg, rgba(198, 40, 40, 0.1) 0%, rgba(198, 40, 40, 0.05) 100%);
            border-left: 4px solid #C62828;
        }

        .quiz-feedback-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .quiz-feedback-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quiz-feedback.correct .quiz-feedback-icon {
            background: #2E7D32;
        }

        .quiz-feedback.incorrect .quiz-feedback-icon {
            background: #C62828;
        }

        .quiz-feedback-title {
            font-weight: 600;
            font-size: 16px;
        }

        .quiz-feedback.correct .quiz-feedback-title {
            color: #2E7D32;
        }

        .quiz-feedback.incorrect .quiz-feedback-title {
            color: #C62828;
        }

        .quiz-feedback-explanation {
            font-size: 14px;
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .quiz-feedback-tip {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.7);
            border-radius: var(--radius-sm);
        }

        .quiz-feedback-tip svg {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .quiz-feedback-tip-text {
            font-size: 13px;
            color: var(--navy);
        }

        .quiz-feedback-tip-text strong {
            color: var(--gold-dark);
        }

        .quiz-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .quiz-btn {
            padding: 12px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quiz-btn-primary {
            background: var(--navy);
            color: white;
            border: none;
        }

        .quiz-btn-primary:hover {
            background: #1a2d47;
        }

        .quiz-btn-secondary {
            background: white;
            color: var(--navy);
            border: 2px solid var(--navy);
        }

        .quiz-btn-secondary:hover {
            background: var(--navy);
            color: white;
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quiz Results */
        .quiz-results {
            text-align: center;
            padding: 40px 20px;
        }

        .quiz-results-score {
            width: 140px;
            height: 140px;
            margin: 0 auto 25px;
            position: relative;
        }

        .quiz-results-ring {
            transform: rotate(-90deg);
        }

        .quiz-results-ring-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 10;
        }

        .quiz-results-ring-progress {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }

        .quiz-results-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .quiz-results-number {
            font-family: 'Cormorant Garamond', serif;
            font-size: 42px;
            color: var(--navy);
            line-height: 1;
        }

        .quiz-results-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .quiz-results-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--navy);
            margin-bottom: 10px;
        }

        .quiz-results-subtitle {
            font-size: 15px;
            color: var(--text-light);
            margin-bottom: 30px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .quiz-results-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
        }

        .quiz-results-stat {
            text-align: center;
        }

        .quiz-results-stat-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--navy);
        }

        .quiz-results-stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .quiz-start-card {
            text-align: center;
            padding: 40px 20px;
        }

        .quiz-start-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, rgba(201, 169, 98, 0.2) 0%, rgba(201, 169, 98, 0.1) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quiz-start-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 26px;
            color: var(--navy);
            margin-bottom: 10px;
        }

        .quiz-start-desc {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 25px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .quiz-start-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .quiz-start-feature {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text);
        }

        .quiz-category-btn {
            transition: all 0.3s ease;
        }

        .quiz-category-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .quiz-category-btn.active {
            border-color: var(--gold) !important;
            background: rgba(201, 169, 98, 0.1) !important;
        }

        /* Modules */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .module-card {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: all 0.3s;
        }

        .module-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .module-card.locked {
            opacity: 0.7;
        }

        .module-card h4 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .module-card p {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .module-card .module-meta {
            font-size: 11px;
            color: var(--gold-dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Resource Groups */
        .resource-group {
            margin-bottom: 35px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(201, 169, 98, 0.15);
        }

        .resource-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .resource-group-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            color: var(--navy);
            margin: 0 0 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resource-group-title svg {
            color: var(--gold);
        }

        .resource-group-desc {
            font-size: 14px;
            color: var(--text-light);
            margin: 0 0 20px;
        }

        .resource-group .modules-grid:empty + .empty-group-msg,
        .resource-group .modules-grid:empty {
            display: none;
        }

        /* Substance checkboxes */
        .substance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .substance-check {
            cursor: pointer;
        }

        .substance-check input {
            display: none;
        }

        .substance-box {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            font-size: 14px;
            color: #555;
            transition: all 0.2s;
        }

        .substance-check input:checked + .substance-box {
            background: rgba(201, 169, 98, 0.15);
            border-color: var(--gold);
            color: var(--navy);
        }

        .substance-box svg {
            color: #888;
            flex-shrink: 0;
        }

        .substance-check input:checked + .substance-box svg {
            color: var(--gold);
        }

        /* Rested buttons styling */
        .rested-btn svg {
            stroke-width: 1.5;
        }

        /* NPS Scale */
        .nps-scale {
            margin-top: 10px;
        }

        .nps-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .nps-buttons {
            display: flex;
            gap: 6px;
        }

        .nps-btn {
            flex: 1;
            min-width: 32px;
            height: 42px;
            border: 2px solid #e0e0e0;
            background: #f8f8f8;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nps-btn:hover {
            border-color: var(--gold);
            background: rgba(201, 169, 98, 0.1);
        }

        .nps-btn.active {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--deep-navy);
        }

        /* Detractor (0-6) */
        .nps-btn.active[data-value="0"],
        .nps-btn.active[data-value="1"],
        .nps-btn.active[data-value="2"],
        .nps-btn.active[data-value="3"],
        .nps-btn.active[data-value="4"],
        .nps-btn.active[data-value="5"],
        .nps-btn.active[data-value="6"] {
            background: #ef5350;
            border-color: #ef5350;
            color: white;
        }

        /* Passive (7-8) */
        .nps-btn.active[data-value="7"],
        .nps-btn.active[data-value="8"] {
            background: #ffc107;
            border-color: #ffc107;
            color: #333;
        }

        /* Promoter (9-10) */
        .nps-btn.active[data-value="9"],
        .nps-btn.active[data-value="10"] {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }

        /* Discharge pill buttons */
        .discharge-pill {
            font-size: 13px;
        }

        /* AI Chatbot Widget */
        .chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
        }

        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, var(--gold) 0%, #b8923c 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(201, 169, 98, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(201, 169, 98, 0.5);
        }

        .chat-toggle svg {
            width: 28px;
            height: 28px;
            color: var(--deep-navy);
        }

        .chat-toggle .close-icon {
            display: none;
        }

        .chat-widget.open .chat-toggle .chat-icon {
            display: none;
        }

        .chat-widget.open .chat-toggle .close-icon {
            display: block;
        }

        .chat-panel {
            position: absolute;
            bottom: 75px;
            right: 0;
            width: 380px;
            height: 520px;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-widget.open .chat-panel {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }

        @keyframes chatSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-header {
            background: var(--deep-navy);
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            background: var(--gold);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-header-avatar svg {
            width: 22px;
            height: 22px;
            color: var(--deep-navy);
        }

        .chat-header-info h4 {
            color: var(--cream);
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }

        .chat-header-info p {
            color: var(--gold);
            font-size: 12px;
            margin: 2px 0 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.assistant {
            align-items: flex-start;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.user .chat-bubble {
            background: var(--deep-navy);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .chat-message.assistant .chat-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: var(--radius-sm);
        }

        .chat-bubble p {
            margin: 0 0 8px;
        }

        .chat-bubble p:last-child {
            margin-bottom: 0;
        }

        .chat-bubble ul, .chat-bubble ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .chat-bubble strong {
            color: var(--navy);
        }

        .chat-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius-lg);
            border-bottom-left-radius: var(--radius-sm);
            width: fit-content;
        }

        .chat-typing span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .chat-typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .chat-typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 16px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-contact-btn:hover {
            background: #b8923c;
        }

        .chat-input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--gold);
        }

        .chat-send {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: var(--gold);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat-send:hover {
            background: #b8923c;
        }

        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .chat-send svg {
            width: 20px;
            height: 20px;
            color: var(--deep-navy);
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .chat-suggestion {
            padding: 8px 14px;
            background: rgba(201, 169, 98, 0.1);
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: var(--radius-md);
            font-size: 12px;
            color: var(--navy);
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-suggestion:hover {
            background: rgba(201, 169, 98, 0.2);
            border-color: var(--gold);
        }

        @media (max-width: 768px) {
            .chat-panel {
                width: calc(100vw - 32px);
                height: calc(100vh - 120px);
                bottom: 70px;
                right: -8px;
            }
        }

        /* Questionnaires */
        .questionnaires-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .questionnaire-card {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            padding: 20px;
            border-radius: var(--radius-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
        }

        .questionnaire-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .questionnaire-card.pending {
            border-left: 4px solid var(--gold);
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
        }

        .questionnaire-card.completed {
            border-left: 4px solid #2e7d32;
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
        }

        .questionnaire-card.overdue {
            border-left: 4px solid #c62828;
            background: #fff5f5;
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
        }

        .questionnaire-info h4 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            color: var(--navy);
            margin-bottom: 5px;
        }

        .questionnaire-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-light);
        }

        .questionnaire-result {
            text-align: right;
        }

        .questionnaire-score {
            font-size: 24px;
            font-weight: 600;
            color: var(--navy);
        }

        .questionnaire-severity {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            color: white;
        }

        /* Profile */
        .profile-form {
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 600px;
        }

        .profile-form h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 20px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            background: white;
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: var(--radius-lg);
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            color: var(--gold);
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 25px;
        }

        /* ========== ONBOARDING & ANIMATIONS ========== */

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(201, 169, 98, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(201, 169, 98, 0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 28, 46, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .welcome-modal.active { display: flex; }

        .welcome-modal .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .welcome-modal .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--gold);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite;
        }

        .welcome-card {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 520px;
            width: 90%;
            overflow: hidden;
            position: relative;
            animation: slideIn 0.6s ease;
        }

        .welcome-header {
            background: linear-gradient(135deg, var(--deep-navy) 0%, #1a3a5c 100%);
            padding: 40px 35px 35px;
            text-align: center;
            position: relative;
        }

        .welcome-header::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 20px solid #1a3a5c;
        }

        .welcome-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(201, 169, 98, 0.2);
            border: 1px solid var(--gold);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--gold);
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            color: white;
            margin: 0 0 8px;
            line-height: 1.2;
        }

        .welcome-name { color: var(--gold); }

        .welcome-subtitle {
            font-size: 15px;
            color: rgba(255,255,255,0.7);
            margin: 0;
        }

        .welcome-body {
            padding: 35px 35px 30px;
        }

        .welcome-program-intro {
            font-size: 15px;
            line-height: 1.8;
            color: #555;
            margin-bottom: 25px;
        }

        .welcome-features {
            display: grid;
            gap: 12px;
            margin-bottom: 25px;
        }

        .welcome-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(201, 169, 98, 0.08), rgba(201, 169, 98, 0.03));
            border-radius: 10px;
        }

        .welcome-feature-icon {
            width: 36px;
            height: 36px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .welcome-feature-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--deep-navy);
        }

        .welcome-feature span {
            font-size: 14px;
            color: var(--navy);
        }

        .welcome-gdpr {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .welcome-gdpr-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }

        .welcome-gdpr-checkbox input {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: var(--gold);
            flex-shrink: 0;
        }

        .welcome-gdpr-checkbox span {
            font-size: 12px;
            line-height: 1.6;
            color: #666;
        }

        .welcome-gdpr-checkbox a {
            color: var(--gold-dark);
            text-decoration: underline;
        }

        .welcome-btn-primary {
            width: 100%;
            padding: 16px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .welcome-btn-primary:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(201, 169, 98, 0.3);
        }

        .welcome-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Spotlight Tour */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9998;
            pointer-events: none;
            display: none;
        }

        .tour-overlay.active {
            display: block;
            pointer-events: auto;
        }

        .tour-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 28, 46, 0.85);
            transition: all 0.4s ease;
        }

        .tour-spotlight {
            position: absolute;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(15, 28, 46, 0.85);
            transition: all 0.4s ease;
            animation: pulse 2s infinite;
        }

        .tour-tooltip {
            position: absolute;
            background: white;
            border-radius: 16px;
            padding: 25px;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideIn 0.4s ease;
        }

        .tour-tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
        }

        .tour-tooltip-arrow.top {
            top: -12px;
            left: 30px;
            border-bottom: 12px solid white;
        }

        .tour-tooltip-arrow.bottom {
            bottom: -12px;
            left: 30px;
            border-top: 12px solid white;
        }

        .tour-step-indicator {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
        }

        .tour-step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .tour-step-dot.active { background: var(--gold); }
        .tour-step-dot.completed { background: var(--navy); }

        .tour-tooltip h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            color: var(--navy);
            margin: 0 0 10px;
        }

        .tour-tooltip p {
            font-size: 14px;
            line-height: 1.7;
            color: #666;
            margin: 0 0 20px;
        }

        .tour-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .tour-skip {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #999;
            font-size: 13px;
            cursor: pointer;
        }

        .tour-skip:hover { color: #666; }

        .tour-next {
            padding: 10px 24px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .tour-next:hover { background: var(--gold-light); }

        /* Assessment Reminder Modal */
        .assessment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 28, 46, 0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .assessment-modal.active { display: flex; }

        .assessment-card {
            background: white;
            border-radius: 20px;
            max-width: 480px;
            width: 90%;
            overflow: hidden;
            animation: slideIn 0.5s ease;
            text-align: center;
        }

        .assessment-header {
            background: linear-gradient(135deg, var(--gold) 0%, #d4b978 100%);
            padding: 40px 30px;
        }

        .assessment-icon {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .assessment-icon svg {
            width: 40px;
            height: 40px;
            stroke: var(--gold);
        }

        .assessment-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--deep-navy);
            margin: 0;
        }

        .assessment-body {
            padding: 30px;
        }

        .assessment-body p {
            font-size: 15px;
            line-height: 1.7;
            color: #555;
            margin: 0 0 25px;
        }

        .assessment-deadline {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(201, 169, 98, 0.1);
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .assessment-deadline svg {
            width: 20px;
            height: 20px;
            stroke: var(--gold);
        }

        .assessment-deadline span {
            font-size: 14px;
            font-weight: 600;
            color: var(--navy);
        }

        .assessment-actions {
            display: flex;
            gap: 12px;
        }

        .assessment-later {
            flex: 1;
            padding: 14px;
            background: #f5f5f5;
            color: #666;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .assessment-later:hover { background: #eee; }

        .assessment-start {
            flex: 2;
            padding: 14px;
            background: var(--gold);
            color: var(--deep-navy);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .assessment-start:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
        }

        /* Tasks Notification Banner */
        .tasks-banner {
            background: linear-gradient(135deg, #fff8e6 0%, #fffdf8 100%);
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: var(--radius-lg);
            padding: 20px 25px;
            margin-bottom: 25px;
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .tasks-banner.show {
            display: block;
        }

        .tasks-banner-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .tasks-banner-icon {
            width: 45px;
            height: 45px;
            background: var(--gold);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tasks-banner-icon svg {
            width: 22px;
            height: 22px;
            stroke: var(--deep-navy);
        }

        .tasks-banner-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--navy);
            margin: 0;
        }

        .tasks-banner-subtitle {
            font-size: 13px;
            color: var(--text-light);
            margin: 0;
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(201, 169, 98, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .task-item.high-priority {
            border-left: 3px solid #c62828;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--gold);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 3px;
        }

        .task-due {
            font-size: 12px;
            color: var(--text-light);
        }

        .task-due.overdue {
            color: #c62828;
            font-weight: 500;
        }

        /* Dashboard Card Animations */
        .dashboard-card {
            opacity: 0;
            animation: fadeInUp 0.5s ease forwards;
        }

        .dashboard-card:nth-child(1) { animation-delay: 0.1s; }
        .dashboard-card:nth-child(2) { animation-delay: 0.2s; }
        .dashboard-card:nth-child(3) { animation-delay: 0.3s; }
        .dashboard-card:nth-child(4) { animation-delay: 0.4s; }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: #c62828;
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 1s ease;
        }

        /* ========== END ONBOARDING & ANIMATIONS ========== */

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }

            .sidebar-header {
                padding: 0 10px 20px;
            }

            .sidebar-user {
                justify-content: center;
            }

            .sidebar-user-info {
                display: none;
            }

            .sidebar-nav a {
                padding: 14px 20px;
                justify-content: center;
            }

            .sidebar-nav a span {
                display: none;
            }

            .sidebar-nav .badge {
                position: absolute;
                top: 5px;
                right: 10px;
            }

            .sidebar-footer {
                text-align: center;
            }

            .logout-btn span {
                display: none;
            }

            .dashboard-main {
                margin-left: 80px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-layout {
                flex-direction: column;
            }

            .sidebar {
                position: static;
                width: 100%;
                padding: 15px 0;
            }

            .sidebar-header {
                display: none;
            }

            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 0 15px;
            }

            .sidebar-nav li {
                margin: 0;
            }

            .sidebar-nav a {
                padding: 10px 15px;
                white-space: nowrap;
            }

            .sidebar-nav a span {
                display: inline;
            }

            .sidebar-footer {
                display: none;
            }

            .dashboard-main {
                margin-left: 0;
                padding: 20px;
            }

            .diary-entry-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>

<!-- Welcome Modal (for new users) -->
<div class="welcome-modal" id="welcomeModal">
    <div class="particles" id="welcomeParticles"></div>
    <div class="welcome-card">
        <div class="welcome-header">
            <div class="welcome-badge" id="welcomeBadge">ATHLETE PROGRAM</div>
            <h1 class="welcome-title">Welcome, <span class="welcome-name" id="welcomeName">Friend</span></h1>
            <p class="welcome-subtitle">Your personalized sleep optimization journey begins</p>
        </div>
        <div class="welcome-body">
            <p class="welcome-program-intro" id="welcomeIntro">
                I'm Dr. Alen Juginovic, a Harvard sleep scientist and physician. Over the next few weeks, we'll work together to optimize your sleep for peak performance and recovery.
            </p>
            <div class="welcome-features" id="welcomeFeatures">
                <div class="welcome-feature">
                    <div class="welcome-feature-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    </div>
                    <span>Personalized sleep assessment & analysis</span>
                </div>
                <div class="welcome-feature">
                    <div class="welcome-feature-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                    </div>
                    <span>Daily tracking & progress monitoring</span>
                </div>
                <div class="welcome-feature">
                    <div class="welcome-feature-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <span>Direct messaging with Dr. Alen</span>
                </div>
            </div>
            <div class="welcome-gdpr">
                <label class="welcome-gdpr-checkbox">
                    <input type="checkbox" id="welcomeConsent">
                    <span>I consent to the collection of my sleep and health data for personalized sleep consultation. My data will be kept confidential and used only to provide recommendations. I can request deletion at any time. <a href="#" onclick="showPrivacyPolicy(event)">Privacy Policy</a></span>
                </label>
            </div>
            <button class="welcome-btn-primary" id="welcomeContinueBtn" onclick="startTour()" disabled>
                Continue
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
            </button>
        </div>
    </div>
</div>

<!-- Spotlight Tour Overlay -->
<div class="tour-overlay" id="tourOverlay">
    <div class="tour-spotlight" id="tourSpotlight"></div>
    <div class="tour-tooltip" id="tourTooltip">
        <div class="tour-tooltip-arrow top" id="tourArrow"></div>
        <div class="tour-step-indicator" id="tourStepIndicator"></div>
        <h3 id="tourTitle">Dashboard Overview</h3>
        <p id="tourText">This is your central hub for tracking sleep progress and accessing all features.</p>
        <div class="tour-actions">
            <button class="tour-skip" onclick="skipTour()">Skip Tour</button>
            <button class="tour-next" onclick="nextTourStep()">
                Next
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
        </div>
    </div>
</div>

<!-- Assessment Reminder Modal -->
<div class="assessment-modal" id="assessmentModal">
    <div class="assessment-card">
        <div class="assessment-header">
            <div class="assessment-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
            </div>
            <h2>One Last Thing</h2>
        </div>
        <div class="assessment-body">
            <p>To create your personalized sleep plan, I need to understand your current sleep patterns. Please complete your initial assessment within the next 24 hours.</p>
            <div class="assessment-deadline">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span>Complete within 24 hours</span>
            </div>
            <div class="assessment-actions">
                <button class="assessment-later" onclick="dismissAssessmentModal()">I'll Do It Later</button>
                <button class="assessment-start" onclick="startAssessmentNow()">
                    Start Assessment
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<nav class="nav">
    <a href="../index.html" class="nav-brand">
        <span class="nav-brand-main">SLEEP WELLNESS</span>
        <span class="nav-brand-sub">by Dr. Alen</span>
    </a>
    <div class="nav-links">
        <a href="account.html" class="active" data-auth="logged-in">My Account</a>
        <a href="auth.html" data-auth="logged-out">Sign In</a>
    </div>
</nav>

<!-- Dashboard Layout -->
<div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-user">
                <div class="sidebar-avatar" id="userAvatar">--</div>
                <div class="sidebar-user-info">
                    <h4 data-user-name>Loading...</h4>
                    <p>Client</p>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <li><a href="#dashboard" class="active" onclick="showSection('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span>Dashboard</span>
            </a></li>
            <li><a href="#assessments" onclick="showSection('assessments')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                </svg>
                <span>Assessments</span>
            </a></li>
            <li><a href="#questionnaires" onclick="showSection('questionnaires')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                <span>Questionnaires</span>
                <span class="badge" id="questionnaireBadge" style="display: none;">0</span>
            </a></li>
            <li><a href="#diary" onclick="showSection('diary')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                <span>Sleep Diary</span>
            </a></li>
            <li><a href="#messages" onclick="showSection('messages')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span>Messages</span>
                <span class="badge" id="unreadBadge" style="display: none;">0</span>
            </a></li>
            <li><a href="#appointments" onclick="showSection('appointments')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span>Appointments</span>
            </a></li>
            <li><a href="#education" onclick="showSection('education')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
                <span>Learn About Sleep</span>
            </a></li>
            <li><a href="#modules" onclick="showSection('modules')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                    <polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>
                </svg>
                <span>Sleep Resources</span>
            </a></li>
            <li><a href="#profile" onclick="showSection('profile')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Profile</span>
            </a></li>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="Auth.logout()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>Log Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Dashboard Section -->
        <section class="dashboard-section active" id="section-dashboard">
            <div class="section-header">
                <h1>Welcome back, <span data-user-name>User</span></h1>
                <a href="take-assessment.html" class="btn-primary">Take Assessment</a>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <a href="#appointments" onclick="showSection('appointments')" class="quick-action-btn primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                        <line x1="12" y1="14" x2="12" y2="18"/>
                        <line x1="10" y1="16" x2="14" y2="16"/>
                    </svg>
                    Schedule Appointment
                </a>
                <a href="#messages" onclick="showSection('messages')" class="quick-action-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Messages
                </a>
                <a href="mailto:alen_juginovic@hms.harvard.edu?subject=Sleep%20Wellness%20Inquiry" class="quick-action-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Email Dr. Alen
                </a>
                <a href="#diary" onclick="showSection('diary')" class="quick-action-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                    Log Sleep
                </a>
                <!-- Hotel Guest Checkout Button (shown only for hotel guests) -->
                <a href="#" onclick="showCheckoutWizard(); return false;" class="quick-action-btn hotel-checkout-btn" id="checkoutBtn" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    Complete Your Stay
                </a>
            </div>

            <!-- Hotel Stay Banner (shown for hotel guests) -->
            <div id="hotelStayBanner" style="display: none; background: linear-gradient(135deg, #0f1c2e, #1a2a3a); border-radius: 12px; padding: 20px 25px; margin-bottom: 25px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Your Stay at</p>
                        <h3 id="hotelBannerName" style="font-family: 'Cormorant Garamond', serif; font-size: 24px; margin: 0;">Hotel Name</h3>
                        <p id="hotelBannerDates" style="font-size: 13px; color: rgba(255,255,255,0.7); margin-top: 5px;">Room 123 | Jan 15 - 18</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 3px;">Days Remaining</p>
                        <p id="hotelDaysRemaining" style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: #C9A962; margin: 0;">3</p>
                    </div>
                </div>
            </div>

            <!-- Tasks Banner -->
            <div class="tasks-banner" id="tasksBanner">
                <div class="tasks-banner-header">
                    <div class="tasks-banner-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="tasks-banner-title">Your Tasks</h3>
                        <p class="tasks-banner-subtitle" id="tasksSubtitle">You have tasks to complete</p>
                    </div>
                </div>
                <div class="tasks-list" id="tasksList">
                    <!-- Tasks populated by JS -->
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card clickable" onclick="showSection('assessments')">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <h3>Assessments</h3>
                    <div class="value" id="assessmentCount">0</div>
                    <p>Completed assessments</p>
                </div>

                <div class="dashboard-card clickable" onclick="showSection('diary')">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <h3>Sleep Efficiency</h3>
                    <div class="value" id="avgEfficiency">--%</div>
                    <p>7-day average</p>
                </div>

                <div class="dashboard-card clickable" onclick="showSection('appointments')">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                        </svg>
                    </div>
                    <h3>Next Appointment</h3>
                    <div class="value" id="nextAppointment">--</div>
                    <p id="nextAppointmentDetails">No upcoming appointments</p>
                </div>

                <div class="dashboard-card clickable" onclick="showSection('modules')">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                            <polyline points="2 17 12 22 22 17"/>
                        </svg>
                    </div>
                    <h3>Unlocked Resources</h3>
                    <div class="value" id="unlockedCount">0</div>
                    <p>Therapeutic modules</p>
                </div>
            </div>

            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--navy); margin-bottom: 20px;">Recent Activity</h2>
            <div class="activity-list" id="activityList">
                <div class="empty-state">
                    <p>No recent activity</p>
                </div>
            </div>
        </section>

        <!-- Assessments Section -->
        <section class="dashboard-section" id="section-assessments">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>My Assessments</h1>
                </div>
                <a href="take-assessment.html" class="btn-primary">Take New Assessment</a>
            </div>

            <div class="assessment-list" id="assessmentList">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <h3>No Assessments Yet</h3>
                    <p>Complete your first sleep assessment to track your progress.</p>
                    <a href="take-assessment.html" class="btn-primary">Take Assessment</a>
                </div>
            </div>
        </section>

        <!-- Sleep Diary Section - Based on Consensus Sleep Diary -->
        <section class="dashboard-section" id="section-diary">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>Sleep Diary</h1>
                </div>
            </div>

            <!-- Diary Reminder Banner -->
            <div class="diary-reminder" id="diaryReminder" style="display: none;">
                <div class="diary-reminder-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div class="diary-reminder-text">
                    <strong>Good morning!</strong> Don't forget to log last night's sleep.
                </div>
                <button class="diary-reminder-dismiss" onclick="dismissDiaryReminder()"></button>
            </div>

            <!-- Diary Tabs -->
            <div class="diary-tabs">
                <button class="diary-tab active" onclick="switchDiaryTab('log')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    Log Entry
                </button>
                <button class="diary-tab" onclick="switchDiaryTab('history')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    History
                </button>
                <button class="diary-tab" onclick="switchDiaryTab('analytics')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    Analytics
                </button>
                <button class="diary-tab" onclick="switchDiaryTab('evening')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    Evening Check-in
                </button>
            </div>

            <!-- Log Entry Tab -->
            <div class="diary-tab-content active" id="diary-tab-log">
            <div class="diary-form">
                <h3>Log Your Sleep</h3>
                <p style="color: var(--text-light); margin-bottom: 25px; font-size: 14px;">Based on the Consensus Sleep Diary - Complete each morning</p>

                <form id="diaryForm" onsubmit="saveDiaryEntry(event)">
                    <!-- Date Selection -->
                    <div class="diary-section">
                        <label class="diary-label">1. What date are you reporting on?</label>
                        <div class="diary-date-pills">
                            <button type="button" class="date-pill" onclick="setDiaryDate(-1)">Last Night</button>
                            <button type="button" class="date-pill active" onclick="setDiaryDate(0)">Tonight</button>
                        </div>
                        <input type="date" id="diaryDate" required style="margin-top: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <!-- Bedtime -->
                    <div class="diary-section">
                        <label class="diary-label">2. What time did you get into bed?</label>
                        <div class="time-picker-grid">
                            <button type="button" class="time-pill" data-field="bedtime" data-time="21:00">9 PM</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="21:30">9:30</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="22:00">10 PM</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="22:30">10:30</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="23:00">11 PM</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="23:30">11:30</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="00:00">12 AM</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="00:30">12:30</button>
                            <button type="button" class="time-pill" data-field="bedtime" data-time="01:00">1 AM</button>
                        </div>
                        <input type="time" id="diaryBedtime" placeholder="Or enter exact time" style="margin-top: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <!-- Lights Out / Try to Sleep -->
                    <div class="diary-section">
                        <label class="diary-label">3. What time did you try to go to sleep?</label>
                        <div class="time-picker-grid">
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="21:00">9 PM</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="21:30">9:30</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="22:00">10 PM</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="22:30">10:30</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="23:00">11 PM</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="23:30">11:30</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="00:00">12 AM</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="00:30">12:30</button>
                            <button type="button" class="time-pill" data-field="lightsOut" data-time="01:00">1 AM</button>
                        </div>
                        <input type="time" id="diaryLightsOut" style="margin-top: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <!-- Sleep Latency -->
                    <div class="diary-section">
                        <label class="diary-label">4. How long did it take you to fall asleep?</label>
                        <div class="quick-pick-grid">
                            <button type="button" class="quick-pill" data-field="latency" data-value="0">Immediately</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="5">~5 min</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="10">~10 min</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="15">~15 min</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="20">~20 min</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="30">~30 min</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="45">~45 min</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="60">~1 hour</button>
                            <button type="button" class="quick-pill" data-field="latency" data-value="90">1+ hours</button>
                        </div>
                        <input type="hidden" id="diaryLatency" value="">
                    </div>

                    <!-- Night Awakenings -->
                    <div class="diary-section">
                        <label class="diary-label">5. How many times did you wake up, not counting your final awakening?</label>
                        <div class="quick-pick-grid">
                            <button type="button" class="quick-pill" data-field="awakenings" data-value="0">0</button>
                            <button type="button" class="quick-pill" data-field="awakenings" data-value="1">1</button>
                            <button type="button" class="quick-pill" data-field="awakenings" data-value="2">2</button>
                            <button type="button" class="quick-pill" data-field="awakenings" data-value="3">3</button>
                            <button type="button" class="quick-pill" data-field="awakenings" data-value="4">4</button>
                            <button type="button" class="quick-pill" data-field="awakenings" data-value="5">5+</button>
                        </div>
                        <input type="hidden" id="diaryAwakenings" value="">
                    </div>

                    <!-- WASO -->
                    <div class="diary-section">
                        <label class="diary-label">6. In total, how long did these awakenings last?</label>
                        <div class="quick-pick-grid">
                            <button type="button" class="quick-pill" data-field="waso" data-value="0">None</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="5">~5 min</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="10">~10 min</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="15">~15 min</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="20">~20 min</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="30">~30 min</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="45">~45 min</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="60">~1 hour</button>
                            <button type="button" class="quick-pill" data-field="waso" data-value="90">1+ hours</button>
                        </div>
                        <input type="hidden" id="diaryWASO" value="">
                    </div>

                    <!-- Final Wake Time -->
                    <div class="diary-section">
                        <label class="diary-label">7. What time was your final awakening?</label>
                        <div class="time-picker-grid">
                            <button type="button" class="time-pill" data-field="finalWake" data-time="05:00">5 AM</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="05:30">5:30</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="06:00">6 AM</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="06:30">6:30</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="07:00">7 AM</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="07:30">7:30</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="08:00">8 AM</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="08:30">8:30</button>
                            <button type="button" class="time-pill" data-field="finalWake" data-time="09:00">9 AM</button>
                        </div>
                        <input type="time" id="diaryFinalWake" style="margin-top: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <!-- Out of Bed Time -->
                    <div class="diary-section">
                        <label class="diary-label">8. What time did you get out of bed for the day?</label>
                        <div class="time-picker-grid">
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="05:00">5 AM</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="05:30">5:30</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="06:00">6 AM</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="06:30">6:30</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="07:00">7 AM</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="07:30">7:30</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="08:00">8 AM</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="08:30">8:30</button>
                            <button type="button" class="time-pill" data-field="outOfBed" data-time="09:00">9 AM</button>
                        </div>
                        <input type="time" id="diaryOutOfBed" style="margin-top: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <!-- Sleep Quality -->
                    <div class="diary-section">
                        <label class="diary-label">9. How would you rate the quality of your sleep?</label>
                        <div class="quality-rating">
                            <button type="button" class="quality-star" data-value="1" onclick="setQuality(1)">
                                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                <span>Very Poor</span>
                            </button>
                            <button type="button" class="quality-star" data-value="2" onclick="setQuality(2)">
                                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                <span>Poor</span>
                            </button>
                            <button type="button" class="quality-star" data-value="3" onclick="setQuality(3)">
                                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                <span>Fair</span>
                            </button>
                            <button type="button" class="quality-star" data-value="4" onclick="setQuality(4)">
                                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                <span>Good</span>
                            </button>
                            <button type="button" class="quality-star" data-value="5" onclick="setQuality(5)">
                                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                <span>Very Good</span>
                            </button>
                        </div>
                        <input type="hidden" id="diaryQuality" value="">
                    </div>

                    <!-- Restedness -->
                    <div class="diary-section">
                        <label class="diary-label">10. How rested or refreshed did you feel when you woke up?</label>
                        <div class="quality-rating">
                            <button type="button" class="quality-star rested-btn" data-value="1" onclick="setRestedness(1)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                                <span>Not at all</span>
                            </button>
                            <button type="button" class="quality-star rested-btn" data-value="2" onclick="setRestedness(2)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                                <span>Slightly</span>
                            </button>
                            <button type="button" class="quality-star rested-btn" data-value="3" onclick="setRestedness(3)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                                <span>Somewhat</span>
                            </button>
                            <button type="button" class="quality-star rested-btn" data-value="4" onclick="setRestedness(4)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                                <span>Well rested</span>
                            </button>
                            <button type="button" class="quality-star rested-btn" data-value="5" onclick="setRestedness(5)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                                <span>Very well</span>
                            </button>
                        </div>
                        <input type="hidden" id="diaryRestedness" value="">
                    </div>

                    <!-- Naps -->
                    <div class="diary-section">
                        <label class="diary-label">11. Did you take any naps or doze yesterday?</label>
                        <div class="quick-pick-grid">
                            <button type="button" class="quick-pill" data-field="naps" data-value="0">No naps</button>
                            <button type="button" class="quick-pill" data-field="naps" data-value="15">~15 min</button>
                            <button type="button" class="quick-pill" data-field="naps" data-value="30">~30 min</button>
                            <button type="button" class="quick-pill" data-field="naps" data-value="45">~45 min</button>
                            <button type="button" class="quick-pill" data-field="naps" data-value="60">~1 hour</button>
                            <button type="button" class="quick-pill" data-field="naps" data-value="90">1+ hours</button>
                        </div>
                        <input type="hidden" id="diaryNaps" value="0">
                    </div>

                    <!-- Substances -->
                    <div class="diary-section">
                        <label class="diary-label">12. Substances consumed yesterday (select all that apply)</label>
                        <div class="substance-grid">
                            <label class="substance-check">
                                <input type="checkbox" id="diaryCaffeine" name="substances" value="caffeine">
                                <span class="substance-box">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
                                    Caffeine
                                </span>
                            </label>
                            <label class="substance-check">
                                <input type="checkbox" id="diaryAlcohol" name="substances" value="alcohol">
                                <span class="substance-box">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M8 22h8"/><path d="M12 11v11"/><path d="M5.28 3h13.44a1 1 0 0 1 .97 1.24L17 11a5 5 0 0 1-10 0L4.31 4.24A1 1 0 0 1 5.28 3z"/></svg>
                                    Alcohol
                                </span>
                            </label>
                            <label class="substance-check">
                                <input type="checkbox" id="diarySleepAid" name="substances" value="sleepaid">
                                <span class="substance-box">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M10.5 20.5L10 17c-2-2-4-3.5-4-6 0-3.31 2.69-6 6-6s6 2.69 6 6c0 2.5-2 4-4 6l-.5 3.5"/><path d="M8.5 17h7"/><path d="M12 22v-2"/></svg>
                                    Sleep Aid
                                </span>
                            </label>
                            <label class="substance-check">
                                <input type="checkbox" id="diaryNone" name="substances" value="none">
                                <span class="substance-box">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
                                    None
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="diary-section">
                        <label class="diary-label">13. Comments (optional)</label>
                        <textarea id="diaryNotes" placeholder="Anything that may have affected your sleep (stress, illness, exercise, room conditions, etc.)" rows="3" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                    </div>

                    <button type="submit" class="btn-primary" style="width: 100%; padding: 16px; font-size: 16px; margin-top: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Save Entry
                    </button>
                </form>
            </div>

            <!-- Calculated Metrics Display -->
            <div id="diaryMetrics" style="display: none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border: 1px solid rgba(201, 169, 98, 0.2); border-radius: 12px;">
                <h4 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin-bottom: 15px;">Last Night's Sleep Metrics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: var(--gold-dark);" id="metricTST">--</div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase;">Total Sleep</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: var(--gold-dark);" id="metricSE">--</div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase;">Sleep Efficiency</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: var(--gold-dark);" id="metricSOL">--</div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase;">Sleep Onset</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: var(--gold-dark);" id="metricWASO">--</div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase;">WASO</div>
                    </div>
                </div>
            </div>
            </div><!-- End diary-tab-log -->

            <!-- History Tab -->
            <div class="diary-tab-content" id="diary-tab-history">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: var(--navy); margin-bottom: 20px;">Sleep History</h3>
                <div class="diary-history" id="diaryHistory">
                    <div class="empty-state">
                        <p>No diary entries yet. Start tracking your sleep in the Log Entry tab.</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="diary-tab-content" id="diary-tab-analytics">
                <!-- Sleep Score Card -->
                <div class="sleep-score-card">
                    <div class="sleep-score-content">
                        <div class="sleep-score-circle">
                            <svg class="sleep-score-ring" width="120" height="120" viewBox="0 0 120 120">
                                <circle class="sleep-score-ring-bg" cx="60" cy="60" r="52"/>
                                <circle class="sleep-score-ring-progress" id="sleepScoreRing" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="326.73"/>
                            </svg>
                            <div class="sleep-score-value">
                                <div class="sleep-score-number" id="sleepScoreNumber">--</div>
                                <div class="sleep-score-label">Sleep Score</div>
                            </div>
                        </div>
                        <div class="sleep-score-details">
                            <h3 class="sleep-score-title" id="sleepScoreTitle">Calculating...</h3>
                            <p class="sleep-score-subtitle" id="sleepScoreSubtitle">Log at least 3 nights to see your score</p>
                            <div class="sleep-score-breakdown" id="sleepScoreBreakdown">
                                <div class="score-component">
                                    <div class="score-component-value" id="scoreDuration">--</div>
                                    <div class="score-component-label">Duration</div>
                                </div>
                                <div class="score-component">
                                    <div class="score-component-value" id="scoreEfficiency">--</div>
                                    <div class="score-component-label">Efficiency</div>
                                </div>
                                <div class="score-component">
                                    <div class="score-component-value" id="scoreQuality">--</div>
                                    <div class="score-component-label">Quality</div>
                                </div>
                                <div class="score-component">
                                    <div class="score-component-value" id="scoreConsistency">--</div>
                                    <div class="score-component-label">Consistency</div>
                                </div>
                            </div>
                        </div>
                        <div class="streak-badge" id="streakBadge">
                            <div class="streak-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="2" width="20" height="20"><path d="M12 2v20M2 12h20"/></svg>
                            </div>
                            <div class="streak-info">
                                <div class="streak-count" id="streakCount">0 days</div>
                                <div class="streak-label">Current Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Period Selector -->
                <div class="analytics-header">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy);">Your Sleep Trends</h3>
                    <div class="analytics-period">
                        <button class="period-btn active" onclick="setAnalyticsPeriod(7)">7 Days</button>
                        <button class="period-btn" onclick="setAnalyticsPeriod(14)">14 Days</button>
                        <button class="period-btn" onclick="setAnalyticsPeriod(30)">30 Days</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-grid" id="summaryGrid">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                        </div>
                        <div class="summary-value" id="avgSleepTime">--</div>
                        <div class="summary-label">Avg Sleep Time</div>
                        <div class="summary-change" id="avgSleepTimeChange"></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        </div>
                        <div class="summary-value" id="avgBedtime">--</div>
                        <div class="summary-label">Avg Bedtime</div>
                        <div class="summary-change" id="avgBedtimeChange"></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <div class="summary-value" id="avgEfficiencySum">--</div>
                        <div class="summary-label">Avg Efficiency</div>
                        <div class="summary-change" id="avgEfficiencyChange"></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        </div>
                        <div class="summary-value" id="avgQualitySum">--</div>
                        <div class="summary-label">Avg Quality</div>
                        <div class="summary-change" id="avgQualityChange"></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
                        </div>
                        <div class="summary-value" id="avgAwakenings">--</div>
                        <div class="summary-label">Avg Awakenings</div>
                        <div class="summary-change" id="avgAwakeningsChange"></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        </div>
                        <div class="summary-value" id="totalNights">--</div>
                        <div class="summary-label">Nights Logged</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="analytics-charts">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 class="chart-title">Sleep Duration</h4>
                            <div class="chart-trend" id="durationTrend">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                                <span>--</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="durationChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 class="chart-title">Sleep Efficiency</h4>
                            <div class="chart-trend" id="efficiencyTrend">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                                <span>--</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="efficiencyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="analytics-charts">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 class="chart-title">Sleep Quality Ratings</h4>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 class="chart-title">Bedtime Consistency</h4>
                        </div>
                        <div class="chart-container">
                            <canvas id="bedtimeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Insights Section -->
                <div class="insights-section" id="insightsSection">
                    <div class="insights-header">
                        <div class="insights-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        </div>
                        <h3 class="insights-title">Personalized Insights</h3>
                    </div>
                    <div id="insightsList">
                        <div class="insight-card">
                            <div class="insight-type">Getting Started</div>
                            <p class="insight-text">Log at least 7 nights of sleep to unlock personalized insights about your sleep patterns.</p>
                        </div>
                    </div>
                </div>

                <!-- Achievements Section -->
                <div class="insights-section">
                    <div class="insights-header">
                        <div class="insights-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="2" width="18" height="18"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
                        </div>
                        <h3 class="insights-title">Achievements</h3>
                    </div>
                    <div class="achievements-grid" id="achievementsGrid">
                        <div class="achievement-badge locked" id="badge-first-log">
                            <div class="achievement-icon">1</div>
                            <div class="achievement-info">
                                <h5>First Entry</h5>
                                <p>Log your first sleep night</p>
                            </div>
                        </div>
                        <div class="achievement-badge locked" id="badge-week-streak">
                            <div class="achievement-icon">7</div>
                            <div class="achievement-info">
                                <h5>Week Warrior</h5>
                                <p>7-day logging streak</p>
                            </div>
                        </div>
                        <div class="achievement-badge locked" id="badge-month-streak">
                            <div class="achievement-icon">30</div>
                            <div class="achievement-info">
                                <h5>Consistency Champion</h5>
                                <p>30-day logging streak</p>
                            </div>
                        </div>
                        <div class="achievement-badge locked" id="badge-efficiency-master">
                            <div class="achievement-icon">85</div>
                            <div class="achievement-info">
                                <h5>Efficiency Master</h5>
                                <p>Avg efficiency above 85%</p>
                            </div>
                        </div>
                        <div class="achievement-badge locked" id="badge-quality-sleeper">
                            <div class="achievement-icon">4+</div>
                            <div class="achievement-info">
                                <h5>Quality Sleeper</h5>
                                <p>Avg quality rating 4+</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evening Check-in Tab -->
            <div class="diary-tab-content" id="diary-tab-evening">
                <div class="checkin-card">
                    <div class="checkin-header">
                        <div class="checkin-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--cream)" stroke-width="2" width="24" height="24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                        </div>
                        <div>
                            <h3 class="checkin-title">Evening Check-in</h3>
                            <p class="checkin-subtitle">Track factors that may affect tonight's sleep</p>
                        </div>
                    </div>

                    <form id="eveningCheckinForm" onsubmit="saveEveningCheckin(event)">
                        <input type="hidden" id="checkinDate" value="">

                        <div class="checkin-grid">
                            <div class="checkin-item">
                                <label>Stress Level Today</label>
                                <input type="range" class="checkin-slider" id="checkinStress" min="1" max="10" value="5" oninput="updateSliderLabel(this, 'stressLabel')">
                                <div class="checkin-value" id="stressLabel">5 - Moderate</div>
                            </div>
                            <div class="checkin-item">
                                <label>Physical Activity</label>
                                <input type="range" class="checkin-slider" id="checkinExercise" min="0" max="5" value="2" oninput="updateSliderLabel(this, 'exerciseLabel')">
                                <div class="checkin-value" id="exerciseLabel">2 - Light activity</div>
                            </div>
                            <div class="checkin-item">
                                <label>Last Caffeine (hours ago)</label>
                                <input type="range" class="checkin-slider" id="checkinCaffeine" min="0" max="12" value="8" oninput="updateSliderLabel(this, 'caffeineLabel')">
                                <div class="checkin-value" id="caffeineLabel">8+ hours ago</div>
                            </div>
                            <div class="checkin-item">
                                <label>Screen Time Before Bed</label>
                                <input type="range" class="checkin-slider" id="checkinScreens" min="0" max="4" value="1" oninput="updateSliderLabel(this, 'screensLabel')">
                                <div class="checkin-value" id="screensLabel">1 - 30 min or less</div>
                            </div>
                            <div class="checkin-item">
                                <label>Meal Timing (hours before bed)</label>
                                <input type="range" class="checkin-slider" id="checkinMeals" min="0" max="6" value="3" oninput="updateSliderLabel(this, 'mealsLabel')">
                                <div class="checkin-value" id="mealsLabel">3+ hours</div>
                            </div>
                            <div class="checkin-item">
                                <label>Overall Mood</label>
                                <input type="range" class="checkin-slider" id="checkinMood" min="1" max="5" value="3" oninput="updateSliderLabel(this, 'moodLabel')">
                                <div class="checkin-value" id="moodLabel">3 - Neutral</div>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <label style="display: block; font-size: 13px; color: var(--text); margin-bottom: 10px;">Any concerns about tonight's sleep?</label>
                            <textarea id="checkinNotes" rows="3" placeholder="E.g., big presentation tomorrow, feeling under the weather, unusual noise outside..." style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px; padding: 14px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
                            Save Evening Check-in
                        </button>
                    </form>
                </div>

                <!-- Today's Factors Summary -->
                <div class="insights-section" id="todaysFactors" style="display: none;">
                    <div class="insights-header">
                        <div class="insights-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="2" width="18" height="18"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <h3 class="insights-title">Today's Check-in Summary</h3>
                    </div>
                    <div id="factorsSummary"></div>
                </div>

                <!-- Tips Based on Check-in -->
                <div class="insights-section">
                    <div class="insights-header">
                        <div class="insights-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="2" width="18" height="18"><path d="M9 18l6-6-6-6"/></svg>
                        </div>
                        <h3 class="insights-title">Tonight's Sleep Tips</h3>
                    </div>
                    <div id="eveningTips">
                        <div class="insight-card">
                            <div class="insight-type">Tip</div>
                            <p class="insight-text">Complete your evening check-in to receive personalized tips for better sleep tonight.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Messages Section -->
        <section class="dashboard-section" id="section-messages">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>Messages</h1>
                </div>
            </div>

            <div class="messages-container">
                <div class="messages-list">
                    <div class="messages-header">
                        <div class="messages-header-avatar">AJ</div>
                        <div class="messages-header-info">
                            <h4>Dr. Alen Juginovic</h4>
                            <p>Sleep Wellness Consultant</p>
                        </div>
                    </div>
                    <div class="messages-body" id="messagesBody">
                        <div class="message received">
                            <p>Welcome to Sleep Wellness! I'm here to help you optimize your sleep. Feel free to ask any questions about your assessment results or sleep concerns.</p>
                            <div class="message-time">Dr. Alen</div>
                        </div>
                    </div>
                    <div class="messages-input">
                        <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="handleMessageKeypress(event)">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Appointments Section -->
        <section class="dashboard-section" id="section-appointments">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>Appointments</h1>
                </div>
            </div>

            <div class="book-appointment-form">
                <h3>Book a Consultation</h3>
                <form id="appointmentForm" onsubmit="bookAppointment(event)">
                    <div class="form-group">
                        <label>Preferred Date</label>
                        <input type="date" id="apptDate" required>
                    </div>
                    <div class="form-group">
                        <label>Preferred Time</label>
                        <select id="apptTime" required>
                            <option value="">Select time</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Topic / Reason</label>
                        <select id="apptTopic">
                            <option value="assessment">Discuss Assessment Results</option>
                            <option value="follow-up">Follow-up Consultation</option>
                            <option value="program">Sleep Program Planning</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="apptNotes" rows="3" style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); font-family: 'Montserrat', sans-serif;"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Request Appointment</button>
                </form>
            </div>

            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: var(--navy); margin: 30px 0 20px;">Your Appointments</h3>
            <div class="appointments-grid" id="appointmentsList">
                <div class="empty-state">
                    <p>No appointments scheduled.</p>
                </div>
            </div>
        </section>

        <!-- Questionnaires Section -->
        <section class="dashboard-section" id="section-questionnaires">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>Questionnaires</h1>
                </div>
            </div>

            <p style="font-size: 15px; color: var(--text-light); margin-bottom: 25px;">
                Complete clinical questionnaires assigned by Dr. Alen to help track your progress and guide your treatment plan.
            </p>

            <!-- Pending Questionnaires -->
            <div id="pendingQuestionnairesSection" style="margin-bottom: 30px;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 15px;">Pending Questionnaires</h3>
                <div id="pendingQuestionnaires" class="questionnaires-list">
                    <p style="color: var(--text-light); font-size: 14px;">No pending questionnaires.</p>
                </div>
            </div>

            <!-- Completed Questionnaires -->
            <div>
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 15px;">Completed Questionnaires</h3>
                <div id="completedQuestionnaires" class="questionnaires-list">
                    <p style="color: var(--text-light); font-size: 14px;">No completed questionnaires.</p>
                </div>
            </div>
        </section>

        <!-- Sleep Education Section -->
        <section class="dashboard-section" id="section-education">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>Learn About Sleep</h1>
                </div>
            </div>

            <p style="font-size: 15px; color: var(--text-light); margin-bottom: 30px;">
                Explore the science of sleep with our free educational resources. Understanding how sleep works is the first step toward better rest.
            </p>

            <!-- Interactive Presentation -->
            <div style="background: linear-gradient(135deg, var(--navy) 0%, #1a2d47 100%); border-radius: var(--radius-lg); padding: 35px; margin-bottom: 35px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(201, 169, 98, 0.15) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <div style="width: 45px; height: 45px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="2" width="22" height="22">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                        </div>
                        <div>
                            <span style="font-size: 11px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px;">Interactive Guide</span>
                        </div>
                    </div>
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--cream); margin-bottom: 10px;">Understanding Sleep</h2>
                    <p style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px; max-width: 500px;">
                        An interactive journey through the science of sleep - from how it works to why it matters for your health and performance.
                    </p>
                    <button onclick="openSleepPresentation()" class="btn-primary" style="background: var(--gold); color: var(--navy); border: none; padding: 14px 28px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer;">
                        Start Learning
                    </button>
                </div>
            </div>

            <!-- Educational PDFs -->
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: var(--navy); margin-bottom: 20px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="vertical-align: middle; margin-right: 8px; color: var(--gold-dark);">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                Downloadable Guides
            </h3>
            <p style="font-size: 14px; color: var(--text-light); margin-bottom: 20px;">
                In-depth guides tailored to your specific needs. Download and read at your own pace.
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- General Audience -->
                <div class="module-card" style="cursor: pointer;" onclick="downloadPDF('general')">
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="width: 50px; height: 50px; background: rgba(201, 169, 98, 0.15); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="1.5" width="24" height="24">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin-bottom: 5px;">The Science of Better Sleep</h4>
                            <p style="font-size: 13px; color: var(--text-light); margin-bottom: 10px;">A comprehensive guide for everyone wanting to understand and improve their sleep.</p>
                            <span style="font-size: 12px; color: var(--gold-dark); display: flex; align-items: center; gap: 5px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download PDF
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Athletes -->
                <div class="module-card" style="cursor: pointer;" onclick="downloadPDF('athletes')">
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="width: 50px; height: 50px; background: rgba(201, 169, 98, 0.15); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="1.5" width="24" height="24">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 2a10 10 0 0 1 0 20M12 2a10 10 0 0 0 0 20M2 12h20"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin-bottom: 5px;">Sleep for Peak Performance</h4>
                            <p style="font-size: 13px; color: var(--text-light); margin-bottom: 10px;">How elite athletes use sleep to enhance recovery, reaction time, and competitive edge.</p>
                            <span style="font-size: 12px; color: var(--gold-dark); display: flex; align-items: center; gap: 5px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download PDF
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Executives -->
                <div class="module-card" style="cursor: pointer;" onclick="downloadPDF('executives')">
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="width: 50px; height: 50px; background: rgba(201, 169, 98, 0.15); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="1.5" width="24" height="24">
                                <rect x="2" y="3" width="20" height="14" rx="2"/>
                                <path d="M8 21h8"/><path d="M12 17v4"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--navy); margin-bottom: 5px;">Executive Sleep Guide</h4>
                            <p style="font-size: 13px; color: var(--text-light); margin-bottom: 10px;">Optimize decision-making, manage jet lag, and maintain peak performance under pressure.</p>
                            <span style="font-size: 12px; color: var(--gold-dark); display: flex; align-items: center; gap: 5px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download PDF
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Facts Section -->
            <div style="margin-top: 40px; padding: 30px; background: var(--cream); border-radius: var(--radius-lg);">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: var(--navy); margin-bottom: 20px; text-align: center;">Did You Know?</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px;">
                    <div style="text-align: center;">
                        <div style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: var(--gold-dark); margin-bottom: 5px;">7-9</div>
                        <p style="font-size: 13px; color: var(--text-light);">Hours of sleep recommended for adults</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: var(--gold-dark); margin-bottom: 5px;">4-6</div>
                        <p style="font-size: 13px; color: var(--text-light);">Sleep cycles per night</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: var(--gold-dark); margin-bottom: 5px;">90</div>
                        <p style="font-size: 13px; color: var(--text-light);">Minutes per complete sleep cycle</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: var(--gold-dark); margin-bottom: 5px;">25%</div>
                        <p style="font-size: 13px; color: var(--text-light);">Of sleep spent in REM stage</p>
                    </div>
                </div>
            </div>

            <!-- Sleep Knowledge Quiz -->
            <div class="quiz-container" id="sleepQuizContainer">
                <div class="quiz-header">
                    <div class="quiz-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="2" width="24" height="24">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="quiz-title">Test Your Sleep Knowledge</h3>
                        <p class="quiz-subtitle">Learn while you play - explanations with every answer</p>
                    </div>
                </div>

                <!-- Quiz Start Screen -->
                <div id="quizStart" class="quiz-start-card">
                    <h4 class="quiz-start-title">Choose Your Quiz</h4>
                    <p class="quiz-start-desc">Select a category that matches your interests. Each quiz has 10 questions with detailed explanations and actionable tips.</p>

                    <!-- Category Selection -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 25px;">
                        <button class="quiz-category-btn active" data-category="general" onclick="selectQuizCategory('general')" style="padding: 16px 12px; border: 2px solid var(--gold); background: rgba(201, 169, 98, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center;">
                            <div style="width: 40px; height: 40px; margin: 0 auto 10px; background: #C9A962; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                            </div>
                            <div style="font-weight: 600; font-size: 13px; color: var(--navy);">Sleep Basics</div>
                            <div style="font-size: 11px; color: var(--text-light);">Fundamentals</div>
                        </button>
                        <button class="quiz-category-btn" data-category="athlete" onclick="selectQuizCategory('athlete')" style="padding: 16px 12px; border: 2px solid #e0e0e0; background: white; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center;">
                            <div style="width: 40px; height: 40px; margin: 0 auto 10px; background: #2A8B8B; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                            </div>
                            <div style="font-weight: 600; font-size: 13px; color: var(--navy);">Athletes</div>
                            <div style="font-size: 11px; color: var(--text-light);">Performance</div>
                        </button>
                        <button class="quiz-category-btn" data-category="executive" onclick="selectQuizCategory('executive')" style="padding: 16px 12px; border: 2px solid #e0e0e0; background: white; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center;">
                            <div style="width: 40px; height: 40px; margin: 0 auto 10px; background: #4A6085; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                            </div>
                            <div style="font-weight: 600; font-size: 13px; color: var(--navy);">Executives</div>
                            <div style="font-size: 11px; color: var(--text-light);">Leadership</div>
                        </button>
                        <button class="quiz-category-btn" data-category="traveler" onclick="selectQuizCategory('traveler')" style="padding: 16px 12px; border: 2px solid #e0e0e0; background: white; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center;">
                            <div style="width: 40px; height: 40px; margin: 0 auto 10px; background: #8B4D5C; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                            </div>
                            <div style="font-weight: 600; font-size: 13px; color: var(--navy);">Travelers</div>
                            <div style="font-size: 11px; color: var(--text-light);">Jet Lag</div>
                        </button>
                    </div>

                    <!-- Selected Quiz Info -->
                    <div style="background: rgba(15, 28, 46, 0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                        <h5 id="quizCategoryName" style="font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy); margin-bottom: 5px;">Sleep Basics</h5>
                        <p id="quizCategoryDesc" style="font-size: 13px; color: var(--text-light); margin: 0;">Test your fundamental sleep knowledge</p>
                    </div>

                    <div class="quiz-start-features">
                        <div class="quiz-start-feature">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#2E7D32" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
                            10 Questions
                        </div>
                        <div class="quiz-start-feature">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#2E7D32" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
                            Instant Feedback
                        </div>
                        <div class="quiz-start-feature">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#2E7D32" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
                            Actionable Tips
                        </div>
                    </div>
                    <button class="quiz-btn quiz-btn-primary" onclick="startQuiz()">
                        Start Quiz
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </div>

                <!-- Quiz Questions (hidden initially) -->
                <div id="quizContent" style="display: none;">
                    <div class="quiz-progress">
                        <div class="quiz-progress-bar">
                            <div class="quiz-progress-fill" id="quizProgressFill" style="width: 10%;"></div>
                        </div>
                        <span class="quiz-progress-text" id="quizProgressText">1 of 10</span>
                    </div>

                    <div class="quiz-question">
                        <div class="quiz-question-number" id="quizQuestionNumber">Question 1</div>
                        <p class="quiz-question-text" id="quizQuestionText">Loading question...</p>
                    </div>

                    <div class="quiz-options" id="quizOptions">
                        <!-- Options will be populated by JavaScript -->
                    </div>

                    <div class="quiz-feedback" id="quizFeedback">
                        <div class="quiz-feedback-header">
                            <div class="quiz-feedback-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="16" height="16" id="feedbackIcon"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                            <span class="quiz-feedback-title" id="feedbackTitle">Correct!</span>
                        </div>
                        <p class="quiz-feedback-explanation" id="feedbackExplanation"></p>
                        <div class="quiz-feedback-tip">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            <p class="quiz-feedback-tip-text" id="feedbackTip"></p>
                        </div>
                    </div>

                    <div class="quiz-actions">
                        <button class="quiz-btn quiz-btn-primary" id="quizNextBtn" onclick="nextQuestion()" disabled>
                            Next Question
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Quiz Results (hidden initially) -->
                <div id="quizResults" style="display: none;" class="quiz-results">
                    <div class="quiz-results-score">
                        <svg class="quiz-results-ring" width="140" height="140" viewBox="0 0 140 140">
                            <circle class="quiz-results-ring-bg" cx="70" cy="70" r="60"/>
                            <circle class="quiz-results-ring-progress" id="quizResultsRing" cx="70" cy="70" r="60" stroke-dasharray="377" stroke-dashoffset="377"/>
                        </svg>
                        <div class="quiz-results-value">
                            <div class="quiz-results-number" id="quizResultsNumber">0</div>
                            <div class="quiz-results-label">out of 10</div>
                        </div>
                    </div>
                    <h3 class="quiz-results-title" id="quizResultsTitle">Great Job!</h3>
                    <p class="quiz-results-subtitle" id="quizResultsSubtitle">You're on your way to becoming a sleep expert.</p>
                    <div class="quiz-results-stats">
                        <div class="quiz-results-stat">
                            <div class="quiz-results-stat-value" id="quizCorrectCount">0</div>
                            <div class="quiz-results-stat-label">Correct</div>
                        </div>
                        <div class="quiz-results-stat">
                            <div class="quiz-results-stat-value" id="quizIncorrectCount">0</div>
                            <div class="quiz-results-stat-label">Incorrect</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 15px;">
                        <button class="quiz-btn quiz-btn-secondary" onclick="restartQuiz()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                            Try Again
                        </button>
                        <button class="quiz-btn quiz-btn-primary" onclick="shareQuizResults()">
                            Share Results
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modules Section -->
        <section class="dashboard-section" id="section-modules">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>Sleep Resources</h1>
                </div>
            </div>

            <p style="font-size: 15px; color: var(--text-light); margin-bottom: 25px;">
                Access evidence-based content and techniques to improve your sleep. Resources are unlocked based on your assessment results and consultation with Dr. Alen.
            </p>

            <!-- Core Sleep Skills -->
            <div class="resource-group">
                <h3 class="resource-group-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                    Core Sleep Skills
                </h3>
                <p class="resource-group-desc">Foundational techniques for better sleep</p>
                <div class="modules-grid" id="modulesGrid-core">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Cognitive & Behavioral -->
            <div class="resource-group">
                <h3 class="resource-group-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 2a4 4 0 0 0-4 4c0 1.1.4 2.1 1.1 2.9L12 12l2.9-3.1A4 4 0 0 0 12 2z"/><path d="M12 12v10"/><path d="M8 17h8"/></svg>
                    Cognitive & Behavioral
                </h3>
                <p class="resource-group-desc">Evidence-based CBT-I techniques</p>
                <div class="modules-grid" id="modulesGrid-cbt">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Relaxation & Stress Management -->
            <div class="resource-group">
                <h3 class="resource-group-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    Relaxation & Stress Management
                </h3>
                <p class="resource-group-desc">Calming techniques for mind and body</p>
                <div class="modules-grid" id="modulesGrid-relaxation">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Travel & Jet Lag -->
            <div class="resource-group" id="travelResourceGroup" style="display: none;">
                <h3 class="resource-group-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>
                    Travel & Jet Lag
                </h3>
                <p class="resource-group-desc">Tools for travelers and frequent flyers</p>
                <div class="modules-grid" id="modulesGrid-travel">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Additional Resources -->
            <div class="resource-group">
                <h3 class="resource-group-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
                    Additional Resources
                </h3>
                <p class="resource-group-desc">More tools to support your sleep journey</p>
                <div class="modules-grid" id="modulesGrid-other">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Profile Section -->
        <section class="dashboard-section" id="section-profile">
            <div class="section-header">
                <div class="section-header-left">
                    <button class="back-btn" onclick="showSection('dashboard')" title="Back to Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <h1>My Profile</h1>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Left Column - Editable Info -->
                <div class="profile-form">
                    <h3>Personal Information</h3>
                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="profileName" data-user-name>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="profileEmail" data-user-email disabled>
                        </div>
                        <div class="form-group">
                            <label>Phone (optional)</label>
                            <input type="tel" id="profilePhone">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Age</label>
                                <input type="number" id="profileAge" min="18" max="120" placeholder="Enter age">
                            </div>
                            <div class="form-group">
                                <label>Sex</label>
                                <select id="profileSex">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other / Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Height (cm)</label>
                                <input type="number" id="profileHeight" min="100" max="250" placeholder="e.g., 175">
                            </div>
                            <div class="form-group">
                                <label>Weight (kg)</label>
                                <input type="number" id="profileWeight" min="30" max="300" placeholder="e.g., 70">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Client Type</label>
                            <select id="profileClientType">
                                <option value="athlete">Athlete</option>
                                <option value="executive">Executive</option>
                                <option value="hotel">Traveler</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Timezone</label>
                            <select id="profileTimezone">
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="Europe/London">London (GMT/BST)</option>
                                <option value="Europe/Paris">Central European (CET)</option>
                                <option value="Europe/Zagreb">Zagreb (CET)</option>
                                <option value="Asia/Dubai">Dubai (GST)</option>
                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </form>
                </div>

                <!-- Right Column - Assessment Summary -->
                <div>
                    <div class="profile-form">
                        <h3>Health Summary</h3>
                        <div id="profileHealthSummary" style="padding: 15px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="text-align: center; padding: 20px; background: var(--cream); border-radius: var(--radius-md);">
                                    <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">BMI</div>
                                    <div id="profileBMI" style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--navy);">--</div>
                                    <div id="profileBMILabel" style="font-size: 12px; color: var(--text-light);">Not calculated</div>
                                </div>
                                <div style="text-align: center; padding: 20px; background: var(--cream); border-radius: var(--radius-md);">
                                    <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Sleep Score</div>
                                    <div id="profileSleepScore" style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--navy);">--</div>
                                    <div style="font-size: 12px; color: var(--text-light);">Latest assessment</div>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--text-light); margin-bottom: 15px;">
                                Complete your assessment to populate your health summary and receive personalized recommendations.
                            </p>
                        </div>
                    </div>

                    <div class="profile-form" style="margin-top: 20px;">
                        <h3>Sleep Goals</h3>
                        <div class="form-group">
                            <label>Primary Sleep Goal</label>
                            <select id="profileSleepGoal">
                                <option value="">Select your main goal...</option>
                                <option value="fall_asleep_faster">Fall asleep faster</option>
                                <option value="stay_asleep">Stay asleep through the night</option>
                                <option value="feel_rested">Wake up feeling more rested</option>
                                <option value="consistent_schedule">Maintain consistent sleep schedule</option>
                                <option value="reduce_snoring">Reduce snoring/sleep apnea</option>
                                <option value="manage_shift_work">Manage shift work sleep</option>
                                <option value="jet_lag">Better manage jet lag</option>
                                <option value="performance">Optimize performance</option>
                                <option value="general">General sleep improvement</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes for Dr. Alen (optional)</label>
                            <textarea id="profileNotes" rows="3" placeholder="Any additional information about your sleep concerns..." style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); border-radius: var(--radius-sm); font-family: 'Montserrat', sans-serif; font-size: 14px;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer Disclaimer -->
        <footer style="margin-top: 40px; padding: 20px 0; border-top: 1px solid rgba(201, 169, 98, 0.15);">
            <p style="font-size: 11px; color: var(--text-light); line-height: 1.6; margin: 0; text-align: center;">
                Sleep Wellness by Dr. Alen is a consulting service providing sleep education and wellness guidance.
                This portal does not provide medical advice, diagnosis, or treatment.
                Always consult a qualified healthcare provider for medical concerns.
                <a href="#" onclick="showTermsModal()" style="color: var(--gold-dark); text-decoration: none; margin-left: 5px;">Terms of Service</a>
            </p>
        </footer>
    </main>
</div>

<!-- Content Modal -->
<div class="modal" id="contentModal">
    <div class="modal-content">
        <button class="modal-close" onclick="Content.closeModal()">&times;</button>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<!-- Request Access Modal -->
<div class="modal" id="requestModal">
    <div class="modal-content" style="max-width: 480px;">
        <button class="modal-close" onclick="closeRequestModal()">&times;</button>
        <div class="modal-body">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--navy); margin-bottom: 10px;">Request Access</h2>
            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 25px;">
                Request access to <strong id="requestModuleName"></strong>. Dr. Alen will review your request.
            </p>
            <input type="hidden" id="requestModuleId">
            <div class="form-group">
                <label for="requestReason">Why would you like access to this module? (optional)</label>
                <textarea id="requestReason" rows="3" placeholder="e.g., I have trouble falling asleep due to racing thoughts..." style="width: 100%; padding: 12px; border: 1px solid rgba(201, 169, 98, 0.3); font-family: 'Montserrat', sans-serif; font-size: 14px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeRequestModal()" style="flex: 1;">Cancel</button>
                <button class="btn-primary" onclick="submitModuleRequest()" id="submitRequestBtn" style="flex: 1;">Send Request</button>
            </div>
        </div>
    </div>
</div>

<!-- AI Chat Widget -->
<div class="chat-widget" id="chatWidget">
    <div class="chat-panel">
        <div class="chat-header">
            <div class="chat-header-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <div class="chat-header-info">
                <h4>Sleep Assistant</h4>
                <p>Ask me anything about sleep</p>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                <div class="chat-bubble">
                    <p>Hello! I'm your Sleep Wellness assistant. I can help you:</p>
                    <ul>
                        <li>Understand sleep terms and metrics</li>
                        <li>Navigate the portal</li>
                        <li>Learn about healthy sleep habits</li>
                        <li>Summarize your results</li>
                    </ul>
                    <p>How can I help you today?</p>
                </div>
            </div>
            <div class="chat-suggestions" id="chatSuggestions">
                <button class="chat-suggestion" onclick="askSuggestion('What is sleep efficiency?')">What is sleep efficiency?</button>
                <button class="chat-suggestion" onclick="askSuggestion('How do I improve my sleep?')">Tips for better sleep</button>
                <button class="chat-suggestion" onclick="askSuggestion('Summarize my sleep data')">Summarize my data</button>
            </div>
        </div>
        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <textarea class="chat-input" id="chatInput" placeholder="Ask about sleep..." rows="1" onkeypress="handleChatKeypress(event)"></textarea>
                <button class="chat-send" id="chatSendBtn" onclick="sendChatMessage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <button class="chat-toggle" onclick="toggleChat()">
        <svg class="chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <svg class="close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>
</div>

<!-- Discharge/Satisfaction Questionnaire Modal -->
<div class="modal" id="dischargeModal">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <button class="modal-close" onclick="closeDischargeModal()">&times;</button>
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 30px;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" style="margin-bottom: 15px;">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--navy); margin-bottom: 10px;">Program Completion</h2>
                <p style="color: var(--text-light); font-size: 14px;">
                    Congratulations on completing your sleep wellness program! Your feedback helps us improve our service.
                </p>
            </div>

            <form id="dischargeForm" onsubmit="submitDischargeSurvey(event)">
                <!-- Overall Satisfaction -->
                <div class="diary-section">
                    <label class="diary-label">1. Overall, how satisfied are you with the Sleep Wellness program?</label>
                    <div class="quality-rating satisfaction-rating">
                        <button type="button" class="quality-star sat-btn" data-value="1" onclick="setSatisfaction(1)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Very Unsatisfied</span>
                        </button>
                        <button type="button" class="quality-star sat-btn" data-value="2" onclick="setSatisfaction(2)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Unsatisfied</span>
                        </button>
                        <button type="button" class="quality-star sat-btn" data-value="3" onclick="setSatisfaction(3)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Neutral</span>
                        </button>
                        <button type="button" class="quality-star sat-btn" data-value="4" onclick="setSatisfaction(4)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Satisfied</span>
                        </button>
                        <button type="button" class="quality-star sat-btn" data-value="5" onclick="setSatisfaction(5)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Very Satisfied</span>
                        </button>
                    </div>
                    <input type="hidden" id="dischargeSatisfaction" value="">
                </div>

                <!-- Sleep Improvement -->
                <div class="diary-section">
                    <label class="diary-label">2. How much has your sleep improved since starting the program?</label>
                    <div class="quick-pick-grid">
                        <button type="button" class="quick-pill discharge-pill" data-field="improvement" data-value="worse">Got Worse</button>
                        <button type="button" class="quick-pill discharge-pill" data-field="improvement" data-value="same">No Change</button>
                        <button type="button" class="quick-pill discharge-pill" data-field="improvement" data-value="slight">Slightly Better</button>
                        <button type="button" class="quick-pill discharge-pill" data-field="improvement" data-value="moderate">Moderately Better</button>
                        <button type="button" class="quick-pill discharge-pill" data-field="improvement" data-value="much">Much Better</button>
                        <button type="button" class="quick-pill discharge-pill" data-field="improvement" data-value="resolved">Completely Resolved</button>
                    </div>
                    <input type="hidden" id="dischargeImprovement" value="">
                </div>

                <!-- NPS - Net Promoter Score -->
                <div class="diary-section">
                    <label class="diary-label">3. How likely are you to recommend Sleep Wellness to a friend or colleague?</label>
                    <div class="nps-scale">
                        <div class="nps-labels">
                            <span>Not at all likely</span>
                            <span>Extremely likely</span>
                        </div>
                        <div class="nps-buttons">
                            <button type="button" class="nps-btn" data-value="0" onclick="setNPS(0)">0</button>
                            <button type="button" class="nps-btn" data-value="1" onclick="setNPS(1)">1</button>
                            <button type="button" class="nps-btn" data-value="2" onclick="setNPS(2)">2</button>
                            <button type="button" class="nps-btn" data-value="3" onclick="setNPS(3)">3</button>
                            <button type="button" class="nps-btn" data-value="4" onclick="setNPS(4)">4</button>
                            <button type="button" class="nps-btn" data-value="5" onclick="setNPS(5)">5</button>
                            <button type="button" class="nps-btn" data-value="6" onclick="setNPS(6)">6</button>
                            <button type="button" class="nps-btn" data-value="7" onclick="setNPS(7)">7</button>
                            <button type="button" class="nps-btn" data-value="8" onclick="setNPS(8)">8</button>
                            <button type="button" class="nps-btn" data-value="9" onclick="setNPS(9)">9</button>
                            <button type="button" class="nps-btn" data-value="10" onclick="setNPS(10)">10</button>
                        </div>
                    </div>
                    <input type="hidden" id="dischargeNPS" value="">
                </div>

                <!-- Most Helpful -->
                <div class="diary-section">
                    <label class="diary-label">4. What was most helpful about the program? (select all that apply)</label>
                    <div class="substance-grid">
                        <label class="substance-check">
                            <input type="checkbox" name="helpful" value="assessment">
                            <span class="substance-box">Initial Assessment</span>
                        </label>
                        <label class="substance-check">
                            <input type="checkbox" name="helpful" value="diary">
                            <span class="substance-box">Sleep Diary</span>
                        </label>
                        <label class="substance-check">
                            <input type="checkbox" name="helpful" value="modules">
                            <span class="substance-box">Learning Modules</span>
                        </label>
                        <label class="substance-check">
                            <input type="checkbox" name="helpful" value="messaging">
                            <span class="substance-box">Direct Messaging</span>
                        </label>
                        <label class="substance-check">
                            <input type="checkbox" name="helpful" value="appointments">
                            <span class="substance-box">Consultations</span>
                        </label>
                        <label class="substance-check">
                            <input type="checkbox" name="helpful" value="questionnaires">
                            <span class="substance-box">Questionnaires</span>
                        </label>
                    </div>
                </div>

                <!-- Communication Quality -->
                <div class="diary-section">
                    <label class="diary-label">5. How would you rate the communication with Dr. Alen?</label>
                    <div class="quality-rating comm-rating">
                        <button type="button" class="quality-star comm-btn" data-value="1" onclick="setCommunication(1)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Poor</span>
                        </button>
                        <button type="button" class="quality-star comm-btn" data-value="2" onclick="setCommunication(2)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Fair</span>
                        </button>
                        <button type="button" class="quality-star comm-btn" data-value="3" onclick="setCommunication(3)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Good</span>
                        </button>
                        <button type="button" class="quality-star comm-btn" data-value="4" onclick="setCommunication(4)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Very Good</span>
                        </button>
                        <button type="button" class="quality-star comm-btn" data-value="5" onclick="setCommunication(5)">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Excellent</span>
                        </button>
                    </div>
                    <input type="hidden" id="dischargeCommunication" value="">
                </div>

                <!-- Open Feedback -->
                <div class="diary-section">
                    <label class="diary-label">6. What could we improve? (optional)</label>
                    <textarea id="dischargeImprovements" rows="3" placeholder="Your suggestions help us serve future clients better..." style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                </div>

                <div class="diary-section">
                    <label class="diary-label">7. Any other comments or testimonial you'd like to share? (optional)</label>
                    <textarea id="dischargeTestimonial" rows="3" placeholder="We'd love to hear about your experience..." style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                </div>

                <!-- Permission to use testimonial -->
                <div class="diary-section" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="dischargeTestimonialConsent" style="margin-top: 3px;">
                        <span style="font-size: 13px; color: var(--text-light);">I give permission to use my testimonial (anonymously) for marketing purposes</span>
                    </label>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="button" class="btn-secondary" onclick="closeDischargeModal()" style="flex: 1;">Skip for Now</button>
                    <button type="submit" class="btn-primary" id="submitDischargeBtn" style="flex: 1;">Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Guest Checkout Modal -->
<div id="checkout-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 600px; margin: 20px auto; max-height: 90vh; overflow-y: auto;">
        <!-- Wizard Header -->
        <div style="background: linear-gradient(135deg, #0f1c2e, #1a2a3a); padding: 25px 30px; border-radius: 16px 16px 0 0;">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: white; margin: 0 0 10px;">Complete Your Stay</h2>
            <div style="display: flex; gap: 8px;">
                <div class="checkout-step" data-step="1" style="flex: 1; height: 4px; background: #C9A962; border-radius: 2px;"></div>
                <div class="checkout-step" data-step="2" style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;"></div>
                <div class="checkout-step" data-step="3" style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;"></div>
                <div class="checkout-step" data-step="4" style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;"></div>
                <div class="checkout-step" data-step="5" style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;"></div>
            </div>
        </div>

        <!-- Step 1: Post-Stay ISI -->
        <div class="checkout-wizard-step active" data-step="1" style="padding: 30px;">
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: #0f1c2e; margin-bottom: 10px;">Post-Stay Sleep Assessment</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 25px;">Let's see how your sleep improved during your stay. Answer based on the <strong>past week</strong>.</p>

            <div id="post-isi-questions">
                <!-- ISI questions will be loaded here -->
                <div style="text-align: center; padding: 40px; color: #888;">Loading assessment...</div>
            </div>
        </div>

        <!-- Step 2: Post-Stay ESS -->
        <div class="checkout-wizard-step" data-step="2" style="display: none; padding: 30px;">
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: #0f1c2e; margin-bottom: 10px;">Daytime Alertness Check</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 25px;">How likely are you to doze off in these situations now?</p>

            <div id="post-ess-questions">
                <!-- ESS questions will be loaded here -->
                <div style="text-align: center; padding: 40px; color: #888;">Loading assessment...</div>
            </div>
        </div>

        <!-- Step 3: Feedback Survey -->
        <div class="checkout-wizard-step" data-step="3" style="display: none; padding: 30px;">
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: #0f1c2e; margin-bottom: 10px;">Your Feedback</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 25px;">Help us improve the sleep wellness experience.</p>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-size: 14px; font-weight: 500; color: #0f1c2e; margin-bottom: 12px;">Overall Experience</label>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="rating-star" data-rating="1" onclick="selectRating(1)" style="background: none; border: 2px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;">
                        <span style="font-size: 28px;"></span>
                    </button>
                    <button type="button" class="rating-star" data-rating="2" onclick="selectRating(2)" style="background: none; border: 2px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;">
                        <span style="font-size: 28px;"></span>
                    </button>
                    <button type="button" class="rating-star" data-rating="3" onclick="selectRating(3)" style="background: none; border: 2px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;">
                        <span style="font-size: 28px;"></span>
                    </button>
                    <button type="button" class="rating-star" data-rating="4" onclick="selectRating(4)" style="background: none; border: 2px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;">
                        <span style="font-size: 28px;"></span>
                    </button>
                    <button type="button" class="rating-star" data-rating="5" onclick="selectRating(5)" style="background: none; border: 2px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;">
                        <span style="font-size: 28px;"></span>
                    </button>
                </div>
                <input type="hidden" id="feedback-rating" value="">
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-size: 14px; font-weight: 500; color: #0f1c2e; margin-bottom: 10px;">Would you recommend this to other guests?</label>
                <div style="display: flex; gap: 15px;">
                    <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="recommend" value="yes" style="width: 18px; height: 18px;"> Yes, definitely
                    </label>
                    <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="recommend" value="no" style="width: 18px; height: 18px;"> Not really
                    </label>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-size: 14px; font-weight: 500; color: #0f1c2e; margin-bottom: 10px;">What was most helpful? (optional)</label>
                <select id="feedback-helpful" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="">Select one...</option>
                    <option value="personalized-schedule">Personalized sleep schedule</option>
                    <option value="room-optimization">Room optimization tips</option>
                    <option value="relaxation-techniques">Relaxation techniques</option>
                    <option value="sleep-diary">Sleep tracking/diary</option>
                    <option value="consultation">Consultation with Dr. Alen</option>
                    <option value="all">Everything worked together</option>
                </select>
            </div>

            <div>
                <label style="display: block; font-size: 14px; font-weight: 500; color: #0f1c2e; margin-bottom: 10px;">Any additional comments? (optional)</label>
                <textarea id="feedback-comments" rows="3" placeholder="Share your thoughts..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: none;"></textarea>
            </div>
        </div>

        <!-- Step 4: Hotel Experience Ratings -->
        <div class="checkout-wizard-step" data-step="4" style="display: none; padding: 30px;">
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 22px; color: #0f1c2e; margin-bottom: 10px;">Room & Sleep Environment</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 25px;">Rate how each aspect of your room affected your sleep (1-10).</p>

            <div style="display: grid; gap: 15px;">
                <div class="hotel-rating-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f6f3; border-radius: 8px;">
                    <span style="font-size: 24px;"></span>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 500; color: #0f1c2e;">Mattress Comfort</div>
                    </div>
                    <div style="display: flex; gap: 4px;" id="rating-mattress">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button type="button" onclick="setHotelRating('mattress', ${n})" style="width: 28px; height: 28px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 11px;">${n}</button>`).join('')}
                    </div>
                </div>

                <div class="hotel-rating-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f6f3; border-radius: 8px;">
                    <span style="font-size: 24px;"></span>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 500; color: #0f1c2e;">Pillow Quality</div>
                    </div>
                    <div style="display: flex; gap: 4px;" id="rating-pillows">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button type="button" onclick="setHotelRating('pillows', ${n})" style="width: 28px; height: 28px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 11px;">${n}</button>`).join('')}
                    </div>
                </div>

                <div class="hotel-rating-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f6f3; border-radius: 8px;">
                    <span style="font-size: 24px;"></span>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 500; color: #0f1c2e;">Room Temperature</div>
                    </div>
                    <div style="display: flex; gap: 4px;" id="rating-roomTemp">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button type="button" onclick="setHotelRating('roomTemp', ${n})" style="width: 28px; height: 28px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 11px;">${n}</button>`).join('')}
                    </div>
                </div>

                <div class="hotel-rating-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f6f3; border-radius: 8px;">
                    <span style="font-size: 24px;"></span>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 500; color: #0f1c2e;">Room Darkness</div>
                    </div>
                    <div style="display: flex; gap: 4px;" id="rating-darkness">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button type="button" onclick="setHotelRating('darkness', ${n})" style="width: 28px; height: 28px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 11px;">${n}</button>`).join('')}
                    </div>
                </div>

                <div class="hotel-rating-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f6f3; border-radius: 8px;">
                    <span style="font-size: 24px;"></span>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 500; color: #0f1c2e;">Quietness / Noise Level</div>
                    </div>
                    <div style="display: flex; gap: 4px;" id="rating-quietness">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button type="button" onclick="setHotelRating('quietness', ${n})" style="width: 28px; height: 28px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 11px;">${n}</button>`).join('')}
                    </div>
                </div>

                <div class="hotel-rating-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f6f3; border-radius: 8px;">
                    <span style="font-size: 24px;"></span>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 500; color: #0f1c2e;">Air Quality / Ventilation</div>
                    </div>
                    <div style="display: flex; gap: 4px;" id="rating-airQuality">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button type="button" onclick="setHotelRating('airQuality', ${n})" style="width: 28px; height: 28px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 11px;">${n}</button>`).join('')}
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <label style="display: block; font-size: 14px; font-weight: 500; color: #0f1c2e; margin-bottom: 10px;">What helped your sleep the most? (optional)</label>
                <textarea id="hotel-top-factor" rows="2" placeholder="e.g., The blackout curtains were amazing..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: none;"></textarea>
            </div>
        </div>

        <!-- Step 5: Thank You -->
        <div class="checkout-wizard-step" data-step="5" style="display: none; padding: 40px; text-align: center;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #C9A962, #d4b978); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 28px; color: #0f1c2e; margin-bottom: 15px;">Thank You!</h3>
            <p style="color: #666; font-size: 15px; margin-bottom: 30px; max-width: 400px; margin-left: auto; margin-right: auto;">Your sleep wellness journey at the hotel is complete. Here's a summary of your improvement.</p>

            <div style="background: linear-gradient(135deg, #0f1c2e, #1a2a3a); padding: 30px; border-radius: 12px; margin-bottom: 25px;">
                <p style="font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Your Sleep Improvement</p>
                <p id="checkout-improvement" style="font-family: 'Cormorant Garamond', serif; font-size: 56px; color: #C9A962; margin: 0;">+0%</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <div style="background: #f8f6f3; padding: 20px; border-radius: 8px;">
                    <p style="font-size: 11px; color: #888; margin-bottom: 5px;">ISI Score Change</p>
                    <p id="checkout-isi-change" style="font-size: 20px; font-weight: 600; color: #0f1c2e;">-  -</p>
                </div>
                <div style="background: #f8f6f3; padding: 20px; border-radius: 8px;">
                    <p style="font-size: 11px; color: #888; margin-bottom: 5px;">ESS Score Change</p>
                    <p id="checkout-ess-change" style="font-size: 20px; font-weight: 600; color: #0f1c2e;">-  -</p>
                </div>
            </div>

            <p style="font-size: 13px; color: #888;">A detailed report will be sent to the hotel. Safe travels!</p>
        </div>

        <!-- Wizard Footer -->
        <div style="padding: 20px 30px; border-top: 1px solid #eee; display: flex; justify-content: space-between;">
            <button id="checkout-back-btn" onclick="checkoutPrevStep()" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; display: none;">Back</button>
            <button id="checkout-cancel-btn" onclick="closeCheckoutModal()" style="padding: 12px 24px; background: #f5f5f5; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Cancel</button>
            <button id="checkout-next-btn" onclick="checkoutNextStep()" style="padding: 12px 30px; background: #C9A962; color: #0f1c2e; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-left: auto;">Next</button>
        </div>
    </div>
</div>

<style>
    .checkout-wizard-step { display: none; }
    .checkout-wizard-step.active { display: block; }
    .rating-star.selected { border-color: #C9A962 !important; background: rgba(201, 169, 98, 0.1) !important; }
    .rating-star.selected span { color: #C9A962; }
    .hotel-checkout-btn { background: linear-gradient(135deg, #2e7d32, #388e3c) !important; color: white !important; border-color: #2e7d32 !important; }
    .hotel-checkout-btn:hover { background: linear-gradient(135deg, #388e3c, #43a047) !important; }
    .hotel-checkout-btn svg { color: white !important; }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="auth.js"></script>
<script src="content.js"></script>
<script src="questionnaires.js"></script>
<!-- Chart.js for sleep analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    let currentUser = null;
    let userProfile = null;
    let conversationId = null;
    let messagesUnsubscribe = null;
    // ==================== ONBOARDING SYSTEM ====================

    let tourStep = 0;
    const totalTourSteps = 4;

    // Personalized content based on client type
    const clientTypeContent = {
        athlete: {
            badge: 'ATHLETE PROGRAM',
            intro: "I'm Dr. Alen Juginovic, a Harvard sleep scientist and physician. Over the next few weeks, we'll work together to optimize your sleep for peak athletic performance, faster recovery, and reduced injury risk.",
            features: [
                { icon: 'chart', text: 'Performance-focused sleep analysis' },
                { icon: 'recovery', text: 'Recovery optimization tracking' },
                { icon: 'message', text: 'Direct access to Dr. Alen' }
            ]
        },
        executive: {
            badge: 'EXECUTIVE PROGRAM',
            intro: "I'm Dr. Alen Juginovic, a Harvard sleep scientist and physician. Over the next few weeks, we'll work together to optimize your sleep for sharper decision-making, sustained energy, and peak cognitive performance.",
            features: [
                { icon: 'brain', text: 'Cognitive performance optimization' },
                { icon: 'travel', text: 'Jet lag & travel sleep strategies' },
                { icon: 'message', text: 'Direct access to Dr. Alen' }
            ]
        },
        hotel: {
            badge: 'WELLNESS PROGRAM',
            intro: "I'm Dr. Alen Juginovic, a Harvard sleep scientist and physician. Over the next few weeks, we'll work together to help you achieve deeper, more restorative sleep and wake up feeling refreshed.",
            features: [
                { icon: 'sleep', text: 'Personalized sleep assessment' },
                { icon: 'chart', text: 'Daily tracking & insights' },
                { icon: 'message', text: 'Direct access to Dr. Alen' }
            ]
        }
    };

    // Tour steps - target elements and content
    const tourSteps = [
        {
            target: '.sidebar-nav li:first-child a',
            title: 'Your Dashboard',
            text: 'This is your home base. Check your sleep stats, recent activity, and any pending tasks at a glance.',
            position: 'right'
        },
        {
            target: '.sidebar-nav li:nth-child(2) a',
            title: 'Sleep Assessments',
            text: 'Complete assessments to help me understand your sleep patterns. Your first assessment is waiting!',
            position: 'right'
        },
        {
            target: '.sidebar-nav li:nth-child(4) a',
            title: 'Sleep Diary',
            text: 'Log your sleep each morning. Just 30 seconds a day helps track your progress over time.',
            position: 'right'
        },
        {
            target: '.sidebar-nav li:nth-child(5) a',
            title: 'Messages',
            text: 'Have questions? Send me a message anytime. I typically respond within 24-48 hours.',
            position: 'right'
        }
    ];

    // Feature icons SVGs
    const featureIcons = {
        chart: '<path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/>',
        recovery: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
        message: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
        brain: '<path d="M12 2a4 4 0 0 0-4 4c0 1.1.4 2.1 1.1 2.9L12 12l2.9-3.1A4 4 0 0 0 12 2z"/><path d="M12 12v10"/><path d="M8 17h8"/>',
        travel: '<path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/>',
        sleep: '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'
    };

    // Create floating particles
    function createParticles() {
        const container = document.getElementById('welcomeParticles');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 0; i < 25; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 15 + 's';
            particle.style.animationDuration = (15 + Math.random() * 10) + 's';
            container.appendChild(particle);
        }
    }

    // Show personalized welcome modal
    function showWelcomeModal(userName, clientType) {
        const modal = document.getElementById('welcomeModal');
        const content = clientTypeContent[clientType] || clientTypeContent.hotel;

        // Set personalized content
        document.getElementById('welcomeName').textContent = userName || 'Friend';
        document.getElementById('welcomeBadge').textContent = content.badge;
        document.getElementById('welcomeIntro').textContent = content.intro;

        // Build features HTML
        const featuresHtml = content.features.map(f => `
            <div class="welcome-feature">
                <div class="welcome-feature-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${featureIcons[f.icon] || featureIcons.chart}</svg>
                </div>
                <span>${f.text}</span>
            </div>
        `).join('');
        document.getElementById('welcomeFeatures').innerHTML = featuresHtml;

        // Setup consent checkbox
        const consentCheckbox = document.getElementById('welcomeConsent');
        const continueBtn = document.getElementById('welcomeContinueBtn');
        consentCheckbox.addEventListener('change', () => {
            continueBtn.disabled = !consentCheckbox.checked;
        });

        // Create particles and show
        createParticles();
        modal.classList.add('active');
    }

    // Start spotlight tour
    function startTour() {
        // Hide welcome modal
        document.getElementById('welcomeModal').classList.remove('active');

        // Save consent to Firestore
        if (currentUser) {
            db.collection('users').doc(currentUser.uid).update({
                onboardingConsentGiven: true,
                onboardingConsentDate: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Start tour
        tourStep = 0;
        document.getElementById('tourOverlay').classList.add('active');
        updateTourStep();
    }

    // Update tour step
    function updateTourStep() {
        const step = tourSteps[tourStep];
        const targetEl = document.querySelector(step.target);

        if (!targetEl) {
            nextTourStep();
            return;
        }

        const rect = targetEl.getBoundingClientRect();
        const spotlight = document.getElementById('tourSpotlight');
        const tooltip = document.getElementById('tourTooltip');
        const arrow = document.getElementById('tourArrow');

        // Position spotlight
        const padding = 8;
        spotlight.style.top = (rect.top - padding) + 'px';
        spotlight.style.left = (rect.left - padding) + 'px';
        spotlight.style.width = (rect.width + padding * 2) + 'px';
        spotlight.style.height = (rect.height + padding * 2) + 'px';

        // Update tooltip content
        document.getElementById('tourTitle').textContent = step.title;
        document.getElementById('tourText').textContent = step.text;

        // Build step indicator
        let dotsHtml = '';
        for (let i = 0; i < totalTourSteps; i++) {
            let cls = 'tour-step-dot';
            if (i < tourStep) cls += ' completed';
            if (i === tourStep) cls += ' active';
            dotsHtml += `<div class="${cls}"></div>`;
        }
        document.getElementById('tourStepIndicator').innerHTML = dotsHtml;

        // Position tooltip
        tooltip.style.top = (rect.bottom + 20) + 'px';
        tooltip.style.left = Math.max(10, rect.left - 20) + 'px';
        arrow.className = 'tour-tooltip-arrow top';

        // Update button text
        const nextBtn = tooltip.querySelector('.tour-next');
        if (tourStep === totalTourSteps - 1) {
            nextBtn.innerHTML = 'Finish <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
        } else {
            nextBtn.innerHTML = 'Next <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
        }

        // Animate tooltip
        tooltip.style.animation = 'none';
        tooltip.offsetHeight;
        tooltip.style.animation = 'slideIn 0.4s ease';
    }

    // Next tour step
    function nextTourStep() {
        if (tourStep < totalTourSteps - 1) {
            tourStep++;
            updateTourStep();
        } else {
            finishTour();
        }
    }

    // Skip tour
    function skipTour() {
        finishTour();
    }

    // Finish tour
    function finishTour() {
        document.getElementById('tourOverlay').classList.remove('active');

        // Mark onboarding complete
        if (currentUser) {
            db.collection('users').doc(currentUser.uid).update({
                onboardingComplete: true,
                onboardingCompletedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Show assessment reminder
        setTimeout(() => {
            document.getElementById('assessmentModal').classList.add('active');
        }, 500);
    }

    // Assessment modal functions
    function dismissAssessmentModal() {
        document.getElementById('assessmentModal').classList.remove('active');
    }

    function startAssessmentNow() {
        document.getElementById('assessmentModal').classList.remove('active');
        showSection('assessments');
    }

    // Privacy policy popup
    function showPrivacyPolicy(e) {
        e.preventDefault();
        const modal = document.createElement('div');
        modal.id = 'privacyModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; justify-content: center; align-items: center; padding: 20px;';
        modal.innerHTML = `
            <div style="background: white; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 30px; border-radius: 16px; position: relative;">
                <button onclick="document.getElementById('privacyModal').remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                <h2 style="font-family: 'Cormorant Garamond', serif; color: var(--navy); margin-bottom: 20px;">Privacy Policy</h2>
                <div style="font-size: 14px; line-height: 1.7; color: #555;">
                    <h3 style="color: var(--navy); font-size: 16px; margin: 20px 0 10px;">Data We Collect</h3>
                    <p>We collect the following information to provide sleep wellness services:</p>
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li>Contact information (name, email)</li>
                        <li>Sleep patterns and habits</li>
                        <li>Assessment responses</li>
                        <li>Sleep diary entries</li>
                        <li>Messages with your consultant</li>
                    </ul>
                    <h3 style="color: var(--navy); font-size: 16px; margin: 20px 0 10px;">How We Use Your Data</h3>
                    <p>Your data is used exclusively to:</p>
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li>Provide personalized sleep assessment and recommendations</li>
                        <li>Track your progress over time</li>
                        <li>Enable communication with Dr. Alen Juginovic</li>
                    </ul>
                    <h3 style="color: var(--navy); font-size: 16px; margin: 20px 0 10px;">Your Rights (GDPR)</h3>
                    <p>You have the right to:</p>
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li>Access your personal data</li>
                        <li>Request correction of inaccurate data</li>
                        <li>Request deletion of your data</li>
                        <li>Withdraw consent at any time</li>
                    </ul>
                    <h3 style="color: var(--navy); font-size: 16px; margin: 20px 0 10px;">Contact</h3>
                    <p>For any privacy-related inquiries, contact Dr. Alen Juginovic at alen_juginovic@hms.harvard.edu</p>
                </div>
                <button onclick="document.getElementById('privacyModal').remove()" style="margin-top: 20px; padding: 12px 24px; background: var(--gold); color: var(--deep-navy); border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Legacy function for backward compatibility
    function showWelcomeOverlay(userName) {
        showWelcomeModal(userName, userProfile?.clientType || 'hotel');
    }

    // Load user tasks
    async function loadUserTasks() {
        if (!currentUser) return;

        try {
            // Query without orderBy to avoid index issues, sort client-side
            const snapshot = await db.collection('clientTasks')
                .where('clientId', '==', currentUser.uid)
                .where('status', '==', 'pending')
                .get();

            const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Sort by dueDate client-side (field name matches admin's assignTaskToClient)
            tasks.sort((a, b) => {
                const aDate = a.dueDate?.toDate?.() || new Date(9999, 11, 31);
                const bDate = b.dueDate?.toDate?.() || new Date(9999, 11, 31);
                return aDate - bDate;
            });

            const tasksBanner = document.getElementById('tasksBanner');
            const tasksList = document.getElementById('tasksList');
            const tasksSubtitle = document.getElementById('tasksSubtitle');

            if (tasks.length === 0) {
                tasksBanner.classList.remove('show');
                return;
            }

            tasksBanner.classList.add('show');
            tasksSubtitle.textContent = `You have ${tasks.length} task${tasks.length > 1 ? 's' : ''} to complete`;

            tasksList.innerHTML = tasks.slice(0, 5).map(task => {
                const dueDate = task.dueDate?.toDate?.();
                const isOverdue = dueDate && dueDate < new Date();
                const isHighPriority = task.priority === 'high' || task.taskType === 'assessment';
                const deadlineText = dueDate ? (isOverdue ? 'Overdue' : 'Due ' + dueDate.toLocaleDateString()) : '';

                return `
                    <div class="task-item ${isHighPriority ? 'high-priority' : ''}" onclick="handleTaskClick('${task.id}', '${task.taskType}')">
                        <div class="task-checkbox"></div>
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                            <div class="task-due ${isOverdue ? 'overdue' : ''}">${deadlineText}</div>
                        </div>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }

    // Handle task click
    function handleTaskClick(taskId, taskType) {
        // Navigate based on task type
        switch (taskType) {
            case 'assessment':
                showSection('assessments');
                break;
            case 'diary':
            case 'diary-week':
                showSection('diary');
                break;
            case 'questionnaire-isi':
            case 'questionnaire-ess':
            case 'questionnaire-psqi':
            case 'questionnaire-all':
                showSection('questionnaires');
                break;
            case 'module':
            case 'reading':
            case 'practice':
                showSection('modules');
                break;
            case 'schedule-appointment':
                showSection('appointments');
                break;
            case 'check-in':
                showSection('messages');
                break;
            default:
                // For other tasks, just highlight them
                showSection('assessments');
        }
    }

    // Show section
    function showSection(section) {
        // Update nav
        document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
        document.querySelector(`[href="#${section}"]`).classList.add('active');

        // Update section
        document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + section).classList.add('active');

        // Load section data
        if (section === 'assessments') loadAssessments();
        if (section === 'diary') loadDiaryEntries();
        if (section === 'messages') initMessages();
        if (section === 'appointments') loadAppointments();
        if (section === 'modules') loadModules();
        if (section === 'questionnaires') loadUserQuestionnaires();
    }

    // Initialize dashboard
    async function initDashboard(user, profile) {
        currentUser = user;
        userProfile = profile;

        // Update avatar
        const displayName = profile.displayName || user.email.split('@')[0];
        const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        document.getElementById('userAvatar').textContent = initials;

        // Update all user name displays
        document.querySelectorAll('[data-user-name]').forEach(el => {
            if (el.tagName === 'INPUT') {
                el.value = displayName;
            } else {
                el.textContent = displayName;
            }
        });

        // Check if this is a new user (never completed onboarding)
        console.log('Onboarding check:', { onboardingComplete: profile.onboardingComplete, clientType: profile.clientType });
        if (profile.onboardingComplete !== true) {
            const firstName = (profile.displayName || '').split(' ')[0] || 'Friend';
            console.log('Showing welcome modal for:', firstName);
            setTimeout(() => {
                showWelcomeModal(firstName, profile.clientType || 'hotel');
            }, 500);
        }

        // Load dashboard data
        loadDashboardStats();

        // Load user tasks
        loadUserTasks();

        // Load questionnaire badge count
        updateQuestionnaireBadge();

        // Set default diary date
        document.getElementById('diaryDate').value = new Date().toISOString().split('T')[0];

        // Check diary reminder
        checkDiaryReminder();

        // Check for pending discharge survey
        checkForDischargeSurvey();

        // Set min date for appointments
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('apptDate').min = tomorrow.toISOString().split('T')[0];
    }

    // Load dashboard stats
    async function loadDashboardStats() {
        try {
            const [assessments, diary, appointments, unlocks] = await Promise.all([
                FirebaseDB.getUserAssessments(currentUser.uid),
                FirebaseDB.getDiaryEntries(currentUser.uid, 7),
                FirebaseDB.getUserAppointments(currentUser.uid),
                FirebaseDB.getUserUnlocks(currentUser.uid)
            ]);

            // Assessment count
            document.getElementById('assessmentCount').textContent = assessments.length;

            // Average sleep efficiency
            if (diary.length > 0) {
                const avgEff = diary.reduce((sum, d) => sum + (d.sleepEfficiency || 0), 0) / diary.length;
                document.getElementById('avgEfficiency').textContent = avgEff.toFixed(0) + '%';
            }

            // Next appointment
            const upcoming = appointments.find(a => {
                const dt = a.dateTime?.toDate();
                return dt && dt > new Date() && a.status !== 'cancelled';
            });
            if (upcoming) {
                const dt = upcoming.dateTime.toDate();
                document.getElementById('nextAppointment').textContent = dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('nextAppointmentDetails').textContent = dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            }

            // Unlocked modules
            const unlockedCount = unlocks.includes('all') ? 7 : unlocks.length;
            document.getElementById('unlockedCount').textContent = unlockedCount;

            // Recent activity
            const activities = [];
            assessments.slice(0, 3).forEach(a => {
                activities.push({
                    type: 'assessment',
                    title: 'Completed Assessment',
                    description: `Score: ${a.overallScore}/100`,
                    time: a.createdAt?.toDate()
                });
            });
            renderActivities(activities);

        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    // Render activities
    function renderActivities(activities) {
        const container = document.getElementById('activityList');
        if (activities.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
            return;
        }

        container.innerHTML = activities.map(a => `
            <div class="activity-item">
                <div class="activity-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                </div>
                <div class="activity-content">
                    <h4>${a.title}</h4>
                    <p>${a.description}</p>
                </div>
                <span class="activity-time">${formatTimeAgo(a.time)}</span>
            </div>
        `).join('');
    }

    // Load assessments
    async function loadAssessments() {
        const container = document.getElementById('assessmentList');
        container.innerHTML = '<p style="padding: 20px; color: var(--text-light);">Loading...</p>';

        const assessments = await FirebaseDB.getUserAssessments(currentUser.uid);

        if (assessments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <h3>No Assessments Yet</h3>
                    <p>Complete your first sleep assessment to track your progress.</p>
                    <a href="take-assessment.html" class="btn-primary">Take Assessment</a>
                </div>
            `;
            return;
        }

        container.innerHTML = assessments.map(a => {
            const score = a.overallScore || 0;
            const scoreClass = score >= 70 ? 'good' : score >= 40 ? 'moderate' : 'poor';
            const date = a.createdAt?.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            return `
                <div class="assessment-item">
                    <div class="assessment-score ${scoreClass}">${score}</div>
                    <div class="assessment-details">
                        <h4>Sleep Health Assessment</h4>
                        <p>${date} - ${a.clientType || 'General'}</p>
                    </div>
                    <div class="assessment-actions">
                        <button class="btn-secondary" onclick="viewAssessment('${a.id}')">View Details</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ==================== DIARY HELPER FUNCTIONS ====================

    // Set diary date (0 = today, -1 = yesterday)
    function setDiaryDate(offset) {
        const date = new Date();
        date.setDate(date.getDate() + offset);
        document.getElementById('diaryDate').value = date.toISOString().split('T')[0];

        // Update pills
        document.querySelectorAll('.date-pill').forEach(pill => pill.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Setup diary pill click handlers
    document.addEventListener('DOMContentLoaded', () => {
        // Time pills - handle all time fields
        document.querySelectorAll('.time-pill').forEach(pill => {
            pill.addEventListener('click', function() {
                const field = this.dataset.field;
                const time = this.dataset.time;

                // Map field to input ID
                const fieldMap = {
                    'bedtime': 'diaryBedtime',
                    'lightsOut': 'diaryLightsOut',
                    'finalWake': 'diaryFinalWake',
                    'outOfBed': 'diaryOutOfBed'
                };

                const inputId = fieldMap[field];
                if (inputId) {
                    document.getElementById(inputId).value = time;
                }

                // Update active state
                document.querySelectorAll(`.time-pill[data-field="${field}"]`).forEach(p => p.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Quick pick pills - handle all quick-pick fields
        document.querySelectorAll('.quick-pill').forEach(pill => {
            pill.addEventListener('click', function() {
                const field = this.dataset.field;
                const value = this.dataset.value;

                // Map field to input ID
                const fieldMap = {
                    'latency': 'diaryLatency',
                    'awakenings': 'diaryAwakenings',
                    'waso': 'diaryWASO',
                    'naps': 'diaryNaps'
                };

                const inputId = fieldMap[field];
                if (inputId) {
                    document.getElementById(inputId).value = value;
                }

                // Update active state
                document.querySelectorAll(`.quick-pill[data-field="${field}"]`).forEach(p => p.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });

    // Set quality rating
    function setQuality(value) {
        document.getElementById('diaryQuality').value = value;

        // Update stars (only non-rested ones)
        document.querySelectorAll('.quality-star:not(.rested-btn)').forEach(star => {
            star.classList.remove('active');
            if (parseInt(star.dataset.value) === value) {
                star.classList.add('active');
            }
        });
    }

    // Set restedness rating
    function setRestedness(value) {
        document.getElementById('diaryRestedness').value = value;

        // Update rested buttons
        document.querySelectorAll('.rested-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.dataset.value) === value) {
                btn.classList.add('active');
            }
        });
    }

    // Check if diary needs to be filled today
    function checkDiaryReminder() {
        const now = new Date();
        const hour = now.getHours();

        // Show reminder between 6 AM and 11 AM
        if (hour >= 6 && hour < 11) {
            // Check if already filled today
            const lastDismiss = localStorage.getItem('diaryReminderDismissed');
            const today = now.toISOString().split('T')[0];

            if (lastDismiss !== today) {
                document.getElementById('diaryReminder').style.display = 'flex';
            }
        }
    }

    // Dismiss diary reminder
    function dismissDiaryReminder() {
        document.getElementById('diaryReminder').style.display = 'none';
        localStorage.setItem('diaryReminderDismissed', new Date().toISOString().split('T')[0]);
    }

    // Save diary entry
    async function saveDiaryEntry(e) {
        e.preventDefault();

        // Get all time fields
        const bedtime = document.getElementById('diaryBedtime').value;
        const lightsOut = document.getElementById('diaryLightsOut').value;
        const finalWake = document.getElementById('diaryFinalWake').value;
        const outOfBed = document.getElementById('diaryOutOfBed').value;

        // Validate required fields
        if (!lightsOut || !finalWake) {
            alert('Please select when you tried to sleep and your final wake time.');
            return;
        }

        // Get numeric fields
        const latency = parseInt(document.getElementById('diaryLatency').value) || 0;
        const waso = parseInt(document.getElementById('diaryWASO').value) || 0;
        const awakenings = parseInt(document.getElementById('diaryAwakenings').value) || 0;
        const quality = parseInt(document.getElementById('diaryQuality').value) || 3;
        const restedness = parseInt(document.getElementById('diaryRestedness').value) || 3;
        const naps = parseInt(document.getElementById('diaryNaps').value) || 0;

        // Get substances
        const substances = [];
        if (document.getElementById('diaryCaffeine').checked) substances.push('caffeine');
        if (document.getElementById('diaryAlcohol').checked) substances.push('alcohol');
        if (document.getElementById('diarySleepAid').checked) substances.push('sleepaid');
        if (document.getElementById('diaryNone').checked) substances.push('none');

        // Calculate sleep metrics (Consensus Sleep Diary formulas)
        // Time in Bed (TIB) = Out of bed time - Bedtime (or lights out if no bedtime)
        const tibStart = bedtime || lightsOut;
        const tibEnd = outOfBed || finalWake;

        const [tibStartH, tibStartM] = tibStart.split(':').map(Number);
        const [tibEndH, tibEndM] = tibEnd.split(':').map(Number);
        let timeInBed = (tibEndH * 60 + tibEndM) - (tibStartH * 60 + tibStartM);
        if (timeInBed < 0) timeInBed += 24 * 60;

        // Sleep Period Time (SPT) = Final wake - (Lights out + Sleep latency)
        const [loH, loM] = lightsOut.split(':').map(Number);
        const [fwH, fwM] = finalWake.split(':').map(Number);
        let sleepPeriodTime = (fwH * 60 + fwM) - (loH * 60 + loM) - latency;
        if (sleepPeriodTime < 0) sleepPeriodTime += 24 * 60;

        // Total Sleep Time (TST) = SPT - WASO
        const totalSleepTime = sleepPeriodTime - waso;

        // Sleep Efficiency (SE) = (TST / TIB) * 100
        const sleepEfficiency = timeInBed > 0 ? (totalSleepTime / timeInBed * 100) : 0;

        // Sleep Onset Latency (SOL) = latency
        const sleepOnsetLatency = latency;

        const entry = {
            date: document.getElementById('diaryDate').value,
            // Time fields
            bedtime: bedtime || null,
            lightsOut,
            finalWake,
            outOfBed: outOfBed || null,
            // Duration fields
            sleepLatency: latency,
            awakenings,
            waso,
            naps,
            // Quality fields
            quality,
            restedness,
            // Other
            substances,
            notes: document.getElementById('diaryNotes').value || '',
            // Calculated metrics
            timeInBed,
            sleepPeriodTime,
            totalSleepTime,
            sleepEfficiency,
            sleepOnsetLatency
        };

        await FirebaseDB.saveDiaryEntry(currentUser.uid, entry);

        // Show calculated metrics
        document.getElementById('diaryMetrics').style.display = 'block';
        document.getElementById('metricTST').textContent = `${Math.floor(totalSleepTime / 60)}h ${totalSleepTime % 60}m`;
        document.getElementById('metricSE').textContent = `${sleepEfficiency.toFixed(0)}%`;
        document.getElementById('metricSOL').textContent = `${latency}m`;
        document.getElementById('metricWASO').textContent = `${waso}m`;

        // Show success message
        const btn = document.querySelector('#diaryForm button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><polyline points="20 6 9 17 4 12"/></svg> Saved!';
        btn.style.background = '#4caf50';

        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '';
        }, 2000);

        // Reset form
        document.getElementById('diaryForm').reset();
        document.getElementById('diaryDate').value = new Date().toISOString().split('T')[0];
        document.querySelectorAll('.time-pill, .quick-pill, .quality-star, .rested-btn').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.date-pill').forEach(p => {
            p.classList.toggle('active', p.textContent.includes('Tonight'));
        });

        // Dismiss reminder
        dismissDiaryReminder();

        loadDiaryEntries();
    }

    // Load diary entries
    async function loadDiaryEntries() {
        const container = document.getElementById('diaryHistory');
        const entries = await FirebaseDB.getDiaryEntries(currentUser.uid);

        if (entries.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No diary entries yet.</p></div>';
            return;
        }

        container.innerHTML = entries.map(e => {
            const date = new Date(e.date);
            return `
                <div class="diary-entry">
                    <div class="diary-entry-date">
                        <div class="day">${date.getDate()}</div>
                        <div class="month">${date.toLocaleDateString('en-US', { month: 'short' })}</div>
                    </div>
                    <div class="diary-entry-stats">
                        <div class="diary-stat">
                            <span>Sleep Time</span>
                            <strong>${Math.floor(e.totalSleepTime / 60)}h ${e.totalSleepTime % 60}m</strong>
                        </div>
                        <div class="diary-stat">
                            <span>Efficiency</span>
                            <strong>${e.sleepEfficiency.toFixed(0)}%</strong>
                        </div>
                        <div class="diary-stat">
                            <span>Latency</span>
                            <strong>${e.sleepLatency}m</strong>
                        </div>
                        <div class="diary-stat">
                            <span>Quality</span>
                            <strong>${e.quality}/5</strong>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ==================== SLEEP ANALYTICS SYSTEM ====================

    let analyticsCharts = {};
    let currentAnalyticsPeriod = 7;
    let allDiaryEntries = [];

    // Switch diary tabs
    function switchDiaryTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.diary-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.diary-tab[onclick="switchDiaryTab('${tabName}')"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.diary-tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`diary-tab-${tabName}`).classList.add('active');

        // Load data for specific tabs
        if (tabName === 'analytics') {
            loadAnalytics();
        } else if (tabName === 'history') {
            loadDiaryEntries();
        } else if (tabName === 'evening') {
            initEveningCheckin();
        }
    }

    // Set analytics period
    function setAnalyticsPeriod(days) {
        currentAnalyticsPeriod = days;
        document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.period-btn[onclick="setAnalyticsPeriod(${days})"]`).classList.add('active');
        loadAnalytics();
    }

    // Load analytics data
    async function loadAnalytics() {
        try {
            allDiaryEntries = await FirebaseDB.getDiaryEntries(currentUser.uid, 90);

            if (allDiaryEntries.length === 0) {
                showEmptyAnalytics();
                return;
            }

            const periodEntries = filterEntriesByPeriod(allDiaryEntries, currentAnalyticsPeriod);

            calculateAndDisplaySleepScore(allDiaryEntries);
            calculateStreak(allDiaryEntries);
            updateSummaryCards(periodEntries);
            createCharts(periodEntries);
            generateInsights(allDiaryEntries, periodEntries);
            updateAchievements(allDiaryEntries);
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    function filterEntriesByPeriod(entries, days) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return entries.filter(e => new Date(e.date) >= cutoff);
    }

    function showEmptyAnalytics() {
        document.getElementById('sleepScoreNumber').textContent = '--';
        document.getElementById('sleepScoreTitle').textContent = 'Start Tracking';
        document.getElementById('sleepScoreSubtitle').textContent = 'Log your first night to begin your sleep journey';
    }

    // Calculate composite sleep score (0-100)
    function calculateAndDisplaySleepScore(entries) {
        if (entries.length < 3) {
            document.getElementById('sleepScoreTitle').textContent = 'Keep Logging';
            document.getElementById('sleepScoreSubtitle').textContent = `${3 - entries.length} more nights needed for your score`;
            return;
        }

        const recentEntries = entries.slice(0, 7);

        // Duration score (7-9 hours is optimal)
        const avgDuration = recentEntries.reduce((sum, e) => sum + (e.totalSleepTime || 0), 0) / recentEntries.length;
        const durationHours = avgDuration / 60;
        let durationScore;
        if (durationHours >= 7 && durationHours <= 9) {
            durationScore = 100;
        } else if (durationHours >= 6 && durationHours < 7) {
            durationScore = 70 + (durationHours - 6) * 30;
        } else if (durationHours > 9 && durationHours <= 10) {
            durationScore = 100 - (durationHours - 9) * 20;
        } else if (durationHours < 6) {
            durationScore = Math.max(0, durationHours / 6 * 70);
        } else {
            durationScore = Math.max(0, 80 - (durationHours - 10) * 20);
        }

        // Efficiency score
        const avgEfficiency = recentEntries.reduce((sum, e) => sum + (e.sleepEfficiency || 0), 0) / recentEntries.length;
        const efficiencyScore = Math.min(100, avgEfficiency * 1.18); // 85% efficiency = 100 score

        // Quality score (1-5 scale to 0-100)
        const avgQuality = recentEntries.reduce((sum, e) => sum + (e.quality || 3), 0) / recentEntries.length;
        const qualityScore = ((avgQuality - 1) / 4) * 100;

        // Consistency score (based on bedtime variance)
        const bedtimes = recentEntries.filter(e => e.bedtime).map(e => {
            const [h, m] = e.bedtime.split(':').map(Number);
            return h < 12 ? h + 24 + m/60 : h + m/60; // Normalize to continuous scale
        });
        let consistencyScore = 100;
        if (bedtimes.length >= 3) {
            const mean = bedtimes.reduce((a, b) => a + b, 0) / bedtimes.length;
            const variance = bedtimes.reduce((sum, bt) => sum + Math.pow(bt - mean, 2), 0) / bedtimes.length;
            const stdDev = Math.sqrt(variance);
            consistencyScore = Math.max(0, 100 - stdDev * 20); // Penalize variance
        }

        // Weighted composite score
        const compositeScore = Math.round(
            durationScore * 0.30 +
            efficiencyScore * 0.30 +
            qualityScore * 0.25 +
            consistencyScore * 0.15
        );

        // Update UI
        document.getElementById('sleepScoreNumber').textContent = compositeScore;
        document.getElementById('scoreDuration').textContent = Math.round(durationScore);
        document.getElementById('scoreEfficiency').textContent = Math.round(efficiencyScore);
        document.getElementById('scoreQuality').textContent = Math.round(qualityScore);
        document.getElementById('scoreConsistency').textContent = Math.round(consistencyScore);

        // Update ring animation
        const ring = document.getElementById('sleepScoreRing');
        const circumference = 326.73;
        const offset = circumference - (compositeScore / 100) * circumference;
        ring.style.strokeDashoffset = offset;

        // Update title based on score
        let title, subtitle;
        if (compositeScore >= 90) {
            title = 'Excellent Sleep';
            subtitle = 'Your sleep is outstanding. Keep it up!';
        } else if (compositeScore >= 75) {
            title = 'Good Sleep';
            subtitle = 'Your sleep is healthy with room for improvement';
        } else if (compositeScore >= 60) {
            title = 'Fair Sleep';
            subtitle = 'There are opportunities to improve your sleep';
        } else {
            title = 'Needs Attention';
            subtitle = 'Consider reviewing your sleep habits';
        }
        document.getElementById('sleepScoreTitle').textContent = title;
        document.getElementById('sleepScoreSubtitle').textContent = subtitle;
    }

    // Calculate logging streak
    function calculateStreak(entries) {
        if (entries.length === 0) {
            document.getElementById('streakCount').textContent = '0 days';
            return 0;
        }

        const sortedDates = entries.map(e => e.date).sort().reverse();
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

        let streak = 0;
        let checkDate = sortedDates[0] === today || sortedDates[0] === yesterday ?
            new Date(sortedDates[0]) : null;

        if (!checkDate) {
            document.getElementById('streakCount').textContent = '0 days';
            return 0;
        }

        const dateSet = new Set(sortedDates);
        while (dateSet.has(checkDate.toISOString().split('T')[0])) {
            streak++;
            checkDate.setDate(checkDate.getDate() - 1);
        }

        document.getElementById('streakCount').textContent = streak === 1 ? '1 day' : `${streak} days`;

        // Update streak icon based on streak length
        const streakIcon = document.querySelector('.streak-icon');
        if (streak >= 30) {
            streakIcon.innerHTML = '<span style="font-size: 20px;">&#128293;</span>'; // Fire emoji
        } else if (streak >= 7) {
            streakIcon.innerHTML = '<span style="font-size: 20px;">&#11088;</span>'; // Star emoji
        } else if (streak >= 3) {
            streakIcon.innerHTML = '<span style="font-size: 20px;">&#9889;</span>'; // Lightning emoji
        }

        return streak;
    }

    // Update summary cards
    function updateSummaryCards(entries) {
        if (entries.length === 0) return;

        // Average sleep time
        const avgTST = entries.reduce((sum, e) => sum + (e.totalSleepTime || 0), 0) / entries.length;
        const hours = Math.floor(avgTST / 60);
        const mins = Math.round(avgTST % 60);
        document.getElementById('avgSleepTime').textContent = `${hours}h ${mins}m`;

        // Average bedtime
        const bedtimes = entries.filter(e => e.bedtime).map(e => e.bedtime);
        if (bedtimes.length > 0) {
            const avgBedtimeMinutes = bedtimes.reduce((sum, bt) => {
                const [h, m] = bt.split(':').map(Number);
                return sum + (h < 12 ? (h + 24) * 60 + m : h * 60 + m);
            }, 0) / bedtimes.length;
            const avgHour = Math.floor(avgBedtimeMinutes / 60) % 24;
            const avgMin = Math.round(avgBedtimeMinutes % 60);
            const period = avgHour >= 12 ? 'PM' : 'AM';
            const displayHour = avgHour % 12 || 12;
            document.getElementById('avgBedtime').textContent = `${displayHour}:${avgMin.toString().padStart(2, '0')} ${period}`;
        }

        // Average efficiency
        const avgEff = entries.reduce((sum, e) => sum + (e.sleepEfficiency || 0), 0) / entries.length;
        document.getElementById('avgEfficiencySum').textContent = `${avgEff.toFixed(0)}%`;

        // Average quality
        const avgQual = entries.reduce((sum, e) => sum + (e.quality || 0), 0) / entries.length;
        document.getElementById('avgQualitySum').textContent = `${avgQual.toFixed(1)}/5`;

        // Average awakenings
        const avgAwk = entries.reduce((sum, e) => sum + (e.awakenings || 0), 0) / entries.length;
        document.getElementById('avgAwakenings').textContent = avgAwk.toFixed(1);

        // Total nights
        document.getElementById('totalNights').textContent = entries.length;
    }

    // Create charts
    function createCharts(entries) {
        if (entries.length === 0) return;

        // Destroy existing charts
        Object.values(analyticsCharts).forEach(chart => chart?.destroy());

        const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
        const labels = sortedEntries.map(e => {
            const date = new Date(e.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 10 }, color: '#666' }
                },
                y: {
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { font: { size: 10 }, color: '#666' }
                }
            }
        };

        // Duration chart
        const durationCtx = document.getElementById('durationChart').getContext('2d');
        analyticsCharts.duration = new Chart(durationCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: sortedEntries.map(e => (e.totalSleepTime || 0) / 60),
                    borderColor: '#C9A962',
                    backgroundColor: 'rgba(201, 169, 98, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#C9A962'
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        min: 0,
                        max: 12,
                        ticks: {
                            ...chartOptions.scales.y.ticks,
                            callback: value => `${value}h`
                        }
                    }
                }
            }
        });

        // Update duration trend
        updateTrend('durationTrend', sortedEntries.map(e => e.totalSleepTime || 0));

        // Efficiency chart
        const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
        analyticsCharts.efficiency = new Chart(efficiencyCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: sortedEntries.map(e => e.sleepEfficiency || 0),
                    borderColor: '#0f1c2e',
                    backgroundColor: 'rgba(15, 28, 46, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#0f1c2e'
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        min: 0,
                        max: 100,
                        ticks: {
                            ...chartOptions.scales.y.ticks,
                            callback: value => `${value}%`
                        }
                    }
                }
            }
        });

        // Update efficiency trend
        updateTrend('efficiencyTrend', sortedEntries.map(e => e.sleepEfficiency || 0));

        // Quality chart (bar)
        const qualityCtx = document.getElementById('qualityChart').getContext('2d');
        analyticsCharts.quality = new Chart(qualityCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: sortedEntries.map(e => e.quality || 0),
                    backgroundColor: sortedEntries.map(e => {
                        const q = e.quality || 0;
                        if (q >= 4) return '#2E7D32';
                        if (q >= 3) return '#F57C00';
                        return '#C62828';
                    }),
                    borderRadius: 4
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        min: 0,
                        max: 5
                    }
                }
            }
        });

        // Bedtime consistency chart
        const bedtimeData = sortedEntries.filter(e => e.bedtime).map(e => {
            const [h, m] = e.bedtime.split(':').map(Number);
            return h < 12 ? h + 24 + m/60 : h + m/60;
        });
        const bedtimeLabels = sortedEntries.filter(e => e.bedtime).map(e => {
            const date = new Date(e.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        if (bedtimeData.length > 0) {
            const bedtimeCtx = document.getElementById('bedtimeChart').getContext('2d');
            analyticsCharts.bedtime = new Chart(bedtimeCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: bedtimeData.map((bt, i) => ({ x: i, y: bt })),
                        backgroundColor: '#4A6085',
                        pointRadius: 6
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        x: {
                            ...chartOptions.scales.x,
                            ticks: {
                                ...chartOptions.scales.x.ticks,
                                callback: (value, index) => bedtimeLabels[index] || ''
                            }
                        },
                        y: {
                            ...chartOptions.scales.y,
                            min: 20, // 8 PM
                            max: 28, // 4 AM
                            ticks: {
                                ...chartOptions.scales.y.ticks,
                                callback: value => {
                                    const h = Math.floor(value) % 24;
                                    return `${h % 12 || 12}${h >= 12 ? 'AM' : 'PM'}`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    function updateTrend(elementId, data) {
        if (data.length < 2) return;

        const firstHalf = data.slice(0, Math.floor(data.length / 2));
        const secondHalf = data.slice(Math.floor(data.length / 2));

        const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
        const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

        const change = ((secondAvg - firstAvg) / firstAvg * 100).toFixed(1);
        const trendEl = document.getElementById(elementId);

        if (change > 0) {
            trendEl.className = 'chart-trend up';
            trendEl.querySelector('span').textContent = `+${change}%`;
        } else if (change < 0) {
            trendEl.className = 'chart-trend down';
            trendEl.querySelector('span').textContent = `${change}%`;
        } else {
            trendEl.className = 'chart-trend neutral';
            trendEl.querySelector('span').textContent = 'No change';
        }
    }

    // Generate personalized insights
    function generateInsights(allEntries, periodEntries) {
        const insights = [];

        if (allEntries.length < 7) {
            document.getElementById('insightsList').innerHTML = `
                <div class="insight-card">
                    <div class="insight-type">Getting Started</div>
                    <p class="insight-text">Log ${7 - allEntries.length} more nights to unlock personalized insights.</p>
                </div>
            `;
            return;
        }

        // Caffeine correlation
        const caffeineNights = allEntries.filter(e => e.substances?.includes('caffeine'));
        const noCaffeineNights = allEntries.filter(e => !e.substances?.includes('caffeine'));
        if (caffeineNights.length >= 3 && noCaffeineNights.length >= 3) {
            const caffeineEfficiency = caffeineNights.reduce((sum, e) => sum + (e.sleepEfficiency || 0), 0) / caffeineNights.length;
            const noCaffeineEfficiency = noCaffeineNights.reduce((sum, e) => sum + (e.sleepEfficiency || 0), 0) / noCaffeineNights.length;
            if (noCaffeineEfficiency - caffeineEfficiency > 5) {
                insights.push({
                    type: 'Pattern Detected',
                    text: `Your sleep efficiency is ${(noCaffeineEfficiency - caffeineEfficiency).toFixed(0)}% higher on nights without caffeine. Consider reducing afternoon caffeine intake.`,
                    action: 'Try limiting caffeine after 2 PM'
                });
            }
        }

        // Alcohol correlation
        const alcoholNights = allEntries.filter(e => e.substances?.includes('alcohol'));
        const noAlcoholNights = allEntries.filter(e => !e.substances?.includes('alcohol'));
        if (alcoholNights.length >= 3 && noAlcoholNights.length >= 3) {
            const alcoholQuality = alcoholNights.reduce((sum, e) => sum + (e.quality || 0), 0) / alcoholNights.length;
            const noAlcoholQuality = noAlcoholNights.reduce((sum, e) => sum + (e.quality || 0), 0) / noAlcoholNights.length;
            if (noAlcoholQuality - alcoholQuality > 0.5) {
                insights.push({
                    type: 'Pattern Detected',
                    text: `Your sleep quality rating is ${(noAlcoholQuality - alcoholQuality).toFixed(1)} points higher on nights without alcohol.`,
                    action: 'Consider alcohol-free nights for better rest'
                });
            }
        }

        // Weekend vs weekday
        const weekendEntries = allEntries.filter(e => {
            const day = new Date(e.date).getDay();
            return day === 0 || day === 6;
        });
        const weekdayEntries = allEntries.filter(e => {
            const day = new Date(e.date).getDay();
            return day !== 0 && day !== 6;
        });
        if (weekendEntries.length >= 3 && weekdayEntries.length >= 5) {
            const weekendSleep = weekendEntries.reduce((sum, e) => sum + (e.totalSleepTime || 0), 0) / weekendEntries.length;
            const weekdaySleep = weekdayEntries.reduce((sum, e) => sum + (e.totalSleepTime || 0), 0) / weekdayEntries.length;
            if (Math.abs(weekendSleep - weekdaySleep) > 60) {
                insights.push({
                    type: 'Consistency',
                    text: `You sleep ${Math.abs((weekendSleep - weekdaySleep) / 60).toFixed(1)} hours ${weekendSleep > weekdaySleep ? 'more' : 'less'} on weekends. Large variations can disrupt your circadian rhythm.`,
                    action: 'Try to maintain consistent sleep times all week'
                });
            }
        }

        // Latency issues
        const avgLatency = allEntries.reduce((sum, e) => sum + (e.sleepLatency || 0), 0) / allEntries.length;
        if (avgLatency > 30) {
            insights.push({
                type: 'Sleep Onset',
                text: `Your average time to fall asleep is ${Math.round(avgLatency)} minutes, which is above the ideal 15-20 minutes.`,
                action: 'Consider a wind-down routine before bed'
            });
        }

        // Positive insight
        const avgEfficiency = periodEntries.reduce((sum, e) => sum + (e.sleepEfficiency || 0), 0) / periodEntries.length;
        if (avgEfficiency >= 85) {
            insights.push({
                type: 'Great Progress',
                text: `Your sleep efficiency of ${avgEfficiency.toFixed(0)}% is excellent! This indicates you're spending your time in bed actually sleeping.`,
                action: 'Keep up the good work!'
            });
        }

        // Render insights
        if (insights.length > 0) {
            document.getElementById('insightsList').innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-type">${insight.type}</div>
                    <p class="insight-text">${insight.text}</p>
                    ${insight.action ? `<div class="insight-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M9 18l6-6-6-6"/></svg> ${insight.action}</div>` : ''}
                </div>
            `).join('');
        }
    }

    // Update achievements
    function updateAchievements(entries) {
        const streak = calculateStreak(entries);
        const avgEfficiency = entries.length > 0 ?
            entries.reduce((sum, e) => sum + (e.sleepEfficiency || 0), 0) / entries.length : 0;
        const avgQuality = entries.length > 0 ?
            entries.reduce((sum, e) => sum + (e.quality || 0), 0) / entries.length : 0;

        // First log
        if (entries.length >= 1) {
            document.getElementById('badge-first-log').classList.remove('locked');
            document.getElementById('badge-first-log').classList.add('earned');
        }

        // Week streak
        if (streak >= 7) {
            document.getElementById('badge-week-streak').classList.remove('locked');
            document.getElementById('badge-week-streak').classList.add('earned');
        }

        // Month streak
        if (streak >= 30) {
            document.getElementById('badge-month-streak').classList.remove('locked');
            document.getElementById('badge-month-streak').classList.add('earned');
        }

        // Efficiency master
        if (avgEfficiency >= 85 && entries.length >= 7) {
            document.getElementById('badge-efficiency-master').classList.remove('locked');
            document.getElementById('badge-efficiency-master').classList.add('earned');
        }

        // Quality sleeper
        if (avgQuality >= 4 && entries.length >= 7) {
            document.getElementById('badge-quality-sleeper').classList.remove('locked');
            document.getElementById('badge-quality-sleeper').classList.add('earned');
        }
    }

    // ==================== EVENING CHECK-IN ====================

    function initEveningCheckin() {
        // Set today's date
        document.getElementById('checkinDate').value = new Date().toISOString().split('T')[0];

        // Initialize slider labels
        updateSliderLabel(document.getElementById('checkinStress'), 'stressLabel');
        updateSliderLabel(document.getElementById('checkinExercise'), 'exerciseLabel');
        updateSliderLabel(document.getElementById('checkinCaffeine'), 'caffeineLabel');
        updateSliderLabel(document.getElementById('checkinScreens'), 'screensLabel');
        updateSliderLabel(document.getElementById('checkinMeals'), 'mealsLabel');
        updateSliderLabel(document.getElementById('checkinMood'), 'moodLabel');

        // Check if already submitted today
        loadTodaysCheckin();
    }

    function updateSliderLabel(slider, labelId) {
        const value = parseInt(slider.value);
        const labels = {
            'stressLabel': ['1 - Very low', '2 - Low', '3 - Mild', '4 - Mild', '5 - Moderate', '6 - Moderate', '7 - High', '8 - High', '9 - Very high', '10 - Extreme'],
            'exerciseLabel': ['0 - None', '1 - Very light', '2 - Light activity', '3 - Moderate', '4 - Vigorous', '5 - Intense workout'],
            'caffeineLabel': ['Just had some', '1 hour ago', '2 hours ago', '3 hours ago', '4 hours ago', '5 hours ago', '6 hours ago', '7 hours ago', '8+ hours ago', '9+ hours', '10+ hours', '11+ hours', 'No caffeine today'],
            'screensLabel': ['0 - No screens', '1 - 30 min or less', '2 - 1 hour', '3 - 2+ hours', '4 - Right before bed'],
            'mealsLabel': ['Just ate', '1 hour', '2 hours', '3+ hours', '4+ hours', '5+ hours', '6+ hours'],
            'moodLabel': ['1 - Very low', '2 - Low', '3 - Neutral', '4 - Good', '5 - Great']
        };
        document.getElementById(labelId).textContent = labels[labelId]?.[value] || value;
    }

    async function loadTodaysCheckin() {
        const today = new Date().toISOString().split('T')[0];
        try {
            const snapshot = await db.collection('eveningCheckins')
                .where('userId', '==', currentUser.uid)
                .where('date', '==', today)
                .get();

            if (!snapshot.empty) {
                const checkin = snapshot.docs[0].data();
                showCheckinSummary(checkin);
                generateEveningTips(checkin);
            }
        } catch (error) {
            console.error('Error loading checkin:', error);
        }
    }

    async function saveEveningCheckin(e) {
        e.preventDefault();

        const checkin = {
            userId: currentUser.uid,
            date: document.getElementById('checkinDate').value || new Date().toISOString().split('T')[0],
            stress: parseInt(document.getElementById('checkinStress').value),
            exercise: parseInt(document.getElementById('checkinExercise').value),
            caffeine: parseInt(document.getElementById('checkinCaffeine').value),
            screens: parseInt(document.getElementById('checkinScreens').value),
            meals: parseInt(document.getElementById('checkinMeals').value),
            mood: parseInt(document.getElementById('checkinMood').value),
            notes: document.getElementById('checkinNotes').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection('eveningCheckins').add(checkin);
            showCheckinSummary(checkin);
            generateEveningTips(checkin);
            alert('Evening check-in saved! Check below for personalized tips.');
        } catch (error) {
            console.error('Error saving checkin:', error);
            alert('Error saving check-in. Please try again.');
        }
    }

    function showCheckinSummary(checkin) {
        document.getElementById('todaysFactors').style.display = 'block';
        document.getElementById('factorsSummary').innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; color: var(--navy);">${checkin.stress}/10</div>
                    <div style="font-size: 11px; color: var(--text-light);">Stress</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; color: var(--navy);">${checkin.exercise}/5</div>
                    <div style="font-size: 11px; color: var(--text-light);">Exercise</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; color: var(--navy);">${checkin.mood}/5</div>
                    <div style="font-size: 11px; color: var(--text-light);">Mood</div>
                </div>
            </div>
        `;
    }

    function generateEveningTips(checkin) {
        const tips = [];

        if (checkin.stress >= 7) {
            tips.push({
                type: 'Stress Management',
                text: 'High stress detected. Try the 4-7-8 breathing technique before bed: inhale for 4 seconds, hold for 7, exhale for 8.'
            });
        }

        if (checkin.caffeine <= 4) {
            tips.push({
                type: 'Caffeine Alert',
                text: 'You had caffeine recently. Consider drinking extra water and avoiding additional stimulants tonight.'
            });
        }

        if (checkin.screens >= 3) {
            tips.push({
                type: 'Blue Light',
                text: 'High screen time today. Enable night mode on devices and consider reading a physical book for 20 minutes before bed.'
            });
        }

        if (checkin.meals <= 1) {
            tips.push({
                type: 'Digestion',
                text: 'You ate recently. Light activity like a gentle walk can help digestion before bed.'
            });
        }

        if (checkin.exercise >= 4) {
            tips.push({
                type: 'Recovery',
                text: 'Intense exercise today - great! Make sure to stay hydrated and give your body time to cool down before bed.'
            });
        }

        if (tips.length === 0) {
            tips.push({
                type: 'Looking Good',
                text: 'Your evening habits look healthy tonight! Stick to your regular bedtime routine for optimal rest.'
            });
        }

        document.getElementById('eveningTips').innerHTML = tips.map(tip => `
            <div class="insight-card">
                <div class="insight-type">${tip.type}</div>
                <p class="insight-text">${tip.text}</p>
            </div>
        `).join('');
    }

    // ==================== SLEEP KNOWLEDGE QUIZ ====================

    // Quiz Categories
    const quizCategories = {
        general: {
            name: "Sleep Basics",
            icon: "moon",
            description: "Test your fundamental sleep knowledge",
            color: "#C9A962"
        },
        athlete: {
            name: "Athlete Performance",
            icon: "activity",
            description: "Sleep strategies for peak athletic performance",
            color: "#2A8B8B"
        },
        executive: {
            name: "Executive Edge",
            icon: "briefcase",
            description: "Optimize sleep for decision-making and leadership",
            color: "#4A6085"
        },
        traveler: {
            name: "Jet Lag Master",
            icon: "globe",
            description: "Conquer time zones and travel fatigue",
            color: "#8B4D5C"
        }
    };

    // General Sleep Questions
    const generalQuizQuestions = [
        {
            question: "What is the ideal room temperature for sleep?",
            options: ["72-76F (22-24C)", "65-68F (18-20C)", "78-82F (26-28C)", "60-62F (15-17C)"],
            correct: 1,
            explanation: "Research shows that a cooler room temperature of 65-68F (18-20C) is optimal for sleep. Your body temperature naturally drops during sleep, and a cool environment helps facilitate this process.",
            tip: "<strong>Action:</strong> Set your thermostat to 65-68F before bed. If you tend to get cold, use breathable layers that you can remove during the night."
        },
        {
            question: "How long before bed should you stop consuming caffeine?",
            options: ["2 hours", "4 hours", "6-8 hours", "12 hours"],
            correct: 2,
            explanation: "Caffeine has a half-life of about 5-6 hours, meaning half of it is still in your system after that time. For optimal sleep, avoid caffeine 6-8 hours before bed.",
            tip: "<strong>Action:</strong> If you go to bed at 10 PM, have your last coffee by 2-4 PM. Switch to herbal tea or decaf in the afternoon."
        },
        {
            question: "Which of these is a sign of good sleep quality?",
            options: ["Waking up multiple times during the night", "Needing more than 30 minutes to fall asleep", "Feeling refreshed upon waking", "Sleeping 10+ hours regularly"],
            correct: 2,
            explanation: "Feeling refreshed and alert upon waking is one of the best indicators of good sleep quality. Frequent awakenings, long sleep latency, or excessive sleep duration can indicate underlying sleep issues.",
            tip: "<strong>Action:</strong> Track how you feel each morning on a 1-5 scale. If you consistently score below 3, consider reviewing your sleep habits or consulting a specialist."
        },
        {
            question: "What happens to your brain during REM sleep?",
            options: ["It shuts down completely", "Memory consolidation and emotional processing occur", "It only controls breathing", "Nothing significant"],
            correct: 1,
            explanation: "During REM (Rapid Eye Movement) sleep, your brain is highly active - consolidating memories, processing emotions, and even solving problems. This is when most vivid dreaming occurs.",
            tip: "<strong>Action:</strong> To maximize REM sleep, maintain consistent sleep schedules. REM periods get longer toward morning, so cutting sleep short especially reduces this vital stage."
        },
        {
            question: "True or False: You can 'catch up' on lost sleep over the weekend.",
            options: ["True - weekend sleep fully recovers lost sleep", "Partially true - it helps but doesn't fully compensate", "False - lost sleep is lost forever", "It depends on your age"],
            correct: 1,
            explanation: "While weekend recovery sleep can help reduce some effects of sleep debt, it doesn't fully reverse the cognitive impairments or health effects of chronic sleep deprivation. Consistent sleep is far more beneficial.",
            tip: "<strong>Action:</strong> Instead of 'sleep bingeing' on weekends, aim for consistent bedtimes. If you must catch up, limit it to 1-2 extra hours to avoid disrupting your schedule."
        },
        {
            question: "Which activity is BEST for the hour before bed?",
            options: ["Watching an exciting TV show", "Checking work emails", "Reading a physical book with dim lighting", "Intense exercise"],
            correct: 2,
            explanation: "Reading a physical book with dim lighting is ideal because it's relaxing, doesn't emit blue light, and creates a positive sleep association. Screens and stimulating activities activate your brain and suppress melatonin.",
            tip: "<strong>Action:</strong> Create a 'wind-down' routine: dim lights, put away screens, and do calming activities like reading, gentle stretching, or listening to soft music."
        },
        {
            question: "How many complete sleep cycles does an adult typically go through per night?",
            options: ["2-3 cycles", "4-6 cycles", "7-8 cycles", "It varies too much to say"],
            correct: 1,
            explanation: "Adults typically experience 4-6 complete sleep cycles per night, with each cycle lasting about 90 minutes. Each cycle includes light sleep, deep sleep, and REM sleep.",
            tip: "<strong>Action:</strong> Try to wake up at the end of a cycle rather than in the middle. Use a sleep calculator or smart alarm that detects your sleep stage."
        },
        {
            question: "What is 'sleep efficiency'?",
            options: ["How quickly you complete tasks after waking", "The percentage of time in bed actually spent sleeping", "How little sleep you need to function", "The quality of your dreams"],
            correct: 1,
            explanation: "Sleep efficiency is the percentage of time spent in bed that you're actually asleep. A sleep efficiency above 85% is considered good. If you spend 8 hours in bed but only sleep 6, your efficiency is 75%.",
            tip: "<strong>Action:</strong> If your sleep efficiency is low, try going to bed later or getting up earlier. Only use your bed for sleep - this strengthens the bed-sleep association."
        },
        {
            question: "Why does alcohol disrupt sleep even though it makes you drowsy?",
            options: ["It doesn't - alcohol helps you sleep better", "It causes frequent bathroom trips only", "It suppresses REM sleep and causes fragmented sleep later in the night", "It only affects people with alcohol sensitivity"],
            correct: 2,
            explanation: "While alcohol initially acts as a sedative, it significantly disrupts sleep architecture. It suppresses REM sleep, causes more awakenings in the second half of the night, and can worsen sleep apnea and snoring.",
            tip: "<strong>Action:</strong> If you drink, finish your last drink 3-4 hours before bed and limit consumption. Alternating with water helps reduce sleep disruption."
        },
        {
            question: "What is the recommended sleep duration for most adults?",
            options: ["5-6 hours", "6-7 hours", "7-9 hours", "9-10 hours"],
            correct: 2,
            explanation: "The National Sleep Foundation recommends 7-9 hours for adults aged 18-64. Individual needs vary, but consistently sleeping less than 7 hours is associated with increased health risks.",
            tip: "<strong>Action:</strong> Experiment to find your ideal duration within 7-9 hours. The right amount leaves you feeling refreshed without an alarm and alert throughout the day."
        }
    ];

    // Athlete-Specific Questions
    const athleteQuizQuestions = [
        {
            question: "How much can reaction time slow after just one night of poor sleep?",
            options: ["5%", "10-15%", "Up to 300%", "No significant change"],
            correct: 2,
            explanation: "Studies show reaction time can slow by up to 300% after sleep deprivation. For athletes, this means slower starts, delayed responses, and increased injury risk. Even moderate sleep loss impacts performance.",
            tip: "<strong>Action:</strong> Prioritize 8-10 hours before competitions. Track your reaction times with apps to see how sleep affects your personal performance."
        },
        {
            question: "What is the optimal nap duration for athletic performance?",
            options: ["10-20 minutes", "30-45 minutes", "60-90 minutes", "2+ hours"],
            correct: 0,
            explanation: "A 10-20 minute 'power nap' boosts alertness without causing sleep inertia (grogginess). Longer naps can leave you groggy for 30+ minutes. However, if you have 90 minutes, a full sleep cycle can be beneficial.",
            tip: "<strong>Action:</strong> Schedule 20-minute naps 6-8 hours before competition. Set an alarm and nap in a cool, dark space. Avoid napping within 4 hours of bedtime."
        },
        {
            question: "How does sleep deprivation affect injury risk in athletes?",
            options: ["No effect on injury risk", "Increases risk by 20-30%", "Increases risk by 60-70%", "Only affects contact sports"],
            correct: 2,
            explanation: "Research on adolescent athletes found those sleeping less than 8 hours had 1.7x higher injury rates. Sleep deprivation impairs coordination, reaction time, and tissue recovery - all key factors in injury prevention.",
            tip: "<strong>Action:</strong> Monitor your sleep during heavy training periods. If you're getting less than 7 hours consistently, you're at significantly higher injury risk. Adjust training load or prioritize sleep."
        },
        {
            question: "When is the worst time for athletes to train if they want quality sleep?",
            options: ["Early morning (5-7 AM)", "Late morning (10 AM-12 PM)", "Late evening (after 8 PM)", "Afternoon (2-5 PM)"],
            correct: 2,
            explanation: "High-intensity exercise within 2-3 hours of bedtime raises core body temperature and stimulates the nervous system, making it harder to fall asleep. Morning and afternoon training typically don't affect sleep quality.",
            tip: "<strong>Action:</strong> Finish intense workouts at least 3 hours before bed. If evening training is unavoidable, follow with a cool shower and extended wind-down routine."
        },
        {
            question: "How much extra sleep do elite athletes typically need compared to non-athletes?",
            options: ["Same amount (7-9 hours)", "1-2 extra hours (8-10 hours)", "3-4 extra hours (10-12 hours)", "Less sleep due to better fitness"],
            correct: 1,
            explanation: "Elite athletes often need 8-10 hours of sleep for optimal recovery. During heavy training or competition, some need even more. The body repairs muscle tissue and releases growth hormone primarily during deep sleep.",
            tip: "<strong>Action:</strong> During intense training blocks, aim for 9-10 hours. Consider 'sleep banking' - getting extra sleep in the week before major competitions."
        },
        {
            question: "What happens to human growth hormone (HGH) release during sleep?",
            options: ["HGH is released evenly throughout sleep", "70-80% is released during deep sleep", "HGH is only released when awake", "HGH release isn't affected by sleep"],
            correct: 1,
            explanation: "About 70-80% of daily HGH is released during deep sleep stages. HGH is critical for muscle repair, bone density, and recovery. Poor sleep directly limits your body's repair mechanisms.",
            tip: "<strong>Action:</strong> Maximize deep sleep by avoiding alcohol (it suppresses deep sleep), keeping consistent bedtimes, and ensuring complete darkness in your room."
        },
        {
            question: "How does sleep affect muscle protein synthesis?",
            options: ["Sleep has no effect on protein synthesis", "Protein synthesis stops during sleep", "Sleep enhances protein synthesis by 20-30%", "Only REM sleep affects protein synthesis"],
            correct: 2,
            explanation: "Quality sleep enhances muscle protein synthesis by 20-30%. During sleep, blood flow to muscles increases, delivering nutrients for repair. Sleep deprivation shifts the body toward muscle breakdown (catabolism).",
            tip: "<strong>Action:</strong> Have a protein-rich snack (20-30g) 1-2 hours before bed. Casein protein is ideal as it releases slowly overnight. Combine with good sleep for maximum recovery."
        },
        {
            question: "What is 'sleep banking' and does it work for athletes?",
            options: ["It's a myth - you can't store sleep", "Sleeping extra before competition can improve performance", "It only works for endurance athletes", "It requires sleeping 12+ hours daily"],
            correct: 1,
            explanation: "Sleep banking - getting extra sleep before a period of expected sleep loss - has been shown to improve cognitive function and physical performance. Studies show athletes who banked sleep before competitions performed better.",
            tip: "<strong>Action:</strong> In the week before major competitions, add 1-2 hours to your normal sleep. This builds a reserve that helps maintain performance even if pre-event nerves disrupt sleep."
        },
        {
            question: "How quickly does athletic performance decline with sleep debt?",
            options: ["Only after several days of poor sleep", "Performance drops after just one night", "Only affects mental, not physical performance", "Athletes are immune to sleep debt effects"],
            correct: 1,
            explanation: "Performance metrics decline after just one night of inadequate sleep. Sprint times slow, accuracy drops, and perceived exertion increases. The effects compound with consecutive nights of poor sleep.",
            tip: "<strong>Action:</strong> Never sacrifice sleep the night before competition. If you have one bad night, a 20-minute nap can help recover some performance, but consistent sleep is best."
        },
        {
            question: "What role does sleep play in motor learning and skill acquisition?",
            options: ["Skills are only learned during practice", "Sleep consolidates motor memories, improving skills by 20-30%", "Sleep only affects theoretical knowledge", "Motor learning happens equally awake or asleep"],
            correct: 1,
            explanation: "During sleep, the brain replays and strengthens motor patterns learned during practice. Studies show performance on newly learned skills improves 20-30% after sleep, without additional practice.",
            tip: "<strong>Action:</strong> After learning new techniques, prioritize sleep that night. The skill consolidation happens primarily in the first sleep cycle after learning."
        }
    ];

    // Executive-Specific Questions
    const executiveQuizQuestions = [
        {
            question: "How does sleep deprivation affect decision-making quality?",
            options: ["Minimal impact on decisions", "Increases risk-taking and impairs judgment", "Only affects simple decisions", "Makes decisions faster and more efficient"],
            correct: 1,
            explanation: "Sleep deprivation impairs the prefrontal cortex, leading to increased risk-taking, poor judgment, and difficulty weighing long-term consequences. Leaders may feel confident in bad decisions while sleep-deprived.",
            tip: "<strong>Action:</strong> Never make major decisions after poor sleep. If unavoidable, use decision frameworks and seek input from well-rested colleagues to compensate for impaired judgment."
        },
        {
            question: "What is the 'CEO sleep paradox'?",
            options: ["CEOs need less sleep than others", "Sleep-deprived leaders think they're performing well when they're not", "Executives should sleep more on weekends", "Leadership skills replace the need for sleep"],
            correct: 1,
            explanation: "Research shows sleep-deprived individuals lose the ability to accurately assess their own impairment. Executives may believe they're functioning normally while cognitive tests show significant decline.",
            tip: "<strong>Action:</strong> Don't trust your self-assessment when sleep-deprived. Track objective metrics (reaction time apps, decision outcomes) and listen to feedback from trusted colleagues."
        },
        {
            question: "How does a leader's sleep affect their team's performance?",
            options: ["No connection between leader sleep and team performance", "Sleep-deprived leaders have less engaged teams", "Teams compensate for tired leaders", "Only affects teams in creative industries"],
            correct: 1,
            explanation: "Studies show sleep-deprived leaders are perceived as less charismatic, less inspiring, and more abusive. Their teams report lower engagement, more conflict, and reduced performance.",
            tip: "<strong>Action:</strong> View your sleep as a leadership responsibility, not a personal choice. Your rest directly impacts your team's morale and productivity."
        },
        {
            question: "What is the most effective power nap strategy for executives?",
            options: ["Skip naps - they show weakness", "90-minute naps in your office", "10-20 minute 'coffee naps'", "Only nap on weekends"],
            correct: 2,
            explanation: "A 'coffee nap' - drinking coffee then immediately napping for 15-20 minutes - is highly effective. The caffeine kicks in as you wake, combining the alertness boost of both. Many top executives use this strategy.",
            tip: "<strong>Action:</strong> Drink coffee quickly, set a 20-minute timer, and nap immediately. The caffeine takes 20 minutes to absorb, so you wake just as it kicks in."
        },
        {
            question: "How much productivity is lost due to sleep-deprived employees?",
            options: ["$500 per employee annually", "About $2,000 per employee annually", "Over $2,000 per employee annually (up to $3,400)", "No measurable productivity loss"],
            correct: 2,
            explanation: "Harvard research estimates sleep deprivation costs U.S. companies $63 billion annually in lost productivity. Per employee, this translates to $2,000-$3,400 in lost productivity through presenteeism and errors.",
            tip: "<strong>Action:</strong> Consider sleep as an ROI issue. Policies supporting employee sleep (flexible start times, nap rooms) often pay for themselves in productivity gains."
        },
        {
            question: "What's the relationship between sleep and emotional intelligence (EQ)?",
            options: ["EQ is fixed and unaffected by sleep", "Sleep deprivation significantly reduces EQ", "Only affects EQ in introverts", "More sleep actually decreases EQ"],
            correct: 1,
            explanation: "Sleep deprivation reduces ability to read emotions, manage reactions, and show empathy - all core EQ skills. Leaders become more irritable, less patient, and worse at reading room dynamics.",
            tip: "<strong>Action:</strong> Before important meetings involving negotiation, conflict resolution, or sensitive conversations, ensure you're well-rested. Your EQ will be sharper."
        },
        {
            question: "How should executives handle early morning meetings across time zones?",
            options: ["Always accommodate the most senior person's time zone", "Rotate meeting times fairly", "Use strategic light exposure and gradual schedule shifts", "Take sleeping pills to adjust quickly"],
            correct: 2,
            explanation: "For recurring cross-time-zone meetings, use light exposure to shift your rhythm. Morning light advances your clock (good for early meetings), evening light delays it. Gradual 30-minute shifts are more sustainable than sudden changes.",
            tip: "<strong>Action:</strong> For a 6 AM meeting, expose yourself to bright light at 5 AM for a few days prior. Consider a light therapy box for your home office."
        },
        {
            question: "What is 'sleep hygiene ROI' for high-performers?",
            options: ["Diminishing returns - busy executives shouldn't bother", "Each hour of quality sleep returns 2-3 hours of productive work", "Only matters for physical jobs", "Sleep quality doesn't affect knowledge work"],
            correct: 1,
            explanation: "Studies on knowledge workers show that each hour of quality sleep can return 2-3 hours of productive, high-quality work. Sleep-deprived executives work more hours but accomplish less meaningful work.",
            tip: "<strong>Action:</strong> Track your output quality, not just hours worked. You may find that 6 well-rested hours outperform 10 exhausted hours."
        },
        {
            question: "How does chronic sleep deprivation affect strategic thinking?",
            options: ["No effect on strategic capabilities", "Reduces ability to see big picture and long-term consequences", "Actually improves focus on details", "Only affects tactical decisions"],
            correct: 1,
            explanation: "Sleep deprivation narrows focus to immediate concerns, reducing ability to think strategically, consider multiple scenarios, or weigh long-term implications. Leaders become reactive rather than proactive.",
            tip: "<strong>Action:</strong> Schedule strategic planning sessions for times when you're well-rested. Avoid making long-term decisions during or after periods of sleep debt."
        },
        {
            question: "What's the best approach to business travel and sleep?",
            options: ["Sleep on the plane, work at the hotel", "Adapt to local time immediately", "Stay on home time for trips under 48 hours", "Always take sleeping pills"],
            correct: 2,
            explanation: "For trips under 48 hours, staying on home time often works better than forcing adaptation. Schedule meetings during your 'home' alert hours when possible. For longer trips, adapt gradually.",
            tip: "<strong>Action:</strong> For short trips, schedule critical meetings during your home-time peak hours. For longer trips, start shifting your schedule 2-3 days before departure."
        }
    ];

    // Traveler-Specific Questions
    const travelerQuizQuestions = [
        {
            question: "How long does it typically take to adjust to a new time zone?",
            options: ["1 day total", "About 1 day per time zone crossed", "1 week regardless of distance", "Adjustment is immediate"],
            correct: 1,
            explanation: "The general rule is one day of adjustment per time zone crossed. Flying from New York to London (5 time zones) typically requires about 5 days for full circadian adjustment.",
            tip: "<strong>Action:</strong> For important events, arrive early enough to adjust. If flying 6 time zones, arrive at least 3-4 days early for critical meetings or performances."
        },
        {
            question: "Is jet lag worse when flying east or west?",
            options: ["Flying west is worse", "Flying east is worse", "Both directions are equally difficult", "Depends on the airline"],
            correct: 1,
            explanation: "Flying east is typically harder because you must advance your body clock (go to sleep earlier), which is more difficult than delaying it. Our natural circadian rhythm runs slightly longer than 24 hours, making it easier to stay up late.",
            tip: "<strong>Action:</strong> When flying east, start going to bed 30 minutes earlier for several days before departure. Use morning light at your destination to help advance your clock."
        },
        {
            question: "What is the best time to take melatonin for eastward travel?",
            options: ["Morning at your destination", "Evening at your destination (30 min before desired bedtime)", "Whenever you feel tired", "Melatonin doesn't help with jet lag"],
            correct: 1,
            explanation: "For eastward travel, take 0.5-3mg melatonin about 30 minutes before your target bedtime at the destination. This helps signal to your body that it's time to sleep in the new time zone.",
            tip: "<strong>Action:</strong> Start taking melatonin at your destination bedtime even before you leave. Continue for 4-5 days after arrival. Lower doses (0.5-1mg) are often as effective as higher doses."
        },
        {
            question: "How does light exposure help with jet lag?",
            options: ["Light has no effect on jet lag", "Bright light in the morning helps you adjust to earlier time zones", "You should avoid all light when jet-lagged", "Only artificial light helps"],
            correct: 1,
            explanation: "Light is the most powerful circadian signal. Morning bright light advances your clock (helpful after flying east), while evening light delays it (helpful after flying west). Strategic light exposure can cut adjustment time in half.",
            tip: "<strong>Action:</strong> After flying east, seek bright morning light and avoid evening light. After flying west, seek evening light and use sunglasses in the morning if needed."
        },
        {
            question: "Should you sleep on the plane during a long-haul flight?",
            options: ["Never - stay awake to tire yourself", "Always sleep as much as possible", "Only sleep if it's nighttime at your destination", "Sleep only in first class"],
            correct: 2,
            explanation: "Strategic plane sleep aligned with your destination time helps pre-adjust your body clock. If it's nighttime where you're going, try to sleep. If it's daytime there, try to stay awake.",
            tip: "<strong>Action:</strong> Change your watch to destination time at takeoff. Sleep when it's night there, stay awake when it's day. Use eye masks, earplugs, and avoid alcohol to improve plane sleep quality."
        },
        {
            question: "What is the 'jet lag diet' approach?",
            options: ["Fasting completely during travel", "Alternating feast and fast days before travel", "Eating only local cuisine", "There's no diet approach to jet lag"],
            correct: 1,
            explanation: "The Argonne Anti-Jet-Lag Diet alternates feast/fast days before travel to reset the body's food clock. While evidence is mixed, many travelers report it helps. Meal timing does influence circadian rhythms.",
            tip: "<strong>Action:</strong> A simpler approach: fast during the flight and eat your first meal at the local breakfast time. This helps reset your food clock to the new time zone."
        },
        {
            question: "How does caffeine affect jet lag recovery?",
            options: ["Avoid caffeine entirely when jet-lagged", "Use caffeine strategically based on destination time", "Caffeine has no effect on circadian adjustment", "Drink as much caffeine as needed"],
            correct: 1,
            explanation: "Strategic caffeine use can help - consuming it in the morning (destination time) helps you stay alert during desired wake hours. However, caffeine in the evening can prevent sleep when you need to adjust.",
            tip: "<strong>Action:</strong> After arriving, have caffeine only during morning hours (destination time). Cut off caffeine by early afternoon to protect that night's sleep, which is crucial for adjustment."
        },
        {
            question: "What's the best hotel room strategy for beating jet lag?",
            options: ["Choose the highest floor for quiet", "Request a room with blackout curtains and eastern exposure", "Room location doesn't matter", "Always choose rooms near the elevator"],
            correct: 1,
            explanation: "Eastern exposure gives you natural morning light to help advance your clock (useful after eastward travel). Blackout curtains let you control light exposure. Room temperature control also matters for sleep quality.",
            tip: "<strong>Action:</strong> When booking, request quiet rooms with good light control. Bring a travel blackout solution (eye mask or portable curtains) as backup. Request rooms away from ice machines and elevators."
        },
        {
            question: "How does exercise timing help with jet lag?",
            options: ["Avoid exercise when jet-lagged", "Exercise at your normal home time", "Exercise in the morning at your destination helps adjustment", "Only evening exercise helps"],
            correct: 2,
            explanation: "Morning exercise at your destination helps shift your body clock forward and promotes alertness during local daytime. It also helps tire you appropriately for local bedtime.",
            tip: "<strong>Action:</strong> Upon arrival, try to get 20-30 minutes of outdoor exercise in the morning. The combination of light, activity, and social engagement accelerates circadian adjustment."
        },
        {
            question: "What is 'social jet lag' and why does it matter?",
            options: ["Feeling antisocial after travel", "The weekly misalignment between work days and weekend sleep patterns", "Missing social events due to travel", "A type of jet lag affecting only group travelers"],
            correct: 1,
            explanation: "Social jet lag refers to the difference between your natural sleep timing and your work schedule. Sleeping late on weekends and early on weekdays creates chronic circadian disruption similar to crossing time zones weekly.",
            tip: "<strong>Action:</strong> Keep weekend wake times within 1 hour of weekday times. This prevents the 'Monday morning jet lag' that many people experience and improves overall sleep quality."
        }
    ];

    // Combined quiz pools
    const allQuizPools = {
        general: generalQuizQuestions,
        athlete: athleteQuizQuestions,
        executive: executiveQuizQuestions,
        traveler: travelerQuizQuestions
    };

    let quizState = {
        currentQuestion: 0,
        score: 0,
        answered: false,
        shuffledQuestions: [],
        currentCategory: 'general'
    };

    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function selectQuizCategory(category) {
        document.querySelectorAll('.quiz-category-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.quiz-category-btn[data-category="${category}"]`)?.classList.add('active');
        quizState.currentCategory = category;

        // Update start button text
        const catInfo = quizCategories[category];
        document.getElementById('quizCategoryName').textContent = catInfo.name;
        document.getElementById('quizCategoryDesc').textContent = catInfo.description;
    }

    function startQuiz(category = null) {
        const selectedCategory = category || quizState.currentCategory || 'general';
        const questions = allQuizPools[selectedCategory] || generalQuizQuestions;

        quizState = {
            currentQuestion: 0,
            score: 0,
            answered: false,
            shuffledQuestions: shuffleArray(questions).slice(0, 10),
            currentCategory: selectedCategory
        };

        document.getElementById('quizStart').style.display = 'none';
        document.getElementById('quizContent').style.display = 'block';
        document.getElementById('quizResults').style.display = 'none';

        displayQuestion();
    }

    function displayQuestion() {
        const question = quizState.shuffledQuestions[quizState.currentQuestion];
        const questionNum = quizState.currentQuestion + 1;
        const totalQuestions = quizState.shuffledQuestions.length;

        document.getElementById('quizQuestionNumber').textContent = `Question ${questionNum}`;
        document.getElementById('quizQuestionText').textContent = question.question;
        document.getElementById('quizProgressText').textContent = `${questionNum} of ${totalQuestions}`;
        document.getElementById('quizProgressFill').style.width = `${(questionNum / totalQuestions) * 100}%`;

        const optionsContainer = document.getElementById('quizOptions');
        const letters = ['A', 'B', 'C', 'D'];

        optionsContainer.innerHTML = question.options.map((option, index) => `
            <div class="quiz-option" onclick="selectAnswer(${index})" data-index="${index}">
                <div class="quiz-option-letter">${letters[index]}</div>
                <div class="quiz-option-text">${option}</div>
            </div>
        `).join('');

        document.getElementById('quizFeedback').classList.remove('show', 'correct', 'incorrect');
        document.getElementById('quizNextBtn').disabled = true;
        quizState.answered = false;

        // Update button text for last question
        if (questionNum === totalQuestions) {
            document.getElementById('quizNextBtn').innerHTML = `
                See Results
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            `;
        } else {
            document.getElementById('quizNextBtn').innerHTML = `
                Next Question
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            `;
        }
    }

    function selectAnswer(selectedIndex) {
        if (quizState.answered) return;
        quizState.answered = true;

        const question = quizState.shuffledQuestions[quizState.currentQuestion];
        const isCorrect = selectedIndex === question.correct;

        if (isCorrect) quizState.score++;

        // Update option styles
        const options = document.querySelectorAll('.quiz-option');
        options.forEach((option, index) => {
            option.classList.add('disabled');
            if (index === question.correct) {
                option.classList.add('correct');
            } else if (index === selectedIndex && !isCorrect) {
                option.classList.add('incorrect');
            }
        });

        // Show feedback
        const feedbackEl = document.getElementById('quizFeedback');
        feedbackEl.classList.add('show', isCorrect ? 'correct' : 'incorrect');

        document.getElementById('feedbackTitle').textContent = isCorrect ? 'Correct!' : 'Not quite right';
        document.getElementById('feedbackExplanation').textContent = question.explanation;
        document.getElementById('feedbackTip').innerHTML = question.tip;

        // Update feedback icon
        const iconEl = document.getElementById('feedbackIcon');
        if (isCorrect) {
            iconEl.innerHTML = '<polyline points="20 6 9 17 4 12"/>';
        } else {
            iconEl.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>';
        }

        document.getElementById('quizNextBtn').disabled = false;
    }

    function nextQuestion() {
        if (quizState.currentQuestion < quizState.shuffledQuestions.length - 1) {
            quizState.currentQuestion++;
            displayQuestion();
        } else {
            showResults();
        }
    }

    function showResults() {
        document.getElementById('quizContent').style.display = 'none';
        document.getElementById('quizResults').style.display = 'block';

        const score = quizState.score;
        const total = quizState.shuffledQuestions.length;
        const percentage = (score / total) * 100;

        document.getElementById('quizResultsNumber').textContent = score;
        document.getElementById('quizCorrectCount').textContent = score;
        document.getElementById('quizIncorrectCount').textContent = total - score;

        // Animate the ring
        const ring = document.getElementById('quizResultsRing');
        const circumference = 377;
        const offset = circumference - (percentage / 100) * circumference;

        // Set color based on score
        let ringColor;
        if (percentage >= 80) ringColor = '#2E7D32';
        else if (percentage >= 60) ringColor = '#F57C00';
        else ringColor = '#C62828';
        ring.style.stroke = ringColor;

        setTimeout(() => {
            ring.style.strokeDashoffset = offset;
        }, 100);

        // Set title and subtitle based on score
        let title, subtitle;
        if (percentage >= 90) {
            title = 'Sleep Expert!';
            subtitle = 'Impressive knowledge! You understand the science of sleep.';
        } else if (percentage >= 70) {
            title = 'Well Rested!';
            subtitle = 'Great job! You have a solid understanding of sleep science.';
        } else if (percentage >= 50) {
            title = 'Getting There!';
            subtitle = 'Good effort! Review the explanations to learn more.';
        } else {
            title = 'Time to Learn!';
            subtitle = 'Sleep is fascinating - try again to discover more!';
        }

        document.getElementById('quizResultsTitle').textContent = title;
        document.getElementById('quizResultsSubtitle').textContent = subtitle;
    }

    function restartQuiz() {
        document.getElementById('quizResults').style.display = 'none';
        document.getElementById('quizResultsRing').style.strokeDashoffset = 377;
        startQuiz();
    }

    function shareQuizResults() {
        const score = quizState.score;
        const total = quizState.shuffledQuestions.length;
        const text = `I scored ${score}/${total} on the Sleep Knowledge Quiz! Test your sleep IQ at Sleep Wellness by Dr. Alen.`;

        if (navigator.share) {
            navigator.share({
                title: 'My Sleep Quiz Results',
                text: text
            }).catch(() => {
                copyToClipboard(text);
            });
        } else {
            copyToClipboard(text);
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Results copied to clipboard!');
        }).catch(() => {
            alert('Score: ' + quizState.score + '/' + quizState.shuffledQuestions.length);
        });
    }

    // Init messages
    async function initMessages() {
        if (!ADMIN_UID || ADMIN_UID === 'YOUR_ADMIN_UID_HERE') {
            document.getElementById('messagesBody').innerHTML = '<p style="padding: 20px; color: var(--text-light);">Messaging will be available once the admin account is configured.</p>';
            return;
        }

        const conv = await FirebaseDB.getOrCreateConversation(currentUser.uid, ADMIN_UID);
        conversationId = conv.id;

        // Listen for messages
        if (messagesUnsubscribe) messagesUnsubscribe();
        messagesUnsubscribe = FirebaseDB.getMessagesListener(conversationId, renderMessages);
    }

    // Render messages
    function renderMessages(messages) {
        const container = document.getElementById('messagesBody');

        if (messages.length === 0) {
            container.innerHTML = `
                <div class="message received">
                    <p>Welcome to Sleep Wellness! I'm here to help you optimize your sleep.</p>
                    <div class="message-time">Dr. Alen</div>
                </div>
            `;
            return;
        }

        container.innerHTML = messages.map(m => {
            const isSent = m.senderId === currentUser.uid;
            const time = m.createdAt?.toDate().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            return `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <p>${m.text}</p>
                    <div class="message-time">${time || ''}</div>
                </div>
            `;
        }).join('');

        container.scrollTop = container.scrollHeight;
    }

    // Send message
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text || !conversationId) return;

        input.value = '';
        await FirebaseDB.sendMessage(conversationId, currentUser.uid, text);
    }

    function handleMessageKeypress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    // Book appointment
    async function bookAppointment(e) {
        e.preventDefault();

        const date = document.getElementById('apptDate').value;
        const time = document.getElementById('apptTime').value;
        const topic = document.getElementById('apptTopic').value;
        const notes = document.getElementById('apptNotes').value;

        const dateTime = new Date(`${date}T${time}`);

        await FirebaseDB.createAppointment(currentUser.uid, {
            dateTime: firebase.firestore.Timestamp.fromDate(dateTime),
            topic,
            notes,
            userName: userProfile.displayName || currentUser.email
        });

        alert('Appointment request submitted! You will be notified once confirmed.');
        document.getElementById('appointmentForm').reset();
        loadAppointments();
    }

    // Load appointments
    async function loadAppointments() {
        const container = document.getElementById('appointmentsList');
        const appointments = await FirebaseDB.getUserAppointments(currentUser.uid);

        if (appointments.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No appointments scheduled.</p></div>';
            return;
        }

        container.innerHTML = appointments.map(a => {
            const dt = a.dateTime?.toDate();
            if (!dt) return '';
            return `
                <div class="appointment-card ${a.status}">
                    <div class="appointment-date">
                        <div class="appointment-calendar">
                            <div class="month">${dt.toLocaleDateString('en-US', { month: 'short' })}</div>
                            <div class="day">${dt.getDate()}</div>
                        </div>
                        <div class="appointment-time">
                            <h4>${dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</h4>
                            <p>${a.topic}</p>
                        </div>
                    </div>
                    <span class="appointment-status ${a.status}">${a.status}</span>
                </div>
            `;
        }).join('');
    }

    // Load modules - grouped by category
    let userRequests = [];

    // Module category mapping
    const moduleCategories = {
        // Core Sleep Skills
        'sleep-hygiene': 'core',
        'cbti-restriction': 'core',
        'cbti-stimulus': 'core',
        'sleep-diary': 'core',
        // CBT-I Techniques
        'cbti-cognitive': 'cbt',
        'worry-management': 'cbt',
        'paradoxical-intention': 'cbt',
        // Relaxation & Mindfulness
        'pmr': 'relaxation',
        'breathing-478': 'relaxation',
        'mindfulness-bodyscan': 'relaxation',
        'guided-imagery': 'relaxation',
        'autogenic-training': 'relaxation',
        // Travel & Circadian
        'jet-lag-calculator': 'travel',
        'circadian-rhythm': 'travel'
    };

    async function loadModules() {
        const [unlocks, requests] = await Promise.all([
            FirebaseDB.getUserUnlocks(currentUser.uid),
            FirebaseDB.getUserModuleRequests(currentUser.uid)
        ]);
        const hasAll = unlocks.includes('all');
        userRequests = requests;

        // Get pending request module IDs
        const pendingRequests = requests.filter(r => r.status === 'pending').map(r => r.moduleId);

        const modules = Content.modules;

        // Group modules by category
        const grouped = {
            core: [],
            cbt: [],
            relaxation: [],
            travel: [],
            other: []
        };

        Object.keys(modules).forEach(id => {
            const category = moduleCategories[id] || 'other';
            grouped[category].push({ id, ...modules[id] });
        });

        // Show/hide travel section based on client type
        const showTravel = userProfile?.clientType === 'executive' || userProfile?.clientType === 'hotel';
        document.getElementById('travelResourceGroup').style.display = showTravel && grouped.travel.length > 0 ? 'block' : 'none';

        // Render each category
        renderModuleGroup('modulesGrid-core', grouped.core, hasAll, unlocks, pendingRequests);
        renderModuleGroup('modulesGrid-cbt', grouped.cbt, hasAll, unlocks, pendingRequests);
        renderModuleGroup('modulesGrid-relaxation', grouped.relaxation, hasAll, unlocks, pendingRequests);
        renderModuleGroup('modulesGrid-travel', grouped.travel, hasAll, unlocks, pendingRequests);
        renderModuleGroup('modulesGrid-other', grouped.other, hasAll, unlocks, pendingRequests);

        // Hide empty groups
        document.querySelectorAll('.resource-group').forEach(group => {
            const grid = group.querySelector('.modules-grid');
            if (grid && grid.children.length === 0) {
                group.style.display = 'none';
            } else {
                group.style.display = '';
            }
        });
    }

    function renderModuleGroup(containerId, modules, hasAll, unlocks, pendingRequests) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (modules.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = modules.map(m => {
            const id = m.id;
            const isUnlocked = !m.locked || hasAll || unlocks.includes(id);
            const isPending = pendingRequests.includes(id);

            if (isUnlocked) {
                return `
                    <div class="module-card" onclick="Content.openModule('${id}')" style="cursor: pointer;">
                        <svg class="module-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">${Content.getModuleIconSVG(m.icon)}</svg>
                        <h4>${m.title}</h4>
                        <p>${m.description}</p>
                    </div>
                `;
            } else if (isPending) {
                return `
                    <div class="module-card locked" style="cursor: default;">
                        <span class="pending-badge" style="position: absolute; top: 15px; right: 15px; background: var(--warning); color: white; font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Pending</span>
                        <svg class="module-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">${Content.getModuleIconSVG(m.icon)}</svg>
                        <h4>${m.title}</h4>
                        <p>${m.description}</p>
                        <p style="font-size: 12px; color: var(--warning); margin-top: 10px;">Request submitted - awaiting approval</p>
                    </div>
                `;
            } else {
                return `
                    <div class="module-card locked" style="cursor: default; position: relative;">
                        <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <svg class="module-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">${Content.getModuleIconSVG(m.icon)}</svg>
                        <h4>${m.title}</h4>
                        <p>${m.description}</p>
                        <button class="btn-request" onclick="openRequestModal('${id}', '${m.title.replace(/'/g, "\\'")}'); event.stopPropagation();" style="margin-top: 12px; width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--gold-dark); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;">
                            Request Access
                        </button>
                    </div>
                `;
            }
        }).join('');
    }

    // Request modal functions
    function openRequestModal(moduleId, moduleName) {
        document.getElementById('requestModuleId').value = moduleId;
        document.getElementById('requestModuleName').textContent = moduleName;
        document.getElementById('requestReason').value = '';
        document.getElementById('requestModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeRequestModal() {
        document.getElementById('requestModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    async function submitModuleRequest() {
        const moduleId = document.getElementById('requestModuleId').value;
        const moduleName = document.getElementById('requestModuleName').textContent;
        const reason = document.getElementById('requestReason').value.trim();
        const btn = document.getElementById('submitRequestBtn');

        btn.disabled = true;
        btn.textContent = 'Sending...';

        try {
            await FirebaseDB.requestModuleAccess(currentUser.uid, moduleId, moduleName, reason);
            closeRequestModal();
            alert('Request sent! Dr. Alen will review your request.');
            loadModules(); // Refresh to show pending status
        } catch (error) {
            console.error('Error submitting request:', error);
            alert('Error sending request. Please try again.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Send Request';
        }
    }

    // ========== QUESTIONNAIRE FUNCTIONS ==========

    async function loadUserQuestionnaires() {
        const pendingContainer = document.getElementById('pendingQuestionnaires');
        const completedContainer = document.getElementById('completedQuestionnaires');

        try {
            // Get user's questionnaire assignments and results
            const [assignments, results] = await Promise.all([
                FirebaseDB.getUserQuestionnaires(currentUser.uid),
                getUserQuestionnaireResults()
            ]);

            // Filter pending assignments
            const pending = assignments.filter(a => a.status === 'pending');
            const completedIds = results.map(r => r.assignmentId);

            // Update badge
            const badge = document.getElementById('questionnaireBadge');
            if (pending.length > 0) {
                badge.textContent = pending.length;
                badge.style.display = '';
            } else {
                badge.style.display = 'none';
            }

            // Render pending questionnaires
            if (pending.length === 0) {
                pendingContainer.innerHTML = '<p style="color: var(--text-light); font-size: 14px;">No pending questionnaires.</p>';
            } else {
                pendingContainer.innerHTML = pending.map(q => {
                    const dueDate = q.dueDate?.toDate?.();
                    const isOverdue = dueDate && dueDate < new Date();
                    const instrument = Questionnaires?.getInstrument(q.questionnaireId);

                    return `
                        <div class="questionnaire-card ${isOverdue ? 'overdue' : 'pending'}">
                            <div class="questionnaire-info">
                                <h4>${q.questionnaireName || q.questionnaireId}</h4>
                                <div class="questionnaire-meta">
                                    <span>${instrument?.timeToComplete || '2-3 minutes'}</span>
                                    <span>${instrument?.questions?.length || '?'} questions</span>
                                    ${dueDate ? `<span style="${isOverdue ? 'color: #c62828; font-weight: 600;' : ''}">Due: ${dueDate.toLocaleDateString()}${isOverdue ? ' (Overdue)' : ''}</span>` : ''}
                                </div>
                                ${q.notes ? `<p style="font-size: 13px; color: var(--text-light); margin-top: 8px;">${q.notes}</p>` : ''}
                            </div>
                            <button onclick="startQuestionnaire('${q.id}', '${q.questionnaireId}')" class="btn-primary" style="white-space: nowrap;">
                                Start
                            </button>
                        </div>
                    `;
                }).join('');
            }

            // Render completed questionnaires
            if (results.length === 0) {
                completedContainer.innerHTML = '<p style="color: var(--text-light); font-size: 14px;">No completed questionnaires.</p>';
            } else {
                completedContainer.innerHTML = results.map(r => {
                    const completedDate = r.completedAt?.toDate?.();

                    return `
                        <div class="questionnaire-card completed">
                            <div class="questionnaire-info">
                                <h4>${r.questionnaireName || r.questionnaireId}</h4>
                                <div class="questionnaire-meta">
                                    <span>Completed: ${completedDate ? completedDate.toLocaleDateString() : 'N/A'}</span>
                                </div>
                            </div>
                            <div class="questionnaire-result">
                                <div class="questionnaire-score">${r.score}/${r.maxScore}</div>
                                <span class="questionnaire-severity" style="background: ${r.color || '#666'};">${r.interpretation || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading questionnaires:', error);
            pendingContainer.innerHTML = '<p style="color: red;">Error loading questionnaires</p>';
        }
    }

    async function getUserQuestionnaireResults() {
        const snapshot = await db.collection('questionnaireResults')
            .where('userId', '==', currentUser.uid)
            .orderBy('completedAt', 'desc')
            .get();

        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function startQuestionnaire(assignmentId, questionnaireId) {
        // Navigate to questionnaire page with assignment ID
        window.location.href = `questionnaire.html?assignment=${assignmentId}&q=${questionnaireId}`;
    }

    async function updateQuestionnaireBadge() {
        try {
            const assignments = await FirebaseDB.getUserQuestionnaires(currentUser.uid);
            const pending = assignments.filter(a => a.status === 'pending');
            const badge = document.getElementById('questionnaireBadge');

            if (pending.length > 0) {
                badge.textContent = pending.length;
                badge.style.display = '';
            } else {
                badge.style.display = 'none';
            }
        } catch (error) {
            console.error('Error updating questionnaire badge:', error);
        }
    }

    // ========== END QUESTIONNAIRE FUNCTIONS ==========

    // ========== DISCHARGE SURVEY FUNCTIONS ==========

    function openDischargeModal() {
        document.getElementById('dischargeModal').classList.add('active');
        document.body.style.overflow = 'hidden';

        // Setup click handlers for discharge pills
        document.querySelectorAll('.discharge-pill').forEach(pill => {
            pill.addEventListener('click', function() {
                const field = this.dataset.field;
                const value = this.dataset.value;
                document.getElementById('dischargeImprovement').value = value;
                document.querySelectorAll(`.discharge-pill[data-field="${field}"]`).forEach(p => p.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }

    function closeDischargeModal() {
        document.getElementById('dischargeModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Sleep Education - Interactive Presentation
    function openSleepPresentation() {
        const modal = document.createElement('div');
        modal.id = 'sleepPresentationModal';
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px; height: 85vh; padding: 0; overflow: hidden;">
                <button class="modal-close" onclick="closeSleepPresentation()" style="position: absolute; top: 15px; right: 20px; z-index: 100;">&times;</button>
                <div id="presentationContainer" style="height: 100%; display: flex; flex-direction: column;">
                    <div id="slideContent" style="flex: 1; overflow-y: auto;"></div>
                    <div style="padding: 20px; border-top: 1px solid rgba(201, 169, 98, 0.2); display: flex; justify-content: space-between; align-items: center; background: var(--cream);">
                        <button onclick="prevSlide()" id="prevBtn" class="btn-secondary" style="padding: 10px 20px;">Previous</button>
                        <span id="slideIndicator" style="font-size: 13px; color: var(--text-light);">1 / 8</span>
                        <button onclick="nextSlide()" id="nextBtn" class="btn-primary" style="padding: 10px 20px;">Next</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        currentSlide = 0;
        showSlide(0);
    }

    function closeSleepPresentation() {
        const modal = document.getElementById('sleepPresentationModal');
        if (modal) modal.remove();
        document.body.style.overflow = '';
    }

    let currentSlide = 0;
    const slides = [
        {
            title: "What is Sleep?",
            content: `
                <div style="padding: 50px 60px; text-align: center;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--gold) 0%, #d4b76d 100%); border-radius: 50%; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.5" width="40" height="40">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: var(--navy); margin-bottom: 25px;">What is Sleep?</h2>
                    <p style="font-size: 18px; color: var(--text-light); max-width: 600px; margin: 0 auto 30px; line-height: 1.7;">
                        Sleep is a naturally recurring state of reduced consciousness and sensory activity. Far from being "downtime," it's when your body and brain perform critical maintenance and restoration.
                    </p>
                    <div style="display: flex; justify-content: center; gap: 40px; margin-top: 40px;">
                        <div style="text-align: center;">
                            <div style="font-family: 'Cormorant Garamond', serif; font-size: 42px; color: var(--gold-dark);">1/3</div>
                            <p style="font-size: 13px; color: var(--text-light);">of your life spent sleeping</p>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-family: 'Cormorant Garamond', serif; font-size: 42px; color: var(--gold-dark);">100+</div>
                            <p style="font-size: 13px; color: var(--text-light);">biological processes during sleep</p>
                        </div>
                    </div>
                </div>
            `
        },
        {
            title: "The Two-Process Model",
            content: `
                <div style="padding: 50px 60px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; color: var(--navy); margin-bottom: 15px; text-align: center;">How Sleep is Regulated</h2>
                    <p style="font-size: 15px; color: var(--text-light); text-align: center; margin-bottom: 40px;">Two key processes work together to control when you feel sleepy and when you feel alert.</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div style="background: linear-gradient(135deg, var(--navy) 0%, #1a2d47 100%); padding: 30px; border-radius: 16px; color: white;">
                            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--gold); margin-bottom: 15px;">Process S: Sleep Pressure</h3>
                            <p style="font-size: 14px; line-height: 1.7; color: rgba(255,255,255,0.8);">
                                The longer you're awake, the more <strong>adenosine</strong> builds up in your brain, creating "sleep pressure." This is why you feel increasingly tired as the day goes on.
                            </p>
                            <p style="font-size: 14px; line-height: 1.7; color: rgba(255,255,255,0.8); margin-top: 15px;">
                                <em>Caffeine works by blocking adenosine receptors, masking sleepiness but not eliminating the sleep debt.</em>
                            </p>
                        </div>
                        <div style="background: var(--cream); padding: 30px; border-radius: 16px;">
                            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--navy); margin-bottom: 15px;">Process C: Circadian Rhythm</h3>
                            <p style="font-size: 14px; line-height: 1.7; color: var(--text-light);">
                                Your internal 24-hour clock, located in the <strong>suprachiasmatic nucleus</strong>, responds to light and regulates your sleep-wake cycle.
                            </p>
                            <p style="font-size: 14px; line-height: 1.7; color: var(--text-light); margin-top: 15px;">
                                <em>This is why jet lag occurs - your clock needs time to adjust to new time zones.</em>
                            </p>
                        </div>
                    </div>
                </div>
            `
        },
        {
            title: "Sleep Stages",
            content: `
                <div style="padding: 50px 60px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; color: var(--navy); margin-bottom: 30px; text-align: center;">The Architecture of Sleep</h2>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 20px; padding: 20px; background: rgba(201, 169, 98, 0.08); border-radius: 12px; border-left: 4px solid #a8d5ba;">
                            <div style="width: 60px; height: 60px; background: #a8d5ba; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Cormorant Garamond', serif; font-size: 24px; color: white;">N1</div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 5px;">Stage 1: Light Sleep</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Transition between wakefulness and sleep. Lasts 5-10 minutes. Easy to wake from.</p>
                            </div>
                            <div style="font-size: 14px; color: var(--text-light);">~5%</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px; padding: 20px; background: rgba(201, 169, 98, 0.08); border-radius: 12px; border-left: 4px solid #7ec8e3;">
                            <div style="width: 60px; height: 60px; background: #7ec8e3; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Cormorant Garamond', serif; font-size: 24px; color: white;">N2</div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 5px;">Stage 2: True Sleep</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Body temperature drops, heart rate slows. Sleep spindles help with memory consolidation.</p>
                            </div>
                            <div style="font-size: 14px; color: var(--text-light);">~45%</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px; padding: 20px; background: rgba(201, 169, 98, 0.08); border-radius: 12px; border-left: 4px solid #5b7db1;">
                            <div style="width: 60px; height: 60px; background: #5b7db1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Cormorant Garamond', serif; font-size: 24px; color: white;">N3</div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 5px;">Stage 3: Deep Sleep</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Physical restoration, immune function, growth hormone release. Hardest to wake from.</p>
                            </div>
                            <div style="font-size: 14px; color: var(--text-light);">~25%</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px; padding: 20px; background: rgba(201, 169, 98, 0.08); border-radius: 12px; border-left: 4px solid var(--gold);">
                            <div style="width: 60px; height: 60px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--navy);">REM</div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 5px;">REM Sleep</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Dreaming, emotional processing, creativity. Brain is highly active, body is paralyzed.</p>
                            </div>
                            <div style="font-size: 14px; color: var(--text-light);">~25%</div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            title: "Sleep Cycles",
            content: `
                <div style="padding: 50px 60px; text-align: center;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; color: var(--navy); margin-bottom: 15px;">Sleep Cycles Through the Night</h2>
                    <p style="font-size: 15px; color: var(--text-light); margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto;">
                        Each night, you cycle through all sleep stages multiple times. Each cycle lasts approximately 90 minutes.
                    </p>
                    <div style="background: var(--cream); padding: 30px; border-radius: 16px; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; height: 150px; padding: 0 20px;">
                            <div style="text-align: center; flex: 1;">
                                <div style="height: 120px; background: linear-gradient(to top, #5b7db1 60%, var(--gold) 40%); border-radius: 8px 8px 0 0; margin-bottom: 10px;"></div>
                                <span style="font-size: 12px; color: var(--text-light);">Cycle 1</span>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="height: 110px; background: linear-gradient(to top, #5b7db1 50%, var(--gold) 50%); border-radius: 8px 8px 0 0; margin-bottom: 10px;"></div>
                                <span style="font-size: 12px; color: var(--text-light);">Cycle 2</span>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="height: 100px; background: linear-gradient(to top, #5b7db1 40%, var(--gold) 60%); border-radius: 8px 8px 0 0; margin-bottom: 10px;"></div>
                                <span style="font-size: 12px; color: var(--text-light);">Cycle 3</span>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="height: 90px; background: linear-gradient(to top, #5b7db1 30%, var(--gold) 70%); border-radius: 8px 8px 0 0; margin-bottom: 10px;"></div>
                                <span style="font-size: 12px; color: var(--text-light);">Cycle 4</span>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="height: 80px; background: linear-gradient(to top, #5b7db1 20%, var(--gold) 80%); border-radius: 8px 8px 0 0; margin-bottom: 10px;"></div>
                                <span style="font-size: 12px; color: var(--text-light);">Cycle 5</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 30px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 16px; height: 16px; background: #5b7db1; border-radius: 3px;"></div><span style="font-size: 12px; color: var(--text-light);">Deep Sleep</span></div>
                            <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 16px; height: 16px; background: var(--gold); border-radius: 3px;"></div><span style="font-size: 12px; color: var(--text-light);">REM Sleep</span></div>
                        </div>
                    </div>
                    <p style="font-size: 14px; color: var(--text-light); font-style: italic;">
                        Deep sleep dominates early cycles, while REM sleep increases toward morning. This is why sleeping in can give you vivid dreams!
                    </p>
                </div>
            `
        },
        {
            title: "Why Sleep Matters",
            content: `
                <div style="padding: 50px 60px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; color: var(--navy); margin-bottom: 30px; text-align: center;">The Power of Sleep</h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="padding: 25px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 45px; height: 45px; background: rgba(201, 169, 98, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="1.5" width="22" height="22"><path d="M12 2a4 4 0 0 0-4 4c0 1.1.4 2.1 1.1 2.9L12 12l2.9-3.1A4 4 0 0 0 12 2z"/><path d="M12 12v10"/></svg>
                            </div>
                            <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 8px;">Brain Health</h4>
                            <p style="font-size: 13px; color: var(--text-light); line-height: 1.6;">Memory consolidation, toxin clearance via the glymphatic system, emotional regulation.</p>
                        </div>
                        <div style="padding: 25px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 45px; height: 45px; background: rgba(201, 169, 98, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="1.5" width="22" height="22"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            </div>
                            <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 8px;">Heart Health</h4>
                            <p style="font-size: 13px; color: var(--text-light); line-height: 1.6;">Blood pressure regulation, reduced inflammation, cardiovascular recovery.</p>
                        </div>
                        <div style="padding: 25px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 45px; height: 45px; background: rgba(201, 169, 98, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="1.5" width="22" height="22"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
                            </div>
                            <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 8px;">Metabolism</h4>
                            <p style="font-size: 13px; color: var(--text-light); line-height: 1.6;">Hormone balance, appetite regulation (ghrelin/leptin), blood sugar control.</p>
                        </div>
                        <div style="padding: 25px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 45px; height: 45px; background: rgba(201, 169, 98, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold-dark)" stroke-width="1.5" width="22" height="22"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            </div>
                            <h4 style="font-size: 16px; color: var(--navy); margin-bottom: 8px;">Immune Function</h4>
                            <p style="font-size: 13px; color: var(--text-light); line-height: 1.6;">T-cell production, antibody response, faster recovery from illness.</p>
                        </div>
                    </div>
                </div>
            `
        },
        {
            title: "Sleep Deprivation",
            content: `
                <div style="padding: 50px 60px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; color: var(--navy); margin-bottom: 15px; text-align: center;">The Cost of Poor Sleep</h2>
                    <p style="font-size: 15px; color: var(--text-light); text-align: center; margin-bottom: 35px;">Even modest sleep loss has measurable effects on your body and mind.</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px;">
                        <div style="text-align: center; padding: 25px; background: rgba(239, 68, 68, 0.05); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <div style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: #dc2626; margin-bottom: 10px;">24h</div>
                            <h4 style="font-size: 14px; color: var(--navy); margin-bottom: 8px;">After 1 Day</h4>
                            <p style="font-size: 12px; color: var(--text-light);">Impaired judgment similar to 0.1% blood alcohol. Reduced reaction time.</p>
                        </div>
                        <div style="text-align: center; padding: 25px; background: rgba(239, 68, 68, 0.08); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.25);">
                            <div style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: #dc2626; margin-bottom: 10px;">1 Week</div>
                            <h4 style="font-size: 14px; color: var(--navy); margin-bottom: 8px;">Chronic Restriction</h4>
                            <p style="font-size: 12px; color: var(--text-light);">Increased cortisol, impaired glucose tolerance, weakened immunity.</p>
                        </div>
                        <div style="text-align: center; padding: 25px; background: rgba(239, 68, 68, 0.12); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <div style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: #dc2626; margin-bottom: 10px;">Long-term</div>
                            <h4 style="font-size: 14px; color: var(--navy); margin-bottom: 8px;">Accumulated Debt</h4>
                            <p style="font-size: 12px; color: var(--text-light);">Higher risk of obesity, diabetes, heart disease, and cognitive decline.</p>
                        </div>
                    </div>
                    <div style="margin-top: 30px; padding: 20px; background: rgba(201, 169, 98, 0.1); border-radius: 12px; text-align: center;">
                        <p style="font-size: 14px; color: var(--navy); margin: 0;"><strong>The good news:</strong> Most effects of sleep deprivation are reversible with consistent, quality sleep.</p>
                    </div>
                </div>
            `
        },
        {
            title: "Sleep Hygiene Basics",
            content: `
                <div style="padding: 50px 60px;">
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; color: var(--navy); margin-bottom: 30px; text-align: center;">Foundations of Good Sleep</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 15px; padding: 20px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 40px; height: 40px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--navy); font-weight: bold;">1</div>
                            <div>
                                <h4 style="font-size: 15px; color: var(--navy); margin-bottom: 5px;">Consistent Schedule</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Go to bed and wake up at the same time every day, even on weekends.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 15px; padding: 20px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 40px; height: 40px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--navy); font-weight: bold;">2</div>
                            <div>
                                <h4 style="font-size: 15px; color: var(--navy); margin-bottom: 5px;">Dark Environment</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Use blackout curtains and eliminate light sources. Light suppresses melatonin.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 15px; padding: 20px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 40px; height: 40px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--navy); font-weight: bold;">3</div>
                            <div>
                                <h4 style="font-size: 15px; color: var(--navy); margin-bottom: 5px;">Cool Temperature</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Keep bedroom at 65-68F (18-20C). Cool temperatures promote deep sleep.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 15px; padding: 20px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 40px; height: 40px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--navy); font-weight: bold;">4</div>
                            <div>
                                <h4 style="font-size: 15px; color: var(--navy); margin-bottom: 5px;">Limit Screens</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Avoid blue light 1-2 hours before bed. Use night mode if necessary.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 15px; padding: 20px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 40px; height: 40px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--navy); font-weight: bold;">5</div>
                            <div>
                                <h4 style="font-size: 15px; color: var(--navy); margin-bottom: 5px;">Watch Caffeine</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Avoid caffeine at least 6 hours before bed. It has a half-life of 5-6 hours.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 15px; padding: 20px; background: white; border-radius: 12px; border: 1px solid rgba(201, 169, 98, 0.2);">
                            <div style="width: 40px; height: 40px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--navy); font-weight: bold;">6</div>
                            <div>
                                <h4 style="font-size: 15px; color: var(--navy); margin-bottom: 5px;">Wind-Down Routine</h4>
                                <p style="font-size: 13px; color: var(--text-light);">Create a relaxing pre-sleep ritual to signal your body it's time to rest.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            title: "Your Sleep Journey",
            content: `
                <div style="padding: 50px 60px; text-align: center;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--gold) 0%, #d4b76d 100%); border-radius: 50%; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.5" width="40" height="40">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 36px; color: var(--navy); margin-bottom: 20px;">Start Your Journey</h2>
                    <p style="font-size: 18px; color: var(--text-light); max-width: 550px; margin: 0 auto 35px; line-height: 1.7;">
                        Understanding sleep is the first step. Now it's time to take action and improve your rest.
                    </p>
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <button onclick="closeSleepPresentation(); showSection('dashboard');" class="btn-primary" style="padding: 14px 28px;">Take Sleep Assessment</button>
                        <button onclick="closeSleepPresentation(); downloadPDF('general');" class="btn-secondary" style="padding: 14px 28px;">Download Guide</button>
                    </div>
                    <p style="font-size: 14px; color: var(--text-light); margin-top: 40px;">
                        Questions? Send a message to Dr. Alen through the portal.
                    </p>
                </div>
            `
        }
    ];

    function showSlide(index) {
        const container = document.getElementById('slideContent');
        container.innerHTML = slides[index].content;
        document.getElementById('slideIndicator').textContent = (index + 1) + ' / ' + slides.length;
        document.getElementById('prevBtn').style.visibility = index === 0 ? 'hidden' : 'visible';
        document.getElementById('nextBtn').textContent = index === slides.length - 1 ? 'Close' : 'Next';
    }

    function nextSlide() {
        if (currentSlide < slides.length - 1) {
            currentSlide++;
            showSlide(currentSlide);
        } else {
            closeSleepPresentation();
        }
    }

    function prevSlide() {
        if (currentSlide > 0) {
            currentSlide--;
            showSlide(currentSlide);
        }
    }

    // Download PDF function - opens professional sleep guides
    function downloadPDF(type) {
        const guides = {
            general: 'guides/sleep-guide-general.html',
            athletes: 'guides/sleep-guide-athletes.html',
            executives: 'guides/sleep-guide-executives.html'
        };

        // Open the guide in a new tab
        window.open(guides[type], '_blank');
    }

    // Terms of Service Modal
    function showTermsModal() {
        const modal = document.createElement('div');
        modal.id = 'termsModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;';
        modal.innerHTML = `
            <div style="background: white; max-width: 650px; max-height: 85vh; overflow-y: auto; padding: 35px; border-radius: 16px; position: relative;">
                <button onclick="document.getElementById('termsModal').remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                <h2 style="font-family: 'Cormorant Garamond', serif; color: var(--navy); margin-bottom: 25px; font-size: 28px;">Terms of Service</h2>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-light);">
                    <h3 style="color: var(--navy); font-size: 16px; margin: 0 0 12px;">Nature of Services</h3>
                    <p style="margin-bottom: 20px;">Sleep Wellness by Dr. Alen ("the Service") is a consulting and educational service focused on sleep wellness. <strong>The Service is not a medical practice and does not provide medical advice, diagnosis, or treatment.</strong> Dr. Alen Juginovic provides sleep wellness consulting based on his expertise in sleep science.</p>

                    <h3 style="color: var(--navy); font-size: 16px; margin: 0 0 12px;">Not Medical Advice</h3>
                    <p style="margin-bottom: 20px;">All information, assessments, recommendations, and resources provided through this portal are for informational and educational purposes only. They are not intended to replace professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified healthcare provider with any questions you may have regarding a medical condition or sleep disorder.</p>

                    <h3 style="color: var(--navy); font-size: 16px; margin: 0 0 12px;">Emergency Situations</h3>
                    <p style="margin-bottom: 20px;">If you think you may have a medical emergency, call your doctor or emergency services immediately. The Service does not provide emergency medical services.</p>

                    <h3 style="color: var(--navy); font-size: 16px; margin: 0 0 12px;">Your Responsibilities</h3>
                    <p style="margin-bottom: 20px;">You are responsible for your own health decisions. Any actions you take based on information from this Service are at your own discretion and risk. You agree to consult with appropriate healthcare professionals before making any changes to your health regimen.</p>

                    <h3 style="color: var(--navy); font-size: 16px; margin: 0 0 12px;">Data Collection & Privacy</h3>
                    <p style="margin-bottom: 20px;">We collect sleep-related information to provide personalized guidance. All data is kept confidential and used solely for the purpose of improving your sleep wellness experience. You may provide as much or as little information as you are comfortable sharing. You may request deletion of your data at any time.</p>

                    <h3 style="color: var(--navy); font-size: 16px; margin: 0 0 12px;">Limitation of Liability</h3>
                    <p style="margin-bottom: 20px;">The Service and its providers shall not be liable for any direct, indirect, incidental, or consequential damages arising from the use of information or recommendations provided through this portal.</p>

                    <h3 style="color: var(--navy); font-size: 16px; margin: 0 0 12px;">Contact</h3>
                    <p>For questions about these terms, contact Dr. Alen Juginovic at alen_juginovic@hms.harvard.edu</p>
                </div>
                <button onclick="document.getElementById('termsModal').remove()" style="margin-top: 25px; padding: 14px 28px; background: var(--gold); color: var(--deep-navy); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif;">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function setSatisfaction(value) {
        document.getElementById('dischargeSatisfaction').value = value;
        document.querySelectorAll('.sat-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.dataset.value) === value) {
                btn.classList.add('active');
            }
        });
    }

    function setNPS(value) {
        document.getElementById('dischargeNPS').value = value;
        document.querySelectorAll('.nps-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.dataset.value) === value) {
                btn.classList.add('active');
            }
        });
    }

    function setCommunication(value) {
        document.getElementById('dischargeCommunication').value = value;
        document.querySelectorAll('.comm-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.dataset.value) === value) {
                btn.classList.add('active');
            }
        });
    }

    async function submitDischargeSurvey(e) {
        e.preventDefault();

        const btn = document.getElementById('submitDischargeBtn');
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        // Collect helpful items
        const helpfulItems = [];
        document.querySelectorAll('input[name="helpful"]:checked').forEach(cb => {
            helpfulItems.push(cb.value);
        });

        const surveyData = {
            satisfaction: parseInt(document.getElementById('dischargeSatisfaction').value) || null,
            improvement: document.getElementById('dischargeImprovement').value || null,
            nps: parseInt(document.getElementById('dischargeNPS').value),
            communication: parseInt(document.getElementById('dischargeCommunication').value) || null,
            helpfulItems,
            improvements: document.getElementById('dischargeImprovements').value.trim() || null,
            testimonial: document.getElementById('dischargeTestimonial').value.trim() || null,
            testimonialConsent: document.getElementById('dischargeTestimonialConsent').checked,
            userId: currentUser.uid,
            userEmail: currentUser.email,
            userName: userProfile?.displayName || null,
            clientType: userProfile?.clientType || null,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Calculate NPS category
        if (surveyData.nps !== null && !isNaN(surveyData.nps)) {
            if (surveyData.nps <= 6) surveyData.npsCategory = 'detractor';
            else if (surveyData.nps <= 8) surveyData.npsCategory = 'passive';
            else surveyData.npsCategory = 'promoter';
        }

        try {
            // Save to Firestore
            await db.collection('dischargeSurveys').add(surveyData);

            // Mark user as discharged
            await db.collection('users').doc(currentUser.uid).update({
                discharged: true,
                dischargedAt: firebase.firestore.FieldValue.serverTimestamp(),
                dischargeNPS: surveyData.nps,
                dischargeSatisfaction: surveyData.satisfaction
            });

            closeDischargeModal();

            // Show thank you message
            alert('Thank you for your feedback! We appreciate you taking the time to help us improve.');

        } catch (error) {
            console.error('Error submitting survey:', error);
            alert('There was an error submitting your feedback. Please try again.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Submit Feedback';
        }
    }

    // Check if user should see discharge survey (can be triggered by admin)
    async function checkForDischargeSurvey() {
        if (!currentUser) return;

        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();

            // Check if marked for discharge but hasn't completed survey
            if (userData?.pendingDischarge && !userData?.discharged) {
                openDischargeModal();
            }
        } catch (error) {
            console.error('Error checking discharge status:', error);
        }
    }

    // ========== END DISCHARGE SURVEY FUNCTIONS ==========

    // ========== AI CHATBOT FUNCTIONS ==========

    let chatHistory = [];
    let isChatProcessing = false;

    // Cloud Function URL - matches Firebase project ID from firebase-config.js
    // For local development, use: http://localhost:5001/sleep-wellness-48d57/us-central1/chatWithClaude
    const CHAT_API_URL = 'https://us-central1-sleep-wellness-48d57.cloudfunctions.net/chatWithClaude';

    // Medical advice detection keywords (used as fallback)
    const medicalKeywords = [
        'diagnose', 'diagnosis', 'medication', 'medicine', 'drug', 'prescription',
        'treatment', 'cure', 'disease', 'disorder', 'condition', 'symptom',
        'should i take', 'what should i do about', 'is this serious',
        'am i sick', 'do i have', 'sleeping pills', 'melatonin dose',
        'side effects', 'doctor', 'physician', 'medical advice'
    ];

    function toggleChat() {
        document.getElementById('chatWidget').classList.toggle('open');
    }

    function handleChatKeypress(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    }

    function askSuggestion(question) {
        document.getElementById('chatInput').value = question;
        sendChatMessage();
        // Hide suggestions after use
        document.getElementById('chatSuggestions').style.display = 'none';
    }

    async function sendChatMessage() {
        if (isChatProcessing) return;

        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        input.value = '';
        isChatProcessing = true;
        document.getElementById('chatSendBtn').disabled = true;

        // Add user message
        addChatMessage(message, 'user');

        // Show typing indicator
        showTypingIndicator();

        // Process and respond
        setTimeout(async () => {
            const response = await generateResponse(message);
            hideTypingIndicator();
            addChatMessage(response.text, 'assistant', response.showContactBtn);
            isChatProcessing = false;
            document.getElementById('chatSendBtn').disabled = false;
        }, 800 + Math.random() * 700);
    }

    function addChatMessage(text, role, showContactBtn = false) {
        const container = document.getElementById('chatMessages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${role}`;

        let content = `<div class="chat-bubble">${text}</div>`;

        if (showContactBtn) {
            content = `<div class="chat-bubble">${text}
                <button class="chat-contact-btn" onclick="contactDrAlen()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Contact Dr. Alen
                </button>
            </div>`;
        }

        msgDiv.innerHTML = content;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;

        // Store in history
        chatHistory.push({ role, content: text });
    }

    function showTypingIndicator() {
        const container = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message assistant';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `<div class="chat-typing"><span></span><span></span><span></span></div>`;
        container.appendChild(typingDiv);
        container.scrollTop = container.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    async function generateResponse(message) {
        try {
            // Build conversation history for API
            const conversationHistory = chatHistory.slice(-10).map(msg => ({
                role: msg.role === 'user' ? 'user' : 'assistant',
                content: msg.content
            }));

            // Call Claude API via Cloud Function
            const response = await fetch(CHAT_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    userId: currentUser ? currentUser.uid : null,
                    conversationHistory: conversationHistory
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();

            return {
                text: data.message,
                showContactBtn: data.showContactBtn || false
            };

        } catch (error) {
            console.error('Error calling Claude API:', error);

            // Fallback to local response on error
            const lowerMsg = message.toLowerCase();

            // Check for medical advice requests
            const needsMedical = medicalKeywords.some(keyword => lowerMsg.includes(keyword));

            if (needsMedical) {
                return {
                    text: `<p>I understand you have questions about this topic. While I can provide general sleep education, I'm not able to give medical or health advice.</p>
                           <p>Dr. Alen would be the best person to discuss this with you directly. Would you like to send him a message?</p>`,
                    showContactBtn: true
                };
            }

            // Check for greetings
            if (lowerMsg.match(/^(hi|hello|hey|good morning|good evening)/)) {
                const greeting = new Date().getHours() < 12 ? 'Good morning' : new Date().getHours() < 18 ? 'Good afternoon' : 'Good evening';
                return {
                    text: `<p>${greeting}! How can I help you with your sleep wellness journey today?</p>`,
                    showContactBtn: false
                };
            }

            // Default fallback
            return {
                text: `<p>I'm having trouble connecting right now. Please try again in a moment.</p>
                       <p>In the meantime, you can explore the <strong>Resources</strong> section or send a message to Dr. Alen directly.</p>`,
                showContactBtn: true
            };
        }
    }

    async function generateDataSummary() {
        try {
            // Fetch user's diary entries
            const diaryEntries = await FirebaseDB.getDiaryEntries(currentUser.uid, 7);

            if (diaryEntries.length === 0) {
                return {
                    text: `<p>You haven't logged any sleep diary entries yet.</p>
                           <p>Start tracking your sleep in the <strong>Sleep Diary</strong> section, and I'll be able to summarize your patterns!</p>`,
                    showContactBtn: false
                };
            }

            // Calculate averages
            const avgEfficiency = diaryEntries.reduce((sum, e) => sum + (e.sleepEfficiency || 0), 0) / diaryEntries.length;
            const avgTST = diaryEntries.reduce((sum, e) => sum + (e.totalSleepTime || 0), 0) / diaryEntries.length;
            const avgLatency = diaryEntries.reduce((sum, e) => sum + (e.sleepLatency || 0), 0) / diaryEntries.length;
            const avgQuality = diaryEntries.reduce((sum, e) => sum + (e.quality || 0), 0) / diaryEntries.length;

            const hours = Math.floor(avgTST / 60);
            const mins = Math.round(avgTST % 60);

            let efficiencyRating = avgEfficiency >= 85 ? 'excellent' : avgEfficiency >= 75 ? 'good' : avgEfficiency >= 65 ? 'fair' : 'needs improvement';

            return {
                text: `<p><strong>Your Sleep Summary (Last ${diaryEntries.length} nights):</strong></p>
                       <ul>
                           <li><strong>Average Sleep Time:</strong> ${hours}h ${mins}m per night</li>
                           <li><strong>Sleep Efficiency:</strong> ${avgEfficiency.toFixed(0)}% (${efficiencyRating})</li>
                           <li><strong>Sleep Latency:</strong> ~${Math.round(avgLatency)} minutes to fall asleep</li>
                           <li><strong>Quality Rating:</strong> ${avgQuality.toFixed(1)}/5</li>
                       </ul>
                       <p>${avgEfficiency >= 85 ? "Great job! Your sleep efficiency is in the excellent range." :
                          avgEfficiency >= 75 ? "Your sleep efficiency is good. There's still room to optimize!" :
                          "Let's work on improving your sleep efficiency. The Resources section has helpful techniques."}</p>`,
                showContactBtn: false
            };
        } catch (error) {
            console.error('Error fetching sleep data:', error);
            return {
                text: `<p>I had trouble fetching your sleep data. Please try again or check the Sleep Diary section directly.</p>`,
                showContactBtn: false
            };
        }
    }

    function contactDrAlen() {
        // Navigate to messages section
        showSection('messages');
        toggleChat();

        // Pre-fill with context
        setTimeout(() => {
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = "Hi Dr. Alen, I have a question that the assistant suggested I ask you directly: ";
                input.focus();
            }
        }, 300);
    }

    // ========== END AI CHATBOT FUNCTIONS ==========

    // Update profile
    async function updateProfile(e) {
        e.preventDefault();

        const name = document.getElementById('profileName').value;
        const phone = document.getElementById('profilePhone').value;
        const clientType = document.getElementById('profileClientType').value;

        await db.collection('users').doc(currentUser.uid).update({
            displayName: name,
            phone,
            clientType
        });

        alert('Profile updated!');
    }

    // Utility: format time ago
    function formatTimeAgo(date) {
        if (!date) return '';
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
        return Math.floor(seconds / 86400) + 'd ago';
    }

    // ============================================
    // HOTEL GUEST CHECKOUT FUNCTIONALITY
    // ============================================

    let currentGuestStay = null;
    let currentHotelPartner = null;
    let checkoutStep = 1;
    let postStayISI = null;
    let postStayESS = null;

    // ISI Questions for checkout
    const isiQuestions = [
        { id: 'isi1', text: 'Difficulty falling asleep', options: ['None', 'Mild', 'Moderate', 'Severe', 'Very Severe'] },
        { id: 'isi2', text: 'Difficulty staying asleep', options: ['None', 'Mild', 'Moderate', 'Severe', 'Very Severe'] },
        { id: 'isi3', text: 'Problems waking up too early', options: ['None', 'Mild', 'Moderate', 'Severe', 'Very Severe'] },
        { id: 'isi4', text: 'How satisfied are you with your sleep?', options: ['Very Satisfied', 'Satisfied', 'Neutral', 'Dissatisfied', 'Very Dissatisfied'] },
        { id: 'isi5', text: 'How noticeable to others is your sleep problem?', options: ['Not at all', 'A little', 'Somewhat', 'Much', 'Very much'] },
        { id: 'isi6', text: 'How worried are you about your current sleep?', options: ['Not at all', 'A little', 'Somewhat', 'Much', 'Very much'] },
        { id: 'isi7', text: 'How much does your sleep interfere with daily functioning?', options: ['Not at all', 'A little', 'Somewhat', 'Much', 'Very much'] }
    ];

    // ESS Questions for checkout
    const essQuestions = [
        { id: 'ess1', text: 'Sitting and reading' },
        { id: 'ess2', text: 'Watching TV' },
        { id: 'ess3', text: 'Sitting inactive in a public place' },
        { id: 'ess4', text: 'As a passenger in a car for an hour' },
        { id: 'ess5', text: 'Lying down to rest in the afternoon' },
        { id: 'ess6', text: 'Sitting and talking to someone' },
        { id: 'ess7', text: 'Sitting quietly after lunch (no alcohol)' },
        { id: 'ess8', text: 'In a car, while stopped in traffic' }
    ];

    const essOptions = ['No chance (0)', 'Slight chance (1)', 'Moderate chance (2)', 'High chance (3)'];

    // Initialize hotel guest mode
    async function initHotelGuestMode(profile) {
        if (!profile.hotelAffiliation?.isHotelGuest) return;

        const stayId = profile.hotelAffiliation.currentStayId;
        if (!stayId) return;

        try {
            currentGuestStay = await FirebaseDB.getGuestStay(stayId);
            if (!currentGuestStay || currentGuestStay.stayStatus !== 'active') return;

            currentHotelPartner = await FirebaseDB.getHotelPartner(currentGuestStay.hotelPartnerId);
            if (!currentHotelPartner) return;

            // Show checkout button
            document.getElementById('checkoutBtn').style.display = 'flex';

            // Show hotel stay banner
            const banner = document.getElementById('hotelStayBanner');
            banner.style.display = 'block';
            document.getElementById('hotelBannerName').textContent = currentHotelPartner.name;

            const checkIn = currentGuestStay.checkInDate?.toDate?.();
            const checkOut = currentGuestStay.checkoutDate?.toDate?.();
            const roomNum = currentGuestStay.roomNumber || 'N/A';

            if (checkIn && checkOut) {
                const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('hotelBannerDates').textContent = `Room ${roomNum} | ${formatDate(checkIn)} - ${formatDate(checkOut)}`;

                // Calculate days remaining
                const now = new Date();
                const daysRemaining = Math.max(0, Math.ceil((checkOut - now) / (1000 * 60 * 60 * 24)));
                document.getElementById('hotelDaysRemaining').textContent = daysRemaining;
            }

        } catch (error) {
            console.error('Error initializing hotel guest mode:', error);
        }
    }

    // Show checkout wizard
    function showCheckoutWizard() {
        if (!currentGuestStay) {
            alert('No active stay found.');
            return;
        }

        checkoutStep = 1;
        updateCheckoutUI();
        loadISIQuestions();

        document.getElementById('checkout-modal').style.display = 'flex';
    }

    // Close checkout modal
    function closeCheckoutModal() {
        document.getElementById('checkout-modal').style.display = 'none';
    }

    // Load ISI questions into the checkout wizard
    function loadISIQuestions() {
        const container = document.getElementById('post-isi-questions');
        container.innerHTML = isiQuestions.map(q => `
            <div style="margin-bottom: 20px;">
                <p style="font-size: 14px; color: #0f1c2e; margin-bottom: 10px;">${q.text}</p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${q.options.map((opt, i) => `
                        <label style="flex: 1; min-width: 80px; text-align: center;">
                            <input type="radio" name="${q.id}" value="${i}" style="display: none;">
                            <span class="isi-option" onclick="selectISIOption(this, '${q.id}', ${i})" style="display: block; padding: 10px 8px; background: #f5f5f5; border: 2px solid transparent; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">${opt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // Load ESS questions
    function loadESSQuestions() {
        const container = document.getElementById('post-ess-questions');
        container.innerHTML = essQuestions.map(q => `
            <div style="margin-bottom: 20px;">
                <p style="font-size: 14px; color: #0f1c2e; margin-bottom: 10px;">${q.text}</p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${essOptions.map((opt, i) => `
                        <label style="flex: 1; min-width: 100px; text-align: center;">
                            <input type="radio" name="${q.id}" value="${i}" style="display: none;">
                            <span class="ess-option" onclick="selectESSOption(this, '${q.id}', ${i})" style="display: block; padding: 10px 8px; background: #f5f5f5; border: 2px solid transparent; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">${opt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // Select ISI option
    function selectISIOption(el, questionId, value) {
        // Deselect siblings
        el.parentElement.parentElement.querySelectorAll('.isi-option').forEach(opt => {
            opt.style.borderColor = 'transparent';
            opt.style.background = '#f5f5f5';
        });
        // Select this one
        el.style.borderColor = '#C9A962';
        el.style.background = 'rgba(201, 169, 98, 0.1)';
        // Set radio value
        document.querySelector(`input[name="${questionId}"][value="${value}"]`).checked = true;
    }

    // Select ESS option
    function selectESSOption(el, questionId, value) {
        el.parentElement.parentElement.querySelectorAll('.ess-option').forEach(opt => {
            opt.style.borderColor = 'transparent';
            opt.style.background = '#f5f5f5';
        });
        el.style.borderColor = '#C9A962';
        el.style.background = 'rgba(201, 169, 98, 0.1)';
        document.querySelector(`input[name="${questionId}"][value="${value}"]`).checked = true;
    }

    // Select rating star
    function selectRating(rating) {
        document.querySelectorAll('.rating-star').forEach((star, i) => {
            if (i < rating) {
                star.classList.add('selected');
            } else {
                star.classList.remove('selected');
            }
        });
        document.getElementById('feedback-rating').value = rating;
    }

    // Update checkout UI based on step
    function updateCheckoutUI() {
        // Update progress bar
        document.querySelectorAll('.checkout-step').forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            step.style.background = stepNum <= checkoutStep ? '#C9A962' : 'rgba(255,255,255,0.3)';
        });

        // Show/hide steps
        document.querySelectorAll('.checkout-wizard-step').forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            step.style.display = stepNum === checkoutStep ? 'block' : 'none';
            if (stepNum === checkoutStep) step.classList.add('active');
            else step.classList.remove('active');
        });

        // Update buttons
        const backBtn = document.getElementById('checkout-back-btn');
        const nextBtn = document.getElementById('checkout-next-btn');
        const cancelBtn = document.getElementById('checkout-cancel-btn');

        backBtn.style.display = checkoutStep > 1 && checkoutStep < 5 ? 'inline-block' : 'none';
        cancelBtn.style.display = checkoutStep < 5 ? 'inline-block' : 'none';

        if (checkoutStep === 5) {
            nextBtn.textContent = 'Done';
            nextBtn.onclick = closeCheckoutModal;
        } else if (checkoutStep === 4) {
            nextBtn.textContent = 'Submit';
        } else {
            nextBtn.textContent = 'Next';
            nextBtn.onclick = checkoutNextStep;
        }
    }

    // Hotel experience ratings storage
    let hotelRatings = {
        mattress: null, pillows: null, roomTemp: null,
        darkness: null, quietness: null, airQuality: null
    };

    // Set hotel rating
    function setHotelRating(category, value) {
        hotelRatings[category] = value;
        // Update button styles
        const container = document.getElementById('rating-' + category);
        if (container) {
            container.querySelectorAll('button').forEach((btn, idx) => {
                const btnVal = idx + 1;
                if (btnVal <= value) {
                    btn.style.background = '#C9A962';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#C9A962';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    btn.style.borderColor = '#ddd';
                }
            });
        }
    }

    // Go to previous step
    function checkoutPrevStep() {
        if (checkoutStep > 1) {
            checkoutStep--;
            updateCheckoutUI();
        }
    }

    // Go to next step
    async function checkoutNextStep() {
        if (checkoutStep === 1) {
            // Validate and collect ISI
            const isiScore = collectISIScore();
            if (isiScore === null) {
                alert('Please answer all questions before continuing.');
                return;
            }
            postStayISI = isiScore;
            checkoutStep = 2;
            loadESSQuestions();
            updateCheckoutUI();

        } else if (checkoutStep === 2) {
            // Validate and collect ESS
            const essScore = collectESSScore();
            if (essScore === null) {
                alert('Please answer all questions before continuing.');
                return;
            }
            postStayESS = essScore;
            checkoutStep = 3;
            updateCheckoutUI();

        } else if (checkoutStep === 3) {
            // Collect feedback and move to hotel ratings
            const rating = parseInt(document.getElementById('feedback-rating').value);

            if (!rating) {
                alert('Please provide a rating.');
                return;
            }

            checkoutStep = 4;
            updateCheckoutUI();

        } else if (checkoutStep === 4) {
            // Collect hotel ratings and complete checkout
            const feedbackRating = parseInt(document.getElementById('feedback-rating').value);
            const recommend = document.querySelector('input[name="recommend"]:checked')?.value;

            // Collect hotel experience data
            const hotelExperience = {
                ...hotelRatings,
                topFactor: document.getElementById('hotel-top-factor')?.value || ''
            };

            // Save everything
            await completeCheckout({
                rating: feedbackRating,
                wouldRecommend: recommend === 'yes',
                mostHelpful: document.getElementById('feedback-helpful').value,
                comments: document.getElementById('feedback-comments').value
            }, hotelExperience);

            checkoutStep = 5;
            updateCheckoutUI();
        }
    }

    // Collect ISI score
    function collectISIScore() {
        let score = 0;
        for (const q of isiQuestions) {
            const selected = document.querySelector(`input[name="${q.id}"]:checked`);
            if (!selected) return null;
            score += parseInt(selected.value);
        }
        return score;
    }

    // Collect ESS score
    function collectESSScore() {
        let score = 0;
        for (const q of essQuestions) {
            const selected = document.querySelector(`input[name="${q.id}"]:checked`);
            if (!selected) return null;
            score += parseInt(selected.value);
        }
        return score;
    }

    // Complete checkout process
    async function completeCheckout(feedback, hotelExperience = {}) {
        try {
            // Record post-stay assessments
            await FirebaseDB.recordPostStayAssessment(currentGuestStay.id, 'isi', postStayISI);
            await FirebaseDB.recordPostStayAssessment(currentGuestStay.id, 'ess', postStayESS);

            // Save assessments to assessments collection as well
            await FirebaseDB.saveAssessmentWithContext(currentUser.uid, {
                type: 'ISI',
                instrumentId: 'isi',
                scores: { isi: postStayISI }
            }, 'post-stay', currentGuestStay.id);

            await FirebaseDB.saveAssessmentWithContext(currentUser.uid, {
                type: 'ESS',
                instrumentId: 'ess',
                scores: { ess: postStayESS }
            }, 'post-stay', currentGuestStay.id);

            // Save hotel experience ratings
            if (Object.values(hotelExperience).some(v => v !== null)) {
                await db.collection('guestStays').doc(currentGuestStay.id).update({
                    hotelExperience: hotelExperience
                });
            }

            // Complete checkout with feedback
            await FirebaseDB.completeGuestCheckout(currentGuestStay.id, feedback);

            // Calculate and display improvement
            const baselineISI = currentGuestStay.baselineAssessments?.isi;
            let improvement = 0;
            if (baselineISI && postStayISI !== null) {
                improvement = Math.round(((baselineISI - postStayISI) / baselineISI) * 100);
            }

            document.getElementById('checkout-improvement').textContent = improvement > 0 ? `+${improvement}%` : `${improvement}%`;
            document.getElementById('checkout-improvement').style.color = improvement > 0 ? '#C9A962' : '#fff';

            document.getElementById('checkout-isi-change').textContent = `${baselineISI ?? '-'}  ${postStayISI}`;
            document.getElementById('checkout-ess-change').textContent = `${currentGuestStay.baselineAssessments?.ess ?? '-'}  ${postStayESS}`;

            // Hide checkout button and banner
            document.getElementById('checkoutBtn').style.display = 'none';
            document.getElementById('hotelStayBanner').style.display = 'none';

        } catch (error) {
            console.error('Error completing checkout:', error);
            alert('Error completing checkout. Please try again.');
        }
    }

    // Auth state listener
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = 'auth.html?redirect=' + encodeURIComponent(window.location.pathname);
            return;
        }

        const profile = await FirebaseDB.getUserProfile(user.uid);

        // If admin, redirect to admin dashboard
        if (profile && profile.role === 'admin') {
            window.location.href = 'admin/index.html';
            return;
        }

        // Update auth UI
        Auth.currentUser = user;
        Auth.userProfile = profile;
        Auth.updateAuthUI(true);

        // Store current user for later use
        currentUser = user;

        // Initialize dashboard
        initDashboard(user, profile);

        // Initialize hotel guest mode if applicable
        initHotelGuestMode(profile);

        // Load profile form
        if (profile) {
            document.getElementById('profileName').value = profile.displayName || '';
            document.getElementById('profilePhone').value = profile.phone || '';
            document.getElementById('profileClientType').value = profile.clientType || 'athlete';
        }
    });
</script>

</body>
</html>
